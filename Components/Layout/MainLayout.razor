@inherits LayoutComponentBase
@inject NavigationManager Nav

<div class="app-shell" @onclick="CloseTransientMenus">
    <aside class="shell-sidebar">
        <div class="sidebar-brand">
            <img src="images/ResQLinkLogoFull.png" alt="ResQLink" class="brand-logo" />
        </div>

        <nav class="nav-stack">
            <button class='nav-btn @ActiveClass("/home")' type="button" @onclick='() => Go("/home")' disabled="@IsActive("/home")">
                <span>Dashboard</span>
            </button>
            <button class='nav-btn @ActiveClass("/evacuees")' type="button" @onclick='() => Go("/evacuees")' disabled="@IsActive("/evacuees")">
                <span>Evacuees</span>
            </button>
            <button class='nav-btn @ActiveClass("/disasters")' type="button" @onclick='() => Go("/disasters")' disabled="@IsActive("/disasters")">
                <span>Disasters</span>
            </button>

            @* Inventory button with small dropdown menu for categories *@
            <div class="nav-item-with-menu">
                <button class='nav-btn nav-btn-static @(InventoryOpen ? "active" : "")' type="button"
                        @onclick="ToggleInventoryMenu" @onclick:stopPropagation="true" aria-expanded="@InventoryOpen" aria-haspopup="true">
                    <span>Inventory ▾</span>
                </button>

                @if (InventoryOpen)
                {
                    <div class="inventory-dropdown" @onclick:stopPropagation="true">
                        <button class="dropdown-link" @onclick="() => GoInventory()">Overview</button>
                        @foreach (var c in InventoryCategories)
                        {
                            <button class="dropdown-link" @onclick="() => GoInventoryCategory(c.Slug)">@c.Label</button>
                        }
                    </div>
                }
            </div>

            <button class='nav-btn @ActiveClass("/reports")' type="button" @onclick='() => Go("/reports")' disabled="@IsActive("/reports")">
                <span>Reports</span>
            </button>
            <button class='nav-btn @ActiveClass("/audit-logs")' type="button" @onclick='() => Go("/audit-logs")' disabled="@IsActive("/audit-logs")">
                <span>Audit Logs</span>
            </button>
        </nav>
    </aside>

    <section class="shell-body">
        <!-- Top bar -->
        <header class="shell-header">
            <div class="header-left">
                <button class="menu-icon" type="button" aria-label="Menu">
                    <span></span><span></span><span></span>
                </button>   
            </div>
            <div class="header-icons">
                <button class="icon-btn" aria-label="Settings">
                    <i class="bi bi-gear-fill"></i>
                </button>
                <button class="icon-btn" aria-label="Notifications">
                    <i class="bi bi-bell-fill"></i>
                </button>
                <button class="icon-btn" aria-label="Profile">
                    <i class="bi bi-person-circle"></i>
                </button>
            </div>
        </header>

        <!-- Page title bar (separate from top bar) -->
        <div class="page-title-bar">
            <h1 class="page-title">@CurrentTitle</h1>
        </div>

        <!-- Main content -->
        <main class="shell-content">
            @Body
            <footer class="shell-footer">© All rights reserved</footer>
        </main>
    </section>
</div>

@code {
    private bool InventoryOpen;

    // Basic category list for the Inventory dropdown. Slugs are friendly for URLs.
    private readonly (string Label, string Slug)[] InventoryCategories = new[]
    {
        ("Relief Goods", "relief-goods"),
        ("Consumables", "consumables"),
        ("Protective", "protective"),
        ("Medical", "medical"),
        ("Logistics", "logistics"),
        ("Technology", "technology")
    };

    private void ToggleInventoryMenu()
    {
        InventoryOpen = !InventoryOpen;
    }

    private void CloseTransientMenus()
    {
        InventoryOpen = false;
    }

    private void GoInventory()
    {
        InventoryOpen = false;
        Go("/inventory");
    }

    private void GoInventoryCategory(string slug)
    {
        InventoryOpen = false;
        Go($"/inventory/category/{slug}");
    }

    private void Go(string href)
    {
        if (!IsActive(href))
            Nav.NavigateTo(href);
    }

    private string ActiveClass(string href) => IsActive(href) ? "active nav-btn-disabled" : string.Empty;

    private bool IsActive(string href)
    {
        var current = "/" + Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');
        if (current == "/") current = "/home";
        return string.Equals(current, href, StringComparison.OrdinalIgnoreCase);
    }

    private string CurrentTitle
    {
        get
        {
            var path = "/" + Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');
            if (path == "/") path = "/home";
            return path switch
            {
                "/home" => "DASHBOARD",
                "/evacuees" => "EVACUEES",
                "/disasters" => "DISASTERS",
                "/inventory" => "INVENTORY",
                var p when p.StartsWith("/inventory/category/") => "INVENTORY - " + Uri.UnescapeDataString(p.Split('/').Last()).Replace('-', ' ').ToUpperInvariant(),
                "/reports" => "REPORTS",
                "/audit-logs" => "AUDIT LOGS",
                _ => path.Trim('/').Replace('-', ' ').ToUpperInvariant()
            };
        }
    }
}
