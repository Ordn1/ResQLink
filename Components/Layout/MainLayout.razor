@inherits LayoutComponentBase
@inject NavigationManager Nav

<div class="app-shell" @onclick="CloseTransientMenus">
    <aside class="shell-sidebar">
        <div class="sidebar-brand">
            <img src="images/ResQLinkLogoFull.png" alt="ResQLink" class="brand-logo" />
        </div>

        <nav class="nav-stack">

            <!-- Header Label -->
            <div class="nav-header-label">Menu</div>

            <button class='nav-btn @ActiveClass("/home")' @onclick='() => Go("/home")'>
                <i class="bi bi-grid-fill nav-icon"></i>
                <span class="nav-text">Dashboard</span>
            </button>

            <button class='nav-btn @ActiveClass("/evacuees")' @onclick='() => Go("/evacuees")'>
                <i class="bi bi-people-fill nav-icon"></i>
                <span class="nav-text">Evacuees</span>
            </button>

            <button class='nav-btn @ActiveClass("/shelters")' @onclick='() => Go("/shelters")'>
                <i class="bi bi-house-heart-fill nav-icon"></i>
                <span class="nav-text">Shelters</span>
            </button>

            <button class='nav-btn @ActiveClass("/disasters")' @onclick='() => Go("/disasters")'>
                <i class="bi bi-exclamation-triangle-fill nav-icon"></i>
                <span class="nav-text">Disasters</span>
            </button>

            <!-- Inventory Dropdown -->
            <div class="nav-item-with-menu">

                <!-- Parent button -->
                <button class='nav-btn @(IsInventoryActive ? "active" : "")'
                        @onclick="ToggleInventoryMenu" @onclick:stopPropagation="true">
                    <i class="bi bi-box-seam-fill nav-icon"></i>
                    <span class="nav-text">
                        Inventory
                        <i class="bi @(InventoryOpen ? "bi-chevron-up" : "bi-chevron-down")" style="font-size: 0.7rem;"></i>
                    </span>
                </button>

                @if (InventoryOpen)
                {
                    <div class="inventory-dropdown" @onclick:stopPropagation="true">

                        <!-- Inventory Overview -->
                        <button class="dropdown-link @(IsActive("/inventory") ? "active-link" : "")"
                                @onclick="() => GoInventory()">Overview</button>

                        <!-- Dynamic Categories -->
                        @foreach (var c in InventoryCategories)
                        {
                            var slugPath = $"/inventory/category/{c.Slug}";
                            <button class="dropdown-link @(IsActive(slugPath) ? "active-link" : "")"
                                    @onclick="() => GoInventoryCategory(c.Slug)">
                                @c.Label
                            </button>
                        }

                        <!-- Manage Categories -->
                        <button class="dropdown-link @(IsActive("/categories") ? "active-link" : "")"
                                @onclick="() => GoCategories()">
                            + Manage Categories
                        </button>

                    </div>
                }
            </div>

            <!-- Stocks -->
            <button class='nav-btn @ActiveClass("/stocks")' @onclick='() => Go("/stocks")'>
                <i class="bi bi-graph-up-arrow nav-icon"></i>
                <span class="nav-text">Stocks</span>
            </button>

            <!-- Suppliers -->
            <button class='nav-btn @ActiveClass("/suppliers")' @onclick='() => Go("/suppliers")'>
                <i class="bi bi-truck nav-icon"></i>
                <span class="nav-text">Suppliers</span>
            </button>

            <!-- ADMIN LABEL -->
            <div class="nav-header-label">Admin</div>

            <button class='nav-btn @ActiveClass("/reports")' @onclick='() => Go("/reports")'>
                <i class="bi bi-file-text-fill nav-icon"></i>
                <span class="nav-text">Reports</span>
            </button>

            <button class='nav-btn @ActiveClass("/audit-logs")' @onclick='() => Go("/audit-logs")'>
                <i class="bi bi-clock-history nav-icon"></i>
                <span class="nav-text">Audit Logs</span>
            </button>

            <button class='nav-btn @ActiveClass("/users")' @onclick='() => Go("/users")'>
                <i class="bi bi-person-badge-fill nav-icon"></i>
                <span class="nav-text">Manage Users</span>
            </button>
        </nav>
    </aside>

    <section class="shell-body">

        <header class="shell-header">

            <!-- Mobile Menu Button -->
            <div class="header-left-mobile">
                <button class="menu-icon">
                    <i class="bi bi-list"></i>
                </button>
            </div>

            <div class="header-icons">
                <button class="icon-btn">
                    <i class="bi bi-bell"></i>
                </button>

                <div class="user-profile-preview">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=07562c&color=fff"
                         class="user-avatar" />
                    <div class="user-name-drop">Admin</div>
                    <i class="bi bi-chevron-down" style="font-size: 0.7rem; color: #94a3b8;"></i>
                </div>
            </div>
        </header>

        <main class="shell-content">

            <div class="page-title-bar">
                <h1 class="page-title">@CurrentTitle</h1>
            </div>

            @Body

            <footer class="shell-footer">© 2024 ResQLink System</footer>
        </main>
    </section>
</div>

@code {
    private bool InventoryOpen;

    private readonly (string Label, string Slug)[] InventoryCategories = new[]
    {
        ("Perishable", "perishable"),
        ("Non-perishable", "non-perishable"),
        ("Medical", "medical"),
    };

    // Ensure Inventory auto-opens when route is inventory-related
    protected override void OnParametersSet()
    {
        InventoryOpen = IsInventoryActive;
    }

    private void ToggleInventoryMenu()
    {
        InventoryOpen = !InventoryOpen;
    }

    private void CloseTransientMenus() => InventoryOpen = false;

    private void GoInventory() => Go("/inventory");
    private void GoInventoryCategory(string slug) => Go($"/inventory/category/{slug}");
    private void GoCategories() => Go("/categories");

    private void Go(string href)
    {
        if (!IsActive(href))
            Nav.NavigateTo(href);
    }

    // Top-level buttons (Dashboard, Evacuees, etc.)
    private string ActiveClass(string href)
{
    var current = "/" + Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');
    if (current == "/") current = "/home";

    // Exact match
    if (string.Equals(current, href, StringComparison.OrdinalIgnoreCase))
        return "active";

    // Nested routes (e.g. /evacuees/view/1)
    if (current.StartsWith(href + "/", StringComparison.OrdinalIgnoreCase))
        return "active";

    return "";
}

    // For inventory submenu and other nested links
    private bool IsActive(string href)
    {
        var current = "/" + Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');
        if (current == "/") current = "/home";

        return string.Equals(current, href, StringComparison.OrdinalIgnoreCase)
            || current.StartsWith(href + "/", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsInventoryActive
    {
        get
        {
            var path = "/" + Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');
            if (path == "/") path = "/home";

            return path.StartsWith("/inventory", StringComparison.OrdinalIgnoreCase)
                || path.StartsWith("/categories", StringComparison.OrdinalIgnoreCase);
        }
    }

    private string CurrentTitle
    {
        get
        {
            var path = "/" + Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');
            if (path == "/") path = "/home";

            return path switch
            {
                "/home" => "Dashboard",
                "/evacuees" => "Evacuees",
                "/shelters" => "Shelters",
                "/disasters" => "Disasters",
                "/inventory" => "Inventory",
                var p when p.StartsWith("/inventory/category/") =>
                    "Inventory - " + Uri.UnescapeDataString(p.Split('/').Last()).Replace('-', ' ').ToUpperInvariant(),
                "/categories" => "Categories",
                "/stocks" => "Stocks",
                "/suppliers" => "Suppliers",
                "/reports" => "Reports",
                "/audit-logs" => "Audit Logs",
                "/users" => "Manage Users",
                _ => path.Trim('/').Replace('-', ' ')
            };
        }
    }
}
