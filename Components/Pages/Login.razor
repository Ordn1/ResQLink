@page "/"
@layout ResQLink.Components.Layout.LoginLayout
@namespace ResQLink.Components.Pages
@using ResQLink.Components
@using ResQLink.Services
@inject NavigationManager Navigation
@inject ResQLink.Services.AuthState Auth
@inject ResQLink.Services.Users.IUserService Users
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using System.Security.Cryptography
@using System.Text
@inject AuditService AuditService

<div class="login-root">
    <div class="login-card" aria-label="Login">
        <!-- Logo (blank placeholder) -->
        <div class="login-logo" aria-hidden="true"></div>

        <div class="login-title">WELCOME</div>

        <div class="login-field-group">
            <label class="login-label" for="username">Username:</label>
            <input id="username" @bind="Username" class="login-input" @onkeypress="HandleKeyPress" />

            <label class="login-label" for="password" style="margin-top:12px;">Password:</label>
            <div class="password-input-wrapper">
                <input id="password" type="@(ShowPassword ? "text" : "password")" @bind="Password" class="login-input" @onkeypress="HandleKeyPress" />
                <button type="button"
                        class="toggle-password-btn"
                        title="@(ShowPassword ? "Hide password" : "Show password")"
                        @onclick="ToggleShowPassword">
                    <i class="bi @(ShowPassword ? "bi-eye-slash" : "bi-eye")"></i>
                </button>
            </div>
        </div>

        <div class="login-actions">
            <button type="button" class="login-btn" @onclick="HandleLogin">LOGIN</button>
            <button type="button" class="login-btn volunteer-btn" @onclick="HandleVolunteerLogin">SIGN IN AS VOLUNTEER</button>
            <a href="/register" class="forgot-link">Register new account</a>
            <a href="#" class="forgot-link" @onclick="ShowResetPasswordDialog">Forgot password?</a>
            @if (!string.IsNullOrEmpty(LoginError))
            {
                <div style="color:#ffdddd;font-size:.75rem;margin-top:6px;">@LoginError</div>
            }
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div style="color:#90ee90;font-size:.75rem;margin-top:6px;">@SuccessMessage</div>
            }
        </div>
    </div>

    <!-- Password Reset Modal -->
    @if (ShowResetDialog)
    {
        <div class="modal-overlay" @onclick="CloseResetDialog">
            <div class="modal-content" @onclick:stopPropagation>
                <h3 style="margin-bottom:16px;color:#333;">Reset Password</h3>
                
                <label class="login-label" for="reset-username">Username:</label>
                <input id="reset-username" @bind="ResetUsername" class="login-input" style="margin-bottom:12px;" />
                
                <label class="login-label" for="new-password">New Password:</label>
                <input id="new-password" type="password" @bind="NewPassword" class="login-input" style="margin-bottom:12px;" />
                
                <label class="login-label" for="confirm-password">Confirm Password:</label>
                <input id="confirm-password" type="password" @bind="ConfirmPassword" class="login-input" style="margin-bottom:16px;" />
                
                @if (!string.IsNullOrEmpty(ResetError))
                {
                    <div style="color:#ff6b6b;font-size:.85rem;margin-bottom:12px;">@ResetError</div>
                }
                
                <div style="display:flex;gap:8px;">
                    <button type="button" class="login-btn" @onclick="HandlePasswordReset">Reset Password</button>
                    <button type="button" class="login-btn volunteer-btn" @onclick="CloseResetDialog">Cancel</button>
                </div>
            </div>
        </div>
    }

    <div class="login-frame">
        <h1 class="resqlink-header">
            <span class="resq">ResQ</span><span class="link">Link</span>
        </h1>
        <div class="underline"></div>
        <p class="login-subtext">Connecting responders.</p>
        <p class="login-subtext">Saving lives.</p>
        <div class="frame-visual"></div>
    </div>
</div>

@code {
    private string Username { get; set; } = "";
    private string Password { get; set; } = "";
    private string LoginError { get; set; } = "";
    private string SuccessMessage { get; set; } = "";
    private bool ShowPassword { get; set; } = false;
    
    // Password Reset Dialog
    private bool ShowResetDialog { get; set; } = false;
    private string ResetUsername { get; set; } = "";
    private string NewPassword { get; set; } = "";
    private string ConfirmPassword { get; set; } = "";
    private string ResetError { get; set; } = "";

    private void ToggleShowPassword() => ShowPassword = !ShowPassword;

    private void ShowResetPasswordDialog(MouseEventArgs e)
    {
        ShowResetDialog = true;
        ResetUsername = Username; // Pre-fill with current username
        NewPassword = "";
        ConfirmPassword = "";
        ResetError = "";
    }

    private void CloseResetDialog()
    {
        ShowResetDialog = false;
        ResetUsername = "";
        NewPassword = "";
        ConfirmPassword = "";
        ResetError = "";
    }

    private async Task HandlePasswordReset()
    {
        ResetError = "";
        SuccessMessage = "";
        
        if (string.IsNullOrWhiteSpace(ResetUsername))
        {
            ResetError = "Please enter your username.";
            return;
        }
        
        if (string.IsNullOrWhiteSpace(NewPassword))
        {
            ResetError = "Please enter a new password.";
            return;
        }
        
        if (NewPassword != ConfirmPassword)
        {
            ResetError = "Passwords do not match.";
            return;
        }
        
        if (NewPassword.Length < 6)
        {
            ResetError = "Password must be at least 6 characters long.";
            return;
        }
        
        var (success, message) = await Users.ResetPasswordByUsernameAsync(ResetUsername, NewPassword);
        
        if (success)
        {
            SuccessMessage = message;
            CloseResetDialog();
            Username = ResetUsername;
            Password = "";
        }
        else
        {
            ResetError = message;
        }
    }

    private async Task HandleLogin()
    {
        LoginError = "";
        SuccessMessage = "";
        
        // Do not clear Password or ShowPassword to preserve state on validation errors
        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
        {
            LoginError = "Enter username and password.";
            return;
        }

        var user = await Users.AuthenticateAsync(Username, Password);
        if (user is null)
        {
            // Check if account is locked by trying to fetch user
            var lockedUser = await Db.Users.AsNoTracking()
                .FirstOrDefaultAsync(u => u.Username == Username && u.IsActive);
            
            if (lockedUser != null && lockedUser.LockoutEnd != null && lockedUser.LockoutEnd > DateTime.UtcNow)
            {
                var remainingMinutes = Math.Ceiling((lockedUser.LockoutEnd.Value - DateTime.UtcNow).TotalMinutes);
                LoginError = $"Account locked due to multiple failed attempts. Try again in {remainingMinutes} minute(s) or reset your password.";
            }
            else if (lockedUser != null && lockedUser.FailedLoginAttempts >= 2)
            {
                LoginError = $"Invalid credentials. Warning: {3 - lockedUser.FailedLoginAttempts} attempt(s) remaining before account lockout.";
            }
            else
            {
                LoginError = "Invalid credentials.";
            }
            return;
        }

        // Set authenticated with user info and role
        Auth.SetAuthenticated(true, user);
        await Task.Yield();

        // Log the login action
        await AuditService.LogAsync(
            action: "Login",
            entityType: "User",
            entityId: user.UserId,
            userId: user.UserId,
            userType: user.Role?.RoleName,
            userName: $"{user.Username} ({user.Email})",
            description: $"User {user.Username} logged in successfully"
        );

        // Redirect based on role
        var redirectPath = Auth.IsInventoryManager() ? "/inventory" 
                         : Auth.IsFinanceManager() ? "/inventory" 
                         : "/home";
        Navigation.NavigateTo(redirectPath);
    }

    private async Task HandleVolunteerLogin()
    {
        LoginError = "";
        SuccessMessage = "";
        
        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
        {
            LoginError = "Enter first name and password.";
            return;
        }

        // Authenticate volunteer using first name (case-insensitive) and password
        var volunteer = await Db.Volunteers
            .FirstOrDefaultAsync(v => v.FirstName.ToLower() == Username.ToLower() && v.Status == "Active");

        if (volunteer is null)
        {
            LoginError = "Invalid credentials or account not active.";
            return;
        }

        // Check if volunteer account is locked
        if (volunteer.LockoutEnd != null && volunteer.LockoutEnd > DateTime.UtcNow)
        {
            var remainingMinutes = Math.Ceiling((volunteer.LockoutEnd.Value - DateTime.UtcNow).TotalMinutes);
            LoginError = $"Account locked due to multiple failed attempts. Try again in {remainingMinutes} minute(s) or contact administrator.";
            return;
        }

        // Verify password
        var passwordHash = HashPassword(Password);
        if (volunteer.PasswordHash != passwordHash)
        {
            // Record failed login attempt
            volunteer.FailedLoginAttempts++;
            
            if (volunteer.FailedLoginAttempts >= 3)
            {
                volunteer.LockoutEnd = DateTime.UtcNow.AddMinutes(5);
                volunteer.RequiresPasswordReset = true;
                Db.Volunteers.Update(volunteer);
                await Db.SaveChangesAsync();
                
                LoginError = "Account locked due to multiple failed attempts. Please contact administrator to reset your password.";
            }
            else
            {
                Db.Volunteers.Update(volunteer);
                await Db.SaveChangesAsync();
                
                LoginError = $"Invalid credentials. Warning: {3 - volunteer.FailedLoginAttempts} attempt(s) remaining before account lockout.";
            }
            return;
        }

        // Successful login - reset failed attempts
        if (volunteer.FailedLoginAttempts > 0 || volunteer.LockoutEnd != null)
        {
            volunteer.FailedLoginAttempts = 0;
            volunteer.LockoutEnd = null;
            Db.Volunteers.Update(volunteer);
            await Db.SaveChangesAsync();
        }

        // Create a temporary User object for the volunteer to work with AuthState
        // Using FirstName as the username
        var volunteerUser = new ResQLink.Data.Entities.User
        {
            UserId = volunteer.VolunteerId,
            Username = volunteer.FirstName,
            Email = volunteer.Email,
            RoleId = 0, // Volunteer role (you may need to create this role in database)
            Role = new ResQLink.Data.Entities.UserRole { RoleId = 0, RoleName = "Volunteer" },
            IsActive = true
        };

        // Set authenticated
        Auth.SetAuthenticated(true, volunteerUser);
        await Task.Yield();

        // Redirect to volunteer dashboard
        Navigation.NavigateTo("/volunteer-dashboard");
    }

    private string HashPassword(string password)
    {
        using var sha256 = SHA256.Create();
        var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
        return Convert.ToBase64String(hashedBytes);
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleLogin();
        }
    }
}