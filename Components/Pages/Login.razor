@page "/"
@layout ResQLink.Components.Layout.LoginLayout
@namespace ResQLink.Components.Pages
@using ResQLink.Components
@using ResQLink.Services
@inject NavigationManager Navigation
@inject ResQLink.Services.AuthState Auth
@inject ResQLink.Services.Users.IUserService Users
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using System.Security.Cryptography
@using System.Text
@inject AuditService AuditService

<div class="login-root">
    <div class="login-card" aria-label="Login">
        <!-- Logo (blank placeholder) -->
        <div class="login-logo" aria-hidden="true"></div>

        <div class="login-title">WELCOME</div>

        <div class="login-field-group">
            <label class="login-label" for="username">Username:</label>
            <input id="username" @bind="Username" class="login-input" @onkeypress="HandleKeyPress" />

            <label class="login-label" for="password" style="margin-top:12px;">Password:</label>
            <input id="password" type="password" @bind="Password" class="login-input" @onkeypress="HandleKeyPress" />
        </div>

        <div class="login-actions">
            <button type="button" class="login-btn" @onclick="HandleLogin">LOGIN</button>
            <button type="button" class="login-btn volunteer-btn" @onclick="HandleVolunteerLogin">SIGN IN AS VOLUNTEER</button>
            <a href="/register" class="forgot-link">Register new account</a>
            <a href="#" class="forgot-link" @onclick="PreventDefault">Forgot password?</a>
            @if (!string.IsNullOrEmpty(LoginError))
            {
                <div style="color:#ffdddd;font-size:.75rem;margin-top:6px;">@LoginError</div>
            }
        </div>
    </div>

    <div class="login-frame">
        <h1 class="resqlink-header">
            <span class="resq">ResQ</span><span class="link">Link</span>
        </h1>
        <div class="underline"></div>
        <p class="login-subtext">Connecting responders.</p>
        <p class="login-subtext">Saving lives.</p>
        <div class="frame-visual"></div>
    </div>
</div>

@code {
    private string Username { get; set; } = "";
    private string Password { get; set; } = "";
    private string LoginError { get; set; } = "";

    private async Task HandleLogin()
    {
        LoginError = "";
        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
        {
            LoginError = "Enter username and password.";
            return;
        }

        var user = await Users.AuthenticateAsync(Username, Password);
        if (user is null)
        {
            LoginError = "Invalid credentials.";
            return;
        }

        // Set authenticated with user info and role
        Auth.SetAuthenticated(true, user);
        await Task.Yield();

        // Log the login action
        await AuditService.LogAsync(
            action: "Login",
            entityType: "User",
            entityId: user.UserId,
            userId: user.UserId,
            userType: user.Role?.RoleName,
            userName: $"{user.Username} ({user.Email})",
            description: $"User {user.Username} logged in successfully"
        );

        // Redirect based on role
        var redirectPath = Auth.IsInventoryManager() ? "/inventory" 
                         : Auth.IsFinanceManager() ? "/inventory" 
                         : "/home";
        Navigation.NavigateTo(redirectPath);
    }

    private async Task HandleVolunteerLogin()
    {
        LoginError = "";
        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
        {
            LoginError = "Enter first name and password.";
            return;
        }

        // Authenticate volunteer using first name (case-insensitive) and password
        var volunteer = await Db.Volunteers
            .AsNoTracking()
            .FirstOrDefaultAsync(v => v.FirstName.ToLower() == Username.ToLower() && v.Status == "Active");

        if (volunteer is null)
        {
            LoginError = "Invalid credentials or account not active.";
            return;
        }

        // Verify password
        var passwordHash = HashPassword(Password);
        if (volunteer.PasswordHash != passwordHash)
        {
            LoginError = "Invalid credentials.";
            return;
        }

        // Create a temporary User object for the volunteer to work with AuthState
        // Using FirstName as the username
        var volunteerUser = new ResQLink.Data.Entities.User
        {
            UserId = volunteer.VolunteerId,
            Username = volunteer.FirstName,
            Email = volunteer.Email,
            RoleId = 0, // Volunteer role (you may need to create this role in database)
            Role = new ResQLink.Data.Entities.UserRole { RoleId = 0, RoleName = "Volunteer" },
            IsActive = true
        };

        // Set authenticated
        Auth.SetAuthenticated(true, volunteerUser);
        await Task.Yield();

        // Redirect to volunteer dashboard
        Navigation.NavigateTo("/volunteer-dashboard");
    }

    private string HashPassword(string password)
    {
        using var sha256 = SHA256.Create();
        var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
        return Convert.ToBase64String(hashedBytes);
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleLogin();
        }
    }

    private void PreventDefault(MouseEventArgs e) { }
}