@page "/settings"
@using ResQLink.Components.Shared
@inject ResQLink.Services.Sync.SyncSettings SyncConfig
@inject ResQLink.Services.Sync.ISyncSettingsStorage Storage
@inject ResQLink.Services.Sync.ISyncService Sync
@inject IJSRuntime JS
@inject ResQLink.Services.AuthState Auth
@inject NavigationManager Navigation
@implements IDisposable

@if (!Auth.IsAuthenticated)
{
    <div class="access-denied">
        <i class="bi bi-shield-x" style="font-size: 4rem; color: #dc3545;"></i>
        <h2>Access Denied</h2>
        <p>Please log in to access settings.</p>
        <button class="btn-primary" @onclick="NavigateToLogin">
            <i class="bi bi-box-arrow-in-right"></i> Go to Login
        </button>
    </div>
    return;
}

<div class="settings-root">
    <div class="settings-section-header">
        <i class="bi bi-gear-fill"></i>
        <h3>Synchronization Settings</h3>
    </div>

    <div class="panel @(busy ? "loading-pulse" : "")">
        <header class="panel-head">
            <h3 class="panel-title">Remote Database</h3>
            @if (busy)
            {
                <span class="loading-text" style="padding: 0; margin: 0;">
                    <span class="spinner"></span>
                    <span>Processing...</span>
                </span>
            }
        </header>
        <div class="panel-body">
            <div class="form-row">
                <div class="form-group">
                    <ToggleSwitch @bind-Value="remoteEnabled" 
                                  Label="Enable remote sync" 
                                  Disabled="@DisableConfig" />
                    <span class="help-text">Enable synchronization with remote database server</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="interval">Auto-sync interval</label>
                    <select id="interval" class="form-control" @bind="interval" disabled="@DisableConfig">
                        <option value="0">Off</option>
                        <option value="5">Every 5 minutes</option>
                        <option value="10">Every 10 minutes</option>
                        <option value="15">Every 15 minutes</option>
                    </select>
                    <span class="help-text">Set automatic synchronization frequency</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="button-group">
                        <button class="btn-primary" @onclick="SaveAsync" disabled="@DisableConfig">
                            @if (isSaving)
                            {
                                <span class="spinner"></span>
                            }
                            <span>Save Settings</span>
                        </button>
                        <button class="mini-btn" @onclick="CheckOnlineAsync" disabled="@busy">
                            @if (isCheckingOnline)
                            {
                                <span class="spinner"></span>
                            }
                            <i class="bi bi-wifi"></i>
                            <span>Check Online</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <div class="info-label">Connection Status</div>
                <div class="info-value">
                    @if (isCheckingOnline)
                    {
                        <span class="status-indicator checking">
                            <span class="spinner"></span>
                            Checking...
                        </span>
                    }
                    else if (!remoteEnabled)
                    {
                        <span class="status-indicator disabled">
                            <i class="bi bi-dash-circle"></i>
                            Disabled
                        </span>
                    }
                    else if (online is true)
                    {
                        <span class="status-indicator online">
                            <i class="bi bi-check-circle-fill"></i>
                            Online
                        </span>
                    }
                    else if (online is false)
                    {
                        <span class="status-indicator offline">
                            <i class="bi bi-x-circle-fill"></i>
                            Offline
                        </span>
                    }
                    else
                    {
                        <span class="status-indicator unknown">
                            <i class="bi bi-question-circle"></i>
                            Unknown
                        </span>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="panel @(busy ? "loading-pulse" : "")">
        <header class="panel-head">
            <h3 class="panel-title">Manual Sync</h3>
        </header>
        <div class="panel-body">
            <div class="form-row">
                <div class="form-group">
                    <div class="button-group">
                        <button class="btn-primary" @onclick="SyncNowAsync" disabled="@(busy || !remoteEnabled)">
                            @if (isSyncing)
                            {
                                <span class="spinner"></span>
                            }
                            <i class="bi bi-arrow-repeat"></i>
                            <span>Sync Now</span>
                        </button>
                        <button class="mini-btn" @onclick="PullAsync" disabled="@(busy || !remoteEnabled)">
                            @if (isPulling)
                            {
                                <span class="spinner"></span>
                            }
                            <i class="bi bi-download"></i>
                            <span>Pull</span>
                        </button>
                        <button class="mini-btn" @onclick="PushAsync" disabled="@(busy || !remoteEnabled)">
                            @if (isPushing)
                            {
                                <span class="spinner"></span>
                            }
                            <i class="bi bi-upload"></i>
                            <span>Push</span>
                        </button>
                    </div>
                    <span class="help-text">Manually trigger data synchronization operations</span>
                </div>
            </div>

            @if (busy && !string.IsNullOrWhiteSpace(operationStatus))
            {
                <div class="progress-indicator">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%"></div>
                    </div>
                    <span class="operation-status-text">@operationStatus</span>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(message))
            {
                <div class="message-box @GetMessageType()" style="position: relative;">
                    <i class="bi @GetMessageIcon()"></i>
                    <span>@message</span>
                    @if (!string.IsNullOrWhiteSpace(message))
                    {
                        <button class="message-dismiss" @onclick="ClearMessage" title="Dismiss">
                            <i class="bi bi-x"></i>
                        </button>
                    }
                </div>
            }
        </div>

        @if (!remoteEnabled)
        {
            <div class="panel-foot">
                <span><i class="bi bi-info-circle"></i> Enable remote sync to use manual sync operations</span>
            </div>
        }
    </div>
</div>

<style>
    .message-dismiss {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        color: currentColor;
        opacity: 0.6;
        transition: opacity 0.2s ease;
        font-size: 1.2rem;
        line-height: 1;
    }

    .message-dismiss:hover {
        opacity: 1;
    }

    .message-box {
        padding-right: 40px;
    }
</style>

@code {
    private bool remoteEnabled;
    private int interval;
    private bool? online;
    private bool busy;
    private bool isSaving;
    private bool isCheckingOnline;
    private bool isSyncing;
    private bool isPulling;
    private bool isPushing;
    private string message = string.Empty;
    private string operationStatus = string.Empty;
    private CancellationTokenSource? _messageTimeoutCts;

    private bool DisableConfig => !Auth.IsAdmin();

    protected override async Task OnInitializedAsync()
    {
        if (!Auth.IsAuthenticated)
        {
            await JS.InvokeVoidAsync("alert", "Access denied. Please log in.");
            return;
        }

        Storage.LoadInto(SyncConfig);
        remoteEnabled = SyncConfig.RemoteEnabled;
        interval = SyncConfig.IntervalMinutes;
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/", true);
    }

    private async Task SaveAsync()
    {
        if (DisableConfig) return;
        busy = true;
        isSaving = true;
        message = string.Empty;
        operationStatus = "Saving settings...";
        StateHasChanged();

        try
        {
            await Task.Delay(300);

            SyncConfig.RemoteEnabled = remoteEnabled;
            SyncConfig.IntervalMinutes = interval;
            Storage.Save(SyncConfig);

            if (remoteEnabled && interval > 0)
            {
                Sync.StartAutoSync(TimeSpan.FromMinutes(interval));
            }
            else
            {
                Sync.StopAutoSync();
            }

            message = "Settings saved successfully!";
            await StartMessageTimeoutAsync();
        }
        catch (Exception ex)
        {
            message = "Save failed: " + ex.Message;
        }
        finally
        {
            busy = false;
            isSaving = false;
            operationStatus = string.Empty;
            StateHasChanged();
        }
    }

    private async Task CheckOnlineAsync()
    {
        busy = true;
        isCheckingOnline = true;
        message = string.Empty;
        operationStatus = "Checking connection...";
        StateHasChanged();

        try
        {
            online = await Sync.CheckOnlineAsync();
            message = online == true ? "Connection successful!" : "Cannot reach remote server";
            
            if (online == true)
            {
                await StartMessageTimeoutAsync();
            }
        }
        catch (Exception ex)
        {
            online = false;
            message = "Connection check failed: " + ex.Message;
        }
        finally
        {
            busy = false;
            isCheckingOnline = false;
            operationStatus = string.Empty;
            StateHasChanged();
        }
    }

    private async Task PullAsync()
    {
        busy = true;
        isPulling = true;
        message = string.Empty;
        operationStatus = "Pulling data from remote...";
        StateHasChanged();

        try
        {
            var res = await Sync.PullAsync();
            message = res.ok ? "Pull completed successfully!" : $"Pull failed: {res.error}";
            
            if (res.ok)
            {
                await StartMessageTimeoutAsync();
            }
        }
        catch (Exception ex)
        {
            message = "Pull operation failed: " + ex.Message;
        }
        finally
        {
            busy = false;
            isPulling = false;
            operationStatus = string.Empty;
            StateHasChanged();
        }
    }

    private async Task PushAsync()
    {
        busy = true;
        isPushing = true;
        message = string.Empty;
        operationStatus = "Pushing data to remote...";
        StateHasChanged();

        try
        {
            var res = await Sync.PushAsync();
            message = res.ok ? "Push completed successfully!" : $"Push failed: {res.error}";
            
            if (res.ok)
            {
                await StartMessageTimeoutAsync();
            }
        }
        catch (Exception ex)
        {
            message = "Push operation failed: " + ex.Message;
        }
        finally
        {
            busy = false;
            isPushing = false;
            operationStatus = string.Empty;
            StateHasChanged();
        }
    }

    private async Task SyncNowAsync()
    {
        busy = true;
        isSyncing = true;
        message = string.Empty;
        operationStatus = "Synchronizing data...";
        StateHasChanged();

        try
        {
            var res = await Sync.SyncNowAsync();
            message = res.ok ? "Sync completed successfully!" : $"Sync failed: {res.error}";
            
            if (res.ok)
            {
                await StartMessageTimeoutAsync();
            }
        }
        catch (Exception ex)
        {
            message = "Sync operation failed: " + ex.Message;
        }
        finally
        {
            busy = false;
            isSyncing = false;
            operationStatus = string.Empty;
            StateHasChanged();
        }
    }

    private async Task StartMessageTimeoutAsync()
    {
        // Cancel any existing timeout
        _messageTimeoutCts?.Cancel();
        _messageTimeoutCts?.Dispose();
        
        // Create new cancellation token
        _messageTimeoutCts = new CancellationTokenSource();
        
        try
        {
            // Wait for 5 seconds
            await Task.Delay(5000, _messageTimeoutCts.Token);
            
            // Clear message after timeout
            message = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
        catch (TaskCanceledException)
        {
            // Timeout was cancelled, ignore
        }
    }

    private void ClearMessage()
    {
        _messageTimeoutCts?.Cancel();
        message = string.Empty;
    }

    private string GetMessageType()
    {
        if (message.Contains("success", StringComparison.OrdinalIgnoreCase) ||
            message.Contains("completed", StringComparison.OrdinalIgnoreCase))
            return "success";
        
        if (message.Contains("failed", StringComparison.OrdinalIgnoreCase) ||
            message.Contains("error", StringComparison.OrdinalIgnoreCase))
            return "error";
        
        if (message.Contains("cannot", StringComparison.OrdinalIgnoreCase))
            return "warning";
        
        return "info";
    }

    private string GetMessageIcon()
    {
        var type = GetMessageType();
        return type switch
        {
            "success" => "bi-check-circle-fill",
            "error" => "bi-x-circle-fill",
            "warning" => "bi-exclamation-triangle-fill",
            _ => "bi-info-circle-fill"
        };
    }

    public void Dispose()
    {
        _messageTimeoutCts?.Cancel();
        _messageTimeoutCts?.Dispose();
    }
}
