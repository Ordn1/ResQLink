@page "/home"
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities

<div class="dashboard-root">
    <!-- Summary Banner -->
    <div class="summary-banner">
        <div class="summary-header">
            <div class="summary-icon">
                <i class="bi bi-speedometer2"></i>
            </div>
            <div class="summary-content">
                <h2 class="summary-title">ResQLink Dashboard</h2>
                <p class="summary-subtitle">
                    Real-time disaster response coordination • Last updated: @DateTime.Now.ToString("MMM dd, yyyy HH:mm")
                </p>
            </div>
        </div>
        
        <div class="summary-stats">
            <div class="stat-group">
                <span class="stat-label">Active Operations</span>
                <span class="stat-value">@ActiveDisastersCount disasters</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-group">
                <span class="stat-label">People Assisted</span>
                <span class="stat-value">@TotalEvacuees evacuees</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-group">
                <span class="stat-label">Resources</span>
                <span class="stat-value">@(LowStockCount > 0 ? $"{LowStockCount} items need restocking" : "Inventory levels healthy")</span>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">

        <!-- KPI Section -->
        <section class="kpi-section">
            
            <!-- Active Disasters -->
            <div class="kpi-card priority-high">
                <div class="kpi-header">
                    <div class="kpi-label">Active Disasters</div>
                    <div class="kpi-icon-circle" style="background: #fee2e2; color: #ef4444;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value" style="color: #ef4444;">@ActiveDisastersCount</div>
                    <div class="kpi-footer">
                        <span class="trend-badge @GetTrendClass(_activeToday, _activeYesterday)">
                            @ActiveDisasterDeltaText
                        </span>
                        <span class="kpi-detail">vs yesterday</span>
                    </div>
                </div>
            </div>

            <!-- Evacuees -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Total Evacuees</div>
                    <div class="kpi-icon-circle">
                        <i class="bi bi-people-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value">@TotalEvacuees</div>
                    <div class="kpi-footer">
                        <span class="trend-badge @GetTrendClass(_evacueesToday, _evacueesYesterday)">
                            @EvacueeDeltaText
                        </span>
                        <span class="kpi-detail">registered today</span>
                    </div>
                </div>
            </div>

            <!-- Shelter Capacity -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Shelter Capacity</div>
                    <div class="kpi-icon-circle">
                        <i class="bi bi-house-heart-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value">@ShelterCapacityUsed%</div>
                    <div class="kpi-footer">
                        <div class="capacity-detail">
                            <span>@_totalOccupancy / @_totalCapacity beds</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill @GetCapacityClass(ShelterCapacityUsed)" style="width:@ShelterCapacityUsed%"></div>
                    </div>
                </div>
            </div>

            <!-- Low Stock -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Low Stock Alert</div>
                    <div class="kpi-icon-circle" style="background: #ffedd5; color: #d97706;">
                        <i class="bi bi-box-seam-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value" style="color: #d97706;">@LowStockCount</div>
                    <div class="kpi-footer">
                         <span class="trend-badge @GetTrendClass(_lowStockToday, _lowStockYesterday)">
                             @LowStockDeltaText
                         </span>
                         <span class="kpi-detail">items ≤ @LowStockThreshold units</span>
                    </div>
                </div>
            </div>

        </section>

        <!-- Main Content: Left Column -->
        <div class="col-left">
            
            <!-- Recent Evacuees Table -->
            <div class="modern-card">
                <div class="card-header">
                    <div class="card-title-group">
                        <h3 class="card-title">Recent Evacuees</h3>
                        <span class="card-badge">@FilteredEvacuees.Count() of @AllEvacuees.Count</span>
                    </div>
                    <div class="header-actions">
                        <input class="search-input" placeholder="Search name..." @bind="evacueeFilter" @bind:event="oninput" />
                        <button class="refresh-btn" @onclick="Refresh" disabled="@_loading" title="Refresh Data">
                            <i class="bi bi-arrow-clockwise @(_loading ? "spin" : "")"></i>
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="clean-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Disaster</th>
                                <th>Shelter</th>
                                <th>Status</th>
                                <th>Registered</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (FilteredEvacuees.Any())
                            {
                                foreach (var e in FilteredEvacuees)
                                {
                                    <tr>
                                        <td>
                                            <div style="font-weight:600;">@e.Name</div>
                                        </td>
                                        <td>@e.Disaster</td>
                                        <td>@e.Shelter</td>
                                        <td>
                                            <span class="status-chip @StatusClass(e.Status)">@e.Status</span>
                                        </td>
                                        <td style="color: var(--text-muted); font-size: 0.85rem;">
                                            @e.Registered.ToString("MMM dd, HH:mm")
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-inbox" style="font-size: 1.5rem; margin-bottom: 8px; display:block;"></i>
                                        No recent evacuees found.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <i class="bi bi-info-circle"></i> Showing most recent registrations
                </div>
            </div>

            <!-- Active Disasters Table -->
            <div class="modern-card">
                <div class="card-header">
                    <div class="card-title-group">
                        <h3 class="card-title">Active Disasters</h3>
                        <span class="card-badge">@ActiveDisasters.Count() active</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="clean-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Started</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ActiveDisasters.Any())
                            {
                                foreach (var d in ActiveDisasters)
                                {
                                    <tr>
                                        <td style="font-weight: 700;">@d.Title</td>
                                        <td>@d.DisasterType</td>
                                        <td>
                                            <span class="sev-chip sev-@d.Severity.ToLower()">@d.Severity</span>
                                        </td>
                                        <td style="color: var(--text-muted);">@d.StartDate.ToString("MMM dd, yyyy")</td>
                                        <td>@d.Location</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <i class="bi bi-check-circle-fill" style="font-size: 1.5rem; color: #10b981; margin-bottom: 8px; display:block;"></i>
                                        No active disasters reported.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <i class="bi bi-info-circle"></i> Only showing active and open status disasters
                </div>
            </div>

        </div>

        <!-- Side Content: Right Column -->
        <div class="col-right">
            
            <!-- Low Stock Inventory List -->
            <div class="modern-card" style="height: 100%;">
                <div class="card-header alert-header">
                    <div class="card-title-group">
                        <h3 class="card-title" style="color: #9a3412;">
                            <i class="bi bi-exclamation-circle-fill" style="margin-right: 8px;"></i>
                            Low Stock Alert
                        </h3>
                        <span class="card-badge alert-badge">@LowStockItems.Count items</span>
                    </div>
                </div>
                
                <div class="inventory-list">
                    @if (LowStockItems.Any())
                    {
                        foreach (var item in LowStockItems.Take(8))
                        {
                            <div class="inv-item">
                                <div class="inv-info">
                                    <div class="inv-name">@item.Name</div>
                                    <div class="inv-meta">Unit: @item.Unit</div>
                                </div>
                                <div class="inv-stat">
                                    <div class="inv-qty" style="color: #ef4444;">@item.Quantity</div>
                                    <div class="inv-bar-mini">
                                        <div class="inv-fill" style="width:@StockPercent(item.Quantity)%; background: @GetStockColor(item.Quantity)"></div>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        @if (LowStockItems.Count > 8)
                        {
                            <div class="inv-footer">
                                <i class="bi bi-three-dots"></i> +@(LowStockItems.Count - 8) more items need attention
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state" style="padding: 40px 20px;">
                            <i class="bi bi-check-circle-fill" style="font-size: 2.5rem; color: #10b981; margin-bottom: 10px; display:block;"></i>
                            <strong>All Clear!</strong>
                            <p style="margin-top: 8px; color: #64748b;">Inventory levels are healthy.</p>
                        </div>
                    }
                </div>
                <div class="card-footer">
                    <i class="bi bi-info-circle"></i> Threshold: ≤ @LowStockThreshold items
                </div>
            </div>

        </div>
    </div>
</div>

@code {
    // View models
    private record EvacueeRow(string Name, string Disaster, string Shelter, string Status, DateTime Registered);
    private record StockRow(string Name, int Quantity, string Unit);

    // Data collections
    private List<EvacueeRow> AllEvacuees = new();
    private List<Disaster> AllDisasters = new();
    private List<StockRow> LowStockItems = new();

    // Filters / state
    private string evacueeFilter = string.Empty;
    private bool _loading = false;

    // Thresholds
    private const int LowStockThreshold = 10;

    // Metrics
    private int ActiveDisastersCount => ActiveDisasters.Count();
    private int TotalEvacuees => AllEvacuees.Count;
    private int LowStockCount => LowStockItems.Count;
    private int _totalCapacity;
    private int _totalOccupancy;
    
    private int ShelterCapacityUsed
    {
        get
        {
            var shelters = _shelterSnapshot;
            if (shelters.Count == 0) return 0;
            _totalCapacity = shelters.Sum(s => s.Capacity);
            _totalOccupancy = shelters.Sum(s => s.CurrentOccupancy);
            return _totalCapacity > 0 ? (int)Math.Round(_totalOccupancy / (double)_totalCapacity * 100) : 0;
        }
    }

    // Delta texts (today vs yesterday)
    private string EvacueeDeltaText => DeltaLabel(_evacueesToday, _evacueesYesterday, "today");
    private string ActiveDisasterDeltaText => DeltaLabel(_activeToday, _activeYesterday, "today");
    private string LowStockDeltaText => DeltaLabel(_lowStockToday, _lowStockYesterday, "today");

    // Snapshots for delta computation
    private int _evacueesToday;
    private int _evacueesYesterday;
    private int _activeToday;
    private int _activeYesterday;
    private int _lowStockToday;
    private int _lowStockYesterday;
    private List<Shelter> _shelterSnapshot = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;

        var today = DateTime.UtcNow.Date;
        var yesterday = today.AddDays(-1);

        // Evacuees
        var evacueesQuery = Db.Evacuees
            .Include(e => e.Disaster)
            .Include(e => e.Shelter)
            .AsNoTracking();

        var evacuees = await evacueesQuery
            .OrderByDescending(e => e.RegisteredAt)
            .Take(200)
            .ToListAsync();

        AllEvacuees = evacuees.Select(e => new EvacueeRow(
            e.FirstName + " " + e.LastName,
            e.Disaster.Title,
            e.Shelter?.Name ?? "—",
            e.Status,
            e.RegisteredAt
        )).ToList();

        _evacueesToday = evacuees.Count(e => e.RegisteredAt.Date == today);
        _evacueesYesterday = evacuees.Count(e => e.RegisteredAt.Date == yesterday);

        // Disasters
        AllDisasters = await Db.Disasters.AsNoTracking()
            .OrderByDescending(d => d.StartDate)
            .Take(100)
            .ToListAsync();

        _activeToday = AllDisasters.Count(d => IsActiveStatus(d.Status) && d.StartDate.Date <= today);
        _activeYesterday = AllDisasters.Count(d => IsActiveStatus(d.Status) && d.StartDate.Date <= yesterday);

        // Shelters
        _shelterSnapshot = await Db.Shelters.AsNoTracking().ToListAsync();

        // Stocks (low)
        var lowStocks = await Db.Stocks
            .Include(s => s.ReliefGood)
            .AsNoTracking()
            .Where(s => s.Quantity <= LowStockThreshold)
            .OrderBy(s => s.Quantity)
            .Take(50)
            .ToListAsync();

        LowStockItems = lowStocks.Select(s => new StockRow(
            s.ReliefGood.Name,
            s.Quantity,
            s.ReliefGood.Unit
        )).ToList();

        _lowStockToday = lowStocks.Count(s => s.LastUpdated.Date == today);
        _lowStockYesterday = lowStocks.Count(s => s.LastUpdated.Date == yesterday);

        _loading = false;
        StateHasChanged();
    }

    private IEnumerable<EvacueeRow> FilteredEvacuees =>
        AllEvacuees
            .Where(e =>
                string.IsNullOrWhiteSpace(evacueeFilter) ||
                e.Name.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Shelter.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Status.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Disaster.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(e => e.Registered)
            .Take(12);

    private IEnumerable<Disaster> ActiveDisasters =>
        AllDisasters.Where(d => IsActiveStatus(d.Status))
                    .OrderByDescending(d => d.StartDate)
                    .Take(15);

    private static bool IsActiveStatus(string status) =>
        status.Equals("Active", StringComparison.OrdinalIgnoreCase) ||
        status.Equals("Open", StringComparison.OrdinalIgnoreCase);

    private static int StockPercent(int qty)
    {
        var cap = Math.Max(LowStockThreshold * 2, 1);
        return Math.Clamp((int)Math.Round(qty / (double)cap * 100), 0, 100);
    }

    private static string GetStockColor(int qty)
    {
        if (qty == 0) return "#ef4444";
        if (qty <= 5) return "#f97316";
        return "#fb923c";
    }

    private static string GetCapacityClass(int percent)
    {
        if (percent >= 90) return "critical";
        if (percent >= 75) return "warning";
        return "normal";
    }

    private static string GetTrendClass(int today, int yesterday)
    {
        var diff = today - yesterday;
        if (diff > 0) return "trend-up";
        if (diff < 0) return "trend-down";
        return "trend-neutral";
    }

    private static string DeltaLabel(int today, int yesterday, string suffix)
    {
        var diff = today - yesterday;
        if (diff == 0) return "No change";
        var sign = diff > 0 ? "+" : "";
        return $"{sign}{diff} {suffix}";
    }

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "critical" => "st-critical",
        "needs med" => "st-med",
        "admitted" => "st-stable",
        "stable" => "st-stable",
        "released" => "st-contained",
        _ => "st-stable"
    };

    private async void Refresh()
    {
        if (_loading) return;
        await LoadAsync();
    }
}