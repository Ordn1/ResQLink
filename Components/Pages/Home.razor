@page "/home"
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities

<div class="dashboard-root">
    <div class="dashboard-grid">

        <!-- KPI Section -->
        <section class="kpi-section">
            
            <!-- Active Disasters -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Active Disasters</div>
                    <div class="kpi-icon-circle" style="background: #fee2e2; color: #ef4444;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value" style="color: #ef4444;">@ActiveDisastersCount</div>
                    <div class="kpi-footer">
                        <span class="trend-badge">@ActiveDisasterDeltaText</span>
                    </div>
                </div>
            </div>

            <!-- Evacuees -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Total Evacuees</div>
                    <div class="kpi-icon-circle">
                        <i class="bi bi-people-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value">@TotalEvacuees</div>
                    <div class="kpi-footer">
                        <span class="trend-badge">@EvacueeDeltaText</span>
                    </div>
                </div>
            </div>

            <!-- Shelter Capacity -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Shelter Capacity</div>
                    <div class="kpi-icon-circle">
                        <i class="bi bi-house-heart-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value">@ShelterCapacityUsed%</div>
                    <div class="progress-container">
                        <div class="progress-fill" style="width:@ShelterCapacityUsed%"></div>
                    </div>
                </div>
            </div>

            <!-- Low Stock -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-label">Low Stock Items</div>
                    <div class="kpi-icon-circle" style="background: #ffedd5; color: #d97706;">
                        <i class="bi bi-box-seam-fill"></i>
                    </div>
                </div>
                <div>
                    <div class="kpi-value" style="color: #d97706;">@LowStockCount</div>
                    <div class="kpi-footer">
                         <span class="trend-badge">@LowStockDeltaText</span>
                         <span style="font-size: 0.75rem; color: #94a3b8; margin-left: 4px;">(≤ @LowStockThreshold)</span>
                    </div>
                </div>
            </div>

        </section>

        <!-- Main Content: Left Column -->
        <div class="col-left">
            
            <!-- Recent Evacuees Table -->
            <div class="modern-card">
                <div class="card-header">
                    <h3 class="card-title">Recent Evacuees</h3>
                    <div class="header-actions">
                        <input class="search-input" placeholder="Search name..." @bind="evacueeFilter" @bind:event="oninput" />
                        <button class="refresh-btn" @onclick="Refresh" disabled="@_loading" title="Refresh Data">
                            <i class="bi bi-arrow-clockwise @(_loading ? "spin" : "")"></i>
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="clean-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Disaster</th>
                                <th>Shelter</th>
                                <th>Status</th>
                                <th>Registered</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (FilteredEvacuees.Any())
                            {
                                foreach (var e in FilteredEvacuees)
                                {
                                    <tr>
                                        <td>
                                            <div style="font-weight:600;">@e.Name</div>
                                        </td>
                                        <td>@e.Disaster</td>
                                        <td>@e.Shelter</td>
                                        <td>
                                            <span class="status-chip @StatusClass(e.Status)">@e.Status</span>
                                        </td>
                                        <td style="color: var(--text-muted); font-size: 0.85rem;">
                                            @e.Registered.ToString("MMM dd, HH:mm")
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        No recent evacuees found.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    Showing @FilteredEvacuees.Count() of @AllEvacuees.Count total records
                </div>
            </div>

            <!-- Active Disasters Table -->
            <div class="modern-card">
                <div class="card-header">
                    <h3 class="card-title">Active Disasters</h3>
                </div>
                <div class="table-responsive">
                    <table class="clean-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Started</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ActiveDisasters.Any())
                            {
                                foreach (var d in ActiveDisasters)
                                {
                                    <tr>
                                        <td style="font-weight: 700;">@d.Title</td>
                                        <td>@d.DisasterType</td>
                                        <td>
                                            <span class="sev-chip sev-@d.Severity.ToLower()">@d.Severity</span>
                                        </td>
                                        <td style="color: var(--text-muted);">@d.StartDate.ToString("MMM dd, yyyy")</td>
                                        <td>@d.Location</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        No active disasters reported.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- Side Content: Right Column -->
        <div class="col-right">
            
            <!-- Low Stock Inventory List -->
            <div class="modern-card" style="height: 100%;">
                <div class="card-header" style="background-color: #fffaf0;">
                    <h3 class="card-title" style="color: #9a3412;">
                        <i class="bi bi-exclamation-circle-fill" style="margin-right: 8px;"></i>
                        Low Stock Alert
                    </h3>
                </div>
                
                <div class="inventory-list">
                    @if (LowStockItems.Any())
                    {
                        foreach (var item in LowStockItems.Take(8))
                        {
                            <div class="inv-item">
                                <div class="inv-info">
                                    <div class="inv-name">@item.Name</div>
                                    <div class="inv-meta">Unit: @item.Unit</div>
                                </div>
                                <div class="inv-stat">
                                    <div class="inv-qty" style="color: #ef4444;">@item.Quantity</div>
                                    <div class="inv-bar-mini">
                                        <div class="inv-fill" style="width:@StockPercent(item.Quantity)%"></div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <i class="bi bi-check-circle-fill" style="font-size: 2rem; color: #10b981; margin-bottom: 10px; display:block;"></i>
                            Inventory levels are healthy.
                        </div>
                    }
                </div>
                <div class="card-footer">
                    Threshold: ≤ @LowStockThreshold items
                </div>
            </div>

        </div>
    </div>
</div>

@code {
    // --- EXACT SAME C# CODE AS BEFORE, NO CHANGES TO LOGIC ---
    // View models
    private record EvacueeRow(string Name, string Disaster, string Shelter, string Status, DateTime Registered);
    private record StockRow(string Name, int Quantity, string Unit);

    // Data collections
    private List<EvacueeRow> AllEvacuees = new();
    private List<Disaster> AllDisasters = new();
    private List<StockRow> LowStockItems = new();

    // Filters / state
    private string evacueeFilter = string.Empty;
    private bool _loading = false;

    // Thresholds
    private const int LowStockThreshold = 10;

    // Metrics
    private int ActiveDisastersCount => ActiveDisasters.Count();
    private int TotalEvacuees => AllEvacuees.Count;
    private int LowStockCount => LowStockItems.Count;
    private int ShelterCapacityUsed
    {
        get
        {
            var shelters = _shelterSnapshot;
            if (shelters.Count == 0) return 0;
            var capacity = shelters.Sum(s => s.Capacity);
            var occupancy = shelters.Sum(s => s.CurrentOccupancy);
            return capacity > 0 ? (int)Math.Round(occupancy / (double)capacity * 100) : 0;
        }
    }

    // Delta texts (today vs yesterday)
    private string EvacueeDeltaText => DeltaLabel(_evacueesToday, _evacueesYesterday, "today");
    private string ActiveDisasterDeltaText => DeltaLabel(_activeToday, _activeYesterday, "today");
    private string LowStockDeltaText => DeltaLabel(_lowStockToday, _lowStockYesterday, "today");

    // Snapshots for delta computation
    private int _evacueesToday;
    private int _evacueesYesterday;
    private int _activeToday;
    private int _activeYesterday;
    private int _lowStockToday;
    private int _lowStockYesterday;
    private List<Shelter> _shelterSnapshot = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;

        var today = DateTime.UtcNow.Date;
        var yesterday = today.AddDays(-1);

        // Evacuees
        var evacueesQuery = Db.Evacuees
            .Include(e => e.Disaster)
            .Include(e => e.Shelter)
            .AsNoTracking();

        var evacuees = await evacueesQuery
            .OrderByDescending(e => e.RegisteredAt)
            .Take(200)
            .ToListAsync();

        AllEvacuees = evacuees.Select(e => new EvacueeRow(
            e.FirstName + " " + e.LastName,
            e.Disaster.Title,
            e.Shelter?.Name ?? "—",
            e.Status,
            e.RegisteredAt
        )).ToList();

        _evacueesToday = evacuees.Count(e => e.RegisteredAt.Date == today);
        _evacueesYesterday = evacuees.Count(e => e.RegisteredAt.Date == yesterday);

        // Disasters
        AllDisasters = await Db.Disasters.AsNoTracking()
            .OrderByDescending(d => d.StartDate)
            .Take(100)
            .ToListAsync();

        _activeToday = AllDisasters.Count(d => IsActiveStatus(d.Status) && d.StartDate.Date <= today);
        _activeYesterday = AllDisasters.Count(d => IsActiveStatus(d.Status) && d.StartDate.Date <= yesterday);

        // Shelters
        _shelterSnapshot = await Db.Shelters.AsNoTracking().ToListAsync();

        // Stocks (low)
        var lowStocks = await Db.Stocks
            .Include(s => s.ReliefGood)
            .AsNoTracking()
            .Where(s => s.Quantity <= LowStockThreshold)
            .OrderBy(s => s.Quantity)
            .Take(50)
            .ToListAsync();

        LowStockItems = lowStocks.Select(s => new StockRow(
            s.ReliefGood.Name,
            s.Quantity,
            s.ReliefGood.Unit
        )).ToList();

        _lowStockToday = lowStocks.Count(s => s.LastUpdated.Date == today);
        _lowStockYesterday = lowStocks.Count(s => s.LastUpdated.Date == yesterday);

        _loading = false;
        StateHasChanged();
    }

    private IEnumerable<EvacueeRow> FilteredEvacuees =>
        AllEvacuees
            .Where(e =>
                string.IsNullOrWhiteSpace(evacueeFilter) ||
                e.Name.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Shelter.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Status.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Disaster.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(e => e.Registered)
            .Take(12);

    private IEnumerable<Disaster> ActiveDisasters =>
        AllDisasters.Where(d => IsActiveStatus(d.Status))
                    .OrderByDescending(d => d.StartDate)
                    .Take(15);

    private static bool IsActiveStatus(string status) =>
        status.Equals("Active", StringComparison.OrdinalIgnoreCase) ||
        status.Equals("Open", StringComparison.OrdinalIgnoreCase);

    private static int StockPercent(int qty)
    {
        var cap = Math.Max(LowStockThreshold * 2, 1);
        return Math.Clamp((int)Math.Round(qty / (double)cap * 100), 0, 100);
    }

    private static string DeltaLabel(int today, int yesterday, string suffix)
    {
        var diff = today - yesterday;
        if (diff == 0) return "No change";
        var sign = diff > 0 ? "+" : "−";
        return $"{sign}{Math.Abs(diff)} {suffix}";
    }

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "critical" => "st-critical",
        "needs med" => "st-med",
        "admitted" => "st-stable",
        "stable" => "st-stable",
        "released" => "st-contained",
        _ => "st-stable"
    };

    private async void Refresh()
    {
        if (_loading) return;
        await LoadAsync();
    }
}