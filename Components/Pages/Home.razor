@page "/home"
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities

<div class="dashboard-root">
    <div class="dashboard-grid">

        <!-- KPI -->
        <section aria-label="Key metrics" class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Active Disasters</div>
                <div class="kpi-value text-accent">@ActiveDisastersCount</div>
                <div class="kpi-trend">@ActiveDisasterDeltaText</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Registered Evacuees</div>
                <div class="kpi-value">@TotalEvacuees</div>
                <div class="kpi-trend">@EvacueeDeltaText</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Shelter Capacity Used</div>
                <div class="kpi-value">@ShelterCapacityUsed%</div>
                <div class="progress-shell" aria-label="Shelter capacity usage">
                    <div class="progress-bar" style="width:@ShelterCapacityUsed%"></div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Low Stock Items (≤@LowStockThreshold)</div>
                <div class="kpi-value">@LowStockCount</div>
                <div class="kpi-trend">@LowStockDeltaText</div>
            </div>
        </section>

        <!-- LEFT COLUMN -->
        <div class="col-stack">
            <section class="panel">
                <header class="panel-head">
                    <h2 class="panel-title">Recent Evacuees</h2>
                    <div class="panel-actions">
                        <input class="mini-input" placeholder="Search…" @bind="evacueeFilter" @bind:event="oninput" />
                        <button class="mini-btn" @onclick="Refresh" disabled="@_loading">↻</button>
                    </div>
                </header>
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Disaster</th>
                            <th>Shelter</th>
                            <th>Status</th>
                            <th>Registered</th>
                        </tr>
                        </thead>
                        <tbody>
                        @if (FilteredEvacuees.Any())
                        {
                            foreach (var e in FilteredEvacuees)
                            {
                                <tr>
                                    <td>@e.Name</td>
                                    <td>@e.Disaster</td>
                                    <td>@e.Shelter</td>
                                    <td><span class="status-chip @StatusClass(e.Status)">@e.Status</span></td>
                                    <td>@e.Registered.ToString("MMM dd HH:mm")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="5" class="t-center" style="opacity:.6;">No evacuees found.</td></tr>
                        }
                        </tbody>
                    </table>
                </div>
                <footer class="panel-foot">
                    Showing @FilteredEvacuees.Count() of @AllEvacuees.Count
                </footer>
            </section>

            <section class="panel">
                <header class="panel-head">
                    <h2 class="panel-title">Active Disasters</h2>
                </header>
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Started</th>
                            <th>Location</th>
                        </tr>
                        </thead>
                        <tbody>
                        @if (ActiveDisasters.Any())
                        {
                            foreach (var d in ActiveDisasters)
                            {
                                <tr>
                                    <td>@d.Title</td>
                                    <td>@d.DisasterType</td>
                                    <td><span class="sev sev-@d.Severity.ToLower()">@d.Severity</span></td>
                                    <td>@d.StartDate.ToString("MMM dd")</td>
                                    <td>@d.Location</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="5" class="t-center" style="opacity:.6;">No active disasters.</td></tr>
                        }
                        </tbody>
                    </table>
                </div>
                <footer class="panel-foot">
                    Total Active: @ActiveDisastersCount
                </footer>
            </section>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-stack">
            <section class="panel">
                <header class="panel-head">
                    <h2 class="panel-title">Inventory Snapshot (Low)</h2>
                </header>
                <div class="inventory-cards">
                    @if (LowStockItems.Any())
                    {
                        foreach (var item in LowStockItems.Take(6))
                        {
                            <div class="inv-card inv-low">
                                <div class="inv-name">@item.Name</div>
                                <div class="inv-qty">
                                    <strong>@item.Quantity</strong>
                                    <span class="inv-unit">@item.Unit</span>
                                </div>
                                <div class="progress-shell thin" aria-label="Stock level percentage">
                                    <div class="progress-bar" style="width:@StockPercent(item.Quantity)%"></div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div style="padding:12px;font-size:.70rem;opacity:.7;">No low stock items.</div>
                    }
                </div>
                <footer class="panel-foot">
                    @LowStockCount low stock items (threshold: @LowStockThreshold)
                </footer>
            </section>
        </div>
    </div>
</div>

@code {
    // View models
    private record EvacueeRow(string Name, string Disaster, string Shelter, string Status, DateTime Registered);
    private record StockRow(string Name, int Quantity, string Unit);

    // Data collections
    private List<EvacueeRow> AllEvacuees = new();
    private List<Disaster> AllDisasters = new();
    private List<StockRow> LowStockItems = new();

    // Filters / state
    private string evacueeFilter = string.Empty;
    private bool _loading = false;

    // Thresholds
    private const int LowStockThreshold = 10;

    // Metrics
    private int ActiveDisastersCount => ActiveDisasters.Count();
    private int TotalEvacuees => AllEvacuees.Count;
    private int LowStockCount => LowStockItems.Count;
    private int ShelterCapacityUsed
    {
        get
        {
            var shelters = _shelterSnapshot;
            if (shelters.Count == 0) return 0;
            var capacity = shelters.Sum(s => s.Capacity);
            var occupancy = shelters.Sum(s => s.CurrentOccupancy);
            return capacity > 0 ? (int)Math.Round(occupancy / (double)capacity * 100) : 0;
        }
    }

    // Delta texts (today vs yesterday)
    private string EvacueeDeltaText => DeltaLabel(_evacueesToday, _evacueesYesterday, "today");
    private string ActiveDisasterDeltaText => DeltaLabel(_activeToday, _activeYesterday, "today");
    private string LowStockDeltaText => DeltaLabel(_lowStockToday, _lowStockYesterday, "today");

    // Snapshots for delta computation
    private int _evacueesToday;
    private int _evacueesYesterday;
    private int _activeToday;
    private int _activeYesterday;
    private int _lowStockToday;
    private int _lowStockYesterday;
    private List<Shelter> _shelterSnapshot = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        _loading = true;

        var today = DateTime.UtcNow.Date;
        var yesterday = today.AddDays(-1);

        // Evacuees
        var evacueesQuery = Db.Evacuees
            .Include(e => e.Disaster)
            .Include(e => e.Shelter)
            .AsNoTracking();

        var evacuees = await evacueesQuery
            .OrderByDescending(e => e.RegisteredAt)
            .Take(200)
            .ToListAsync();

        AllEvacuees = evacuees.Select(e => new EvacueeRow(
            e.FirstName + " " + e.LastName,
            e.Disaster.Title,
            e.Shelter?.Name ?? "—",
            e.Status,
            e.RegisteredAt
        )).ToList();

        _evacueesToday = evacuees.Count(e => e.RegisteredAt.Date == today);
        _evacueesYesterday = evacuees.Count(e => e.RegisteredAt.Date == yesterday);

        // Disasters
        AllDisasters = await Db.Disasters.AsNoTracking()
            .OrderByDescending(d => d.StartDate)
            .Take(100)
            .ToListAsync();

        _activeToday = AllDisasters.Count(d => IsActiveStatus(d.Status) && d.StartDate.Date <= today);
        _activeYesterday = AllDisasters.Count(d => IsActiveStatus(d.Status) && d.StartDate.Date <= yesterday);

        // Shelters
        _shelterSnapshot = await Db.Shelters.AsNoTracking().ToListAsync();

        // Stocks (low)
        var lowStocks = await Db.Stocks
            .Include(s => s.ReliefGood)
            .AsNoTracking()
            .Where(s => s.Quantity <= LowStockThreshold)
            .OrderBy(s => s.Quantity)
            .Take(50)
            .ToListAsync();

        LowStockItems = lowStocks.Select(s => new StockRow(
            s.ReliefGood.Name,
            s.Quantity,
            s.ReliefGood.Unit
        )).ToList();

        _lowStockToday = lowStocks.Count(s => s.LastUpdated.Date == today);
        _lowStockYesterday = lowStocks.Count(s => s.LastUpdated.Date == yesterday);

        _loading = false;
        StateHasChanged();
    }

    private IEnumerable<EvacueeRow> FilteredEvacuees =>
        AllEvacuees
            .Where(e =>
                string.IsNullOrWhiteSpace(evacueeFilter) ||
                e.Name.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Shelter.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Status.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase) ||
                e.Disaster.Contains(evacueeFilter, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(e => e.Registered)
            .Take(12);

    private IEnumerable<Disaster> ActiveDisasters =>
        AllDisasters.Where(d => IsActiveStatus(d.Status))
                    .OrderByDescending(d => d.StartDate)
                    .Take(15);

    private static bool IsActiveStatus(string status) =>
        status.Equals("Active", StringComparison.OrdinalIgnoreCase) ||
        status.Equals("Open", StringComparison.OrdinalIgnoreCase);

    private static int StockPercent(int qty)
    {
        // Relative fill vs a nominal 'healthy' level (2× threshold)
        var cap = Math.Max(LowStockThreshold * 2, 1);
        return Math.Clamp((int)Math.Round(qty / (double)cap * 100), 0, 100);
    }

    private static string DeltaLabel(int today, int yesterday, string suffix)
    {
        var diff = today - yesterday;
        if (diff == 0) return "No change";
        var sign = diff > 0 ? "+" : "−";
        return $"{sign}{Math.Abs(diff)} {suffix}";
    }

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "critical" => "st-critical",
        "needs med" => "st-med",
        "admitted" => "st-stable",
        "stable" => "st-stable",
        "released" => "st-contained",
        _ => "st-stable"
    };

    private async void Refresh()
    {
        if (_loading) return;
        await LoadAsync();
    }
}