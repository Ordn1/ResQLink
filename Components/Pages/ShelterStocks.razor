@page "/shelter/{ShelterId:int}/stocks"
@using ResQLink.Data.Entities
@using ResQLink.Helpers
@using Microsoft.EntityFrameworkCore
@inject ResQLink.Services.ResourceAllocationService AllocationSvc
@inject ResQLink.Data.AppDbContext Db
@inject NavigationManager Nav

<div class="stock-root">
    
    <div class="page-header">
        <h2 class="page-subtitle">@(_shelter?.Name ?? "Shelter") - Stock Inventory</h2>
    </div>

    @if (_loading)
    {
        <div class="empty-state">
            <div class="spinner"></div>
            <p>Loading stock information...</p>
        </div>
    }
    else if (_shelter == null)
    {
        <div class="empty-state">
            <i class="bi bi-exclamation-circle empty-icon"></i>
            <p class="empty-text">Shelter not found.</p>
        </div>
    }
    else
    {
        <div class="action-buttons">
            <button class="btn-action" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> Back to Shelters
            </button>
            <button class="btn-action" @onclick="Refresh">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">Location</div>
                <div class="info-value">@_shelter.Location</div>
            </div>
            <div class="info-card">
                <div class="info-label">Capacity</div>
                <div class="info-value">@_shelter.CurrentOccupancy / @_shelter.Capacity</div>
            </div>
            <div class="info-card">
                <div class="info-label">Total Items</div>
                <div class="info-value">@_shelterStocks.Count items</div>
            </div>
        </div>

        <div class="section-container">
            <div class="section-header">
                <h3>Current Stock</h3>
            </div>
            @if (_shelterStocks.Count == 0)
            {
                <div class="empty-state">
                    <i class="bi bi-box-seam empty-icon"></i>
                    <p class="empty-text">No items allocated to this shelter yet.</p>
                </div>
            }
            else
            {
                <div class="table-wrap">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="t-center">Quantity</th>
                                <th class="t-center">Max Capacity</th>
                                <th class="t-center">Status</th>
                                <th class="t-center">Progress</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var stock in _shelterStocks)
                            {
                                <tr>
                                    <td class="cell-item">@stock.ReliefGood?.Name (@stock.ReliefGood?.Unit)</td>
                                    <td class="t-center cell-quantity">@stock.Quantity</td>
                                    <td class="t-center cell-quantity">@stock.MaxCapacity</td>
                                    <td class="t-center">
                                        <span class="status-chip @StockExtensions.GetStatusClass(stock.Status ?? StockExtensions.ComputeStatus(stock.Quantity, stock.MaxCapacity))">
                                            @(stock.Status ?? StockExtensions.ComputeStatus(stock.Quantity, stock.MaxCapacity))
                                        </span>
                                    </td>
                                    <td class="t-center">
                                        <div class="progress-shell" style="width:120px;display:inline-block;">
                                            <div class="progress-bar" style="width:@($"{(stock.CapacityPercent ?? StockExtensions.ComputePercent(stock.Quantity, stock.MaxCapacity)):0.0}%")"></div>
                                        </div>
                                        <span style="margin-left:6px;font-size:0.7rem;">
                                            @($"{(stock.CapacityPercent ?? StockExtensions.ComputePercent(stock.Quantity, stock.MaxCapacity)):0.0}%")
                                        </span>
                                    </td>
                                    <td class="cell-date">@stock.LastUpdated.ToString("MMM dd, yyyy HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <div class="section-container">
            <div class="section-header">
                <h3>Allocation History</h3>
            </div>
            @if (_allocations.Count == 0)
            {
                <div class="empty-state">
                    <i class="bi bi-clock-history empty-icon"></i>
                    <p class="empty-text">No allocation history.</p>
                </div>
            }
            else
            {
                <div class="table-wrap">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th style="width:80px">ID</th>
                                <th>Item</th>
                                <th class="t-center">Quantity</th>
                                <th>Allocated By</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var alloc in _allocations)
                            {
                                <tr>
                                    <td class="t-center cell-id">#@alloc.AllocationId</td>
                                    <td class="cell-item">@alloc.Stock?.ReliefGood?.Name</td>
                                    <td class="t-center cell-quantity">@alloc.AllocatedQuantity @alloc.Stock?.ReliefGood?.Unit</td>
                                    <td class="cell-allocatedby">@alloc.AllocatedBy?.Username</td>
                                    <td class="cell-date">@alloc.AllocatedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int ShelterId { get; set; }

    private Shelter? _shelter;
    private List<Stock> _shelterStocks = new();
    private List<ResourceAllocation> _allocations = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _loading = true;
            
            _shelter = await Db.Shelters.FindAsync(ShelterId);
            
            if (_shelter != null)
            {
                _shelterStocks = await AllocationSvc.GetShelterStockAsync(ShelterId);
                _allocations = await AllocationSvc.GetByShelterAsync(ShelterId);
            }
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error loading shelter stocks: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Refresh()
    {
        await LoadAsync();
    }

    private void GoBack()
    {
        Nav.NavigateTo("/shelters");
    }
}
