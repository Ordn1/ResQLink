@page "/inventory"
@inject IDbContextFactory<ResQLink.Data.AppDbContext> DbFactory
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities

<div class="inventory-root">

    @* --- KPI SECTION --- *@
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Inventory Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-box-seam-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Goods</div>
                    <div class="kpi-value">@ReliefGoods.Count</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-clipboard-data-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Tracked Stocks</div>
                    <div class="kpi-value">@Stocks.Count</div>
                </div>
            </div>

            @* Warning KPI *@
            <div class="kpi-card">
                <div class="kpi-icon-circle" style="background: #fff7ed; color: #ea580c;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label" style="color: #9a3412;">Low / Out</div>
                    <div class="kpi-value" style="color: #ea580c;">@LowCount / @OutCount</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-tags-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Categories</div>
                    <div class="kpi-value">@DistinctCategories.Count()</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-layers-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Qty</div>
                    <div class="kpi-value">@TotalQuantity</div>
                </div>
            </div>
        </div>
    </section>

    @* --- MAIN INVENTORY TABLE --- *@
    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Inventory Items</h2>
            <div class="panel-actions">
                <input class="mini-input"
                       placeholder="Search name or category…"
                       @bind="search"
                       @bind:event="oninput" />
                <select class="mini-input" @bind="categoryFilter">
                    <option value="">Category</option>
                    @foreach (var c in DistinctCategories)
                    {
                        <option>@c</option>
                    }
                </select>
                <select class="mini-input" @bind="stockFilter">
                    <option value="">Stock State</option>
                    <option value="low">Low</option>
                    <option value="out">Out</option>
                    <option value="ok">Adequate</option>
                </select>
                <select class="mini-input" @bind="sortBy">
                    <option value="name_asc">Name A→Z</option>
                    <option value="qty_desc">Qty High→Low</option>
                    <option value="qty_asc">Qty Low→High</option>
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th style="width:70px" class="t-center">ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th class="t-right">Qty</th>
                        <th class="t-right">Last Updated</th>
                        <th class="t-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var i in PagedItems)
                    {
                        <tr>
                            <td class="t-center">@i.RgId</td>
                            <td><strong>@i.Name</strong> <span class="text-muted" style="font-size:0.65rem">(@i.Unit)</span></td>
                            <td>@i.Category</td>
                            <td class="t-right"><span class="amount-text">@i.Quantity</span></td>
                            <td class="t-right text-muted">@i.LastUpdated.ToString("MMM dd HH:mm")</td>
                            <td class="t-center">
                                <span style="font-weight: 700; font-size: 0.7rem; text-transform: uppercase; color: @GetStatusColor(i)">
                                    @StatusText(i)
                                </span>
                            </td>
                        </tr>
                    }
                    @if (!PagedItems.Any())
                    {
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                                <div class="empty-text">No results found</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">
                <i class="bi bi-info-circle"></i>
                Showing @StartIndex–@EndIndex of @Filtered.Count() items
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize" style="width: auto; min-width: 60px;">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>

    @* --- BOTTOM COLUMNS --- *@
    <div class="two-col">

        <!-- Category Summary Section -->
        <section class="panel">
            <header class="panel-head">
                <h2 class="panel-title">Category Health</h2>
            </header>
            <div class="category-grid">
                @foreach (var c in CategorySummaries)
                {
                    // Determine health color
                    var healthColor = (c.OutCount > 0) ? "#dc2626" : (c.LowCount > 0) ? "#f59e0b" : "#16a34a";

                    <div class="category-card" style="border-top: 3px solid @healthColor;">
                        <div class="cat-header">
                            <span class="cat-name">@c.Category</span>
                            <span class="cat-badge" style="background:@healthColor; color:white;">@c.ItemCount</span>
                        </div>

                        <div class="cat-metric">
                            <span class="metric-label">Total Stock</span>
                            <span class="metric-value">@c.TotalQuantity.ToString("N0")</span>
                        </div>

                        <div class="progress-shell thin">
                            <div class="progress-bar" style="width:@($"{c.LowPercent}%"); background: @healthColor"></div>
                        </div>

                        <div class="cat-footer">
                            <div class="@(c.LowCount > 0 ? "text-warn" : "text-dim")">
                                <strong>@c.LowCount</strong> Low
                            </div>
                            <div class="vr-sep"></div>
                            <div class="@(c.OutCount > 0 ? "text-danger" : "text-dim")">
                                <strong>@c.OutCount</strong> Out
                            </div>
                        </div>
                    </div>
                }
            </div>
        </section>

        <!-- Restock Attention Section -->
        <section class="panel">
            <header class="panel-head">
                <h2 class="panel-title" style="color: #dc2626;">Restock Attention</h2>
            </header>
            <div class="attention-list">
                @if (AttentionItems.Any())
                {
                    <div class="att-header-row">
                        <div style="flex:1">Item</div>
                        <div style="width: 80px; text-align: right;">Stock Level</div>
                        <div style="width: 60px; text-align: center;">Status</div>
                    </div>
                    @foreach (var i in AttentionItems)
                    {
                        <div class="att-row">
                            <div class="att-info">
                                <div class="att-name">@i.Name</div>
                                <div class="att-sub">@i.Category</div>
                            </div>

                            <div class="att-visual">
                                <div class="progress-shell tiny">
                                    <div class="progress-bar" style="width:@($"{StockPercent(i)}%"); background: @GetStatusColor(i)"></div>
                                </div>
                                <div class="att-qty">
                                    <span style="color: @GetStatusColor(i)">@i.Quantity</span> / @i.Unit
                                </div>
                            </div>

                            <div class="att-status">
                                <span style="color: @GetStatusColor(i); font-weight:800; font-size:0.7rem;">
                                    @StatusText(i)
                                </span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-icon" style="font-size: 1.5rem; color: #16a34a;"><i class="bi bi-check-circle"></i></div>
                        <div class="empty-text">All stocks are adequate.</div>
                    </div>
                }
            </div>
        </section>
    </div>
</div>

@code {
    private record InventoryRow(int RgId, string Name, string Category, string Unit, int Quantity, DateTime LastUpdated);
    private record CategorySummaryRow(string Category, int ItemCount, int TotalQuantity, int LowCount, int OutCount)
    {
        public int LowPercent => ItemCount == 0
            ? 0
            : (int)Math.Round((LowCount + OutCount) / (double)ItemCount * 100);
    }

    private List<InventoryRow> All = new();
    private List<ReliefGood> ReliefGoods = new();
    private List<Stock> Stocks = new();
    private List<Category> Categories = new();

    private string search = string.Empty;
    private string categoryFilter = string.Empty;
    private string stockFilter = string.Empty;
    private string sortBy = "name_asc";
    private int _pageIndex = 0;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        ReliefGoods = await db.ReliefGoods
            .Include(r => r.Categories)
                .ThenInclude(rc => rc.Category)
            .AsNoTracking()
            .ToListAsync();

        Stocks = await db.Stocks.AsNoTracking().ToListAsync();
        Categories = await db.Categories.AsNoTracking().ToListAsync();

        var latestStock = Stocks
            .GroupBy(s => s.RgId)
            .Select(g => g.OrderByDescending(x => x.LastUpdated).First())
            .ToDictionary(s => s.RgId, s => s);

        All = ReliefGoods.Select(r =>
        {
            var cat = r.Categories.FirstOrDefault()?.Category.CategoryName ?? "Uncategorized";
            var hasStock = latestStock.TryGetValue(r.RgId, out var st);
            return new InventoryRow(
                r.RgId,
                r.Name,
                cat,
                r.Unit,
                hasStock ? st!.Quantity : 0,
                hasStock ? st!.LastUpdated : r.CreatedAt
            );
        }).ToList();
    }

    private IEnumerable<string> DistinctCategories =>
        All.Select(i => i.Category).Distinct().OrderBy(c => c);

    private IEnumerable<InventoryRow> Filtered
    {
        get
        {
            var q = All.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(search))
                q = q.Where(i =>
                    i.Name.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    i.Category.Contains(search, StringComparison.OrdinalIgnoreCase));

            if (!string.IsNullOrWhiteSpace(categoryFilter))
                q = q.Where(i => i.Category.Equals(categoryFilter, StringComparison.OrdinalIgnoreCase));

            if (!string.IsNullOrWhiteSpace(stockFilter))
            {
                q = stockFilter switch
                {
                    "low" => q.Where(IsLow),
                    "out" => q.Where(IsOut),
                    "ok" => q.Where(i => !IsLow(i) && !IsOut(i)),
                    _ => q
                };
            }

            return Sort(q);
        }
    }

    private IEnumerable<InventoryRow> Sort(IEnumerable<InventoryRow> source) => sortBy switch
    {
        "qty_desc" => source.OrderByDescending(i => i.Quantity),
        "qty_asc" => source.OrderBy(i => i.Quantity),
        _ => source.OrderBy(i => i.Name)
    };

    private int TotalFiltered => Filtered.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<InventoryRow> PagedItems => Filtered.Skip(_pageIndex * pageSize).Take(pageSize);

    private int LowCount => All.Count(IsLow);
    private int OutCount => All.Count(IsOut);
    private int TotalQuantity => All.Sum(i => i.Quantity);

    private IEnumerable<CategorySummaryRow> CategorySummaries =>
        DistinctCategories.Select(cat =>
        {
            var items = All.Where(i => i.Category == cat).ToList();
            return new CategorySummaryRow(
                cat,
                items.Count,
                items.Sum(i => i.Quantity),
                items.Count(IsLow),
                items.Count(IsOut)
            );
        });

    private IEnumerable<InventoryRow> AttentionItems =>
        All.Where(i => IsLow(i) || IsOut(i))
           .OrderBy(i => IsOut(i) ? 0 : 1)
           .ThenBy(StockPercent)
           .Take(10);

    private static bool IsOut(InventoryRow i) => i.Quantity <= 0;
    private static bool IsLow(InventoryRow i) => !IsOut(i) && i.Quantity <= 10;

    private static int StockPercent(InventoryRow i)
    {
        if (IsOut(i)) return 0;
        var cap = 50;
        return Math.Clamp((int)Math.Round(i.Quantity / (double)cap * 100), 0, 100);
    }

    private string StatusText(InventoryRow i) =>
        IsOut(i) ? "OUT" :
        IsLow(i) ? "LOW" : "OK";

    private string GetStatusColor(InventoryRow i) =>
        IsOut(i) ? "#dc2626" :
        IsLow(i) ? "#d97706" :
        "#16a34a";

    private async void Refresh()
    {
        await LoadAsync();
        StateHasChanged();
    }

    private void ClearFilters()
    {
        search = string.Empty;
        categoryFilter = string.Empty;
        stockFilter = string.Empty;
        sortBy = "name_asc";
        _pageIndex = 0;
    }

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }
}