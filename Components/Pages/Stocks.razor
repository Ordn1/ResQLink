@page "/stocks"
@using ResQLink.Data.Entities
@using ResQLink.Helpers
@using Microsoft.EntityFrameworkCore
@inject ResQLink.Services.StockService StockSvc
@inject ResQLink.Services.ResourceAllocationService AllocationSvc
@inject ResQLink.Services.InventoryService InventorySvc
@inject ResQLink.Data.AppDbContext Db
@inject ResQLink.Services.AuthState AuthState
@inject IJSRuntime JSRuntime

<div class="stocks-root">
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Stocks Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary" @onclick="OpenAddModal" disabled="@_showModal">
                    <i class="bi bi-box-seam"></i> Add Stock
                </button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Records</div>
                <div class="kpi-value text-accent">@_stocks.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active</div>
                <div class="kpi-value">@_stocks.Count(s => s.IsActive)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Inactive</div>
                <div class="kpi-value">@_stocks.Count(s => !s.IsActive)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Low / Empty</div>
                <div class="kpi-value">
                    @_stocks.Count(s => GetStatus(s) == "Low")
                    /
                    @_stocks.Count(s => GetStatus(s) == "Empty")
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Stocks Management</h2>
            <div class="panel-actions">
                <input class="mini-input"
                       placeholder="Search item or location…"
                       @bind="_search"
                       @bind:event="oninput" />

                <select class="mini-input" @bind="_statusFilter">
                    <option value="">All Status</option>
                    <option value="Empty">Empty</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>

                <label class="chk-inline">
                    <input type="checkbox" @bind="_showInactive" @bind:after="LoadAsync" />
                    <span>Show Inactive</span>
                </label>

                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="panel-body">
            @if (_loading)
            {
                <p class="t-center text-muted">Loading…</p>
            }
            else if (_stocks == null || _stocks.Count == 0)
            {
                <p class="t-center text-muted">
                    No stocks found.
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <span> Error: @_error</span>
                    }
                </p>
            }
            else if (!FilteredStocks.Any())
            {
                <p class="t-center text-muted">No stocks match your filters.</p>
            }
            else
            {
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th class="t-center col-id">ID</th>
                                <th class="col-item">Relief Good</th>
                                <th class="col-location">Location</th>
                                <th class="t-center col-qty">Qty</th>
                                <th class="t-center col-capacity">Max Cap.</th>
                                <th class="t-center col-status">Status</th>
                                <th class="t-center col-progress">Progress</th>
                                <th class="t-center col-active">Active</th>
                                <th class="col-updated">Last Updated</th>
                                <th class="t-center col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var stock in FilteredStocks)
                            {
                                <tr>
                                    <td class="t-center col-id">@stock.StockId</td>
                                    <td class="col-item">
                                        <strong>@stock.ReliefGood?.Name</strong>
                                        <span class="text-muted">(@stock.ReliefGood?.Unit)</span>
                                    </td>
                                    <td class="col-location">@(!string.IsNullOrWhiteSpace(stock.Location) ? stock.Location : "—")</td>
                                    <td class="t-center col-qty">@stock.Quantity</td>
                                    <td class="t-center col-capacity">@stock.MaxCapacity</td>
                                    <td class="t-center col-status">
                                        <span class="status-chip @GetStatusClass(stock)">
                                            @GetStatus(stock)
                                        </span>
                                    </td>
                                    <td class="t-center col-progress">
                                        <div class="progress-shell thin">
                                            <div class="progress-bar" style="width:@GetPercent(stock)%"></div>
                                        </div>
                                        <span class="progress-text">@GetPercent(stock).ToString("0.0")%</span>
                                    </td>
                                    <td class="t-center col-active">
                                        <span class="status-chip @(stock.IsActive ? "st-active" : "st-contained")">
                                            @(stock.IsActive ? "Yes" : "No")
                                        </span>
                                    </td>
                                    <td class="col-updated">
                                        @stock.LastUpdated.ToString("MMM dd, yyyy HH:mm")
                                    </td>
                                    <td class="action-cell col-actions">
                                        <button class="action-btn edit"
                                                @onclick="() => OpenEditModal(stock)"
                                                disabled="@_showModal"
                                                title="Edit stock">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="action-btn view"
                                                @onclick="() => OpenAdjustModal(stock)"
                                                title="Adjust quantity">
                                            <i class="bi bi-sliders"></i>
                                        </button>
                                        <button class="action-btn allocate"
                                                @onclick="() => OpenAllocateModal(stock)"
                                                disabled="@(stock.Quantity == 0 || stock.ShelterId != null)"
                                                title="Allocate to shelter">
                                            <i class="bi bi-arrow-up-right-square"></i>
                                        </button>
                                        <button class="action-btn delete"
                                                @onclick="() => DeleteStock(stock.StockId)"
                                                title="Delete stock">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="form-error" style="margin-top:8px;">@_error</div>
            }
        </div>
    </section>

    @* Enhanced Add / Edit Stock Modal with Validation *@
    @if (_showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>@(_editMode ? $"Edit Stock #{_editStockId}" : "Add New Stock")</h3>
                    <button class="modal-close" @onclick="CloseModal" disabled="@_saving">&times;</button>
                </div>
                <div class="modal-body">
                    @if (_loadingModal)
                    {
                        <div class="loading-spinner">
                            <span class="spinner"></span>
                            <p>Loading stock details...</p>
                        </div>
                    }
                    else
                    {
                        @if (!_editMode)
                        {
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rgSelect">Relief Good *</label>
                                    <select id="rgSelect" 
                                            class="form-control @(_fieldErrors.ContainsKey("ReliefGood") ? "is-invalid" : "")" 
                                            @bind="_selectedRgId"
                                            @bind:after="ValidateReliefGood">
                                        <option value="0">-- Select Relief Good --</option>
                                        @foreach (var rg in _reliefGoods)
                                        {
                                            <option value="@rg.RgId">@rg.Name (@rg.Unit)</option>
                                        }
                                    </select>
                                    @if (_fieldErrors.ContainsKey("ReliefGood"))
                                    {
                                        <div class="invalid-feedback">@_fieldErrors["ReliefGood"]</div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Relief Good</label>
                                    <div class="form-control-plaintext">
                                        <strong>@_selectedReliefGoodName</strong>
                                    </div>
                                    <small class="hint">Relief good cannot be changed after creation</small>
                                </div>
                            </div>
                        }

                        <div class="form-row">
                            <div class="form-group">
                                <label for="qty">Quantity *</label>
                                <input id="qty" 
                                       type="number" 
                                       min="0" 
                                       class="form-control @(_fieldErrors.ContainsKey("Quantity") ? "is-invalid" : "")" 
                                       @bind="_editQuantity"
                                       @bind:event="oninput"
                                       @onblur="ValidateQuantity" />
                                @if (_fieldErrors.ContainsKey("Quantity"))
                                {
                                    <div class="invalid-feedback">@_fieldErrors["Quantity"]</div>
                                }
                                <small class="hint">Current available quantity</small>
                            </div>
                            <div class="form-group">
                                <label for="maxCap">Max Capacity *</label>
                                <input id="maxCap" 
                                       type="number" 
                                       min="1" 
                                       class="form-control @(_fieldErrors.ContainsKey("MaxCapacity") ? "is-invalid" : "")" 
                                       @bind="_editMaxCapacity"
                                       @bind:event="oninput"
                                       @onblur="ValidateMaxCapacity" />
                                @if (_fieldErrors.ContainsKey("MaxCapacity"))
                                {
                                    <div class="invalid-feedback">@_fieldErrors["MaxCapacity"]</div>
                                }
                                <small class="hint">Maximum storage capacity</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="location">Location</label>
                                <input id="location" 
                                       class="form-control @(_fieldErrors.ContainsKey("Location") ? "is-invalid" : "")" 
                                       @bind="_editLocation"
                                       @bind:event="oninput"
                                       @onblur="ValidateLocation"
                                       maxlength="255"
                                       placeholder="e.g., Warehouse A, Shelf 3" />
                                @if (_fieldErrors.ContainsKey("Location"))
                                {
                                    <div class="invalid-feedback">@_fieldErrors["Location"]</div>
                                }
                                <small class="hint">Optional: Physical storage location</small>
                            </div>
                        </div>

                        @if (_editQuantity > 0 && _editMaxCapacity > 0)
                        {
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Stock Status Preview</label>
                                    <div class="status-preview">
                                        @{
                                            var percent = Math.Round((_editQuantity / (decimal)_editMaxCapacity) * 100, 1);
                                            var status = percent == 0 ? "Empty" : percent <= 25 ? "Low" : percent < 75 ? "Medium" : "High";
                                            var statusClass = status.ToLower();
                                        }
                                        <div class="progress-shell">
                                            <div class="progress-bar" style="width:@percent%"></div>
                                        </div>
                                        <div style="margin-top: 8px;">
                                            <span class="status-chip st-@statusClass">@status</span>
                                            <span style="margin-left: 8px; color: #6b7280; font-size: 0.85rem;">
                                                @_editQuantity / @_editMaxCapacity (@percent%)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(_modalError))
                        {
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle-fill"></i> @_modalError
                            </div>
                        }

                        <div class="modal-actions">
                            <button type="button"
                                    class="btn-cancel"
                                    @onclick="CloseModal"
                                    disabled="@_saving"
                                    @onclick:stopPropagation="true">
                                Cancel
                            </button>
                            <button type="button"
                                    class="btn-primary"
                                    @onclick="SaveStock"
                                    disabled="@(_saving || HasValidationErrors())"
                                    @onclick:stopPropagation="true">
                                @if (_saving)
                                {
                                    <span class="spinner"></span>
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <i class="bi @(_editMode ? "bi-check-circle" : "bi-plus-circle")"></i>
                                    <span>@(_editMode ? "Update Stock" : "Create Stock")</span>
                                }
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @* Adjust quantity modal *@
    @if (_showAdjustModal)
    {
        <div class="modal-overlay" @onclick="CloseAdjustModal" @onclick:stopPropagation="false">
            <div class="modal-dialog modal-sm" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Adjust Stock Quantity</h3>
                    <button class="modal-close" @onclick="CloseAdjustModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current</label>
                            <div>
                                <strong>@_adjustStock?.Quantity</strong>
                                /
                                @_adjustStock?.MaxCapacity
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="adjustDelta">Adjustment (+ or -)</label>
                            <input id="adjustDelta"
                                   type="number"
                                   class="form-control"
                                   @bind="_adjustDelta"
                                   placeholder="e.g., 50 or -20" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>New Quantity</label>
                            <div>
                                <strong>@(_adjustStock != null ? _adjustStock.Quantity + _adjustDelta : 0)</strong>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_modalError))
                    {
                        <div class="form-error">@_modalError</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseAdjustModal"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="ApplyAdjustment"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            @if (_saving)
                            {
                                <span class="spinner"></span>
                            }
                            Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Allocate modal *@
    @if (_showAllocateModal)
    {
        <div class="modal-overlay" @onclick="CloseAllocateModal" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Allocate Stock to Shelter</h3>
                    <button class="modal-close" @onclick="CloseAllocateModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item</label>
                            <div class="text-strong">
                                @_allocateStock?.ReliefGood?.Name (@_allocateStock?.ReliefGood?.Unit)
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Available Quantity</label>
                            <div class="text-strong text-accent">
                                @_allocateStock?.Quantity @_allocateStock?.ReliefGood?.Unit
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="allocShelter">Select Shelter *</label>
                            <select id="allocShelter" class="form-control" @bind="_allocateShelterId">
                                <option value="0">-- Select Shelter --</option>
                                @foreach (var shelter in _shelters)
                                {
                                    <option value="@shelter.ShelterId">@shelter.Name (@shelter.Location)</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="allocQty">Quantity to Allocate *</label>
                            <input id="allocQty"
                                   type="number"
                                   class="form-control"
                                   @bind="_allocateQuantity"
                                   min="1"
                                   max="@(_allocateStock?.Quantity ?? 0)" />
                            <small class="hint">Max: @_allocateStock?.Quantity</small>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_modalError))
                    {
                        <div class="form-error">@_modalError</div>
                    }
                    @if (!string.IsNullOrEmpty(_allocateSuccess))
                    {
                        <div class="success-message">@_allocateSuccess</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseAllocateModal"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="AllocateToShelter"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            @if (_saving)
                            {
                                <span class="spinner"></span>
                            }
                            Allocate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .status-preview {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .progress-shell {
        height: 24px;
        background: #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        transition: width 0.3s ease;
    }

    .invalid-feedback {
        display: block;
        color: #dc2626;
        font-size: 0.75rem;
        margin-top: 4px;
    }

    .is-invalid {
        border-color: #dc2626 !important;
    }

    .form-control-plaintext {
        padding: 8px 0;
        font-size: 0.95rem;
    }

    .hint {
        display: block;
        font-size: 0.7rem;
        color: #6b7280;
        margin-top: 4px;
        font-style: italic;
    }

    .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .alert-danger {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px 20px;
    }

    .loading-spinner .spinner {
        display: inline-block;
        margin-bottom: 12px;
    }
</style>

@code {
    private List<Stock> _stocks = new();
    private List<ReliefGood> _reliefGoods = new();
    private List<Shelter> _shelters = new();
    private bool _loading = true;
    private bool _loadingModal = false;
    private bool _showModal;
    private bool _showAdjustModal;
    private bool _showAllocateModal;
    private bool _editMode;
    private bool _saving;
    private bool _showInactive;
    private string _search = string.Empty;
    private string _statusFilter = string.Empty;
    private string _error = string.Empty;
    private string _modalError = string.Empty;
    private string _allocateSuccess = string.Empty;
    private Dictionary<string, string> _fieldErrors = new();

    // Edit fields
    private int _editStockId;
    private int _selectedRgId;
    private string _selectedReliefGoodName = string.Empty;
    private int _editQuantity;
    private int _editMaxCapacity = 1000;
    private string _editLocation = string.Empty;

    // Adjust fields
    private Stock? _adjustStock;
    private int _adjustDelta;

    // Allocate fields
    private Stock? _allocateStock;
    private int _allocateShelterId;
    private int _allocateQuantity;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _loading = true;
            _error = string.Empty;

            _stocks = await StockSvc.GetAllAsync(!_showInactive);
            _reliefGoods = await InventorySvc.GetAllAsync();
            _shelters = await Db.Shelters
                .Where(s => s.IsActive)
                .OrderBy(s => s.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _error = $"Error loading stocks: {ex.Message}";
            _stocks = new();
            _reliefGoods = new();
            _shelters = new();
        }
        finally
        {
            _loading = false;
        }
    }

    private decimal GetPercent(Stock stock)
    {
        var cp = stock.CapacityPercent ?? 0m;
        if (cp > 0m || stock.Quantity == 0)
            return cp;

        return StockExtensions.ComputePercent(stock.Quantity, stock.MaxCapacity);
    }

    private string GetStatus(Stock stock)
    {
        if (!string.IsNullOrEmpty(stock.Status))
            return stock.Status;

        return StockExtensions.ComputeStatus(stock.Quantity, stock.MaxCapacity);
    }

    private string GetStatusClass(Stock stock) =>
        StockExtensions.GetStatusClass(GetStatus(stock));

    private IEnumerable<Stock> FilteredStocks
    {
        get
        {
            if (_stocks == null || _stocks.Count == 0)
                return Enumerable.Empty<Stock>();

            var q = _stocks.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(_search))
            {
                q = q.Where(s =>
                    (s.ReliefGood?.Name?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (s.Location?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            if (!string.IsNullOrWhiteSpace(_statusFilter))
            {
                q = q.Where(s => GetStatus(s).Equals(_statusFilter, StringComparison.OrdinalIgnoreCase));
            }

            return q.OrderBy(s => s.ReliefGood?.Name);
        }
    }

    private void OpenAddModal()
    {
        _editMode = false;
        _showModal = true;
        _modalError = string.Empty;
        _fieldErrors.Clear();
        _selectedRgId = 0;
        _editStockId = 0;
        _editQuantity = 0;
        _editMaxCapacity = 1000;
        _editLocation = string.Empty;
        _selectedReliefGoodName = string.Empty;
    }

    private async void OpenEditModal(Stock stock)
    {
        _editMode = true;
        _showModal = true;
        _loadingModal = true;
        _modalError = string.Empty;
        _fieldErrors.Clear();
        
        StateHasChanged();

        try
        {
            // Reload stock with full details to ensure we have latest data
            var fullStock = await StockSvc.GetAsync(stock.StockId);
            
            if (fullStock == null)
            {
                _modalError = "Stock record not found. It may have been deleted.";
                _loadingModal = false;
                return;
            }

            _editStockId = fullStock.StockId;
            _selectedRgId = fullStock.RgId;
            _editQuantity = fullStock.Quantity;
            _editMaxCapacity = fullStock.MaxCapacity;
            _editLocation = fullStock.Location ?? string.Empty;
            _selectedReliefGoodName = $"{fullStock.ReliefGood?.Name} ({fullStock.ReliefGood?.Unit})";
        }
        catch (Exception ex)
        {
            _modalError = $"Error loading stock details: {ex.Message}";
        }
        finally
        {
            _loadingModal = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CloseModal()
    {
        if (_saving) return;
        _showModal = false;
        _fieldErrors.Clear();
    }

    // Validation methods
    private void ValidateReliefGood()
    {
        _fieldErrors.Remove("ReliefGood");
        if (_selectedRgId == 0)
        {
            _fieldErrors["ReliefGood"] = "Please select a relief good";
        }
    }

    private void ValidateQuantity()
    {
        _fieldErrors.Remove("Quantity");
        if (_editQuantity < 0)
        {
            _fieldErrors["Quantity"] = "Quantity cannot be negative";
        }
        else if (_editQuantity > _editMaxCapacity)
        {
            _fieldErrors["Quantity"] = $"Quantity cannot exceed max capacity ({_editMaxCapacity})";
        }
    }

    private void ValidateMaxCapacity()
    {
        _fieldErrors.Remove("MaxCapacity");
        if (_editMaxCapacity <= 0)
        {
            _fieldErrors["MaxCapacity"] = "Max capacity must be greater than 0";
        }
        else if (_editMaxCapacity > 1000000)
        {
            _fieldErrors["MaxCapacity"] = "Max capacity seems unrealistically high";
        }
        
        // Re-validate quantity if it exists
        if (_editQuantity > _editMaxCapacity)
        {
            _fieldErrors["Quantity"] = $"Quantity cannot exceed max capacity ({_editMaxCapacity})";
        }
        else
        {
            _fieldErrors.Remove("Quantity");
        }
    }

    private void ValidateLocation()
    {
        _fieldErrors.Remove("Location");
        if (!string.IsNullOrWhiteSpace(_editLocation) && _editLocation.Length > 255)
        {
            _fieldErrors["Location"] = "Location must not exceed 255 characters";
        }
    }

    private bool HasValidationErrors()
    {
        return _fieldErrors.Any();
    }

    private bool ValidateAll()
    {
        _fieldErrors.Clear();

        if (!_editMode && _selectedRgId == 0)
        {
            _fieldErrors["ReliefGood"] = "Please select a relief good";
        }

        if (_editQuantity < 0)
        {
            _fieldErrors["Quantity"] = "Quantity cannot be negative";
        }

        if (_editMaxCapacity <= 0)
        {
            _fieldErrors["MaxCapacity"] = "Max capacity must be greater than 0";
        }
        else if (_editMaxCapacity > 1000000)
        {
            _fieldErrors["MaxCapacity"] = "Max capacity seems unrealistically high";
        }

        if (_editQuantity > _editMaxCapacity)
        {
            _fieldErrors["Quantity"] = $"Quantity cannot exceed max capacity ({_editMaxCapacity})";
        }

        if (!string.IsNullOrWhiteSpace(_editLocation) && _editLocation.Length > 255)
        {
            _fieldErrors["Location"] = "Location must not exceed 255 characters";
        }

        return !_fieldErrors.Any();
    }

    private async Task SaveStock()
    {
        if (_saving) return;
        _modalError = string.Empty;

        // Validate all fields
        if (!ValidateAll())
        {
            _modalError = "Please correct the highlighted errors before saving.";
            return;
        }

        _saving = true;
        try
        {
            (Stock? stock, string? err) result;

            if (_editMode)
            {
                // Additional check for edit mode
                var existingStock = await StockSvc.GetAsync(_editStockId);
                if (existingStock == null)
                {
                    _modalError = "Stock record not found. It may have been deleted by another user.";
                    _saving = false;
                    await LoadAsync(); // Refresh the list
                    return;
                }

                result = await StockSvc.UpdateAsync(_editStockId, _editQuantity, _editMaxCapacity, _editLocation, null, null);
            }
            else
            {
                // Verify relief good still exists
                var reliefGood = await InventorySvc.GetByIdAsync(_selectedRgId);
                if (reliefGood == null)
                {
                    _modalError = "Selected relief good not found. It may have been deleted.";
                    _saving = false;
                    await LoadAsync(); // Refresh the lists
                    return;
                }

                result = await StockSvc.CreateAsync(_selectedRgId, _editQuantity, _editMaxCapacity, _editLocation);
            }

            if (result.err != null)
            {
                _modalError = result.err;
                return;
            }

            // Success!
            _showModal = false;
            await LoadAsync();
            
            // Show success message
            await JSRuntime.InvokeVoidAsync("alert", 
                _editMode ? "Stock updated successfully!" : "Stock created successfully!");
        }
        catch (DbUpdateException ex)
        {
            _modalError = $"Database error: {ex.InnerException?.Message ?? ex.Message}";
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OpenAdjustModal(Stock stock)
    {
        _adjustStock = stock;
        _adjustDelta = 0;
        _modalError = string.Empty;
        _showAdjustModal = true;
    }

    private void CloseAdjustModal()
    {
        if (_saving) return;
        _showAdjustModal = false;
        _adjustStock = null;
    }

    private async Task ApplyAdjustment()
    {
        if (_saving || _adjustStock == null) return;
        _modalError = string.Empty;

        if (_adjustDelta == 0)
        {
            _modalError = "Adjustment cannot be zero.";
            return;
        }

        _saving = true;
        try
        {
            var (stock, err) = await StockSvc.AdjustQuantityAsync(_adjustStock.StockId, _adjustDelta);

            if (err != null)
            {
                _modalError = err;
                return;
            }

            _showAdjustModal = false;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteStock(int stockId)
    {
        if (_saving) return;

        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete this stock record? This action cannot be undone.");
            if (!confirmed) return;

            _saving = true;
            var (ok, err) = await StockSvc.DeleteAsync(stockId);
            if (!ok && err != null)
                _error = err;
            else
                await JSRuntime.InvokeVoidAsync("alert", "Stock deleted successfully!");

            await LoadAsync();
        }
        catch (Exception ex)
        {
            _error = $"Delete error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task Refresh()
    {
        await LoadAsync();
    }

    private void OpenAllocateModal(Stock stock)
    {
        _allocateStock = stock;
        _allocateShelterId = 0;
        _allocateQuantity = 0;
        _modalError = string.Empty;
        _allocateSuccess = string.Empty;
        _showAllocateModal = true;
    }

    private void CloseAllocateModal()
    {
        if (_saving) return;
        _showAllocateModal = false;
        _allocateStock = null;
    }

    private async Task AllocateToShelter()
    {
        if (_saving || _allocateStock == null) return;
        _modalError = string.Empty;
        _allocateSuccess = string.Empty;

        if (_allocateShelterId == 0)
        {
            _modalError = "Please select a shelter.";
            return;
        }

        if (_allocateQuantity <= 0)
        {
            _modalError = "Quantity must be greater than zero.";
            return;
        }

        if (_allocateQuantity > _allocateStock.Quantity)
        {
            _modalError = $"Cannot allocate more than available quantity ({_allocateStock.Quantity}).";
            return;
        }

        // Validate user is authenticated
        if (!AuthState.IsAuthenticated || !AuthState.UserId.HasValue)
        {
            _modalError = "You must be logged in to perform this action.";
            return;
        }

        _saving = true;
        try
        {
            var userId = AuthState.UserId.Value;

            var (allocation, err) = await AllocationSvc.AllocateToShelterAsync(
                _allocateStock.StockId,
                _allocateShelterId,
                _allocateQuantity,
                userId
            );

            if (err != null)
            {
                _modalError = err;
                return;
            }

            _allocateSuccess = $"Successfully allocated {_allocateQuantity} {_allocateStock.ReliefGood?.Unit} to shelter.";

            await Task.Delay(1200);

            _showAllocateModal = false;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ClearFilters(MouseEventArgs args)
    {
        _search = string.Empty;
        _statusFilter = string.Empty;
        _showInactive = false;
        _error = string.Empty;

        await LoadAsync();
        StateHasChanged();
    }
}