@page "/stocks"
@using ResQLink.Data.Entities
@using ResQLink.Helpers
@using Microsoft.EntityFrameworkCore
@inject ResQLink.Services.StockService StockSvc
@inject ResQLink.Services.ResourceAllocationService AllocationSvc
@inject ResQLink.Services.InventoryService InventorySvc
@inject ResQLink.Data.AppDbContext Db
@inject ResQLink.Services.AuthState AuthState
@inject IJSRuntime JSRuntime

<div class="stocks-root">
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Stocks Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary" @onclick="OpenAddModal" disabled="@_showModal">
                    <i class="bi bi-box-seam"></i> Add Stock
                </button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh list">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Records</div>
                <div class="kpi-value text-accent">@_stocks.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active</div>
                <div class="kpi-value">@_stocks.Count(s => s.IsActive)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Inactive</div>
                <div class="kpi-value">@_stocks.Count(s => !s.IsActive)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Low / Empty</div>
                <div class="kpi-value">
                    @_stocks.Count(s => GetStatus(s) == "Low")
                    /
                    @_stocks.Count(s => GetStatus(s) == "Empty")
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Stocks Management</h2>
            <div class="panel-actions">
                <input class="mini-input"
                       placeholder="Search item or location…"
                       @bind="_search"
                       @bind:event="oninput" />

                <select class="mini-input" @bind="_statusFilter">
                    <option value="">All Status</option>
                    <option value="Empty">Empty</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>

                <label class="chk-inline">
                    <input type="checkbox" @bind="_showInactive" @bind:after="LoadAsync" />
                    <span>Show Inactive</span>
                </label>

                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="panel-body">
            @if (_loading)
            {
                <p class="t-center text-muted">Loading…</p>
            }
            else if (_stocks == null || _stocks.Count == 0)
            {
                <p class="t-center text-muted">
                    No stocks found.
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <span> Error: @_error</span>
                    }
                </p>
            }
            else if (!FilteredStocks.Any())
            {
                <p class="t-center text-muted">No stocks match your filters.</p>
            }
            else
            {
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th class="t-center col-id">ID</th>
                                <th class="col-item">Relief Good</th>
                                <th class="col-location">Location</th>
                                <th class="t-center col-qty">Qty</th>
                                <th class="t-center col-capacity">Max Cap.</th>
                                <th class="t-center col-status">Status</th>
                                <th class="t-center col-progress">Progress</th>
                                <th class="t-center col-active">Active</th>
                                <th class="col-updated">Last Updated</th>
                                <th class="t-center col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var stock in FilteredStocks)
                            {
                                <tr>
                                    <td class="t-center col-id">@stock.StockId</td>
                                    <td class="col-item">
                                        <strong>@stock.ReliefGood?.Name</strong>
                                        <span class="text-muted">(@stock.ReliefGood?.Unit)</span>
                                    </td>
                                    <td class="col-location">@(!string.IsNullOrWhiteSpace(stock.Location) ? stock.Location : "—")</td>
                                    <td class="t-center col-qty">@stock.Quantity</td>
                                    <td class="t-center col-capacity">@stock.MaxCapacity</td>
                                    <td class="t-center col-status">
                                        <span class="status-chip @GetStatusClass(stock)">
                                            @GetStatus(stock)
                                        </span>
                                    </td>
                                    <td class="t-center col-progress">
                                        <div class="progress-shell thin">
                                            <div class="progress-bar" style="width:@GetPercent(stock)%"></div>
                                        </div>
                                        <span class="progress-text">@GetPercent(stock).ToString("0.0")%</span>
                                    </td>
                                    <td class="t-center col-active">
                                        <span class="status-chip @(stock.IsActive ? "st-active" : "st-contained")">
                                            @(stock.IsActive ? "Yes" : "No")
                                        </span>
                                    </td>
                                    <td class="col-updated">
                                        @stock.LastUpdated.ToString("MMM dd, yyyy HH:mm")
                                    </td>
                                    <td class="action-cell col-actions">
                                        <button class="action-btn edit"
                                                @onclick="() => OpenEditModal(stock)"
                                                title="Edit stock">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="action-btn view"
                                                @onclick="() => OpenAdjustModal(stock)"
                                                title="Adjust quantity">
                                            <i class="bi bi-sliders"></i>
                                        </button>
                                        <button class="action-btn allocate"
                                                @onclick="() => OpenAllocateModal(stock)"
                                                disabled="@(stock.Quantity == 0 || stock.ShelterId != null)"
                                                title="Allocate to shelter">
                                            <i class="bi bi-arrow-up-right-square"></i>
                                        </button>
                                        <button class="action-btn delete"
                                                @onclick="() => DeleteStock(stock.StockId)"
                                                title="Delete stock">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="form-error" style="margin-top:8px;">@_error</div>
            }
        </div>
    </section>

    @* Add / Edit Stock Modal *@
    @if (_showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(_editMode ? "Edit Stock" : "Add Stock")</h3>
                    <button class="modal-close" @onclick="CloseModal">&times;</button>
                </div>
                <div class="modal-body">
                    @if (!_editMode)
                    {
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rgSelect">Relief Good *</label>
                                <select id="rgSelect" class="form-control" @bind="_selectedRgId">
                                    <option value="0">-- Select Relief Good --</option>
                                    @foreach (var rg in _reliefGoods)
                                    {
                                        <option value="@rg.RgId">@rg.Name (@rg.Unit)</option>
                                    }
                                </select>
                            </div>
                        </div>
                    }

                    <div class="form-row">
                        <div class="form-group">
                            <label for="qty">Quantity *</label>
                            <input id="qty" type="number" min="0" class="form-control" @bind="_editQuantity" />
                        </div>
                        <div class="form-group">
                            <label for="maxCap">Max Capacity *</label>
                            <input id="maxCap" type="number" min="1" class="form-control" @bind="_editMaxCapacity" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input id="location" class="form-control" @bind="_editLocation" />
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_modalError))
                    {
                        <div class="form-error">@_modalError</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseModal"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveStock"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            @if (_saving)
                            {
                                <span class="spinner"></span>
                            }
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Adjust quantity modal *@
    @if (_showAdjustModal)
    {
        <div class="modal-overlay" @onclick="CloseAdjustModal" @onclick:stopPropagation="false">
            <div class="modal-dialog modal-sm" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Adjust Stock Quantity</h3>
                    <button class="modal-close" @onclick="CloseAdjustModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current</label>
                            <div>
                                <strong>@_adjustStock?.Quantity</strong>
                                /
                                @_adjustStock?.MaxCapacity
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="adjustDelta">Adjustment (+ or -)</label>
                            <input id="adjustDelta"
                                   type="number"
                                   class="form-control"
                                   @bind="_adjustDelta"
                                   placeholder="e.g., 50 or -20" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>New Quantity</label>
                            <div>
                                <strong>@(_adjustStock != null ? _adjustStock.Quantity + _adjustDelta : 0)</strong>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_modalError))
                    {
                        <div class="form-error">@_modalError</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseAdjustModal"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="ApplyAdjustment"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            @if (_saving)
                            {
                                <span class="spinner"></span>
                            }
                            Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Allocate modal *@
    @if (_showAllocateModal)
    {
        <div class="modal-overlay" @onclick="CloseAllocateModal" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Allocate Stock to Shelter</h3>
                    <button class="modal-close" @onclick="CloseAllocateModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item</label>
                            <div class="text-strong">
                                @_allocateStock?.ReliefGood?.Name (@_allocateStock?.ReliefGood?.Unit)
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Available Quantity</label>
                            <div class="text-strong text-accent">
                                @_allocateStock?.Quantity @_allocateStock?.ReliefGood?.Unit
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="allocShelter">Select Shelter *</label>
                            <select id="allocShelter" class="form-control" @bind="_allocateShelterId">
                                <option value="0">-- Select Shelter --</option>
                                @foreach (var shelter in _shelters)
                                {
                                    <option value="@shelter.ShelterId">@shelter.Name (@shelter.Location)</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="allocQty">Quantity to Allocate *</label>
                            <input id="allocQty"
                                   type="number"
                                   class="form-control"
                                   @bind="_allocateQuantity"
                                   min="1"
                                   max="@(_allocateStock?.Quantity ?? 0)" />
                            <small class="hint">Max: @_allocateStock?.Quantity</small>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_modalError))
                    {
                        <div class="form-error">@_modalError</div>
                    }
                    @if (!string.IsNullOrEmpty(_allocateSuccess))
                    {
                        <div class="success-message">@_allocateSuccess</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseAllocateModal"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="AllocateToShelter"
                                disabled="@_saving"
                                @onclick:stopPropagation="true">
                            @if (_saving)
                            {
                                <span class="spinner"></span>
                            }
                            Allocate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Stock> _stocks = new();
    private List<ReliefGood> _reliefGoods = new();
    private List<Shelter> _shelters = new();
    private bool _loading = true;
    private bool _showModal;
    private bool _showAdjustModal;
    private bool _showAllocateModal;
    private bool _editMode;
    private bool _saving;
    private bool _showInactive;
    private string _search = string.Empty;
    private string _statusFilter = string.Empty;
    private string _error = string.Empty;
    private string _modalError = string.Empty;
    private string _allocateSuccess = string.Empty;

    // Edit fields
    private int _editStockId;
    private int _selectedRgId;
    private int _editQuantity;
    private int _editMaxCapacity = 1000;
    private string _editLocation = string.Empty;

    // Adjust fields
    private Stock? _adjustStock;
    private int _adjustDelta;

    // Allocate fields
    private Stock? _allocateStock;
    private int _allocateShelterId;
    private int _allocateQuantity;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _loading = true;
            _error = string.Empty;

            _stocks = await StockSvc.GetAllAsync(!_showInactive);
            _reliefGoods = await InventorySvc.GetAllAsync();
            _shelters = await Db.Shelters
                .Where(s => s.IsActive)
                .OrderBy(s => s.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _error = $"Error loading stocks: {ex.Message}";
            _stocks = new();
            _reliefGoods = new();
            _shelters = new();
        }
        finally
        {
            _loading = false;
        }
    }

    private decimal GetPercent(Stock stock)
    {
        if (stock.CapacityPercent > 0 || stock.Quantity == 0)
            return stock.CapacityPercent;

        return StockExtensions.ComputePercent(stock.Quantity, stock.MaxCapacity);
    }

    private string GetStatus(Stock stock)
    {
        if (!string.IsNullOrEmpty(stock.Status))
            return stock.Status;

        return StockExtensions.ComputeStatus(stock.Quantity, stock.MaxCapacity);
    }

    private string GetStatusClass(Stock stock) =>
        StockExtensions.GetStatusClass(GetStatus(stock));

    private IEnumerable<Stock> FilteredStocks
    {
        get
        {
            if (_stocks == null || _stocks.Count == 0)
                return Enumerable.Empty<Stock>();

            var q = _stocks.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(_search))
            {
                q = q.Where(s =>
                    (s.ReliefGood?.Name?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (s.Location?.Contains(_search, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            if (!string.IsNullOrWhiteSpace(_statusFilter))
            {
                q = q.Where(s => GetStatus(s).Equals(_statusFilter, StringComparison.OrdinalIgnoreCase));
            }

            return q.OrderBy(s => s.ReliefGood?.Name);
        }
    }

    private void OpenAddModal()
    {
        _editMode = false;
        _showModal = true;
        _modalError = string.Empty;
        _selectedRgId = 0;
        _editStockId = 0;
        _editQuantity = 0;
        _editMaxCapacity = 1000;
        _editLocation = string.Empty;
    }

    private void OpenEditModal(Stock stock)
    {
        _editMode = true;
        _showModal = true;
        _modalError = string.Empty;
        _editStockId = stock.StockId;
        _selectedRgId = stock.RgId;
        _editQuantity = stock.Quantity;
        _editMaxCapacity = stock.MaxCapacity;
        _editLocation = stock.Location ?? string.Empty;
    }

    private void CloseModal()
    {
        if (_saving) return;
        _showModal = false;
    }

    private async Task SaveStock()
    {
        if (_saving) return;
        _modalError = string.Empty;

        if (!_editMode && _selectedRgId == 0)
        {
            _modalError = "Please select a Relief Good.";
            return;
        }

        if (_editQuantity < 0 || _editMaxCapacity <= 0)
        {
            _modalError = "Quantity must be ≥ 0 and capacity must be ≥ 1.";
            return;
        }

        _saving = true;
        try
        {
            (Stock? stock, string? err) result;

            if (_editMode)
            {
                result = await StockSvc.UpdateAsync(_editStockId, _editQuantity, _editMaxCapacity, _editLocation, null, null);
            }
            else
            {
                result = await StockSvc.CreateAsync(_selectedRgId, _editQuantity, _editMaxCapacity, _editLocation);
            }

            if (result.err != null)
            {
                _modalError = result.err;
                return;
            }

            _showModal = false;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private void OpenAdjustModal(Stock stock)
    {
        _adjustStock = stock;
        _adjustDelta = 0;
        _modalError = string.Empty;
        _showAdjustModal = true;
    }

    private void CloseAdjustModal()
    {
        if (_saving) return;
        _showAdjustModal = false;
        _adjustStock = null;
    }

    private async Task ApplyAdjustment()
    {
        if (_saving || _adjustStock == null) return;
        _modalError = string.Empty;

        if (_adjustDelta == 0)
        {
            _modalError = "Adjustment cannot be zero.";
            return;
        }

        _saving = true;
        try
        {
            var (stock, err) = await StockSvc.AdjustQuantityAsync(_adjustStock.StockId, _adjustDelta);

            if (err != null)
            {
                _modalError = err;
                return;
            }

            _showAdjustModal = false;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteStock(int stockId)
    {
        if (_saving) return;

        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete this stock record?");
            if (!confirmed) return;

            _saving = true;
            var (ok, err) = await StockSvc.DeleteAsync(stockId);
            if (!ok && err != null)
                _error = err;

            await LoadAsync();
        }
        catch (Exception ex)
        {
            _error = $"Delete error: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task Refresh()
    {
        await LoadAsync();
    }

    private void OpenAllocateModal(Stock stock)
    {
        _allocateStock = stock;
        _allocateShelterId = 0;
        _allocateQuantity = 0;
        _modalError = string.Empty;
        _allocateSuccess = string.Empty;
        _showAllocateModal = true;
    }

    private void CloseAllocateModal()
    {
        if (_saving) return;
        _showAllocateModal = false;
        _allocateStock = null;
    }

    private async Task AllocateToShelter()
    {
        if (_saving || _allocateStock == null) return;
        _modalError = string.Empty;
        _allocateSuccess = string.Empty;

        if (_allocateShelterId == 0)
        {
            _modalError = "Please select a shelter.";
            return;
        }

        if (_allocateQuantity <= 0)
        {
            _modalError = "Quantity must be greater than zero.";
            return;
        }

        if (_allocateQuantity > _allocateStock.Quantity)
        {
            _modalError = $"Cannot allocate more than available quantity ({_allocateStock.Quantity}).";
            return;
        }

        _saving = true;
        try
        {
            var userId = 1; // TODO: use AuthState when available

            var (allocation, err) = await AllocationSvc.AllocateToShelterAsync(
                _allocateStock.StockId,
                _allocateShelterId,
                _allocateQuantity,
                userId
            );

            if (err != null)
            {
                _modalError = err;
                return;
            }

            _allocateSuccess = $"Successfully allocated {_allocateQuantity} {_allocateStock.ReliefGood?.Unit} to shelter.";

            await Task.Delay(1200);

            _showAllocateModal = false;
            await LoadAsync();
        }
        catch (Exception ex)
        {
            _modalError = $"Error: {ex.Message}";

        }
        finally
        {
            _saving = false;
        }
    }
    private async Task ClearFilters(MouseEventArgs args)
    {
        _search = string.Empty;
        _statusFilter = string.Empty;
        _showInactive = false;
        _error = string.Empty;

        await LoadAsync();
        StateHasChanged();
    }
}