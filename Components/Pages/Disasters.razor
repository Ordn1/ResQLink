@page "/disasters"
@inject ResQLink.Services.IDisasterService DisasterService
@inject IJSRuntime JS
@using ResQLink.Data.Entities

<div class="disasters-root">
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Disasters Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary" @onclick="ShowCreateModal">
                    <i class="bi bi-plus-circle"></i> Add Disaster
                </button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Active</div>
                    <div class="kpi-value">@ActiveCount</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-collection"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total</div>
                    <div class="kpi-value">@AllDisasters.Count</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Open / Active</div>
                    <div class="kpi-value">@OpenOrActiveCount</div>
                </div>
            </div>
        </div>
    </section>

   

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Disasters</h2>
            <div class="panel-actions">
                <input class="mini-input" placeholder="Search title, type or location…" @bind="search" @bind:event="oninput" />
                <select class="mini-input" @bind="severityFilter">
                    <option value="">All Severities</option>
                    <option value="Low">Low</option>
                    <option value="Moderate">Moderate</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
                <select class="mini-input" @bind="statusFilter">
                    <option value="">All Status</option>
                    <option value="Open">Open</option>
                    <option value="Active">Active</option>
                    <option value="Contained">Contained</option>
                    <option value="Closed">Closed</option>
                </select>
                <select class="mini-input" @bind="sortBy">
                    <option value="start_desc">Start: Newest</option>
                    <option value="title_asc">Title: A → Z</option>
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Location</th>
                        <th style="width:120px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var disaster in PagedDisasters)
                    {
                        <tr>
                            <td><strong>@disaster.Title</strong></td>
                            <td>@disaster.DisasterType</td>
                            <td><span class="sev @SevClass(disaster.Severity)">@disaster.Severity</span></td>
                            <td><span class="status-chip @StatusClass(disaster.Status)">@disaster.Status</span></td>
                            <td>@disaster.StartDate.ToString("MMM dd, yyyy")</td>
                            <td>@(disaster.EndDate?.ToString("MMM dd, yyyy") ?? "—")</td>
                            <td>@disaster.Location</td>
                            <td class="action-cell">
                                <button class="action-btn edit" @onclick="() => ShowEditModal(disaster)" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action-btn view" @onclick="() => ShowDetailsModal(disaster)" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="action-btn delete" @onclick="() => ShowDeleteConfirmation(disaster)" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!PagedDisasters.Any())
                    {
                        <tr>
                            <td colspan="8" class="t-center text-muted">No results.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">
                Showing @StartIndex–@EndIndex of @TotalFiltered disasters
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>
</div>

@* Create/Edit Modal *@
@if (showModal)
{
    <div class="modal-overlay" @onclick="async () => await CloseModal()" @onclick:stopPropagation="false">
        <div class="modal-dialog" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditMode ? "Edit Disaster" : "Create New Disaster")</h3>
                <button class="modal-close" @onclick="async () => await CloseModal()" @onclick:stopPropagation="true">&times;</button>
            </div>
            <div class="modal-body">
                <EditForm Model="currentDisaster" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="validation-summary" />

                    <div class="form-row">
                        <div class="form-group">
                            <label for="title">Title *</label>
                            <InputText id="title" @bind-Value="currentDisaster.Title" class="form-control" />
                            <ValidationMessage For="@(() => currentDisaster.Title)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="disasterType">Disaster Type *</label>
                            <InputSelect id="disasterType" @bind-Value="currentDisaster.DisasterType" class="form-control">
                                <option value="">Select Type</option>
                                <option value="Earthquake">Earthquake</option>
                                <option value="Flood">Flood</option>
                                <option value="Typhoon">Typhoon</option>
                                <option value="Fire">Fire</option>
                                <option value="Landslide">Landslide</option>
                                <option value="Volcanic Eruption">Volcanic Eruption</option>
                                <option value="Other">Other</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => currentDisaster.DisasterType)" />
                        </div>
                        <div class="form-group">
                            <label for="severity">Severity *</label>
                            <InputSelect id="severity" @bind-Value="currentDisaster.Severity" class="form-control">
                                <option value="">Select Severity</option>
                                <option value="Low">Low</option>
                                <option value="Moderate">Moderate</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => currentDisaster.Severity)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Status *</label>
                            <InputSelect id="status" @bind-Value="currentDisaster.Status" class="form-control">
                                <option value="">Select Status</option>
                                <option value="Open">Open</option>
                                <option value="Active">Active</option>
                                <option value="Contained">Contained</option>
                                <option value="Closed">Closed</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => currentDisaster.Status)" />
                        </div>
                        <div class="form-group">
                            <label for="location">Location *</label>
                            <InputText id="location" @bind-Value="currentDisaster.Location" class="form-control" />
                            <ValidationMessage For="@(() => currentDisaster.Location)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Start Date *</label>
                            <InputDate id="startDate" 
                                       @bind-Value="currentDisaster.StartDate" 
                                       class="form-control"
                                       max="@DateTime.Now.AddYears(1).ToString("yyyy-MM-dd")" />
                            <ValidationMessage For="@(() => currentDisaster.StartDate)" />
                            <small class="form-text text-muted">Cannot be more than 1 year in the future</small>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <InputDate id="endDate" 
                                       @bind-Value="currentDisaster.EndDate" 
                                       class="form-control"
                                       min="@currentDisaster.StartDate.ToString("yyyy-MM-dd")"
                                       max="@DateTime.Now.AddYears(1).ToString("yyyy-MM-dd")" />
                            <ValidationMessage For="@(() => currentDisaster.EndDate)" />
                            <small class="form-text text-muted">Must be after start date (optional for ongoing disasters)</small>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" @onclick="async () => await CloseModal()" @onclick:stopPropagation="true">Cancel</button>
                        <button type="submit" class="btn-primary" disabled="@isSubmitting" @onclick:stopPropagation="true">
                            @if (isSubmitting)
                            {
                                <span class="spinner"></span>
                            }
                            @(isEditMode ? "Update" : "Create")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Details Modal *@
@if (showDetailsModal && selectedDisaster != null)
{
    <div class="modal-overlay" @onclick="CloseDetailsModal" @onclick:stopPropagation="false">
        <div class="modal-dialog large" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@selectedDisaster.Title - Details</h3>
                <button class="modal-close" @onclick="CloseDetailsModal" @onclick:stopPropagation="true">&times;</button>
            </div>
            <div class="modal-body">
                <div class="details-grid">
                    <div class="detail-item">
                        <label>Disaster Type:</label>
                        <span>@selectedDisaster.DisasterType</span>
                    </div>
                    <div class="detail-item">
                        <label>Severity:</label>
                        <span class="sev @SevClass(selectedDisaster.Severity)">@selectedDisaster.Severity</span>
                    </div>
                    <div class="detail-item">
                        <label>Status:</label>
                        <span class="status-chip @StatusClass(selectedDisaster.Status)">@selectedDisaster.Status</span>
                    </div>
                    <div class="detail-item">
                        <label>Location:</label>
                        <span>@selectedDisaster.Location</span>
                    </div>
                    <div class="detail-item">
                        <label>Start Date:</label>
                        <span>@selectedDisaster.StartDate.ToString("MMMM dd, yyyy 'at' HH:mm")</span>
                    </div>
                    <div class="detail-item">
                        <label>End Date:</label>
                        <span>@(selectedDisaster.EndDate?.ToString("MMMM dd, yyyy 'at' HH:mm") ?? "Ongoing")</span>
                    </div>
                    <div class="detail-item">
                        <label>Created:</label>
                        <span>@selectedDisaster.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</span>
                    </div>
                    <div class="detail-item">
                        <label>Shelters:</label>
                        <span>@selectedDisaster.Shelters.Count shelters</span>
                    </div>
                    <div class="detail-item">
                        <label>Evacuees:</label>
                        <span>@selectedDisaster.Evacuees.Count evacuees</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" @onclick="() => ShowEditModal(selectedDisaster)" @onclick:stopPropagation="true">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn-cancel" @onclick="CloseDetailsModal" @onclick:stopPropagation="true">Close</button>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (showDeleteModal && disasterToDelete != null)
{
    <div class="modal-overlay" @onclick="CloseDeleteModal" @onclick:stopPropagation="false">
        <div class="modal-dialog small" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="modal-close" @onclick="CloseDeleteModal" @onclick:stopPropagation="true">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the disaster <strong>"@disasterToDelete.Title"</strong>?</p>
                <p class="warning-text">This action cannot be undone and will also delete all related data including shelters and evacuees.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseDeleteModal" @onclick:stopPropagation="true">Cancel</button>
                <button class="btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting" @onclick:stopPropagation="true">
                    @if (isDeleting)
                    {
                        <span class="spinner"></span>
                    }
                    Delete
                </button>
            </div>
        </div>
    </div>
}

@code {
    
    private List<Disaster> AllDisasters = new();
    private string search = string.Empty;
    private string severityFilter = string.Empty;
    private string statusFilter = string.Empty;
    private string sortBy = "start_desc";

    // Pagination - matching Evacuees style
    private int _pageIndex = 0;
    private int pageSize = 10;

    // Modal states
    private bool showModal = false;
    private bool showDetailsModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private bool isSubmitting = false;
    private bool isDeleting = false;

    // Current entities
    private Disaster currentDisaster = new();
    private Disaster? selectedDisaster = null;
    private Disaster? disasterToDelete = null;

    protected override async Task OnInitializedAsync() => await LoadDisastersAsync();

    private async Task LoadDisastersAsync()
    {
        try
        {
            AllDisasters = await DisasterService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading disasters: {ex.Message}");
        }
    }

    private IEnumerable<Disaster> Query
    {
        get
        {
            var q = AllDisasters.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(search))
                q = q.Where(d => d.Title.Contains(search, StringComparison.OrdinalIgnoreCase)
                            || d.DisasterType.Contains(search, StringComparison.OrdinalIgnoreCase)
                            || d.Location.Contains(search, StringComparison.OrdinalIgnoreCase));
            
            if (!string.IsNullOrWhiteSpace(severityFilter))
                q = q.Where(d => d.Severity.Equals(severityFilter, StringComparison.OrdinalIgnoreCase));
            
            if (!string.IsNullOrWhiteSpace(statusFilter))
                q = q.Where(d => d.Status.Equals(statusFilter, StringComparison.OrdinalIgnoreCase));
            
            return Sort(q);
        }
    }

    private IEnumerable<Disaster> Sort(IEnumerable<Disaster> source) =>
        sortBy switch
        {
            "title_asc" => source.OrderBy(d => d.Title),
            _ => source.OrderByDescending(d => d.StartDate)
        };

    private int TotalFiltered => Query.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<Disaster> PagedDisasters => Query.Skip(_pageIndex * pageSize).Take(pageSize);

    private int ActiveCount => AllDisasters.Count(d => d.Status.Equals("Active", StringComparison.OrdinalIgnoreCase));
    private int OpenOrActiveCount => AllDisasters.Count(d => d.Status.Equals("Open", StringComparison.OrdinalIgnoreCase) || d.Status.Equals("Active", StringComparison.OrdinalIgnoreCase));

    private string SevClass(string severity) => severity.ToLowerInvariant() switch
    {
        "low" => "sev-low",
        "moderate" => "sev-moderate",
        "high" => "sev-high",
        "critical" => "sev-critical",
        _ => string.Empty
    };

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "open" => "st-active",
        "active" => "st-active",
        "contained" => "st-contained",
        "closed" => "st-monitoring",
        _ => ""
    };

    // Pagination methods - matching Evacuees style
    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    // Event handler to prevent modal from closing when clicking inside
    private void PreventClose()
    {
        // This method intentionally does nothing - it just prevents the click from bubbling up
    }

    // CRUD Operations
    private void ShowCreateModal()
    {
        isEditMode = false;
        currentDisaster = new Disaster
        {
            StartDate = DateTime.Today,
            Status = "Open"
        };
        showModal = true;
    }

    private void ShowEditModal(Disaster disaster)
    {
        CloseDetailsModal();
        isEditMode = true;
        currentDisaster = new Disaster
        {
            DisasterId = disaster.DisasterId,
            Title = disaster.Title,
            DisasterType = disaster.DisasterType,
            Severity = disaster.Severity,
            Status = disaster.Status,
            StartDate = disaster.StartDate,
            EndDate = disaster.EndDate,
            Location = disaster.Location,
            CreatedAt = disaster.CreatedAt
        };
        showModal = true;
    }

    private void ShowDetailsModal(Disaster disaster)
    {
        selectedDisaster = disaster;
        showDetailsModal = true;
    }

    private void ShowDeleteConfirmation(Disaster disaster)
    {
        disasterToDelete = disaster;
        showDeleteModal = true;
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            if (isEditMode)
            {
                var (result, error) = await DisasterService.UpdateAsync(currentDisaster);
                if (error != null)
                {
                    await JS.InvokeVoidAsync("alert", $"Error: {error}");
                    return;
                }
                await JS.InvokeVoidAsync("alert", "Disaster updated successfully!");
            }
            else
            {
                var (result, error) = await DisasterService.CreateAsync(currentDisaster);
                if (error != null)
                {
                    await JS.InvokeVoidAsync("alert", $"Error: {error}");
                    return;
                }
                await JS.InvokeVoidAsync("alert", "Disaster created successfully!");
            }

            await LoadDisastersAsync();
            await CloseModal();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (disasterToDelete == null) return;

        isDeleting = true;
        try
        {
            var success = await DisasterService.DeleteAsync(disasterToDelete.DisasterId);
            if (success)
            {
                await JS.InvokeVoidAsync("alert", "Disaster deleted successfully!");
                await LoadDisastersAsync();
                CloseDeleteModal();
                
                // Adjust current page if needed
                if (_pageIndex >= TotalPages && TotalPages > 0)
                    _pageIndex = TotalPages - 1;
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to delete disaster.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error deleting disaster: {ex.Message}");
        }
        finally
        {
            isDeleting = false;
        }
    }

    // Modal management
    private async Task CloseModal()
    {
        // Ask for confirmation before closing
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to close this form? Any unsaved changes will be lost.");
        if (!confirmed) return;
        
        showModal = false;
        isSubmitting = false;
        currentDisaster = new();
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedDisaster = null;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        disasterToDelete = null;
        isDeleting = false;
    }

    private async void Refresh()
    {
        await LoadDisastersAsync();
        _pageIndex = 0;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        search = string.Empty;
        severityFilter = string.Empty;
        statusFilter = string.Empty;
        sortBy = "start_desc";
        _pageIndex = 0;
    }
}