@page "/disasters"
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities

<div class="disasters-root">
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Disasters Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh">↻</button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Active</div>
                <div class="kpi-value text-accent">@ActiveCount</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Total</div>
                <div class="kpi-value">@All.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Open / Active</div>
                <div class="kpi-value">@OpenOrActiveCount</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Disasters</h2>
            <div class="panel-actions">
                <input class="mini-input" placeholder="Search title, type or location…" @bind="search" @bind:event="oninput" />
                <select class="mini-input" @bind="severityFilter">
                    <option value="">Severity</option>
                    @foreach (var s in DistinctSeverities) { <option>@s</option> }
                </select>
                <select class="mini-input" @bind="statusFilter">
                    <option value="">Status</option>
                    @foreach (var s in DistinctStatuses) { <option>@s</option> }
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th style="width:60px">ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var d in Filtered)
                    {
                        <tr>
                            <td class="t-center">#@d.Id</td>
                            <td>@d.Title</td>
                            <td>@d.Type</td>
                            <td><span class="sev @SevClass(d.Severity)">@d.Severity</span></td>
                            <td><span class="status-chip @StatusClass(d.Status)">@d.Status</span></td>
                            <td>@d.Start.ToString("MMM dd")</td>
                            <td>@(d.End?.ToString("MMM dd") ?? "—")</td>
                            <td>@d.Location</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <footer class="panel-foot">Showing @Filtered.Count() of @All.Count</footer>
    </section>
</div>

@code {
    private record DisasterRow(int Id, string Title, string Type, string Severity, string Status, DateTime Start, DateTime? End, string Location, bool IsActive);

    private List<DisasterRow> All = new();
    private string search = string.Empty;
    private string severityFilter = string.Empty;
    private string statusFilter = string.Empty;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        var list = await Db.Disasters.AsNoTracking().ToListAsync();
        All = list.Select(d => new DisasterRow(
            d.DisasterId,
            d.Title,
            d.DisasterType,
            d.Severity,
            d.Status,
            d.StartDate,
            d.EndDate,
            d.Location,
            d.Status.Equals("Active", StringComparison.OrdinalIgnoreCase)
        )).OrderByDescending(d => d.Start).ToList();
    }

    private IEnumerable<string> DistinctSeverities => All.Select(d => d.Severity).Distinct().OrderBy(s => s);
    private IEnumerable<string> DistinctStatuses => All.Select(d => d.Status).Distinct().OrderBy(s => s);

    private IEnumerable<DisasterRow> Filtered => All
        .Where(d => string.IsNullOrWhiteSpace(search)
                    || d.Title.Contains(search, StringComparison.OrdinalIgnoreCase)
                    || d.Type.Contains(search, StringComparison.OrdinalIgnoreCase)
                    || d.Location.Contains(search, StringComparison.OrdinalIgnoreCase))
        .Where(d => string.IsNullOrWhiteSpace(severityFilter) || d.Severity.Equals(severityFilter, StringComparison.OrdinalIgnoreCase))
        .Where(d => string.IsNullOrWhiteSpace(statusFilter) || d.Status.Equals(statusFilter, StringComparison.OrdinalIgnoreCase))
        .OrderByDescending(d => d.Start);

    private int ActiveCount => All.Count(d => d.Status.Equals("Active", StringComparison.OrdinalIgnoreCase));
    private int OpenOrActiveCount => All.Count(d => d.Status.Equals("Open", StringComparison.OrdinalIgnoreCase) || d.Status.Equals("Active", StringComparison.OrdinalIgnoreCase));

    private string SevClass(string severity) => severity.ToLowerInvariant() switch
    {
        "low" => "sev-low",
        "moderate" => "sev-moderate",
        "high" => "sev-high",
        "critical" => "sev-critical",
        _ => string.Empty
    };

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "open" => "st-active",
        "active" => "st-active",
        "contained" => "st-contained",
        "closed" => "st-monitoring",
        _ => ""
    };

    private async void Refresh()
    {
        await LoadAsync();
        StateHasChanged();
    }
    private void ClearFilters()
    {
        search = string.Empty;
        severityFilter = string.Empty;
        statusFilter = string.Empty;
    }
}