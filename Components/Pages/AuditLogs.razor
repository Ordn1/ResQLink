@page "/audit-logs"
@using System.Linq

<div class="audit-root">

    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Audit Logs Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh" title="Refresh list">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Entries</div>
                <div class="kpi-value text-accent">@AllLogs.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Today</div>
                <div class="kpi-value">@AllLogs.Count(l => l.Timestamp.Date == DateTime.Today)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Actors</div>
                <div class="kpi-value">@DistinctActors.Count()</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Audit Logs</h2>
            <div class="panel-actions">
                <input class="mini-input"
                       placeholder="Search user, resource or details…"
                       @bind="search"
                       @bind:event="oninput" />
                <select class="mini-input" @bind="actorFilter">
                    <option value="">Actor</option>
                    @foreach (var a in DistinctActors)
                    {
                        <option>@a</option>
                    }
                </select>
                <select class="mini-input" @bind="actionFilter">
                    <option value="">Action</option>
                    <option>CREATE</option>
                    <option>UPDATE</option>
                    <option>DELETE</option>
                    <option>LOGIN</option>
                    <option>LOGOUT</option>
                </select>
                <input class="mini-input" type="date" @bind="dateFrom" />
                <input class="mini-input" type="date" @bind="dateTo" />
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh list">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="mini-btn" disabled title="Export not implemented">
                    Export
                </button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th class="t-center col-id">ID</th>
                        <th class="col-time">Timestamp</th>
                        <th class="col-actor">Actor</th>
                        <th class="col-action">Action</th>
                        <th class="col-resource">Resource</th>
                        <th class="col-ip">IP</th>
                        <th class="col-details t-center">Details</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var l in PagedLogs)
                    {
                        <tr>
                            <td class="t-center col-id">#@l.Id</td>
                            <td class="col-time">@l.Timestamp.ToString("yyyy-MM-dd HH:mm")</td>
                            <td class="col-actor">@l.Actor</td>
                            <td class="col-action">
                                <span class="status-chip @ActionClass(l.Action)">@l.Action</span>
                            </td>
                            <td class="col-resource">@l.Resource</td>
                            <td class="t-center col-ip">@l.Ip</td>
                            <td class="t-center col-details">
                                <button class="mini-btn" @onclick="() => ToggleDetails(l.Id)">
                                    @(Expanded.Contains(l.Id) ? "Hide" : "Show")
                                </button>
                            </td>
                        </tr>
                        @if (Expanded.Contains(l.Id))
                        {
                            <tr class="log-details">
                                <td colspan="7">
                                    <div class="details-grid">
                                        <div><strong>User:</strong> @l.Actor</div>
                                        <div><strong>Resource:</strong> @l.Resource</div>
                                        <div><strong>Action:</strong> @l.Action</div>
                                        <div><strong>IP:</strong> @l.Ip</div>
                                        <div><strong>When:</strong> @l.Timestamp.ToString("f")</div>
                                        <div class="details-msg">
                                            <strong>Payload / Notes:</strong>
                                            <pre>@l.Details</pre>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    @if (!PagedLogs.Any())
                    {
                        <tr>
                            <td colspan="7" class="t-center text-muted">No logs match your filters.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">
                Showing @StartIndex–@EndIndex of @TotalFiltered
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>
</div>

@code {
    private class AuditLogItem
    {
        public int Id { get; set; }
        public DateTime Timestamp { get; set; }
        public string Actor { get; set; } = "";
        public string Action { get; set; } = "";
        public string Resource { get; set; } = "";
        public string Ip { get; set; } = "";
        public string Details { get; set; } = "";
    }

    private List<AuditLogItem> AllLogs = new();
    private HashSet<int> Expanded = new();

    // Filters / paging
    private string search = string.Empty;
    private string actorFilter = string.Empty;
    private string actionFilter = string.Empty;
    private DateTime dateFrom = DateTime.Today.AddDays(-7);
    private DateTime dateTo = DateTime.Today;
    private int _pageIndex = 0;
    private int pageSize = 10;

    private IEnumerable<string> DistinctActors =>
        AllLogs.Select(l => l.Actor).Distinct().OrderBy(x => x);

    private IEnumerable<AuditLogItem> Filtered =>
        AllLogs
            .Where(l => l.Timestamp.Date >= dateFrom && l.Timestamp.Date <= dateTo)
            .Where(l => string.IsNullOrWhiteSpace(search)
                        || l.Actor.Contains(search, StringComparison.OrdinalIgnoreCase)
                        || l.Resource.Contains(search, StringComparison.OrdinalIgnoreCase)
                        || l.Details.Contains(search, StringComparison.OrdinalIgnoreCase))
            .Where(l => string.IsNullOrWhiteSpace(actorFilter) || l.Actor.Equals(actorFilter, StringComparison.OrdinalIgnoreCase))
            .Where(l => string.IsNullOrWhiteSpace(actionFilter) || l.Action.Equals(actionFilter, StringComparison.OrdinalIgnoreCase));

    private int TotalFiltered => Filtered.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<AuditLogItem> PagedLogs => Filtered.Skip(_pageIndex * pageSize).Take(pageSize);

    private string ActionClass(string action) => action switch
    {
        "CREATE" => "st-med",
        "UPDATE" => "st-stable",
        "DELETE" => "st-critical",
        "LOGIN" => "st-ok",
        "LOGOUT" => "st-contained",
        _ => ""
    };

    private void ToggleDetails(int id)
    {
        if (!Expanded.Add(id))
            Expanded.Remove(id);
    }

    private void Refresh() => StateHasChanged();

    private void ClearFilters()
    {
        search = string.Empty;
        actorFilter = string.Empty;
        actionFilter = string.Empty;
        dateFrom = DateTime.Today.AddDays(-7);
        dateTo = DateTime.Today;
        _pageIndex = 0;
    }

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }
}