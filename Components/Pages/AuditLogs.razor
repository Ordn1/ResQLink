@page "/admin/audit-logs"
@inject ResQLink.Services.AuditService AuditService
@inject ResQLink.Services.AuthState Auth
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using ResQLink.Data.Entities

<div class="audit-logs-root">
    @if (!Auth.IsAdmin())
    {
        <div class="access-denied">
            <i class="bi bi-shield-x"></i>
            <h2>Access Denied</h2>
            <p>You must be an administrator to view audit logs.</p>
        </div>
        return;
    }

    <!-- Page header -->
    <header class="page-header">
        <div>
            <p class="page-subtitle">
                <i class="bi bi-journal-text"></i>
                Finance‑aligned activity tracking and forensic analysis
            </p>
        </div>

        <div class="page-actions">
            <button class="btn-secondary" @onclick="ClearFilters" title="Clear filters">
                <i class="bi bi-arrow-counterclockwise"></i>
                <span>Clear</span>
            </button>

            <button class="btn-primary" @onclick="ExportLogs" title="Export logs">
                <i class="bi bi-download"></i>
                <span>Export Logs</span>
            </button>
        </div>
    </header>

    <!-- Console-style controls row -->
    <section class="console-panel" aria-label="Audit console">
        <div class="console-head">
            <div class="console-title">AUDIT CONSOLE</div>

            <div class="console-actions">
                <div class="controls-left">
                    <div class="control-item">
                        <label class="sr-only" for="startDate">Start Date</label>
                        <input id="startDate" class="mini-input"
                               type="datetime-local"
                               @bind="filterStartDate" />
                    </div>

                    <div class="control-item">
                        <label class="sr-only" for="endDate">End Date</label>
                        <input id="endDate" class="mini-input"
                               type="datetime-local"
                               @bind="filterEndDate" />
                    </div>

                    <div class="control-item">
                        <select class="mini-input" @bind="filterAction">
                            <option value="">All Actions</option>
                            <option value="LOGIN">Login</option>
                            <option value="LOGOUT">Logout</option>
                            <option value="CREATE">Create</option>
                            <option value="UPDATE">Update</option>
                            <option value="DELETE">Delete</option>
                            <option value="ARCHIVE">Archive</option>
                            <option value="RESTORE">Restore</option>
                            <option value="STOCK_IN">Stock In</option>
                            <option value="STOCK_OUT">Stock Out</option>
                            <option value="APPROVE">Approve</option>
                            <option value="REJECT">Reject</option>
                            <option value="ALLOCATE">Allocate</option>
                        </select>
                    </div>

                    <div class="control-item">
                        <select class="mini-input" @bind="filterSeverity">
                            <option value="">All Severities</option>
                            <option value="Info">Info</option>
                            <option value="Warning">Warning</option>
                            <option value="Error">Error</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div class="control-item">
                        <input class="mini-input"
                               type="text"
                               @bind="filterUserName"
                               placeholder="User Name" />
                    </div>
                </div>

                <div class="controls-right">
                    <button class="btn-primary" @onclick="ApplyFilters" disabled="@isLoading">
                        <i class="bi bi-search"></i>
                        <span>@(isLoading ? "Filtering..." : "Apply Filters")</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- KPI summary cards -->
    <section class="kpi-panel">
        <div class="kpi-grid">
            <!-- INFO -->
            <div class="kpi-card kpi-info">
                <div class="kpi-header">
                    <div class="kpi-label">INFO</div>
                    <div class="kpi-icon-circle">
                        <i class="bi bi-info-circle-fill"></i>
                    </div>
                </div>
                <div class="kpi-value">@logs.Count(l => l.Severity == "Info")</div>
            </div>

            <!-- WARNINGS -->
            <div class="kpi-card" style="border-left:4px solid #f59e0b;">
                <div class="kpi-header">
                    <div class="kpi-label">WARNINGS</div>
                    <div class="kpi-icon-circle" style="background:#fef3c7; color:#b45309;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                </div>
                <div class="kpi-value" style="color:#f59e0b;">
                    @logs.Count(l => l.Severity == "Warning")
                </div>
            </div>

            <!-- ERRORS -->
            <div class="kpi-card kpi-danger">
                <div class="kpi-header">
                    <div class="kpi-label">ERRORS</div>
                    <div class="kpi-icon-circle">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                </div>
                <div class="kpi-value">
                    @logs.Count(l => l.Severity == "Error")
                </div>
            </div>

            <!-- CRITICAL -->
            <div class="kpi-card" style="border-left:4px solid #b91c1c;">
                <div class="kpi-header">
                    <div class="kpi-label">CRITICAL</div>
                    <div class="kpi-icon-circle" style="background:#fee2e2; color:#7f1d1d;">
                        <i class="bi bi-radioactive"></i>
                    </div>
                </div>
                <div class="kpi-value" style="color:#dc2626;">
                    @logs.Count(l => l.Severity == "Critical")
                </div>
            </div>
        </div>
    </section>

    <!-- NEW: Table structure matching Manage User -->
    <div class="audit-table-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading audit logs...</p>
            </div>
        }
        else
        {
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Description</th>
                        <th class="t-center">Severity</th>
                        <th class="t-center">Status</th>
                        <th class="t-center">Details</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var log in PagedLogs)
                    {
                        <tr>
                            <td>
                                <div class="timestamp-cell">
                                    <strong>@log.Timestamp.ToLocalTime().ToString("MMM dd, yyyy")</strong>
                                    <small>@log.Timestamp.ToLocalTime().ToString("HH:mm:ss")</small>
                                </div>
                            </td>

                            <td>
                                <div class="user-info">
                                    <strong>@(log.UserName ?? "System")</strong>
                                    <small>@log.UserType </small>
                                </div>
                            </td>

                            <td>
                                <span class="@GetActionClass(log.Action)">
                                    @log.Action
                                </span>
                            </td>

                            <td>
                                <div class="description-cell" title="@log.Description">
                                    @log.Description
                                </div>
                            </td>

                            <td class="t-center">
                                <span class="@GetSeverityClass(log.Severity)">
                                    @log.Severity
                                </span>
                            </td>

                            <td class="t-center">
                                <span class="@GetStatusClass(log.IsSuccessful)">
                                    @(log.IsSuccessful ? "Success" : "Failed")
                                </span>
                            </td>

                            <td class="t-center">
                                <button class="btn-view-icon"
                                        @onclick="() => ShowDetails(log)"
                                        title="View details">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!PagedLogs.Any())
                    {
                        <tr>
                            <td colspan="7" style="text-align:center; padding: 30px; color: #6b7280;">
                                <i class="bi bi-inbox" style="font-size: 1.5rem; display:block; margin-bottom: 8px;"></i>
                                No logs found matching your criteria.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- NEW: Pagination matching Manage User -->
            @if (TotalFiltered > 0)
            {
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing @StartIndex to @EndIndex of @TotalFiltered entries
                    </div>
                    <div class="pagination-controls">
                        <!-- Keep page size selector but style it subtly to fit -->
                        <select @bind="pageSize" @bind:after="ResetPagination" class="page-size-select">
                            <option value="10">10 / page</option>
                            <option value="25">25 / page</option>
                            <option value="50">50 / page</option>
                            <option value="100">100 / page</option>
                        </select>

                        <button class="btn-page" @onclick="PrevPage" disabled="@(_pageIndex == 0)">
                            <i class="bi bi-chevron-left"></i> Previous
                        </button>

                        <span style="font-size: 0.875rem; margin: 0 8px; color: #374151;">
                            Page @(_pageIndex + 1) of @TotalPages
                        </span>

                        <button class="btn-page" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            }
        }
    </div>


    <!-- Details Modal -->
    @if (selectedLog != null)
    {
        <div class="modal-overlay" @onclick="CloseDetails">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3 class="modal-title">Audit Log Details</h3>
                    <button class="btn-close" @onclick="CloseDetails">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Log ID</label>
                            <span>@selectedLog.AuditLogId</span>
                        </div>

                        <div class="detail-item">
                            <label>Timestamp</label>
                            <span>@selectedLog.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</span>
                        </div>

                        <div class="detail-item">
                            <label>User</label>
                            <span>@selectedLog.UserName (@selectedLog.UserType)</span>
                        </div>

                        <div class="detail-item">
                            <label>Action</label>
                            <span class="@GetActionClass(selectedLog.Action)">@selectedLog.Action</span>
                        </div>

                        <div class="detail-item">
                            <label>Severity</label>
                            <span class="@GetSeverityClass(selectedLog.Severity)">@selectedLog.Severity</span>
                        </div>

                        <div class="detail-item">
                            <label>Status</label>
                            <span class="@GetStatusClass(selectedLog.IsSuccessful)">
                                @(selectedLog.IsSuccessful ? "Success" : "Failed")
                            </span>
                        </div>

                        <div class="detail-item full-width">
                            <label>Description</label>
                            <span>@selectedLog.Description</span>
                        </div>

                        @if (!string.IsNullOrEmpty(selectedLog.IpAddress))
                        {
                            <div class="detail-item">
                                <label>IP Address</label>
                                <span>@selectedLog.IpAddress</span>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(selectedLog.SessionId))
                        {
                            <div class="detail-item full-width">
                                <label>Session ID</label>
                                <span style="word-break:break-all; font-size:0.8rem;">
                                    @selectedLog.SessionId
                                </span>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(selectedLog.ErrorMessage))
                        {
                            <div class="detail-item full-width error-message">
                                <label>Error Message</label>
                                <span>@selectedLog.ErrorMessage</span>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(selectedLog.OldValues))
                        {
                            <div class="detail-item full-width">
                                <label>Old Values</label>
                                <pre class="json-preview">@selectedLog.OldValues</pre>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(selectedLog.NewValues))
                        {
                            <div class="detail-item full-width">
                                <label>New Values</label>
                                <pre class="json-preview">@selectedLog.NewValues</pre>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>
@code {
    private List<AuditLog> logs = new();
    private AuditLog? selectedLog;
    private bool isLoading = true;

    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private string filterAction = "";
    private string filterSeverity = "";
    private string filterUserName = "";

    // Pagination
    private int _pageIndex = 0;
    private int pageSize = 25;

    private int TotalFiltered => logs.Count;
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<AuditLog> PagedLogs => logs.Skip(_pageIndex * pageSize).Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        if (!Auth.IsAdmin())
        {
            await JS.InvokeVoidAsync("alert", "Access denied. Admin privileges required.");
            return;
        }

        await LoadLogs();
    }

    private async Task LoadLogs()
    {
        isLoading = true;
        try
        {
            logs = await AuditService.GetLogsAsync(
                startDate: filterStartDate,
                endDate: filterEndDate,
                action: string.IsNullOrEmpty(filterAction) ? null : filterAction,
                severity: string.IsNullOrEmpty(filterSeverity) ? null : filterSeverity,
                limit: 1000
            );
            if (!string.IsNullOrEmpty(filterUserName))
            {
                logs = logs.Where(l => !string.IsNullOrEmpty(l.UserName) && l.UserName.Contains(filterUserName, StringComparison.OrdinalIgnoreCase)).ToList();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading audit logs: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        _pageIndex = 0;
        await LoadLogs();
    }

    private async Task ClearFilters()
    {
        filterStartDate = null;
        filterEndDate = null;
        filterAction = "";
        filterSeverity = "";
        filterUserName = "";
        _pageIndex = 0;
        await LoadLogs();
    }

    private void ShowDetails(AuditLog log) => selectedLog = log;

    private void CloseDetails() => selectedLog = null;

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    private void ResetPagination()
    {
        _pageIndex = 0;
    }

    private string GetActionClass(string action) => "action-badge"; // All use default colored text now, specificity handled in CSS

    private string GetSeverityClass(string? severity) => severity?.ToUpperInvariant() switch
    {
        "INFO" => "severity-text sev-info",
        "WARNING" => "severity-text sev-warning",
        "ERROR" => "severity-text sev-error",
        "CRITICAL" => "severity-text sev-critical",
        _ => "severity-text"
    };

    private string GetStatusClass(bool isSuccessful) =>
        isSuccessful ? "status-text status-active" : "status-text status-inactive";

    private async Task ExportLogs()
    {
        await JS.InvokeVoidAsync("alert", "Export functionality coming soon!");
    }
}