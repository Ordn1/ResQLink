@page "/reports"
@inject IOperationsReportService ReportService
@inject AuthState Auth
@inject IJSRuntime JS

<div class="reports-root">
    <!-- Header -->
    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Operations Report</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary"
                        @onclick="GenerateOperationsReportAsync"
                        disabled="@_loading">
                    @if (_loading)
                    {
                        <span class="spinner"></span>
                    }
                    <i class="bi bi-file-earmark-pdf"></i>
                    <span class="btn-label">Generate PDF Report</span>
                </button>
                <button class="mini-btn" @onclick="RefreshDataAsync" disabled="@_loading">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
    </section>

    <!-- Modern Modal Popup -->
    @if (showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-container" @onclick:stopPropagation="true">
                <div class="modal-header" style="background: @(modalType == "success" ? "linear-gradient(135deg, #10b981, #059669)" : modalType == "error" ? "linear-gradient(135deg, #ef4444, #dc2626)" : "linear-gradient(135deg, #3b82f6, #2563eb)");">
                    <div class="modal-icon">
                        @if (modalType == "success")
                        {
                            <i class="bi bi-check-circle-fill"></i>
                        }
                        else if (modalType == "error")
                        {
                            <i class="bi bi-exclamation-circle-fill"></i>
                        }
                        else
                        {
                            <i class="bi bi-info-circle-fill"></i>
                        }
                    </div>
                    <h3 class="modal-title">@modalTitle</h3>
                </div>
                <div class="modal-body">
                    <p>@modalMessage</p>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" @onclick="CloseModal">
                        <i class="bi bi-check-lg"></i> OK
                    </button>
                </div>
            </div>
        </div>
    }

    @if (_reportData != null)
    {
        <!-- Page Navigation Header -->
        <div class="panel" style="margin-bottom: 20px;">
            <div style="padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h3 style="margin: 0; font-size: 1.2rem; color: #333;">📄 Page @currentPage of @totalPages</h3>
                    <p style="margin: 4px 0 0 0; color: #666; font-size: 0.9rem;">@GetCurrentPageTitle()</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="mini-btn" @onclick="PreviousPage" disabled="@(currentPage == 1)" style="@(currentPage == 1 ? "opacity: 0.5; cursor: not-allowed;" : "")">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <button class="mini-btn btn-primary" @onclick="NextPage" disabled="@(currentPage == totalPages)" style="@(currentPage == totalPages ? "opacity: 0.5; cursor: not-allowed;" : "")">
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        @if (currentPage == 1)
        {
        <!-- Executive Summary -->
        <section class="panel" id="executive-summary">
            <header class="panel-head">
                <h3 class="panel-title">1. Executive Summary</h3>
            </header>
            <div class="kpi-grid" style="padding: 16px;">
                <div class="kpi-card">
                    <div class="kpi-label">Active Disasters</div>
                    <div class="kpi-value text-accent">@_reportData.Summary.ActiveDisasters</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Evacuees</div>
                    <div class="kpi-value">@_reportData.Summary.TotalEvacuees</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Active Shelters</div>
                    <div class="kpi-value">@_reportData.Summary.ActiveShelters</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Volunteers</div>
                    <div class="kpi-value">@_reportData.Summary.TotalVolunteers</div>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(_reportData.Summary.CurrentDisasterOverview))
            {
                <div style="padding: 16px; border-top: 1px solid #e5e7eb; background: #f0f9ff;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 8px;">
                        <i class="bi bi-info-circle" style="margin-right: 6px;"></i>
                        Current Disaster Overview
                    </h4>
                    <p style="margin: 0; font-size: 0.85rem; line-height: 1.6;">
                        @_reportData.Summary.CurrentDisasterOverview
                    </p>
                </div>
            }
        </section>
        }

        @if (currentPage == 2)
        {
        <!-- Disaster Overview -->
        <section class="panel" id="disaster-overview">
            <header class="panel-head">
                <h3 class="panel-title">2. Disaster Overview</h3>
            </header>
            <div class="table-wrap">
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Disaster Name</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Affected Barangays</th>
                            <th>Days Active</th>
                            <th>Start Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var disaster in _reportData.ActiveDisasters)
                        {
                            <tr>
                                <td><strong>@disaster.Title</strong></td>
                                <td>@disaster.DisasterType</td>
                                <td>
                                    <span class="severity-@disaster.Severity.ToLower()">
                                        @disaster.Severity
                                    </span>
                                </td>
                                <td>@string.Join(", ", disaster.AffectedBarangays)</td>
                                <td>@disaster.DaysActive</td>
                                <td>@disaster.StartDate.ToString("MMM dd, yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>
        }

        @if (currentPage == 3)
        {
        <!-- Evacuee Demographics -->
        <section class="panel" id="evacuee-stats">
            <header class="panel-head">
                <h3 class="panel-title">3. Evacuee Statistics</h3>
            </header>
            <div class="kpi-grid" style="padding: 16px;">
                <div class="kpi-card">
                    <div class="kpi-label">Total Evacuees</div>
                    <div class="kpi-value">@_reportData.EvacueeStats.TotalEvacuees</div>
                </div>
            </div>

            @if (_reportData.EvacueeStats.ByStatus.Any())
            {
                <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Distribution by Status</h4>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        @foreach (var status in _reportData.EvacueeStats.ByStatus)
                        {
                            <div style="padding: 12px 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">@status.Key</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">@status.Value</div>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (_reportData.EvacueeStats.ByShelter.Any())
            {
                <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Distribution by Shelter</h4>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        @foreach (var shelter in _reportData.EvacueeStats.ByShelter)
                        {
                            <div style="padding: 12px 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">@shelter.Key</div>
                                <div style="font-size: 1.5rem; font-weight: 700;">@shelter.Value</div>
                            </div>
                        }
                    </div>
                </div>
            }
        </section>
        }

        @if (currentPage == 4)
        {
        <!-- Shelter Operations -->
        <section class="panel" id="shelter-ops">
            <header class="panel-head">
                <h3 class="panel-title">4. Shelter Operations Report</h3>
            </header>
            <div class="table-wrap">
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Shelter Name</th>
                            <th>Location</th>
                            <th>Capacity</th>
                            <th>Occupancy</th>
                            <th>% Full</th>
                            <th>Volunteers</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var shelter in _reportData.ShelterOps.ActiveShelters)
                        {
                            <tr>
                                <td><strong>@shelter.Name</strong></td>
                                <td>@shelter.Location</td>
                                <td>@shelter.Capacity</td>
                                <td>@shelter.CurrentOccupancy</td>
                                <td>@shelter.OccupancyPercent.ToString("F1")%</td>
                                <td>@shelter.AssignedVolunteers</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (_reportData.ShelterOps.Needs.Any())
            {
                <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Shelter Needs Assessment</h4>
                    @foreach (var need in _reportData.ShelterOps.Needs)
                    {
                        <div style="padding: 8px; margin-bottom: 8px; border-left: 3px solid #ef4444; background: #fef2f2;">
                            <strong>[@need.Priority]</strong> @need.ShelterName - @need.ItemName:
                            Current: @need.CurrentQuantity, Need: @need.RequiredQuantity
                        </div>
                    }
                </div>
            }
        </section>
        }

        @if (currentPage == 5)
        {
        <!-- Financial Summary Section - RENUMBERED from 4.5 to 5 -->
        <section class="panel" id="financial-summary">
            <header class="panel-head">
                <h3 class="panel-title">5. Financial Summary</h3>
            </header>

            <!-- Financial KPIs -->
            <div class="kpi-grid" style="padding: 16px;">
                <div class="kpi-card">
                    <div class="kpi-label">Funds Received (Procurement)</div>
                    <div class="kpi-value" style="color: #16a34a;">₱@_reportData.FinancialInfo.TotalFundsReceived.ToString("N2")</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Total Expenditures</div>
                    <div class="kpi-value" style="color: #dc2626;">₱@_reportData.FinancialInfo.TotalExpenditures.ToString("N2")</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Balance</div>
                    <div class="kpi-value text-accent">₱@_reportData.FinancialInfo.Balance.ToString("N2")</div>
                    <div class="kpi-trend @((_reportData.FinancialInfo.Balance >= 0) ? "up" : "down")">
                        @((_reportData.FinancialInfo.Balance >= 0) ? "Surplus" : "Deficit")
                    </div>
                </div>
            </div>

            <!-- Procurement Breakdown -->
            @if (_reportData.FinancialInfo.ProcurementBreakdown.Any())
            {
                <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">
                        <i class="bi bi-cart3" style="margin-right: 6px;"></i>
                        Procurement Requests Breakdown
                    </h4>
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Request ID</th>
                                    <th>Barangay</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                    <th class="t-right">Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var procurement in _reportData.FinancialInfo.ProcurementBreakdown)
                                {
                                    <tr>
                                        <td><strong>#@procurement.RequestId</strong></td>
                                        <td>@procurement.BarangayName</td>
                                        <td>@procurement.Supplier</td>
                                        <td>
                                            <span class="status-chip status-@procurement.Status.ToLower()">
                                                @procurement.Status
                                            </span>
                                        </td>
                                        <td class="t-right">₱@procurement.Amount.ToString("N2")</td>
                                        <td>@procurement.RequestDate.ToString("MMM dd, yyyy")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="background: #f9fafb; font-weight: 700;">
                                    <td colspan="4" class="t-right">Total Procurement:</td>
                                    <td class="t-right" style="color: #16a34a;">
                                        ₱@_reportData.FinancialInfo.TotalFundsReceived.ToString("N2")
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            }

            <!-- Expenditures Breakdown -->
            @if (_reportData.FinancialInfo.ExpenditureBreakdown.Any())
            {
                <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">
                        <i class="bi bi-wallet2" style="margin-right: 6px;"></i>
                        Expenditures Breakdown
                    </h4>
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Reference</th>
                                    <th class="t-right">Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var expenditure in _reportData.FinancialInfo.ExpenditureBreakdown)
                                {
                                    <tr>
                                        <td><strong>@expenditure.Category</strong></td>
                                        <td>@expenditure.Description</td>
                                        <td>@expenditure.Reference</td>
                                        <td class="t-right">₱@expenditure.Amount.ToString("N2")</td>
                                        <td>@expenditure.Date.ToString("MMM dd, yyyy")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="background: #f9fafb; font-weight: 700;">
                                    <td colspan="3" class="t-right">Total Expenditures:</td>
                                    <td class="t-right" style="color: #dc2626;">
                                        ₱@_reportData.FinancialInfo.TotalExpenditures.ToString("N2")
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            }

            <!-- Balance Summary -->
            <div style="padding: 16px; border-top: 2px solid #e5e7eb; background: #f9fafb;">
                <div style="display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto;">
                    <div>
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            Current Balance
                        </div>
                        <div style="font-size: 2rem; font-weight: 800; color: @((_reportData.FinancialInfo.Balance >= 0) ? "#16a34a" : "#dc2626");">
                            ₱@_reportData.FinancialInfo.Balance.ToString("N2")
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">Status</div>
                        <span class="status-chip @((_reportData.FinancialInfo.Balance >= 0) ? "status-approved" : "status-draft")"
                              style="font-size: 0.85rem; padding: 6px 14px;">
                            @((_reportData.FinancialInfo.Balance >= 0) ? "✓ Surplus" : "⚠ Deficit")
                        </span>
                    </div>
                </div>
            </div>

            @if (_reportData.FinancialInfo.ProcurementBreakdown.Count == 0 && _reportData.FinancialInfo.ExpenditureBreakdown.Count == 0)
            {
                <div style="padding: 40px; text-align: center; color: #666; font-style: italic;">
                    <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 10px; opacity: 0.5;"></i>
                    No financial transactions recorded for this reporting period.
                </div>
            }
        </section>
        }

        @if (currentPage == 6)
        {
        <!-- Volunteer Deployment - RENUMBERED from 5 to 6 -->
        <section class="panel" id="volunteer-deployment">
            <header class="panel-head">
                <h3 class="panel-title">6. Volunteer Deployment Report</h3>
                <span class="card-badge">@_reportData.VolunteerInfo.TotalActiveVolunteers active</span>
            </header>
            <div class="table-wrap">
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Volunteer Name</th>
                            <th>Assigned Shelter</th>
                            <th>Skills</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var volunteer in _reportData.VolunteerInfo.Assignments)
                        {
                            <tr>
                                <td>@volunteer.VolunteerName</td>
                                <td>@volunteer.AssignedShelter</td>
                                <td>@volunteer.Skills</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>
        }

        @if (currentPage == 7)
        {
        <!-- Inventory Report - RENUMBERED from 6 to 7 -->
        <section class="panel" id="inventory-report">
            <header class="panel-head">
                <h3 class="panel-title">7. Inventory Report</h3>
            </header>

            <!-- 7.1 Executive Summary -->
            <div style="padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-clipboard-data" style="margin-right: 6px;"></i>
                    Executive Summary
                </h4>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Total Items in Stock</div>
                        <div class="kpi-value">@_reportData.InventoryInfo.ExecutiveSummary.TotalItemsInStock</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Stock Received (Period)</div>
                        <div class="kpi-value" style="color: #16a34a;">@_reportData.InventoryInfo.ExecutiveSummary.TotalStockReceived</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Stock Released (Period)</div>
                        <div class="kpi-value" style="color: #dc2626;">@_reportData.InventoryInfo.ExecutiveSummary.TotalStockReleased</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Overall Condition</div>
                        <div class="kpi-value text-accent">@_reportData.InventoryInfo.ExecutiveSummary.OverallCondition</div>
                    </div>
                </div>

                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #ef4444;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <i class="bi bi-exclamation-triangle-fill" style="color: #ef4444; font-size: 1.2rem;"></i>
                        <strong style="font-size: 0.9rem;">Critical Stock Alerts</strong>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div>
                            <span style="font-size: 0.75rem; color: #666;">Critically Low Items:</span>
                            <span style="font-size: 1.1rem; font-weight: 700; color: #ef4444; margin-left: 8px;">
                                @_reportData.InventoryInfo.ExecutiveSummary.CriticallyLowItems
                            </span>
                        </div>
                        <div>
                            <span style="font-size: 0.75rem; color: #666;">Low Stock Items:</span>
                            <span style="font-size: 1.1rem; font-weight: 700; color: #f59e0b; margin-left: 8px;">
                                @_reportData.InventoryInfo.ExecutiveSummary.LowStockItems
                            </span>
                        </div>
                    </div>
                </div>

                @if (_reportData.InventoryInfo.ExecutiveSummary.ImmediateProcurementNeeds.Any())
                {
                    <div style="margin-top: 12px; padding: 12px; background: #fef2f2; border-radius: 8px;">
                        <strong style="font-size: 0.85rem; display: block; margin-bottom: 8px;">
                            <i class="bi bi-cart-plus" style="margin-right: 4px;"></i>
                            Immediate Procurement Requirements:
                        </strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            @foreach (var item in _reportData.InventoryInfo.ExecutiveSummary.ImmediateProcurementNeeds)
                            {
                                <span style="padding: 4px 12px; background: white; border-radius: 16px; font-size: 0.75rem; border: 1px solid #ef4444; color: #ef4444;">
                                    @item
                                </span>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- 7.2 Current Inventory Status -->
            <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-box-seam" style="margin-right: 6px;"></i>
                    Current Inventory Status
                </h4>

                @if (_reportData.InventoryInfo.CurrentInventory.Any())
                {
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Available Qty</th>
                                    <th>Unit</th>
                                    <th>Stock Level</th>
                                    <th>Storage Location</th>
                                    <th>Expiration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in _reportData.InventoryInfo.CurrentInventory)
                                {
                                    <tr>
                                        <td><strong>@item.ItemName</strong></td>
                                        <td>
                                            <span style="font-size: 0.75rem; padding: 2px 8px; background: #f3f4f6; border-radius: 4px;">
                                                @item.Category
                                            </span>
                                        </td>
                                        <td>@item.AvailableQuantity</td>
                                        <td>@item.Unit</td>
                                        <td>
                                            <span class="status-chip" style="background: @GetStockLevelColor(item.StockLevel); color: white;">
                                                @item.StockLevel
                                            </span>
                                        </td>
                                        <td>@item.StorageLocation</td>
                                        <td style="font-size: 0.85rem;">
                                            @if (item.ExpirationDate.HasValue)
                                            {
                                                <span style="color: @(item.ExpirationDate.Value < DateTime.Now.AddDays(30) ? "#ef4444" : "#666");">
                                                    @item.ExpirationDate.Value.ToString("MMM dd, yyyy")
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="color: #666;">N/A</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                        No inventory items found.
                    </p>
                }
            </div>

            <!-- 7.3 Stock-In Summary -->
            <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-arrow-down-circle" style="margin-right: 6px; color: #16a34a;"></i>
                    Stock-In Summary (Recent Transactions)
                </h4>

                @if (_reportData.InventoryInfo.StockInSummary.Any())
                {
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Item Name</th>
                                    <th>Quantity</th>
                                    <th>Supplier</th>
                                    <th>Batch Number</th>
                                    <th>Expiration</th>
                                    <th>Received Date</th>
                                    <th>Received By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in _reportData.InventoryInfo.StockInSummary.Take(20))
                                {
                                    <tr>
                                        <td><strong>#@transaction.TransactionId</strong></td>
                                        <td>@transaction.ItemName</td>
                                        <td style="color: #16a34a; font-weight: 600;">+@transaction.Quantity @transaction.Unit</td>
                                        <td>@transaction.Supplier</td>
                                        <td style="font-family: monospace; font-size: 0.8rem;">@transaction.BatchNumber</td>
                                        <td style="font-size: 0.85rem;">
                                            @if (transaction.ExpirationDate.HasValue)
                                            {
                                                @transaction.ExpirationDate.Value.ToString("MMM dd, yyyy")
                                            }
                                            else
                                            {
                                                <span style="color: #666;">N/A</span>
                                            }
                                        </td>
                                        <td>@transaction.ReceivedDate.ToString("MMM dd, yyyy")</td>
                                        <td>@transaction.ReceivedBy</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                        No stock-in transactions recorded.
                    </p>
                }
            </div>

            <!-- 7.4 Stock-Out Summary -->
            <div style="padding: 16px;">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-arrow-up-circle" style="margin-right: 6px; color: #dc2626;"></i>
                    Stock-Out Summary (Recent Transactions)
                </h4>

                @if (_reportData.InventoryInfo.StockOutSummary.Any())
                {
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Item Name</th>
                                    <th>Qty Released</th>
                                    <th>Destination</th>
                                    <th>Purpose</th>
                                    <th>Release Date</th>
                                    <th>Released By</th>
                                    <th>Remaining</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in _reportData.InventoryInfo.StockOutSummary.Take(20))
                                {
                                    <tr>
                                        <td><strong>#@transaction.TransactionId</strong></td>
                                        <td>@transaction.ItemName</td>
                                        <td style="color: #dc2626; font-weight: 600;">-@transaction.QuantityReleased @transaction.Unit</td>
                                        <td>@transaction.Destination</td>
                                        <td>
                                            <span style="font-size: 0.75rem; padding: 2px 8px; background: #f3f4f6; border-radius: 4px;">
                                                @transaction.Purpose
                                            </span>
                                        </td>
                                        <td>@transaction.ReleaseDate.ToString("MMM dd, yyyy")</td>
                                        <td>@transaction.ReleasedBy</td>
                                        <td style="font-weight: 600;">@transaction.RemainingBalance</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                        No stock-out transactions recorded.
                    </p>
                }
            </div>
        </section>
        }

        @if (currentPage == 8)
        {
        <!-- Operational Issues - RENUMBERED from 7 to 8 -->
        <section class="panel" id="operational-issues">
            <header class="panel-head">
                <h3 class="panel-title">8. Operational Issues & Recommendations</h3>
                <button class="mini-btn" @onclick="ToggleEditMode">
                    <i class="bi @(isEditingIssues ? "bi-x" : "bi-pencil")"></i>
                    @(isEditingIssues ? "Cancel" : "Edit")
                </button>
            </header>
            <div style="padding: 16px;">
                @if (isEditingIssues)
                {
                    <div class="form-group">
                        <label>Needed Support</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.NeededSupport"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Urgent Supplies</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.UrgentSupplies"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Funding Requests</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.FundingRequests"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Concerns</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.Concerns"></textarea>
                    </div>
                    <button class="btn-primary" @onclick="SaveIssuesAsync">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                }
                else
                {
                    @if (!string.IsNullOrEmpty(_reportData.Issues.NeededSupport))
                    {
                        <div><strong>Needed Support:</strong> @_reportData.Issues.NeededSupport</div>
                    }
                    @if (!string.IsNullOrEmpty(_reportData.Issues.UrgentSupplies))
                    {
                        <div><strong>Urgent Supplies:</strong> @_reportData.Issues.UrgentSupplies</div>
                    }
                    @if (!string.IsNullOrEmpty(_reportData.Issues.FundingRequests))
                    {
                        <div><strong>Funding Requests:</strong> @_reportData.Issues.FundingRequests</div>
                    }
                    @if (!string.IsNullOrEmpty(_reportData.Issues.Concerns))
                    {
                        <div><strong>Concerns:</strong> @_reportData.Issues.Concerns</div>
                    }

                    @if (string.IsNullOrEmpty(_reportData.Issues.NeededSupport) &&
                                string.IsNullOrEmpty(_reportData.Issues.UrgentSupplies) &&
                                string.IsNullOrEmpty(_reportData.Issues.FundingRequests) &&
                                string.IsNullOrEmpty(_reportData.Issues.Concerns))
                    {
                        <p style="color: #666; font-style: italic;">No operational issues reported at this time.</p>
                    }
                }
            </div>
        </section>
        }
    }
    else if (!_loading)
    {
        <section class="panel panel-empty">
            <div class="empty-state">
                <i class="bi bi-file-text" aria-hidden="true"></i>
                <h3>No Report Generated</h3>
                <p>Click <strong>Refresh</strong> to load report data or <strong>Generate PDF Report</strong> to create a comprehensive operations report.</p>
            </div>
        </section>
    }
</div>

@code {
    private OperationsReportData? _reportData;
    private bool _loading = false;
    private bool isEditingIssues = false;
    private int currentPage = 1;
    private const int totalPages = 8;

    // Modal state
    private bool showModal = false;
    private string modalTitle = "";
    private string modalMessage = "";
    private string modalType = "info"; // success, error, info

    protected override async Task OnInitializedAsync()
    {
        await RefreshDataAsync();
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            StateHasChanged();
            _ = JS.InvokeVoidAsync("window.scrollTo", 0, 0);
        }
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            StateHasChanged();
            _ = JS.InvokeVoidAsync("window.scrollTo", 0, 0);
        }
    }

    private string GetCurrentPageTitle()
    {
        return currentPage switch
        {
            1 => "1. Executive Summary",
            2 => "2. Disaster Overview",
            3 => "3. Evacuee Statistics",
            4 => "4. Shelter Operations Report",
            5 => "5. Financial Summary",
            6 => "6. Volunteer Deployment Report",
            7 => "7. Inventory Report",
            8 => "8. Operational Issues & Recommendations",
            _ => ""
        };
    }

    private void ShowModal(string title, string message, string type = "info")
    {
        modalTitle = title;
        modalMessage = message;
        modalType = type;
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        StateHasChanged();
    }

    private async Task RefreshDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _reportData = await ReportService.GenerateReportDataAsync();
            _reportData.GeneratedBy = Auth.CurrentUser?.Username ?? "System";
        }
        catch (Exception ex)
        {
            ShowModal("Error", $"Error loading report data: {ex.Message}", "error");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateOperationsReportAsync()
    {
        if (_reportData == null)
        {
            await RefreshDataAsync();
            if (_reportData == null) return;
        }

        _loading = true;
        StateHasChanged();

        try
        {
            var pdfBytes = await ReportService.GeneratePdfReportAsync(_reportData);
            var fileName = $"Operations_Report_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            var base64 = Convert.ToBase64String(pdfBytes);
            await JS.InvokeVoidAsync("eval", $@"
                const link = document.createElement('a');
                link.download = '{fileName}';
                link.href = 'data:application/pdf;base64,{base64}';
                link.click();
            ");

            ShowModal("Success", "Operations Report PDF generated successfully!", "success");
        }
        catch (Exception ex)
        {
            ShowModal("Error", $"Error generating PDF: {ex.Message}", "error");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ToggleEditMode()
    {
        isEditingIssues = !isEditingIssues;
    }

    private async Task SaveIssuesAsync()
    {
        if (_reportData == null) return;

        try
        {
            await ReportService.SaveOperationalIssuesAsync(_reportData.Issues);
            ShowModal("Success", "Operational issues saved successfully!", "success");
            isEditingIssues = false;
        }
        catch (Exception ex)
        {
            ShowModal("Error", $"Error saving issues: {ex.Message}", "error");
        }
    }

    private string GetStockLevelColor(string stockLevel)
    {
        return stockLevel switch
        {
            "Critical" => "#ef4444",
            "Low" => "#f59e0b",
            "Normal" => "#10b981",
            _ => "#6b7280"
        };
    }
}