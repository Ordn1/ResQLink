@page "/reports"
@inject IOperationsReportService ReportService
@inject AuthState Auth
@inject IJSRuntime JS

<div class="reports-root">
    <!-- Header -->
    <section class="panel">
        <header class="panel-head panel-head-inline">
            <h2 class="panel-title">Operations Report</h2>

            <div class="panel-actions-right">
                <button class="mini-btn"
                        @onclick="RefreshDataAsync"
                        disabled="@_loading">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
                <button class="mini-btn btn-primary"
                        @onclick="GenerateOperationsReportAsync"
                        disabled="@_loading">
                    @if (_loading)
                    {
                        <span class="spinner"></span>
                    }
                    <i class="bi bi-file-earmark-pdf"></i>
                    <span class="btn-label">Generate PDF Report</span>
                </button>
            </div>
        </header>
    </section>

    @if (_reportData != null)
    {
        <!-- Executive Summary -->
        <section class="panel" id="executive-summary">
            <header class="panel-head">
                <h3 class="panel-title">1. Executive Summary</h3>
            </header>

            <!-- Standardized KPI Grid -->
            <div class="kpi-grid">
                <!-- Active Disasters -->
                <div class="kpi-card kpi-danger">
                    <div class="kpi-header">
                        <div class="kpi-label">ACTIVE DISASTERS</div>
                        <div class="kpi-icon-circle">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        @_reportData.Summary.ActiveDisasters
                    </div>
                    <div class="kpi-footer">
                        <span class="trend-badge trend-neutral">Ongoing</span>
                    </div>
                </div>

                <!-- Total Evacuees -->
                <div class="kpi-card kpi-info">
                    <div class="kpi-header">
                        <div class="kpi-label">TOTAL EVACUEES</div>
                        <div class="kpi-icon-circle">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        @_reportData.Summary.TotalEvacuees
                    </div>
                    <div class="kpi-footer">
                        <span class="trend-badge trend-up">Registered</span>
                    </div>
                </div>

                <!-- Active Shelters -->
                <div class="kpi-card kpi-primary">
                    <div class="kpi-header">
                        <div class="kpi-label">ACTIVE SHELTERS</div>
                        <div class="kpi-icon-circle">
                            <i class="bi bi-house-fill"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        @_reportData.Summary.ActiveShelters
                    </div>
                    <div class="kpi-footer">
                        <span class="trend-badge trend-neutral">Operational</span>
                    </div>
                </div>

                <!-- Total Volunteers -->
                <div class="kpi-card kpi-success">
                    <div class="kpi-header">
                        <div class="kpi-label">TOTAL VOLUNTEERS</div>
                        <div class="kpi-icon-circle">
                            <i class="bi bi-person-heart"></i>
                        </div>
                    </div>
                    <div class="kpi-value">
                        @_reportData.Summary.TotalVolunteers
                    </div>
                    <div class="kpi-footer">
                        <span class="trend-badge trend-neutral">Available</span>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_reportData.Summary.CurrentDisasterOverview))
            {
                <div style="padding: 16px; border-top: 1px solid var(--border); background: #f0f9ff; margin: 0 16px 16px 16px; border-radius: 8px;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 8px; color: #0369a1;">
                        <i class="bi bi-info-circle" style="margin-right: 6px;"></i>
                        Current Disaster Overview
                    </h4>
                    <p style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #0c4a6e;">
                        @_reportData.Summary.CurrentDisasterOverview
                    </p>
                </div>
            }
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                    <i class="bi bi-arrow-up"></i> Top
                </button>
                <span class="pagination-label">📋 End of Executive Summary</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=disaster-overview]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Disaster Overview -->
        <section class="panel" id="disaster-overview">
            <header class="panel-head">
                <h3 class="panel-title">2. Disaster Overview</h3>
            </header>
            <div class="table-wrap">
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Disaster Name</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Affected Barangays</th>
                            <th>Days Active</th>
                            <th>Start Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var disaster in _reportData.ActiveDisasters)
                        {
                            <tr>
                                <td><strong>@disaster.Title</strong></td>
                                <td>@disaster.DisasterType</td>
                                <td>
                                    <span class="severity-badge severity-@disaster.Severity.ToLower()">
                                        @disaster.Severity
                                    </span>
                                </td>
                                <td>@string.Join(", ", disaster.AffectedBarangays)</td>
                                <td>@disaster.DaysActive</td>
                                <td>@disaster.StartDate.ToString("MMM dd, yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="document.querySelector('[id=executive-summary]')?.scrollIntoView({behavior: 'smooth'})">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <span class="pagination-label">📊 End of Disaster Overview Table</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=evacuee-stats]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Evacuee Demographics -->
        <section class="panel" id="evacuee-stats">
            <header class="panel-head">
                <h3 class="panel-title">3. Evacuee Statistics</h3>
            </header>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">TOTAL EVACUEES</div>
                        <div class="kpi-icon-circle">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                    <div class="kpi-value">@_reportData.EvacueeStats.TotalEvacuees</div>
                </div>
            </div>

            @if (_reportData.EvacueeStats.ByStatus.Any())
            {
                <div style="padding: 16px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Distribution by Status</h4>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        @foreach (var status in _reportData.EvacueeStats.ByStatus)
                        {
                            <div class="stat-pill">
                                <div class="stat-label">@status.Key</div>
                                <div class="stat-num">@status.Value</div>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (_reportData.EvacueeStats.ByShelter.Any())
            {
                <div style="padding: 16px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Distribution by Shelter</h4>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        @foreach (var shelter in _reportData.EvacueeStats.ByShelter)
                        {
                            <div class="stat-pill">
                                <div class="stat-label">@shelter.Key</div>
                                <div class="stat-num">@shelter.Value</div>
                            </div>
                        }
                    </div>
                </div>
            }
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="document.querySelector('[id=disaster-overview]')?.scrollIntoView({behavior: 'smooth'})">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <span class="pagination-label">👥 End of Evacuee Statistics</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=shelter-ops]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Shelter Operations -->
        <section class="panel" id="shelter-ops">
            <header class="panel-head">
                <h3 class="panel-title">4. Shelter Operations Report</h3>
            </header>
            <div class="table-wrap">
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Shelter Name</th>
                            <th>Location</th>
                            <th>Capacity</th>
                            <th>Occupancy</th>
                            <th>% Full</th>
                            <th>Volunteers</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var shelter in _reportData.ShelterOps.ActiveShelters)
                        {
                            <tr>
                                <td><strong>@shelter.Name</strong></td>
                                <td>@shelter.Location</td>
                                <td>@shelter.Capacity</td>
                                <td>@shelter.CurrentOccupancy</td>
                                <td>@shelter.OccupancyPercent.ToString("F1")%</td>
                                <td>@shelter.AssignedVolunteers</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (_reportData.ShelterOps.Needs.Any())
            {
                <div style="padding: 16px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Shelter Needs Assessment</h4>
                    @foreach (var need in _reportData.ShelterOps.Needs)
                    {
                        <div class="needs-alert">
                            <strong>[@need.Priority]</strong> @need.ShelterName - @need.ItemName:
                            Current: @need.CurrentQuantity, Need: @need.RequiredQuantity
                        </div>
                    }
                </div>
            }
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="document.querySelector('[id=evacuee-stats]')?.scrollIntoView({behavior: 'smooth'})">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <span class="pagination-label">🏠 End of Shelter Operations Table</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=financial-summary]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Financial Summary -->
        <section class="panel" id="financial-summary">
            <header class="panel-head">
                <h3 class="panel-title">5. Financial Summary</h3>
            </header>

            <!-- Financial KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">FUNDS RECEIVED</div>
                        <div class="kpi-icon-circle" style="background: #dcfce7; color: #16a34a;">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                    </div>
                    <div class="kpi-value" style="color: #16a34a;">₱@_reportData.FinancialInfo.TotalFundsReceived.ToString("N2")</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">EXPENDITURES</div>
                        <div class="kpi-icon-circle" style="background: #fee2e2; color: #dc2626;">
                            <i class="bi bi-graph-down-arrow"></i>
                        </div>
                    </div>
                    <div class="kpi-value" style="color: #dc2626;">₱@_reportData.FinancialInfo.TotalExpenditures.ToString("N2")</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-label">BALANCE</div>
                        <div class="kpi-icon-circle" style="background: #e0e7ff; color: #4338ca;">
                            <i class="bi bi-wallet2"></i>
                        </div>
                    </div>
                    <div class="kpi-value">₱@_reportData.FinancialInfo.Balance.ToString("N2")</div>
                    <div class="kpi-footer">
                        <span class="trend-badge @((_reportData.FinancialInfo.Balance >= 0) ? "trend-down" : "trend-up")">
                            @((_reportData.FinancialInfo.Balance >= 0) ? "Surplus" : "Deficit")
                        </span>
                    </div>
                </div>
            </div>

            <!-- Procurement Breakdown -->
            @if (_reportData.FinancialInfo.ProcurementBreakdown.Any())
            {
                <div style="padding: 16px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">
                        <i class="bi bi-cart3" style="margin-right: 6px;"></i>
                        Procurement Requests Breakdown
                    </h4>
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Request ID</th>
                                    <th>Barangay</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                    <th class="t-right">Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var procurement in _reportData.FinancialInfo.ProcurementBreakdown)
                                {
                                    <tr>
                                        <td><strong>#@procurement.RequestId</strong></td>
                                        <td>@procurement.BarangayName</td>
                                        <td>@procurement.Supplier</td>
                                        <td>
                                            <span class="status-chip status-@procurement.Status.ToLower()">
                                                @procurement.Status
                                            </span>
                                        </td>
                                        <td class="t-right">₱@procurement.Amount.ToString("N2")</td>
                                        <td>@procurement.RequestDate.ToString("MMM dd, yyyy")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="background: #f9fafb; font-weight: 700;">
                                    <td colspan="4" class="t-right">Total Procurement:</td>
                                    <td class="t-right" style="color: #16a34a;">
                                        ₱@_reportData.FinancialInfo.TotalFundsReceived.ToString("N2")
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            }

            <!-- Expenditures Breakdown -->
            @if (_reportData.FinancialInfo.ExpenditureBreakdown.Any())
            {
                <div style="padding: 16px; border-top: 1px solid var(--border);">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">
                        <i class="bi bi-wallet2" style="margin-right: 6px;"></i>
                        Expenditures Breakdown
                    </h4>
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Reference</th>
                                    <th class="t-right">Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var expenditure in _reportData.FinancialInfo.ExpenditureBreakdown)
                                {
                                    <tr>
                                        <td><strong>@expenditure.Category</strong></td>
                                        <td>@expenditure.Description</td>
                                        <td>@expenditure.Reference</td>
                                        <td class="t-right">₱@expenditure.Amount.ToString("N2")</td>
                                        <td>@expenditure.Date.ToString("MMM dd, yyyy")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="background: #f9fafb; font-weight: 700;">
                                    <td colspan="3" class="t-right">Total Expenditures:</td>
                                    <td class="t-right" style="color: #dc2626;">
                                        ₱@_reportData.FinancialInfo.TotalExpenditures.ToString("N2")
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            }

            <!-- Balance Summary -->
            <div style="padding: 16px; border-top: 2px solid var(--border); background: #f9fafb;">
                <div style="display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto;">
                    <div>
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            Current Balance
                        </div>
                        <div style="font-size: 2rem; font-weight: 800; color: @((_reportData.FinancialInfo.Balance >= 0) ? "#16a34a" : "#dc2626");">
                            ₱@_reportData.FinancialInfo.Balance.ToString("N2")
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 4px;">Status</div>
                        <span class="status-chip @((_reportData.FinancialInfo.Balance >= 0) ? "status-approved" : "status-draft")"
                              style="font-size: 0.85rem; padding: 6px 14px;">
                            @((_reportData.FinancialInfo.Balance >= 0) ? "✓ Surplus" : "⚠ Deficit")
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="document.querySelector('[id=shelter-ops]')?.scrollIntoView({behavior: 'smooth'})">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <span class="pagination-label">💰 End of Financial Summary Tables</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=volunteer-deployment]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Volunteer Deployment -->
        <section class="panel" id="volunteer-deployment">
            <header class="panel-head">
                <h3 class="panel-title">6. Volunteer Deployment Report</h3>
                <span class="card-badge">@_reportData.VolunteerInfo.TotalActiveVolunteers active</span>
            </header>
            <div class="table-wrap">
                <table class="rep-table">
                    <thead>
                        <tr>
                            <th>Volunteer Name</th>
                            <th>Assigned Shelter</th>
                            <th>Skills</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var volunteer in _reportData.VolunteerInfo.Assignments)
                        {
                            <tr>
                                <td>@volunteer.VolunteerName</td>
                                <td>@volunteer.AssignedShelter</td>
                                <td>@volunteer.Skills</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="document.querySelector('[id=financial-summary]')?.scrollIntoView({behavior: 'smooth'})">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <span class="pagination-label">👷 End of Volunteer Deployment Table</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=inventory-report]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Inventory Report -->
        <section class="panel" id="inventory-report">
            <header class="panel-head">
                <h3 class="panel-title">7. Inventory Report</h3>
            </header>

            <!-- 7.1 Executive Summary -->
            <div style="padding: 16px; background: #f9fafb; border-bottom: 1px solid var(--border);">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-clipboard-data" style="margin-right: 6px;"></i>
                    Executive Summary
                </h4>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">ITEMS IN STOCK</div>
                            <div class="kpi-icon-circle" style="background: #f3f4f6;">
                                <i class="bi bi-box-seam"></i>
                            </div>
                        </div>
                        <div class="kpi-value">@_reportData.InventoryInfo.ExecutiveSummary.TotalItemsInStock</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">STOCK RECEIVED</div>
                            <div class="kpi-icon-circle" style="background: #dcfce7; color: #16a34a;">
                                <i class="bi bi-arrow-down"></i>
                            </div>
                        </div>
                        <div class="kpi-value" style="color: #16a34a;">@_reportData.InventoryInfo.ExecutiveSummary.TotalStockReceived</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">STOCK RELEASED</div>
                            <div class="kpi-icon-circle" style="background: #fee2e2; color: #dc2626;">
                                <i class="bi bi-arrow-up"></i>
                            </div>
                        </div>
                        <div class="kpi-value" style="color: #dc2626;">@_reportData.InventoryInfo.ExecutiveSummary.TotalStockReleased</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">CONDITION</div>
                            <div class="kpi-icon-circle" style="background: #e0e7ff; color: #4338ca;">
                                <i class="bi bi-activity"></i>
                            </div>
                        </div>
                        <div class="kpi-value">@_reportData.InventoryInfo.ExecutiveSummary.OverallCondition</div>
                    </div>
                </div>

                <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #ef4444;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <i class="bi bi-exclamation-triangle-fill" style="color: #ef4444; font-size: 1.2rem;"></i>
                        <strong style="font-size: 0.9rem;">Critical Stock Alerts</strong>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div>
                            <span style="font-size: 0.75rem; color: #666;">Critically Low Items:</span>
                            <span style="font-size: 1.1rem; font-weight: 700; color: #ef4444; margin-left: 8px;">
                                @_reportData.InventoryInfo.ExecutiveSummary.CriticallyLowItems
                            </span>
                        </div>
                        <div>
                            <span style="font-size: 0.75rem; color: #666;">Low Stock Items:</span>
                            <span style="font-size: 1.1rem; font-weight: 700; color: #f59e0b; margin-left: 8px;">
                                @_reportData.InventoryInfo.ExecutiveSummary.LowStockItems
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7.2 Current Inventory Status -->
            <div style="padding: 16px; border-bottom: 1px solid var(--border);">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-box-seam" style="margin-right: 6px;"></i>
                    Current Inventory Status
                </h4>
                @if (_reportData.InventoryInfo.CurrentInventory.Any())
                {
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Available Qty</th>
                                    <th>Unit</th>
                                    <th>Stock Level</th>
                                    <th>Storage Location</th>
                                    <th>Expiration</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in _reportData.InventoryInfo.CurrentInventory)
                                {
                                    <tr>
                                        <td><strong>@item.ItemName</strong></td>
                                        <td>
                                            <span style="font-size: 0.75rem; padding: 2px 8px; background: #f3f4f6; border-radius: 4px;">
                                                @item.Category
                                            </span>
                                        </td>
                                        <td>@item.AvailableQuantity</td>
                                        <td>@item.Unit</td>
                                        <td>
                                            <span class="status-chip" style="background: @GetStockLevelColor(item.StockLevel); color: white;">
                                                @item.StockLevel
                                            </span>
                                        </td>
                                        <td>@item.StorageLocation</td>
                                        <td style="font-size: 0.85rem;">
                                            @if (item.ExpirationDate.HasValue)
                                            {
                                                <span style="color: @(item.ExpirationDate.Value < DateTime.Now.AddDays(30) ? "#ef4444" : "#666");">
                                                    @item.ExpirationDate.Value.ToString("MMM dd, yyyy")
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="color: #666;">N/A</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="empty-text">No inventory items found.</p>
                }
            </div>

            <!-- 7.3 Stock-In Summary -->
            <div style="padding: 16px; border-bottom: 1px solid var(--border);">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-arrow-down-circle" style="margin-right: 6px; color: #16a34a;"></i>
                    Stock-In Summary
                </h4>
                @if (_reportData.InventoryInfo.StockInSummary.Any())
                {
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Item Name</th>
                                    <th>Quantity</th>
                                    <th>Supplier</th>
                                    <th>Batch</th>
                                    <th>Received Date</th>
                                    <th>Received By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in _reportData.InventoryInfo.StockInSummary.Take(20))
                                {
                                    <tr>
                                        <td><strong>#@transaction.TransactionId</strong></td>
                                        <td>@transaction.ItemName</td>
                                        <td style="color: #16a34a; font-weight: 600;">+@transaction.Quantity @transaction.Unit</td>
                                        <td>@transaction.Supplier</td>
                                        <td style="font-family: monospace; font-size: 0.8rem;">@transaction.BatchNumber</td>
                                        <td>@transaction.ReceivedDate.ToString("MMM dd, yyyy")</td>
                                        <td>@transaction.ReceivedBy</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="empty-text">No stock-in transactions recorded.</p>
                }
            </div>

            <!-- 7.4 Stock-Out Summary -->
            <div style="padding: 16px;">
                <h4 style="font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;">
                    <i class="bi bi-arrow-up-circle" style="margin-right: 6px; color: #dc2626;"></i>
                    Stock-Out Summary
                </h4>
                @if (_reportData.InventoryInfo.StockOutSummary.Any())
                {
                    <div class="table-wrap">
                        <table class="rep-table">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Item Name</th>
                                    <th>Qty Released</th>
                                    <th>Destination</th>
                                    <th>Purpose</th>
                                    <th>Release Date</th>
                                    <th>Released By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in _reportData.InventoryInfo.StockOutSummary.Take(20))
                                {
                                    <tr>
                                        <td><strong>#@transaction.TransactionId</strong></td>
                                        <td>@transaction.ItemName</td>
                                        <td style="color: #dc2626; font-weight: 600;">-@transaction.QuantityReleased @transaction.Unit</td>
                                        <td>@transaction.Destination</td>
                                        <td>
                                            <span style="font-size: 0.75rem; padding: 2px 8px; background: #f3f4f6; border-radius: 4px;">
                                                @transaction.Purpose
                                            </span>
                                        </td>
                                        <td>@transaction.ReleaseDate.ToString("MMM dd, yyyy")</td>
                                        <td>@transaction.ReleasedBy</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="empty-text">No stock-out transactions recorded.</p>
                }
            </div>
        </section>

        <!-- Pagination Controls -->
        <div class="pagination-break">
            <div class="pagination-content">
                <button class="mini-btn btn-ghost" onclick="document.querySelector('[id=volunteer-deployment]')?.scrollIntoView({behavior: 'smooth'})">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <span class="pagination-label">📦 End of Inventory Report Tables</span>
                <button class="mini-btn btn-primary" onclick="document.querySelector('[id=operational-issues]')?.scrollIntoView({behavior: 'smooth'})">
                    Next Section <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Operational Issues -->
        <section class="panel" id="operational-issues">
            <header class="panel-head">
                <h3 class="panel-title">8. Operational Issues & Recommendations</h3>
                <button class="mini-btn" @onclick="ToggleEditMode">
                    <i class="bi @(isEditingIssues ? "bi-x" : "bi-pencil")"></i>
                    @(isEditingIssues ? "Cancel" : "Edit")
                </button>
            </header>
            <div style="padding: 16px;">
                @if (isEditingIssues)
                {
                    <div class="form-group">
                        <label>Needed Support</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.NeededSupport"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Urgent Supplies</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.UrgentSupplies"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Funding Requests</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.FundingRequests"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Concerns</label>
                        <textarea class="form-control" rows="3" @bind="_reportData.Issues.Concerns"></textarea>
                    </div>
                    <button class="btn-primary" @onclick="SaveIssuesAsync" style="margin-top: 12px;">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                }
                else
                {
                    @if (!string.IsNullOrEmpty(_reportData.Issues.NeededSupport))
                    {
                        <div class="issue-item"><strong>Needed Support:</strong> @_reportData.Issues.NeededSupport</div>
                    }
                    @if (!string.IsNullOrEmpty(_reportData.Issues.UrgentSupplies))
                    {
                        <div class="issue-item"><strong>Urgent Supplies:</strong> @_reportData.Issues.UrgentSupplies</div>
                    }
                    @if (!string.IsNullOrEmpty(_reportData.Issues.FundingRequests))
                    {
                        <div class="issue-item"><strong>Funding Requests:</strong> @_reportData.Issues.FundingRequests</div>
                    }
                    @if (!string.IsNullOrEmpty(_reportData.Issues.Concerns))
                    {
                        <div class="issue-item"><strong>Concerns:</strong> @_reportData.Issues.Concerns</div>
                    }

                    @if (string.IsNullOrEmpty(_reportData.Issues.NeededSupport) &&
                                string.IsNullOrEmpty(_reportData.Issues.UrgentSupplies) &&
                                string.IsNullOrEmpty(_reportData.Issues.FundingRequests) &&
                                string.IsNullOrEmpty(_reportData.Issues.Concerns))
                    {
                        <p class="empty-text">No operational issues reported at this time.</p>
                    }
                }
            </div>
        </section>
    }
    else if (!_loading)
    {
        <section class="panel panel-empty">
            <div class="empty-state">
                <i class="bi bi-file-text" aria-hidden="true"></i>
                <h3>No Report Generated</h3>
                <p>Click <strong>Refresh</strong> to load report data or <strong>Generate PDF Report</strong> to create a comprehensive operations report.</p>
            </div>
        </section>
    }
</div>

@if (showPopup)
{
    <div class="popup-backdrop" @onclick="() => showPopup = false">
        <div class="popup-card" @onclick:stopPropagation="true">
            <div class="popup-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-check-circle-fill" style="color: #000;"></i>
                    <span>PDF Generated</span>
                </div>
                <button class="btn-close-icon" @onclick="() => showPopup = false">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="popup-body">
                <p>Operations Report PDF generated successfully!</p>
            </div>
            <div class="popup-footer">
                <button class="mini-btn btn-primary" @onclick="() => showPopup = false">OK</button>
            </div>
        </div>
    </div>
}

@code {
    private OperationsReportData? _reportData;
    private bool _loading = false;
    private bool isEditingIssues = false;
    private bool showPopup = false;


    protected override async Task OnInitializedAsync()
    {
        await RefreshDataAsync();
    }

    private async Task RefreshDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            _reportData = await ReportService.GenerateReportDataAsync();
            _reportData.GeneratedBy = Auth.CurrentUser?.Username ?? "System";
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading report data: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateOperationsReportAsync()
    {
        if (_reportData == null)
        {
            await RefreshDataAsync();
            if (_reportData == null) return;
        }

        _loading = true;
        StateHasChanged();

        try
        {
            var pdfBytes = await ReportService.GeneratePdfReportAsync(_reportData);
            var fileName = $"Operations_Report_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            var base64 = Convert.ToBase64String(pdfBytes);
            await JS.InvokeVoidAsync("eval", $@"
                const link = document.createElement('a');
                link.download = '{fileName}';
                link.href = 'data:application/pdf;base64,{base64}';
                link.click();
            ");

            showPopup = true;

        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error generating PDF: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ToggleEditMode()
    {
        isEditingIssues = !isEditingIssues;
    }

    private async Task SaveIssuesAsync()
    {
        if (_reportData == null) return;

        try
        {
            await ReportService.SaveOperationalIssuesAsync(_reportData.Issues);
            await JS.InvokeVoidAsync("alert", "Operational issues saved successfully!");
            isEditingIssues = false;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error saving issues: {ex.Message}");
        }
    }

    private string GetStockLevelColor(string stockLevel)
    {
        return stockLevel switch
        {
            "Critical" => "#ef4444",
            "Low" => "#f59e0b",
            "Normal" => "#10b981",
            _ => "#6b7280"
        };
    }
}