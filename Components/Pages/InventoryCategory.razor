@page "/inventory/category/{categorySlug}"
@using System.Linq
@using ResQLink.Data.Entities
@using Microsoft.EntityFrameworkCore
@implements IDisposable
@inject NavigationManager Nav
@inject ResQLink.Services.InventoryService InventorySvc
@inject ResQLink.Services.CategoryService CategorySvc
@inject ResQLink.Services.StockService StockSvc
@inject IDbContextFactory<ResQLink.Data.AppDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject ResQLink.Services.BudgetStateService BudgetState

<div class="inventory-root">

    @* --- KPI SECTION --- *@
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Inventory — @DisplayCategory</h2>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
                <button class="mini-btn" @onclick="GoOverview">
                    <i class="bi bi-arrow-left"></i> Overview
                </button>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-box-seam-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Items</div>
                    <div class="kpi-value">@BaseItems.Count()</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle" style="background: #fffbeb; color: #d97706;">
                    <i class="bi bi-exclamation-circle-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label" style="color: #92400e;">Low Stock</div>
                    <div class="kpi-value" style="color: #d97706;">@LowCount</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle" style="background: #fef2f2; color: #dc2626;">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label" style="color: #991b1b;">Out of Stock</div>
                    <div class="kpi-value" style="color: #dc2626;">@OutCount</div>
                </div>
            </div>

            @* Budget KPI *@
            <div class="kpi-card">
                <div class="kpi-icon-circle" style="background: #eff6ff; color: #2563eb;">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label" style="color: #1e40af;">Budget Balance</div>
                    @if (selectedBudgetBalance.HasValue && selectedBudgetId.HasValue)
                    {
                        <div class="kpi-value" style="color: #2563eb; font-size: 1.4rem;">₱@selectedBudgetBalance.Value.ToString("N2")</div>
                        var budget = availableBudgets.FirstOrDefault(b => b.BudgetId == selectedBudgetId.Value);
                        @if (budget != null)
                        {
                            <div class="kpi-detail">@budget.BarangayName (@budget.Year)</div>
                        }
                    }
                    else
                    {
                        <div class="kpi-value text-muted" style="font-size: 1rem;">No Selection</div>
                    }
                </div>
            </div>
        </div>
    </section>

    @* --- BUDGET SELECTOR --- *@
    <div style="margin-bottom: 18px; padding: 16px; background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                <label style="font-size: 0.8rem; font-weight: 700; color: #374151; white-space: nowrap; text-transform: uppercase;">
                    <i class="bi bi-cash-coin" style="color: #16a34a; margin-right: 6px;"></i> Active Budget
                </label>
                <select class="mini-input"
                        style="max-width: 400px; width: 100%; border-color: #d1d5db;"
                        @bind="selectedBudgetId"
                        @bind:after="OnBudgetChanged">
                    <option value="">-- Select Budget to Track --</option>
                    @foreach (var budget in availableBudgets)
                    {
                        var spent = budgetSpent.ContainsKey(budget.BudgetId) ? budgetSpent[budget.BudgetId] : 0m;
                        var available = budget.TotalAmount - spent;
                        var percentUsed = budget.TotalAmount > 0 ? (spent / budget.TotalAmount * 100) : 0;
                        <option value="@budget.BudgetId">
                            @budget.BarangayName (@budget.Year) - ₱@available.ToString("N2") available (@percentUsed.ToString("F1")% used)
                        </option>
                    }
                </select>
            </div>

            @if (selectedBudgetId.HasValue && selectedBudgetBalance.HasValue)
            {
                var budget = availableBudgets.FirstOrDefault(b => b.BudgetId == selectedBudgetId.Value);
                if (budget != null)
                {
                    var spent = budgetSpent.ContainsKey(budget.BudgetId) ? budgetSpent[budget.BudgetId] : 0m;
                    <div style="display: flex; gap: 24px;">
                        <div>
                            <div style="font-size: 0.65rem; color: #6b7280; text-transform: uppercase; font-weight: 700;">Total</div>
                            <div style="font-size: 0.9rem; font-weight: 700; color: #111827;">₱@budget.TotalAmount.ToString("N2")</div>
                        </div>
                        <div>
                            <div style="font-size: 0.65rem; color: #6b7280; text-transform: uppercase; font-weight: 700;">Spent</div>
                            <div style="font-size: 0.9rem; font-weight: 700; color: #dc2626;">₱@spent.ToString("N2")</div>
                        </div>
                        <div>
                            <div style="font-size: 0.65rem; color: #6b7280; text-transform: uppercase; font-weight: 700;">Available</div>
                            <div style="font-size: 0.9rem; font-weight: 700; color: #16a34a;">₱@selectedBudgetBalance.Value.ToString("N2")</div>
                        </div>
                    </div>
                }
            }
        </div>

        @if (selectedBudgetId.HasValue && selectedBudgetBalance.HasValue)
        {
            var budget = availableBudgets.FirstOrDefault(b => b.BudgetId == selectedBudgetId.Value);
            if (budget != null)
            {
                var spent = budgetSpent.ContainsKey(budget.BudgetId) ? budgetSpent[budget.BudgetId] : 0m;
                var percentUsed = budget.TotalAmount > 0 ? (spent / budget.TotalAmount * 100) : 0;

                <div style="margin-top: 10px;">
                    <div class="progress-shell" style="height: 6px;">
                        <div class="progress-bar"
                             style="width: @percentUsed%; background: @(percentUsed > 90 ? "#dc2626" : percentUsed > 75 ? "#f59e0b" : "#16a34a");"></div>
                    </div>
                </div>
            }
        }
    </div>

    @* --- MAIN ITEMS LIST --- *@
    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Items List</h2>
            <div class="panel-actions">
                <input class="mini-input"
                       placeholder="Search name or SKU…"
                       @bind="search"
                       @bind:event="oninput"
                       @onkeyup="ResetPagination" />

                <select class="mini-input" @bind="stockFilter" @bind:after="ResetPagination">
                    <option value="">Stock State</option>
                    <option value="low">Low</option>
                    <option value="out">Out</option>
                    <option value="ok">OK</option>
                </select>

                <select class="mini-input" @bind="sortBy" @bind:after="ResetPagination">
                    <option value="name_asc">Name A→Z</option>
                    <option value="qty_desc">Qty High→Low</option>
                    <option value="qty_asc">Qty Low→High</option>
                </select>

                <button class="mini-btn" @onclick="ToggleView">
                    <i class="bi @(isCardView ? "bi-table" : "bi-grid")"></i>
                    @(isCardView ? "Table" : "Cards")
                </button>

                <button class="mini-btn" @onclick="ClearFilters">Clear</button>

                <button class="mini-btn btn-primary" @onclick="OpenAddModal">
                    <i class="bi bi-plus-circle"></i> Add Item
                </button>
            </div>
        </header>

        @if (!isCardView)
        {
            <!-- TABLE VIEW -->
            <div class="table-wrap">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th class="t-center col-sku">SKU</th>
                            <th class="col-name">Name</th>
                            <th class="t-right col-qty">Qty</th>
                            <th class="t-right col-reorder">Reorder</th>
                            <th class="col-unit">Unit</th>
                            <th class="t-center col-status">Status</th>
                            <th class="t-right col-updated">Updated</th>
                            <th class="t-center" style="width:100px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var it in PagedItems)
                        {
                            <tr>
                                <td class="t-center col-sku">@it.Sku</td>
                                <td class="col-name"><strong>@it.Name</strong></td>
                                <td class="t-right col-qty"><span class="amount-text">@it.Quantity</span></td>
                                <td class="t-right col-reorder">@it.ReorderLevel</td>
                                <td class="col-unit">@it.Unit</td>

                                <td class="t-center col-status">
                                    <span style="font-weight: 700; font-size: 0.7rem; text-transform: uppercase; color: @GetStatusColor(it)">
                                        @StatusText(it)
                                    </span>
                                </td>

                                <td class="t-right col-updated text-muted">@it.LastUpdated.ToString("MMM dd HH:mm")</td>
                                <td class="action-cell">
                                    <button class="action-btn edit"
                                            @onclick="() => OpenEditModal(it)"
                                            title="Edit item">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        @if (!PagedItems.Any())
                        {
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                                    <div class="empty-text">No items match your filters</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <!-- CARDS VIEW -->
            <div class="cards-grid">
                @foreach (var it in PagedItems)
                {
                    <div class="item-card @(IsOut(it) ? "card-out" : IsLow(it) ? "card-low" : "card-ok")">
                        <div class="ic-top">
                            <div class="ic-name">@it.Name</div>
                            <div class="ic-sku">@it.Sku</div>
                        </div>
                        <div class="ic-row">
                            <span style="font-weight: 700; font-size: 0.65rem; text-transform: uppercase; color: @GetStatusColor(it)">
                                @StatusText(it)
                            </span>
                            <span class="ic-unit">@it.Unit</span>
                        </div>
                        <div class="ic-row ic-qty">
                            <span><strong>@it.Quantity</strong> qty</span>
                            <span class="sep">/</span>
                            <span>reorder <strong>@it.ReorderLevel</strong></span>
                        </div>
                        <div class="progress-shell thin" aria-label="Stock %">
                            <div class="progress-bar" style="width:@(StockPercent(it))%; background: @GetStatusColor(it)"></div>
                        </div>
                        <div class="ic-meta">
                            <span class="time">@it.LastUpdated.ToString("MMM dd HH:mm")</span>
                            <button class="mini-btn" style="padding: 2px 8px; height: 24px;" @onclick="() => OpenEditModal(it)">Edit</button>
                        </div>
                    </div>
                }
                @if (!PagedItems.Any())
                {
                    <div class="empty-state">
                        <div class="empty-text">No items found</div>
                    </div>
                }
            </div>
        }

        <!-- PAGINATION FOOTER -->
        <footer class="panel-foot">
            <div class="foot-left">
                <i class="bi bi-info-circle"></i>
                Showing @StartIndex–@EndIndex of @TotalFiltered items
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="_pageSize" style="width: auto; min-width: 60px;" @bind:after="ResetPagination">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>

    @* --- ADD MODAL (CLEAN - NO CLICK HANDLERS ON CONTAINERS) --- *@
    @if (showAdd)
    {
        @* FIX: No @onclick on overlay. No @onclick on dialog. Inputs will work. *@
        <div class="modal-overlay">
            <div class="modal-dialog" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Add Inventory Item</h3>
                    <button class="modal-close" @onclick="async () => await CloseAdd()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invName">Name *</label>
                            <input id="invName" class="form-control" @bind="newName" />
                        </div>
                        <div class="form-group">
                            <label for="invSku">SKU (optional)</label>
                            <input id="invSku" class="form-control" @bind="newSku" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invUnit">Unit *</label>
                            <input id="invUnit"
                                   class="form-control"
                                   placeholder="e.g., kg, pcs, liters"
                                   @bind="newUnit" />
                        </div>
                        <div class="form-group">
                            <label for="invCategory">Category *</label>
                            <select id="invCategory" class="form-control" @bind="selectedCategoryId">
                                <option value="">-- Select Category --</option>
                                @foreach (var c in GetFilteredCategoriesForModal())
                                {
                                    <option value="@c.CategoryId">
                                        @c.CategoryName
                                        @if (c.CategoryType != null)
                                        {
                                            <text> (@c.CategoryType.TypeName)</text>
                                        }
                                    </option>
                                }
                            </select>
                            @if (CurrentCategoryTypeCode.HasValue)
                            {
                                var typeName = CurrentCategoryTypeCode.Value switch
                                {
                                    'P' => "Perishable",
                                    'N' => "Non-Perishable",
                                    'M' => "Medical",
                                    'O' => "Others",
                                    _ => ""
                                };
                                <small class="hint" style="color: #3b82f6; font-weight: 600;">
                                    <i class="bi bi-info-circle"></i> Only @typeName categories are available on this page
                                </small>
                            }
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invDesc">Description</label>
                            <textarea id="invDesc" class="form-control" rows="2" @bind="newDesc"></textarea>
                        </div>
                    </div>

                    @if (RequiresExpiration)
                    {
                        <div class="form-row">
                            <div class="form-group exp-group">
                                <label>Expiration Date *</label>
                                <input type="date"
                                       class="form-control"
                                       @bind="newExpirationDate"
                                       @bind:format="yyyy-MM-dd"
                                       min='@DateTime.Today.ToString("yyyy-MM-dd")' />
                                <small class="hint">
                                    This item requires expiration tracking (Perishable/Medical).
                                </small>
                            </div>
                        </div>
                    }

                    <!-- Stock and Cost Section -->
                    <div style="border-top: 1px solid #e5e7eb; margin-top: 16px; padding-top: 16px;">
                        <h4 style="font-size: 0.85rem; font-weight: 700; color: #374151; margin-bottom: 12px;">
                            <i class="bi bi-box-seam"></i> Stock & Cost Information
                        </h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="invQty">Initial Quantity *</label>
                                <input id="invQty"
                                       type="number"
                                       class="form-control"
                                       @bind="newQty"
                                       @bind:event="oninput"
                                       @onchange="CalculateTotalCost"
                                       min="0" />
                            </div>
                            <div class="form-group">
                                <label for="invMaxCap">Max Capacity</label>
                                <input id="invMaxCap" type="number" class="form-control" @bind="newMaxCapacity" min="1" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="invUnitCost">Unit Cost (₱) *</label>
                                <input id="invUnitCost"
                                       type="number"
                                       step="0.01"
                                       class="form-control"
                                       @bind="newUnitCost"
                                       @bind:event="oninput"
                                       @onchange="CalculateTotalCost"
                                       min="0"
                                       placeholder="0.00" />
                                <small class="hint">Cost per unit/item</small>
                            </div>
                            <div class="form-group">
                                <label for="invBudget">Barangay Budget</label>
                                <select id="invBudget"
                                        class="form-control"
                                        @bind="selectedBudgetId"
                                        @bind:after="OnBudgetChanged">
                                    <option value="">-- No Budget --</option>
                                    @foreach (var budget in availableBudgets)
                                    {
                                        var spent = budgetSpent.ContainsKey(budget.BudgetId) ? budgetSpent[budget.BudgetId] : 0m;
                                        var available = budget.TotalAmount - spent;
                                        <option value="@budget.BudgetId">
                                            @budget.BarangayName (@budget.Year) - ₱@available.ToString("N2") available
                                        </option>
                                    }
                                </select>
                                <small class="hint">Optional: Select budget to deduct from</small>
                            </div>
                        </div>

                        @if (totalCost > 0)
                        {
                            <div class="cost-summary">
                                <div class="cost-row">
                                    <span class="cost-label">Total Cost:</span>
                                    <span class="cost-value">₱@totalCost.ToString("N2")</span>
                                </div>
                                @if (selectedBudgetId.HasValue && selectedBudgetBalance.HasValue)
                                {
                                    <div class="cost-row">
                                        <span class="cost-label">Budget Available:</span>
                                        <span class="cost-value">₱@selectedBudgetBalance.Value.ToString("N2")</span>
                                    </div>
                                    <div class="cost-row">
                                        <span class="cost-label">After Purchase:</span>
                                        <span class="cost-value @(selectedBudgetBalance.Value - totalCost < 0 ? "text-danger" : "text-accent")">
                                            ₱@((selectedBudgetBalance.Value - totalCost).ToString("N2"))
                                        </span>
                                    </div>
                                    @if (selectedBudgetBalance.Value - totalCost < 0)
                                    {
                                        <div class="alert-warning" style="margin-top: 8px; padding: 8px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 6px; font-size: 0.75rem;">
                                            <i class="bi bi-exclamation-triangle"></i> Insufficient budget!
                                            Short by ₱@((totalCost - selectedBudgetBalance.Value).ToString("N2"))
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(addError))
                    {
                        <div class="form-error">@addError</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="async () => await CloseAdd()"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveNew"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            @(saving ? "Saving…" : totalCost > 0 ? $"Save & Pay ₱{totalCost:N2}" : "Save")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* --- EDIT MODAL (CLEAN - NO CLICK HANDLERS ON CONTAINERS) --- *@
    @if (showEdit)
    {
        @* FIX: No @onclick on overlay. No @onclick on dialog. Inputs will work. *@
        <div class="modal-overlay">
            <div class="modal-dialog" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Edit Inventory Item</h3>
                    <button class="modal-close" @onclick="async () => await CloseEdit()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editName">Name *</label>
                            <input id="editName" class="form-control" @bind="editName" />
                        </div>
                        <div class="form-group">
                            <label for="editSku">SKU</label>
                            <input id="editSku" class="form-control" @bind="editSku" disabled />
                            <small class="hint">SKU cannot be changed</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUnit">Unit *</label>
                            <input id="editUnit"
                                   class="form-control"
                                   placeholder="e.g., kg, pcs, liters"
                                   @bind="editUnit" />
                        </div>
                        <div class="form-group">
                            <label for="editCategory">Category *</label>
                            <select id="editCategory" class="form-control" @bind="editCategoryId">
                                <option value="">-- Select Category --</option>
                                @foreach (var c in allCategories)
                                {
                                    <option value="@c.CategoryId">@c.CategoryName</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDesc">Description</label>
                            <textarea id="editDesc" class="form-control" rows="2" @bind="editDesc"></textarea>
                        </div>
                    </div>

                    @if (editRequiresExpiration)
                    {
                        <div class="form-row">
                            <div class="form-group exp-group">
                                <label>Expiration Date *</label>
                                <input type="date"
                                       class="form-control"
                                       @bind="editExpirationDate"
                                       @bind:format="yyyy-MM-dd"
                                       min='@DateTime.Today.ToString("yyyy-MM-dd")' />
                                <small class="hint">
                                    This item requires expiration tracking (Perishable/Medical).
                                </small>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(editError))
                    {
                        <div class="form-error">@editError</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-danger"
                                @onclick="DeleteItem"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            Archive Item
                        </button>
                        <button type="button"
                                class="btn-cancel"
                                @onclick="async () => await CloseEdit()"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveEdit"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .cost-summary {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
    }

    .cost-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
    }

    .cost-label {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 600;
    }

    .cost-value {
        font-size: 1rem;
        font-weight: 700;
        color: #111827;
    }

    .text-danger {
        color: #dc2626 !important;
    }

    .text-accent {
        color: #16a34a !important;
    }

    .hint {
        font-size: 0.7rem;
        color: #6b7280;
        font-style: italic;
    }
</style>

@code {
    [Parameter] public string categorySlug { get; set; } = "";

    private string DisplayCategory =>
        string.IsNullOrWhiteSpace(categorySlug)
            ? "ALL"
            : Uri.UnescapeDataString(categorySlug).Replace('-', ' ').ToUpperInvariant();

    private class Item
    {
        public string Sku { get; set; } = "";
        public string Name { get; set; } = "";
        public string Category { get; set; } = "";
        public string CategoryTypeSlug { get; set; } = "";
        public int Quantity { get; set; }
        public int ReorderLevel { get; set; }
        public string Unit { get; set; } = "";
        public DateTime LastUpdated { get; set; }
    }

    private List<Item> _items = new();

    // UI state
    private string search = string.Empty;
    private string stockFilter = string.Empty;
    private string sortBy = "name_asc";
    private bool isCardView = false;

    // Pagination state (ADDED)
    private int _pageIndex = 0;
    private int _pageSize = 10;

    // Add modal state
    private bool showAdd;
    private bool saving;
    private string newName = "";
    private string newSku = "";
    private string newUnit = "";
    private string newDesc = "";
    private int newQty = 0;
    private int newMaxCapacity = 1000;
    private DateTime? newExpirationDate;
    private List<Category> allCategories = new();

    // Cost and Budget fields
    private decimal newUnitCost = 0m;
    private int? selectedBudgetId;
    private decimal totalCost = 0m;
    private decimal? selectedBudgetBalance;
    private List<BarangayBudget> availableBudgets = new();
    private Dictionary<int, decimal> budgetSpent = new();

    private int? selectedCategoryId;
    private string addError = string.Empty;

    // Edit modal state
    private bool showEdit;
    private int editRgId;
    private string editName = "";
    private string editSku = "";
    private string editUnit = "";
    private string editDesc = "";
    private int? editCategoryId;
    private DateTime? editExpirationDate;
    private string editError = string.Empty;

    private bool RequiresExpiration =>
        allCategories.Any(c =>
            selectedCategoryId.HasValue &&
            c.CategoryId == selectedCategoryId.Value &&
            c.CategoryType != null &&
            (c.CategoryType.TypeCode == 'P' || c.CategoryType.TypeCode == 'M'));

    private bool editRequiresExpiration =>
        allCategories.Any(c =>
            editCategoryId.HasValue &&
            c.CategoryId == editCategoryId.Value &&
            c.CategoryType != null &&
            (c.CategoryType.TypeCode == 'P' || c.CategoryType.TypeCode == 'M'));

    private readonly SemaphoreSlim _loadSemaphore = new(1, 1);

    protected override async Task OnInitializedAsync()
    {
        allCategories = await CategorySvc.GetAllAsync();
        await LoadBudgetsAsync();
        await LoadItemsAsync();
        BudgetState.OnBudgetChanged += HandleBudgetChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        _pageIndex = 0; // Reset page on category change
        await LoadItemsAsync();
    }

    private async Task LoadBudgetsAsync()
    {
        await _loadSemaphore.WaitAsync();
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            availableBudgets = await db.BarangayBudgets
                .Where(b => b.Status == "Approved" || b.Status == "Draft")
                .OrderByDescending(b => b.Year)
                .ThenBy(b => b.BarangayName)
                .AsNoTracking()
                .ToListAsync();

            budgetSpent.Clear();
            foreach (var budget in availableBudgets)
            {
                var spent = await db.BarangayBudgetItems
                    .Where(i => i.BudgetId == budget.BudgetId)
                    .SumAsync(i => i.Amount);
                budgetSpent[budget.BudgetId] = spent;

                BudgetState.UpdateBudgetBalance(budget.BudgetId, budget.TotalAmount - spent);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading budgets: {ex.Message}");
            addError = $"Error loading budgets: {ex.Message}";
        }
        finally
        {
            _loadSemaphore.Release();
        }
    }

    private async Task LoadItemsAsync()
    {
        var goods = await InventorySvc.GetAllAsync();
        var latestStock = goods.SelectMany(g => g.Stocks)
            .GroupBy(s => s.RgId)
            .ToDictionary(g => g.Key, g => g.OrderByDescending(x => x.LastUpdated).First());

        _items = goods.Select(g =>
        {
            var categories = g.Categories.Select(rc => rc.Category).Where(c => c != null).ToList();

            var typeCode = categories.Select(c => c!.CategoryType?.TypeCode)
                                     .Where(tc => tc.HasValue)
                                     .Select(tc => tc!.Value)
                                     .Distinct()
                                     .OrderBy(tc => tc switch
                                     {
                                         'P' => 0,
                                         'M' => 1,
                                         'N' => 2,
                                         'O' => 3,
                                         _ => 99
                                     })
                                     .FirstOrDefault();

            var typeSlug = typeCode switch
            {
                'P' => "perishable",
                'M' => "medical",
                'N' => "non-perishable",
                'O' => "others",
                _ => string.Empty
            };

            var primaryCatName = categories.FirstOrDefault()?.CategoryName ?? "Uncategorized";
            var hasStock = latestStock.TryGetValue(g.RgId, out var st);

            return new Item
            {
                Sku = $"RG-{g.RgId}",
                Name = g.Name,
                Category = primaryCatName,
                CategoryTypeSlug = typeSlug,
                Quantity = hasStock ? st!.Quantity : 0,
                ReorderLevel = 0,
                Unit = g.Unit,
                LastUpdated = hasStock ? st!.LastUpdated : g.CreatedAt
            };
        }).ToList();
    }

    private static bool IsTypeSlug(string slug) =>
        slug is "perishable" or "non-perishable" or "medical" or "others";

    private IEnumerable<Item> BaseItems
    {
        get
        {
            if (_items.Count == 0) return Enumerable.Empty<Item>();
            if (string.IsNullOrWhiteSpace(categorySlug)) return _items;

            var slug = categorySlug.ToLowerInvariant();
            return IsTypeSlug(slug)
                ? _items.Where(i => i.CategoryTypeSlug == slug)
                : _items.Where(i => i.Category.ToLowerInvariant() == slug.Replace('-', ' '));
        }
    }

    private IEnumerable<Item> FilteredItems
    {
        get
        {
            var q = BaseItems;

            if (!string.IsNullOrWhiteSpace(search))
            {
                q = q.Where(i =>
                    i.Name.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    i.Sku.Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            if (!string.IsNullOrWhiteSpace(stockFilter))
            {
                q = stockFilter switch
                {
                    "low" => q.Where(IsLow),
                    "out" => q.Where(IsOut),
                    "ok" => q.Where(i => !IsLow(i) && !IsOut(i)),
                    _ => q
                };
            }

            return sortBy switch
            {
                "qty_desc" => q.OrderByDescending(i => i.Quantity),
                "qty_asc" => q.OrderBy(i => i.Quantity),
                _ => q.OrderBy(i => i.Name)
            };
        }
    }

    // Pagination Properties
    private int TotalFiltered => FilteredItems.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)_pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * _pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * _pageSize, TotalFiltered);
    private IEnumerable<Item> PagedItems => FilteredItems.Skip(_pageIndex * _pageSize).Take(_pageSize);

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void ResetPagination()
    {
        _pageIndex = 0;
    }

    private int LowCount => BaseItems.Count(IsLow);
    private int OutCount => BaseItems.Count(IsOut);

    private static bool IsOut(Item i) => i.Quantity <= 0;
    private static bool IsLow(Item i) => !IsOut(i) && i.Quantity <= i.ReorderLevel;

    private static int StockPercent(Item i)
    {
        if (IsOut(i)) return 0;
        var cap = Math.Max(i.ReorderLevel * 2, i.ReorderLevel + 1);
        return Math.Clamp((int)Math.Round(i.Quantity / (double)cap * 100), 0, 100);
    }

    private string StatusText(Item i) =>
        IsOut(i) ? "OUT" :
        IsLow(i) ? "LOW" : "OK";

    // Replaces StatusClass - returns color hex
    private string GetStatusColor(Item i) =>
        IsOut(i) ? "#dc2626" :
        IsLow(i) ? "#d97706" :
        "#16a34a";

    private void ToggleView() => isCardView = !isCardView;

    private void ClearFilters()
    {
        search = string.Empty;
        stockFilter = string.Empty;
        sortBy = "name_asc";
        ResetPagination();
    }

    private void GoOverview() => Nav.NavigateTo("/inventory");

    private void Refresh() =>
        _ = LoadItemsAsync().ContinueWith(_ => InvokeAsync(StateHasChanged));

    private void OpenAddModal()
    {
        showAdd = true;
        addError = string.Empty;
        newName = ""; newSku = ""; newUnit = ""; newDesc = "";
        newQty = 0; newMaxCapacity = 1000; newExpirationDate = null;
        newUnitCost = 0m; selectedBudgetId = null; totalCost = 0m; selectedBudgetBalance = null;
        selectedCategoryId = null;

        var slug = categorySlug.ToLowerInvariant();
        if (IsTypeSlug(slug))
        {
            var autoCat = allCategories.FirstOrDefault(c => c.CategoryType != null && (
                (slug == "perishable" && c.CategoryType.TypeCode == 'P') ||
                (slug == "non-perishable" && c.CategoryType.TypeCode == 'N') ||
                (slug == "medical" && c.CategoryType.TypeCode == 'M') ||
                (slug == "others" && c.CategoryType.TypeCode == 'O')
            ));
            if (autoCat != null) selectedCategoryId = autoCat.CategoryId;
        }
    }

    private IEnumerable<Category> GetFilteredCategoriesForModal()
    {
        var typeCode = CurrentCategoryTypeCode;
        if (typeCode.HasValue) return allCategories.Where(c => c.CategoryType != null && c.CategoryType.TypeCode == typeCode.Value);
        return allCategories;
    }

    private async Task CloseAdd()
    {
        if (saving) return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to close this form? Any unsaved changes will be lost.");
        if (!confirmed) return;
        showAdd = false;
    }

    private void CalculateTotalCost()
    {
        totalCost = newQty * newUnitCost;
        StateHasChanged();
    }

    private void OnBudgetChanged()
    {
        try
        {
            if (selectedBudgetId.HasValue)
            {
                var budget = availableBudgets.FirstOrDefault(b => b.BudgetId == selectedBudgetId.Value);
                if (budget != null && budgetSpent.ContainsKey(selectedBudgetId.Value))
                {
                    var spent = budgetSpent[selectedBudgetId.Value];
                    selectedBudgetBalance = budget.TotalAmount - spent;
                }
                else selectedBudgetBalance = null;
            }
            else selectedBudgetBalance = null;
        }
        catch (Exception ex) { System.Diagnostics.Debug.WriteLine($"Error in OnBudgetChanged: {ex.Message}"); }
    }

    private async Task SaveNew()
    {
        if (saving) return;
        if (!await _loadSemaphore.WaitAsync(0)) { addError = "Another operation is in progress. Please wait..."; return; }
        addError = string.Empty;
        try
        {
            saving = true;
            if (string.IsNullOrWhiteSpace(newName) || string.IsNullOrWhiteSpace(newUnit)) { addError = "Name and Unit are required."; return; }
            if (!selectedCategoryId.HasValue) { addError = "Please select a category."; return; }
            var typeCode = CurrentCategoryTypeCode;
            if (typeCode.HasValue)
            {
                var selectedCategory = allCategories.FirstOrDefault(c => c.CategoryId == selectedCategoryId.Value);
                if (selectedCategory?.CategoryType == null || selectedCategory.CategoryType.TypeCode != typeCode.Value)
                {
                    addError = $"Category type mismatch."; return;
                }
            }
            if (RequiresExpiration && !newExpirationDate.HasValue) { addError = "Expiration date is required."; return; }
            if (newExpirationDate.HasValue && newExpirationDate.Value < DateTime.Today) { addError = "Expiration date cannot be in the past."; return; }
            if (newQty > 0 && newUnitCost <= 0) { addError = "Unit cost is required when adding initial quantity."; return; }
            if (selectedBudgetId.HasValue && selectedBudgetBalance.HasValue && totalCost > selectedBudgetBalance.Value) { addError = "Insufficient budget."; return; }

            var rg = new ReliefGood
            {
                Name = newName.Trim(),
                Unit = newUnit.Trim(),
                Description = string.IsNullOrWhiteSpace(newDesc) ? null : newDesc.Trim(),
                IsActive = true,
                ExpirationDate = RequiresExpiration ? newExpirationDate : null,
                RequiresExpiration = RequiresExpiration
            };
            var catIds = new List<int> { selectedCategoryId.Value };
            var result = await InventorySvc.CreateAsync(rg, catIds, newQty, newUnitCost, selectedBudgetId);

            if (result.error != null) { addError = result.error; return; }

            await LoadBudgetsAsync();
            BudgetState.NotifyBudgetChanged();
            if (selectedBudgetId.HasValue) OnBudgetChanged();
            await LoadItemsAsync();
            showAdd = false; saving = false; _loadSemaphore.Release(); StateHasChanged();
        }
        catch (Exception ex) { addError = $"Error: {ex.Message}"; saving = false; _loadSemaphore.Release(); StateHasChanged(); }
    }

    private void HandleBudgetChanged() { InvokeAsync(async () => { await LoadBudgetsAsync(); StateHasChanged(); }); }

    private async void OpenEditModal(Item item)
    {
        showEdit = true; editError = string.Empty;
        if (int.TryParse(item.Sku.Replace("RG-", ""), out int rgId))
        {
            editRgId = rgId;
            var reliefGood = await InventorySvc.GetByIdAsync(rgId);
            if (reliefGood != null)
            {
                editName = reliefGood.Name; editSku = item.Sku; editUnit = reliefGood.Unit;
                editDesc = reliefGood.Description ?? ""; editCategoryId = reliefGood.Categories.FirstOrDefault()?.CategoryId;
                editExpirationDate = reliefGood.ExpirationDate;
            }
            else editError = "Item not found.";
        }
        StateHasChanged();
    }

    private async Task CloseEdit()
    {
        if (saving) return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to close? Unsaved changes will be lost.");
        if (!confirmed) return;
        showEdit = false; editError = string.Empty;
    }

    private async Task SaveEdit()
    {
        if (saving) return;
        editError = string.Empty;
        if (string.IsNullOrWhiteSpace(editName) || string.IsNullOrWhiteSpace(editUnit)) { editError = "Name/Unit required."; return; }
        if (!editCategoryId.HasValue) { editError = "Category required."; return; }
        if (editRequiresExpiration && !editExpirationDate.HasValue) { editError = "Expiration required."; return; }
        saving = true;
        try
        {
            var reliefGood = await InventorySvc.GetByIdAsync(editRgId);
            if (reliefGood == null) { editError = "Item not found."; return; }
            reliefGood.Name = editName.Trim(); reliefGood.Unit = editUnit.Trim(); reliefGood.Description = editDesc?.Trim();
            reliefGood.ExpirationDate = editExpirationDate; reliefGood.RequiresExpiration = editRequiresExpiration;
            var catIds = new List<int> { editCategoryId.Value };
            var result = await InventorySvc.UpdateAsync(editRgId, reliefGood, catIds);
            if (result.error != null) { editError = result.error; return; }
            await LoadItemsAsync(); showEdit = false;
        }
        catch (Exception ex) { editError = $"Error: {ex.Message}"; }
        finally { saving = false; await InvokeAsync(StateHasChanged); }
    }

    private async Task DeleteItem()
    {
        if (saving) return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Archive '{editName}'?\n\nThis item will be moved to the archives and can be restored later by an administrator.");
        if (!confirmed) return;
        saving = true;
        try
        {
            var (ok, error) = await InventorySvc.DeleteAsync(editRgId, softIfStock: true);
            if (!ok && error != null) { editError = error; return; }
            await LoadItemsAsync(); showEdit = false;
        }
        catch (Exception ex) { editError = $"Error: {ex.Message}"; }
        finally { saving = false; await InvokeAsync(StateHasChanged); }
    }

    private char? CurrentCategoryTypeCode
    {
        get
        {
            if (string.IsNullOrWhiteSpace(categorySlug)) return null;
            var slug = categorySlug.ToLowerInvariant();
            return slug switch { "perishable" => 'P', "medical" => 'M', "non-perishable" => 'N', "others" => 'O', _ => null };
        }
    }
    public void Dispose() { }
}