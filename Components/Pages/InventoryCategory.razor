@page "/inventory/category/{categorySlug}"
@using System.Linq
@using ResQLink.Data.Entities
@inject NavigationManager Nav
@inject ResQLink.Services.InventoryService InventorySvc
@inject ResQLink.Services.CategoryService CategorySvc
@inject ResQLink.Services.StockService StockSvc
@inject ResQLink.Data.AppDbContext Db

<div class="inventory-root">

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Inventory — @DisplayCategory</h2>
            <div class="panel-actions">
                <input class="mini-input"
                       placeholder="Search name or SKU…"
                       @bind="search"
                       @bind:event="oninput" />
                <select class="mini-input" @bind="stockFilter">
                    <option value="">Stock</option>
                    <option value="low">Low</option>
                    <option value="out">Out</option>
                    <option value="ok">OK</option>
                </select>
                <select class="mini-input" @bind="sortBy">
                    <option value="name_asc">Name A→Z</option>
                    <option value="qty_desc">Qty High→Low</option>
                    <option value="qty_asc">Qty Low→High</option>
                </select>
                <button class="mini-btn" @onclick="ToggleView">
                    View: @(isCardView ? "Cards" : "Table")
                </button>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
                <button class="mini-btn" @onclick="GoOverview">Overview</button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh list">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="mini-btn btn-primary" @onclick="OpenAddModal">
                    <i class="bi bi-plus-circle"></i> Add Item
                </button>
            </div>
        </header>

        <!-- KPIs for this category -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Items</div>
                <div class="kpi-value text-accent">@BaseItems.Count()</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Low</div>
                <div class="kpi-value">@LowCount</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Out</div>
                <div class="kpi-value">@OutCount</div>
            </div>
        </div>

        @* DEBUG (optional): uncomment to see counts
        <div style="padding:0 12px 8px 12px;font-size:.7rem;color:#6b7280;">
            BaseItems: @BaseItems.Count() | FilteredItems: @FilteredItems.Count()
        </div>
        *@

        @if (!isCardView)
        {
            <!-- TABLE VIEW -->
            <div class="table-wrap">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th class="t-center col-sku">SKU</th>
                            <th class="col-name">Name</th>
                            <th class="t-right col-qty">Qty</th>
                            <th class="t-right col-reorder">Reorder</th>
                            <th class="col-unit">Unit</th>
                            <th class="col-status">Status</th>
                            <th class="col-updated">Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var it in FilteredItems)
                        {
                            <tr>
                                <td class="t-center col-sku">@it.Sku</td>
                                <td class="col-name">@it.Name</td>
                                <td class="t-right col-qty">@it.Quantity</td>
                                <td class="t-right col-reorder">@it.ReorderLevel</td>
                                <td class="col-unit">@it.Unit</td>
                                <td class="col-status">
                                    <span class="status-chip @StatusClass(it)">@StatusText(it)</span>
                                </td>
                                <td class="col-updated">@it.LastUpdated.ToString("MMM dd HH:mm")</td>
                            </tr>
                        }
                        @if (!FilteredItems.Any())
                        {
                            <tr>
                                <td colspan="7" class="t-center text-muted">No items match your filters.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <!-- CARDS VIEW -->
            <div class="cards-grid">
                @foreach (var it in FilteredItems)
                {
                    <div class="item-card @(IsOut(it) ? "card-out" : IsLow(it) ? "card-low" : "card-ok")">
                        <div class="ic-top">
                            <div class="ic-name">@it.Name</div>
                            <div class="ic-sku">@it.Sku</div>
                        </div>
                        <div class="ic-row">
                            <span class="status-chip @StatusClass(it)">@StatusText(it)</span>
                            <span class="ic-unit">@it.Unit</span>
                        </div>
                        <div class="ic-row ic-qty">
                            <span><strong>@it.Quantity</strong> qty</span>
                            <span class="sep">/</span>
                            <span>reorder <strong>@it.ReorderLevel</strong></span>
                        </div>
                        <div class="progress-shell thin" aria-label="Stock %">
                            <div class="progress-bar" style="width:@(StockPercent(it))%"></div>
                        </div>
                        <div class="ic-meta">
                            <span class="time">@it.LastUpdated.ToString("MMM dd HH:mm")</span>
                        </div>
                    </div>
                }
                @if (!FilteredItems.Any())
                {
                    <div class="text-muted" style="padding:10px;font-size:.75rem;">
                        No items match your filters.
                    </div>
                }
            </div>
        }

        <footer class="panel-foot">
            <div>
                Showing @FilteredItems.Count() of @BaseItems.Count() items in @DisplayCategory
            </div>
        </footer>
    </section>

    @* Add Inventory Item modal – category dropdown *@
    @if (showAdd)
    {
        <div class="modal-overlay" @onclick="CloseAdd" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Add Inventory Item</h3>
                    <button class="modal-close" @onclick="CloseAdd">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invName">Name *</label>
                            <input id="invName" class="form-control" @bind="newName" />
                        </div>
                        <div class="form-group">
                            <label for="invSku">SKU (optional)</label>
                            <input id="invSku" class="form-control" @bind="newSku" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invUnit">Unit *</label>
                            <input id="invUnit"
                                   class="form-control"
                                   placeholder="e.g., kg, pcs, liters"
                                   @bind="newUnit" />
                        </div>
                        <div class="form-group">
                            <label for="invQty">Initial Quantity</label>
                            <input id="invQty" type="number" class="form-control" @bind="newQty" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invMaxCap">Max Capacity</label>
                            <input id="invMaxCap" type="number" class="form-control" @bind="newMaxCapacity" />
                        </div>
                        <div class="form-group">
                            <label for="invDesc">Description</label>
                            <textarea id="invDesc" class="form-control" rows="2" @bind="newDesc"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invCategory">Category *</label>
                            <select id="invCategory" class="form-control" @bind="selectedCategoryId">
                                <option value="">-- Select Category --</option>
                                @foreach (var c in allCategories)
                                {
                                    <option value="@c.CategoryId">@c.CategoryName</option>
                                }
                            </select>
                        </div>
                    </div>

                    @if (RequiresExpiration)
                    {
                        <div class="form-row">
                            <div class="form-group exp-group">
                                <label>Expiration Date *</label>
                                <input type="date"
                                       class="form-control"
                                       @bind="newExpirationDate"
                                       @bind:format="yyyy-MM-dd"
                                       min='@DateTime.Today.ToString("yyyy-MM-dd")' />
                                <small class="hint">
                                    This item requires expiration tracking (Perishable/Medical).
                                </small>
                            </div>
                        </div>
                    }

                    @if (newQty > 0 && newMaxCapacity > 0)
                    {
                        var pct = Math.Round((newQty * 100.0m) / newMaxCapacity, 1);
                        var status = pct == 0 ? "Empty" : pct <= 25 ? "Low" : pct < 75 ? "Medium" : "High";
                        <div class="form-row">
                            <div class="form-group">
                                <label>Predicted Stock Status</label>
                                <div>
                                    <span class="status-chip st-@status.ToLower()">@status (@pct%)</span>
                                </div>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(addError))
                    {
                        <div class="form-error">@addError</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseAdd"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveNew"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @(saving ? "Saving…" : "Save")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string categorySlug { get; set; } = "";

    private string DisplayCategory =>
        string.IsNullOrWhiteSpace(categorySlug)
            ? "ALL"
            : Uri.UnescapeDataString(categorySlug).Replace('-', ' ').ToUpperInvariant();

    private class Item
    {
        public string Sku { get; set; } = "";
        public string Name { get; set; } = "";
        public string Category { get; set; } = "";
        public string CategoryTypeSlug { get; set; } = "";
        public int Quantity { get; set; }
        public int ReorderLevel { get; set; }
        public string Unit { get; set; } = "";
        public DateTime LastUpdated { get; set; }
    }

    private List<Item> _items = new();

    // UI state
    private string search = string.Empty;
    private string stockFilter = string.Empty;
    private string sortBy = "name_asc";
    private bool isCardView = false; // start with TABLE view

    // Add modal state
    private bool showAdd;
    private bool saving;
    private string newName = "";
    private string newSku = "";
    private string newUnit = "";
    private string newDesc = "";
    private int newQty = 0;
    private int newMaxCapacity = 1000;
    private DateTime? newExpirationDate;
    private List<Category> allCategories = new();

    private int? selectedCategoryId;
    private string addError = string.Empty;

    private bool RequiresExpiration =>
        allCategories.Any(c =>
            selectedCategoryId.HasValue &&
            c.CategoryId == selectedCategoryId.Value &&
            c.CategoryType != null &&
            (c.CategoryType.TypeCode == 'P' || c.CategoryType.TypeCode == 'M'));

    protected override async Task OnInitializedAsync()
    {
        allCategories = await CategorySvc.GetAllAsync();
        await LoadItemsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadItemsAsync();
    }

    private async Task LoadItemsAsync()
    {
        var goods = await InventorySvc.GetAllAsync();
        var latestStock = goods.SelectMany(g => g.Stocks)
            .GroupBy(s => s.RgId)
            .ToDictionary(g => g.Key, g => g.OrderByDescending(x => x.LastUpdated).First());

        _items = goods.Select(g =>
        {
            var categories = g.Categories.Select(rc => rc.Category).Where(c => c != null).ToList();

            var typeCode = categories.Select(c => c!.CategoryType?.TypeCode)
                                     .Where(tc => tc.HasValue)
                                     .Select(tc => tc!.Value)
                                     .Distinct()
                                     .OrderBy(tc => tc switch
                                     {
                                         'P' => 0,
                                         'M' => 1,
                                         'N' => 2,
                                         'O' => 3,
                                         _ => 99
                                     })
                                     .FirstOrDefault();

            var typeSlug = typeCode switch
            {
                'P' => "perishable",
                'M' => "medical",
                'N' => "non-perishable",
                'O' => "others",
                _ => string.Empty
            };

            var primaryCatName = categories.FirstOrDefault()?.CategoryName ?? "Uncategorized";
            var hasStock = latestStock.TryGetValue(g.RgId, out var st);

            return new Item
            {
                Sku = $"RG-{g.RgId}",
                Name = g.Name,
                Category = primaryCatName,
                CategoryTypeSlug = typeSlug,
                Quantity = hasStock ? st!.Quantity : 0,
                ReorderLevel = 0,
                Unit = g.Unit,
                LastUpdated = hasStock ? st!.LastUpdated : g.CreatedAt
            };
        }).ToList();
    }

    private static bool IsTypeSlug(string slug) =>
        slug is "perishable" or "non-perishable" or "medical" or "others";

    private IEnumerable<Item> BaseItems
    {
        get
        {
            if (_items.Count == 0) return Enumerable.Empty<Item>();
            if (string.IsNullOrWhiteSpace(categorySlug)) return _items;

            var slug = categorySlug.ToLowerInvariant();
            return IsTypeSlug(slug)
                ? _items.Where(i => i.CategoryTypeSlug == slug)
                : _items.Where(i => i.Category.ToLowerInvariant() == slug.Replace('-', ' '));
        }
    }

    private IEnumerable<Item> FilteredItems
    {
        get
        {
            var q = BaseItems;

            if (!string.IsNullOrWhiteSpace(search))
            {
                q = q.Where(i =>
                    i.Name.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    i.Sku.Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            if (!string.IsNullOrWhiteSpace(stockFilter))
            {
                q = stockFilter switch
                {
                    "low" => q.Where(IsLow),
                    "out" => q.Where(IsOut),
                    "ok" => q.Where(i => !IsLow(i) && !IsOut(i)),
                    _ => q
                };
            }

            return sortBy switch
            {
                "qty_desc" => q.OrderByDescending(i => i.Quantity),
                "qty_asc" => q.OrderBy(i => i.Quantity),
                _ => q.OrderBy(i => i.Name)
            };
        }
    }

    private int LowCount => BaseItems.Count(IsLow);
    private int OutCount => BaseItems.Count(IsOut);

    private static bool IsOut(Item i) => i.Quantity <= 0;
    private static bool IsLow(Item i) => !IsOut(i) && i.Quantity <= i.ReorderLevel;

    private static int StockPercent(Item i)
    {
        if (IsOut(i)) return 0;
        var cap = Math.Max(i.ReorderLevel * 2, i.ReorderLevel + 1);
        return Math.Clamp((int)Math.Round(i.Quantity / (double)cap * 100), 0, 100);
    }

    private string StatusText(Item i) =>
        IsOut(i) ? "OUT" :
        IsLow(i) ? "LOW" : "OK";

    private string StatusClass(Item i) =>
        IsOut(i) ? "st-out" :
        IsLow(i) ? "st-low" : "st-ok";

    private void ToggleView() => isCardView = !isCardView;

    private void ClearFilters()
    {
        search = string.Empty;
        stockFilter = string.Empty;
        sortBy = "name_asc";
    }

    private void GoOverview() => Nav.NavigateTo("/inventory");

    private void Refresh() =>
        _ = LoadItemsAsync().ContinueWith(_ => InvokeAsync(StateHasChanged));

    private void OpenAddModal()
    {
        showAdd = true;
        addError = string.Empty;
        newName = "";
        newSku = "";
        newUnit = "";
        newDesc = "";
        newQty = 0;
        newMaxCapacity = 1000;
        newExpirationDate = null;

        selectedCategoryId = null;

        var slug = categorySlug.ToLowerInvariant();
        if (IsTypeSlug(slug))
        {
            // auto-preselect a category that matches this type tab
            var autoCat = allCategories.FirstOrDefault(c => c.CategoryType != null && (
                (slug == "perishable" && c.CategoryType.TypeCode == 'P') ||
                (slug == "non-perishable" && c.CategoryType.TypeCode == 'N') ||
                (slug == "medical" && c.CategoryType.TypeCode == 'M') ||
                (slug == "others" && c.CategoryType.TypeCode == 'O')
            ));
            if (autoCat != null)
                selectedCategoryId = autoCat.CategoryId;
        }
    }

    private void CloseAdd()
    {
        if (saving) return;
        showAdd = false;
    }

    private async Task SaveNew()
    {
        if (saving) return;
        addError = string.Empty;

        if (string.IsNullOrWhiteSpace(newName) || string.IsNullOrWhiteSpace(newUnit))
        {
            addError = "Name and Unit are required.";
            return;
        }

        if (!selectedCategoryId.HasValue)
        {
            addError = "Please select a category.";
            return;
        }

        if (RequiresExpiration && !newExpirationDate.HasValue)
        {
            addError = "Expiration date is required for this item.";
            return;
        }

        if (newExpirationDate.HasValue && newExpirationDate.Value < DateTime.Today)
        {
            addError = "Expiration date cannot be in the past.";
            return;
        }

        saving = true;
        try
        {
            var rg = new ReliefGood
            {
                Name = newName.Trim(),
                Unit = newUnit.Trim(),
                Description = string.IsNullOrWhiteSpace(newDesc) ? null : newDesc.Trim(),
                IsActive = true,
                ExpirationDate = newExpirationDate,
                RequiresExpiration = RequiresExpiration
            };

            var catIds = new List<int> { selectedCategoryId.Value };
            var result = await InventorySvc.CreateAsync(rg, catIds);
            if (result.error != null)
            {
                addError = result.error;
                return;
            }

            var entity = result.entity;
            if (entity == null)
            {
                addError = "Create failed.";
                return;
            }

            if (newQty > 0)
            {
                var stockResult = await StockSvc.CreateAsync(entity.RgId, newQty, newMaxCapacity);
                if (stockResult.error != null)
                {
                    addError = $"Item created but stock failed: {stockResult.error}";
                    return;
                }
            }

            await LoadItemsAsync();
            showAdd = false;
        }
        finally
        {
            saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}