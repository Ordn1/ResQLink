@page "/shelters"
@inject ResQLink.Data.AppDbContext Db
@inject ResQLink.Services.ArchiveService ArchiveService
@inject ResQLink.Services.AuthState Auth
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities
@using ResQLink.Components.Shared

@* ========== ALERT MODALS - ADD AT TOP ========== *@

@* Success Alerts *@
<AlertModal @bind-IsVisible="showSaveSuccess"
            Title="@successTitle"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

<AlertModal @bind-IsVisible="showDeleteSuccess"
            Title="Shelter Archived"
            Message="@deleteSuccessMessage"
            Type="AlertModal.AlertType.Success" />

@* Error Alerts *@
<AlertModal @bind-IsVisible="showLoadError"
            Title="Error Loading Data"
            Message="@globalError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showSaveError"
            Title="Error Saving Shelter"
            Message="@formError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showDeleteError"
            Title="Error Archiving Shelter"
            Message="@formError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showValidationError"
            Title="Validation Error"
            Message="@formError"
            Type="AlertModal.AlertType.Warning" />

@* Confirmation Dialogs *@
<AlertModal @bind-IsVisible="showDeleteConfirm"
            Title="Confirm Archive"
            Message="@deleteConfirmMessage"
            DetailMessage="This shelter will be moved to archives. All related data will be preserved. Administrators can restore it from the Archives page if needed."
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Archive"
            CancelText="Cancel"
            IsProcessing="isArchiving"
            OnConfirm="ExecuteArchive"
            OnCancel="CancelArchive" />

@* ========== END ALERT MODALS ========== *@

<div class="shelters-root">

    @* KPI / Overview panel *@
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Shelters Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary" @onclick="BeginCreate" disabled="@showForm">
                    <i class="bi bi-house-add"></i> Add Shelter
                </button>
                <button class="mini-btn" @onclick="RefreshAsync" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-houses"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Shelters</div>
                    <div class="kpi-value">@All.Count</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Active</div>
                    <div class="kpi-value">@All.Count(s => s.IsActive)</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-x-circle"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Inactive</div>
                    <div class="kpi-value">@All.Count(s => !s.IsActive)</div>
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Shelters</h2>
            <div class="panel-actions">
                <input class="mini-input" placeholder="Search name or location…" @bind="search" @bind:event="oninput" />
                <select class="mini-input" @bind="disasterFilter" @bind:after="ResetPagination">
                    <option value="0">All Disasters</option>
                    @foreach (var d in DisasterOptions)
                    {
                        <option value="@d.DisasterId">@d.Title</option>
                    }
                </select>
                <select class="mini-input" @bind="statusFilter" @bind:after="ResetPagination">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
                <button class="mini-btn btn-primary" @onclick="BeginCreate" disabled="@showForm">
                    <i class="bi bi-plus-circle"></i> New
                </button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Location</th>
                        <th>Disaster</th>
                        <th class="t-center">Capacity</th>
                        <th class="t-center">Occupancy</th>
                        <th class="t-center">Status</th>
                        <th class="t-center" style="width:150px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in PagedShelters)
                    {
                        <tr>
                            <td><strong>@s.Name</strong></td>
                            <td>@s.Location</td>
                            <td>@(s.Disaster ?? "—")</td>
                            <td class="t-center">@s.Capacity</td>
                            <td class="t-center">@s.CurrentOccupancy</td>
                            <td class="t-center">
                                <span class="status-chip @(s.IsActive ? "st-active" : "st-contained")">
                                    @(s.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="action-cell">
                                <button class="action-btn edit"
                                        @onclick="() => BeginEdit(s.Id)"
                                        disabled="@(showForm || showDeleteConfirm)"
                                        title="Edit shelter">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action-btn view"
                                        @onclick="() => ViewStock(s.Id)"
                                        disabled="@(showForm || showDeleteConfirm)"
                                        title="View stock">
                                    <i class="bi bi-box-seam"></i>
                                </button>
                                <button class="action-btn delete"
                                        @onclick="() => ShowArchiveConfirmation(s)"
                                        disabled="@(showForm || showDeleteConfirm || isArchiving)"
                                        title="Archive shelter">
                                    <i class="bi bi-archive"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!PagedShelters.Any())
                    {
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                                <div class="empty-text">
                                    @if (!string.IsNullOrWhiteSpace(search) || disasterFilter != 0 || !string.IsNullOrWhiteSpace(statusFilter))
                                    {
                                        <text>No shelters match your filters.</text>
                                    }
                                    else
                                    {
                                        <text>No shelters found.</text>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">
                <i class="bi bi-info-circle"></i>
                Showing @StartIndex–@EndIndex of @FilteredCount shelters
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize" @bind:after="ResetPagination">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>
</div>

@* Create/Edit Shelter Modal *@
@if (showForm)
{
    <div class="modal-overlay">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(editModel.ShelterId == 0 ? "Add Shelter" : "Edit Shelter")</h3>
                <button class="modal-close" @onclick="CancelForm" disabled="@saving" @onclick:stopPropagation="true">&times;</button>
            </div>
            <div class="modal-body">
                @if (loadingForm)
                {
                    <div class="loading-text" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="display: inline-block;"></div>
                        <p style="margin-top: 10px;">Loading shelter details...</p>
                    </div>
                }
                else
                {
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shelterName">Name *</label>
                            <input id="shelterName" 
                                   class="form-control @(fieldErrors.ContainsKey("Name") ? "is-invalid" : "")" 
                                   @bind="editModel.Name" 
                                   @bind:event="oninput"
                                   @onblur="() => ValidateField(nameof(editModel.Name))"
                                   placeholder="e.g., Central Evacuation Center"
                                   maxlength="255" />
                            @if (fieldErrors.ContainsKey("Name"))
                            {
                                <div class="invalid-feedback">@fieldErrors["Name"]</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="shelterLocation">Location</label>
                            <input id="shelterLocation" 
                                   class="form-control" 
                                   @bind="editModel.Location"
                                   placeholder="e.g., Barangay Hall, City Center"
                                   maxlength="255" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="capacity">Capacity *</label>
                            <input id="capacity" 
                                   class="form-control @(fieldErrors.ContainsKey("Capacity") ? "is-invalid" : "")" 
                                   type="number" 
                                   @bind="editModel.Capacity" 
                                   @bind:event="oninput"
                                   @onblur="() => ValidateField(nameof(editModel.Capacity))"
                                   min="0" 
                                   max="100000"
                                   placeholder="0" />
                            @if (fieldErrors.ContainsKey("Capacity"))
                            {
                                <div class="invalid-feedback">@fieldErrors["Capacity"]</div>
                            }
                            <small class="form-text text-muted">Maximum number of evacuees</small>
                        </div>
                        <div class="form-group">
                            <label for="occupancy">Current Occupancy *</label>
                            <input id="occupancy" 
                                   class="form-control @(fieldErrors.ContainsKey("CurrentOccupancy") ? "is-invalid" : "")" 
                                   type="number" 
                                   @bind="editModel.CurrentOccupancy" 
                                   @bind:event="oninput"
                                   @onblur="() => ValidateField(nameof(editModel.CurrentOccupancy))"
                                   min="0" 
                                   max="@editModel.Capacity"
                                   placeholder="0" />
                            @if (fieldErrors.ContainsKey("CurrentOccupancy"))
                            {
                                <div class="invalid-feedback">@fieldErrors["CurrentOccupancy"]</div>
                            }
                            <small class="form-text text-muted">
                                @if (editModel.Capacity > 0)
                                {
                                    @:(@(Math.Round((double)editModel.CurrentOccupancy / editModel.Capacity * 100, 1))% occupied)
                                }
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="disaster">Disaster</label>
                            <select id="disaster" class="form-control" @bind="editModel.DisasterId">
                                <option value="">(None)</option>
                                @foreach (var d in DisasterOptions)
                                {
                                    <option value="@d.DisasterId">@d.Title</option>
                                }
                            </select>
                            <small class="form-text text-muted">Optional: Link to a specific disaster</small>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" class="form-control" @bind="editModel.IsActive">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CancelForm"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveAsync"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            @(editModel.ShelterId == 0 ? "Create" : "Update")
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private record ShelterRow(
        int Id,
        string Name,
        string Location,
        string? Disaster,
        int Capacity,
        int CurrentOccupancy,
        bool IsActive,
        int? DisasterId
    );

    private List<ShelterRow> All = new();
    private List<Disaster> DisasterOptions = new();

    private string search = string.Empty;
    private int disasterFilter = 0;
    private string statusFilter = string.Empty;
    private int _pageIndex = 0;
    private int pageSize = 10;

    private bool showForm = false;
    private bool saving = false;
    private bool loadingForm = false;
    private bool isArchiving = false;
    private string formError = string.Empty;
    private string globalError = string.Empty;
    private Dictionary<string, string> fieldErrors = new();

    private ShelterEditModel editModel = new();
    private ShelterRow? shelterToArchive = null;

    // NEW: Alert modal state variables
    private bool showLoadError = false;
    private bool showSaveSuccess = false;
    private string successTitle = "";
    private string successMessage = "";
    private bool showSaveError = false;
    private bool showDeleteSuccess = false;
    private string deleteSuccessMessage = "";
    private bool showDeleteError = false;
    private bool showValidationError = false;
    private bool showDeleteConfirm = false;
    private string deleteConfirmMessage = "";

    private class ShelterEditModel
    {
        public int ShelterId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Location { get; set; }
        public int? DisasterId { get; set; }
        public int Capacity { get; set; } = 0;
        public int CurrentOccupancy { get; set; } = 0;
        public bool IsActive { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadAsync();
        }
        catch (Exception ex)
        {
            globalError = $"Failed to load shelters: {ex.Message}";
            showLoadError = true;
            await LogErrorAsync("OnInitializedAsync", ex);
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            DisasterOptions = await Db.Disasters
                .AsNoTracking()
                .OrderBy(d => d.Title)
                .ToListAsync();

            var data = await Db.Shelters
                .Include(s => s.Disaster)
                .AsNoTracking()
                .ToListAsync();

            All = data.Select(s => new ShelterRow(
                    s.ShelterId,
                    s.Name,
                    s.Location ?? "—",
                    s.Disaster?.Title,
                    s.Capacity,
                    s.CurrentOccupancy,
                    s.IsActive,
                    s.DisasterId
                ))
                .OrderBy(s => s.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            globalError = $"Error loading data: {ex.Message}";
            showLoadError = true;
            await LogErrorAsync("LoadAsync", ex);
        }
    }

    private async Task RefreshAsync()
    {
        await LoadAsync();
        _pageIndex = 0;
        StateHasChanged();
    }

    private IEnumerable<ShelterRow> Query => All
        .Where(s =>
            string.IsNullOrWhiteSpace(search)
            || s.Name.Contains(search, StringComparison.OrdinalIgnoreCase)
            || (s.Location?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(s => disasterFilter == 0 || s.DisasterId == disasterFilter)
        .Where(s => string.IsNullOrEmpty(statusFilter)
                    || (statusFilter == "Active" ? s.IsActive : !s.IsActive));

    private int FilteredCount => Query.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(FilteredCount / (double)pageSize), 1);
    private int StartIndex => FilteredCount == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, FilteredCount);
    private IEnumerable<ShelterRow> PagedShelters => Query.Skip(_pageIndex * pageSize).Take(pageSize);

    private void ResetPagination()
    {
        _pageIndex = 0;
    }

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    private void ClearFilters()
    {
        search = string.Empty;
        disasterFilter = 0;
        statusFilter = string.Empty;
        _pageIndex = 0;
    }

    private void BeginCreate()
    {
        editModel = new ShelterEditModel();
        formError = string.Empty;
        fieldErrors.Clear();
        showForm = true;
    }

    private async Task BeginEdit(int id)
    {
        if (loadingForm || saving) return;

        loadingForm = true;
        formError = string.Empty;
        fieldErrors.Clear();
        showForm = true;
        StateHasChanged();

        try
        {
            var entity = await Db.Shelters.AsNoTracking().FirstOrDefaultAsync(s => s.ShelterId == id);
            if (entity == null)
            {
                formError = "Shelter not found.";
                showForm = false;
                showSaveError = true;
                return;
            }

            editModel = new ShelterEditModel
            {
                ShelterId = entity.ShelterId,
                Name = entity.Name,
                Location = entity.Location,
                DisasterId = entity.DisasterId,
                Capacity = entity.Capacity,
                CurrentOccupancy = entity.CurrentOccupancy,
                IsActive = entity.IsActive
            };
        }
        catch (Exception ex)
        {
            formError = $"Error loading shelter: {ex.Message}";
            showSaveError = true;
            showForm = false;
            await LogErrorAsync("BeginEdit", ex);
        }
        finally
        {
            loadingForm = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ValidateField(string fieldName)
    {
        fieldErrors.Remove(fieldName);

        switch (fieldName)
        {
            case nameof(editModel.Name):
                if (string.IsNullOrWhiteSpace(editModel.Name))
                    fieldErrors[fieldName] = "Name is required";
                else if (editModel.Name.Trim().Length < 3)
                    fieldErrors[fieldName] = "Name must be at least 3 characters";
                else if (editModel.Name.Length > 255)
                    fieldErrors[fieldName] = "Name must not exceed 255 characters";
                break;

            case nameof(editModel.Capacity):
                if (editModel.Capacity < 0)
                    fieldErrors[fieldName] = "Capacity must be ≥ 0";
                else if (editModel.Capacity > 100000)
                    fieldErrors[fieldName] = "Capacity seems unrealistically high";
                else if (editModel.CurrentOccupancy > editModel.Capacity)
                    fieldErrors["CurrentOccupancy"] = "Occupancy cannot exceed capacity";
                break;

            case nameof(editModel.CurrentOccupancy):
                if (editModel.CurrentOccupancy < 0)
                    fieldErrors[fieldName] = "Occupancy must be ≥ 0";
                else if (editModel.CurrentOccupancy > editModel.Capacity)
                    fieldErrors[fieldName] = "Occupancy cannot exceed capacity";
                break;
        }
    }

    private bool Validate()
    {
        fieldErrors.Clear();

        ValidateField(nameof(editModel.Name));
        ValidateField(nameof(editModel.Capacity));
        ValidateField(nameof(editModel.CurrentOccupancy));

        if (fieldErrors.Any())
        {
            formError = "Please correct the highlighted errors";
            return false;
        }

        return true;
    }

    private async Task<bool> ValidateForeignKeysAsync()
    {
        try
        {
            if (editModel.DisasterId.HasValue && editModel.DisasterId.Value > 0)
            {
                var disasterExists = await Db.Disasters.AnyAsync(d => d.DisasterId == editModel.DisasterId.Value);
                if (!disasterExists)
                {
                    formError = "Selected disaster is invalid";
                    return false;
                }
            }
            return true;
        }
        catch (Exception ex)
        {
            formError = $"Validation error: {ex.Message}";
            await LogErrorAsync("ValidateForeignKeysAsync", ex);
            return false;
        }
    }

    private async Task SaveAsync()
    {
        if (saving) return;
        saving = true;
        formError = string.Empty;
        fieldErrors.Clear();

        try
        {
            if (!Validate())
            {
                showValidationError = true;
                return;
            }
            
            if (!await ValidateForeignKeysAsync())
            {
                showSaveError = true;
                return;
            }

            if (editModel.ShelterId == 0)
            {
                var entity = new Shelter
                {
                    Name = editModel.Name.Trim(),
                    Location = editModel.Location?.Trim(),
                    Capacity = editModel.Capacity,
                    CurrentOccupancy = editModel.CurrentOccupancy,
                    DisasterId = editModel.DisasterId,
                    IsActive = editModel.IsActive
                };
                Db.Shelters.Add(entity);
                
                successTitle = "Shelter Created";
                successMessage = $"Shelter '{editModel.Name}' created successfully!";
            }
            else
            {
                var entity = await Db.Shelters.FirstOrDefaultAsync(s => s.ShelterId == editModel.ShelterId);
                if (entity == null)
                {
                    formError = "Shelter record not found";
                    showSaveError = true;
                    return;
                }
                entity.Name = editModel.Name.Trim();
                entity.Location = editModel.Location?.Trim();
                entity.Capacity = editModel.Capacity;
                entity.CurrentOccupancy = editModel.CurrentOccupancy;
                entity.DisasterId = editModel.DisasterId;
                entity.IsActive = editModel.IsActive;
                Db.Shelters.Update(entity);
                
                successTitle = "Shelter Updated";
                successMessage = $"Shelter '{editModel.Name}' updated successfully!";
            }

            await Db.SaveChangesAsync();
            showForm = false;
            await LoadAsync();
            showSaveSuccess = true;
        }
        catch (DbUpdateException ex) when (ex.InnerException is Microsoft.Data.SqlClient.SqlException sql)
        {
            formError = sql.Number switch
            {
                2601 or 2627 => "A shelter with this name already exists",
                547 => "Cannot save: Referenced data is invalid or missing",
                _ => $"Database error: {sql.Message}"
            };
            showSaveError = true;
            await LogErrorAsync("SaveAsync", ex);
        }
        catch (DbUpdateException ex)
        {
            formError = $"Database update error: {ex.InnerException?.Message ?? ex.Message}";
            showSaveError = true;
            await LogErrorAsync("SaveAsync", ex);
        }
        catch (Exception ex)
        {
            formError = $"Unexpected error: {ex.Message}";
            showSaveError = true;
            await LogErrorAsync("SaveAsync", ex);
        }
        finally
        {
            saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ShowArchiveConfirmation(ShelterRow shelter)
    {
        shelterToArchive = shelter;
        
        var evacueeInfo = shelter.CurrentOccupancy > 0 
            ? $" with {shelter.CurrentOccupancy} evacuee(s) currently assigned" 
            : "";
        
        deleteConfirmMessage = $"Are you sure you want to archive shelter '{shelter.Name}'{evacueeInfo}?";
        showDeleteConfirm = true;
    }

    private async Task ExecuteArchive()
    {
        if (shelterToArchive == null || isArchiving) return;

        isArchiving = true;
        formError = string.Empty;

        try
        {
            var entity = await Db.Shelters
                .Include(s => s.Evacuees)
                .FirstOrDefaultAsync(s => s.ShelterId == shelterToArchive.Id);
            
            if (entity == null)
            {
                formError = "Shelter not found";
                showDeleteError = true;
                showDeleteConfirm = false;
                return;
            }

            var evacueeCount = entity.Evacuees.Count;
            var reason = evacueeCount > 0
                ? $"Archived with {evacueeCount} evacuee(s) assigned"
                : "Archived by user";

            var entityName = !string.IsNullOrEmpty(entity.Location)
                ? $"{entity.Name} ({entity.Location})"
                : entity.Name;

            var result = await ArchiveService.ArchiveAsync<Shelter>(
                shelterToArchive.Id,
                reason,
                entityName);

            if (!result.success)
            {
                formError = result.error ?? "Failed to archive shelter.";
                showDeleteError = true;
                showDeleteConfirm = false;
                return;
            }

            deleteSuccessMessage = $"Shelter '{shelterToArchive.Name}' has been archived successfully. Administrators can restore it from the Archives page.";
            showDeleteConfirm = false;
            await LoadAsync();
            
            // Adjust current page if needed
            if (_pageIndex >= TotalPages && TotalPages > 0)
                _pageIndex = TotalPages - 1;
            
            showDeleteSuccess = true;
        }
        catch (DbUpdateException ex)
        {
            formError = $"Archive failed: {ex.InnerException?.Message ?? ex.Message}";
            showDeleteError = true;
            showDeleteConfirm = false;
            await LogErrorAsync("ExecuteArchive", ex);
        }
        catch (Exception ex)
        {
            formError = $"Archive failed: {ex.Message}";
            showDeleteError = true;
            showDeleteConfirm = false;
            await LogErrorAsync("ExecuteArchive", ex);
        }
        finally
        {
            isArchiving = false;
            shelterToArchive = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CancelArchive()
    {
        showDeleteConfirm = false;
        shelterToArchive = null;
        isArchiving = false;
    }

    private void CancelForm()
    {
        if (saving) return;
        showForm = false;
        formError = string.Empty;
        fieldErrors.Clear();
    }

    private void ViewStock(int shelterId)
    {
        Nav.NavigateTo($"/shelter/{shelterId}/stocks");
    }

    private async Task LogErrorAsync(string method, Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"[Shelters.{method}] {ex.GetType().Name}: {ex.Message}");
        await Task.CompletedTask;
    }
}