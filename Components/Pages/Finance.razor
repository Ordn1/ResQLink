@page "/finance"
@using ResQLink.Components.Shared
@inject ResQLink.Services.AuthState Auth
@inject ResQLink.Services.BudgetService BudgetSvc
@inject ResQLink.Services.ProcurementService ProcSvc
@inject ResQLink.Services.SupplierService SupplierSvc
@inject ResQLink.Services.BudgetStateService BudgetState
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@implements IDisposable

@using ResQLink.Data.Entities
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data

@* ========== ALERT MODALS - ADD AT TOP ========== *@

@* Access Denied *@
<AlertModal @bind-IsVisible="showAccessDenied"
            Title="Access Denied"
            Message="You do not have permission to access this page."
            Type="AlertModal.AlertType.Warning" />

@* Success Alerts *@
<AlertModal @bind-IsVisible="showBudgetSaveSuccess"
            Title="@successTitle"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

<AlertModal @bind-IsVisible="showRequestSaveSuccess"
            Title="@successTitle"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

@* Error Alerts *@
<AlertModal @bind-IsVisible="showBudgetSaveError"
            Title="Error Saving Budget"
            Message="@budgetError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showRequestSaveError"
            Title="Error Saving Request"
            Message="@requestError"
            Type="AlertModal.AlertType.Error" />

@* Validation/Warning Alerts *@
<AlertModal @bind-IsVisible="showProcurementLimitWarning"
            Title="Procurement Limit Warning"
            Message="@procurementLimitMessage"
            DetailMessage="Current total would exceed the ₱50,000.00 procurement limit. Please reduce the item quantity or unit price."
            Type="AlertModal.AlertType.Warning" />

<AlertModal @bind-IsVisible="showBudgetValidationError"
            Title="Validation Error"
            Message="@budgetError"
            Type="AlertModal.AlertType.Warning" />

<AlertModal @bind-IsVisible="showRequestValidationError"
            Title="Validation Error"
            Message="@requestError"
            Type="AlertModal.AlertType.Warning" />

@* Status Change Confirmation *@
<AlertModal @bind-IsVisible="showStatusChangeConfirm"
            Title="Confirm Status Change"
            Message="@statusChangeMessage"
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Update Status"
            CancelText="Cancel"
            IsProcessing="isChangingStatus"
            OnConfirm="ExecuteStatusChange"
            OnCancel="CancelStatusChange" />

@* Procurement Limit Exceeded Alert *@
<AlertModal @bind-IsVisible="showProcurementLimitExceeded"
            Title="Procurement Limit Exceeded"
            Message="Cannot add item. Total would exceed the ₱50,000.00 procurement limit."
            DetailMessage="@procurementExceededDetails"
            Type="AlertModal.AlertType.Error" />

@* Budget Creation Success with Status Update Info *@
<AlertModal @bind-IsVisible="showBudgetCreatedWithStatusUpdate"
            Title="Budget Created Successfully"
            Message="@budgetSuccessMessage"
            DetailMessage="The linked procurement request status has been automatically updated to 'Ordered'."
            Type="AlertModal.AlertType.Success" />

@* ========== END ALERT MODALS ========== *@

@if (!(Auth.IsInRole("Finance Manager") || Auth.IsInRole("Admin")))
{
    @* Trigger access denied modal *@
    showAccessDenied = true;
}
else
{
    <div class="finance-root">

        <section class="panel kpi-panel">
            <header class="panel-head">
                <h2 class="panel-title">Finance — Budgeting & Procurement</h2>
                <div class="panel-actions">
                    <button class="mini-btn" @onclick="RefreshAll" title="Refresh">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </header>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon-circle">
                        <i class="bi bi-folder-fill"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Total Budgets</div>
                        <div class="kpi-value">@Budgets.Count</div>
                        <div class="kpi-detail">₱@Budgets.Sum(b => b.TotalAmount).ToString("N2") allocated</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon-circle">
                        <i class="bi bi-file-text-fill"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Procurement Requests</div>
                        <div class="kpi-value">@Requests.Count</div>
                        <div class="kpi-detail">₱@Requests.Sum(r => r.TotalAmount).ToString("N2")</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon-circle">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Approved Requests</div>
                        <div class="kpi-value">@Requests.Count(r => r.Status == "Approved")</div>
                        <div class="kpi-detail">₱@Requests.Where(r => r.Status == "Approved").Sum(r => r.TotalAmount).ToString("N2")</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon-circle">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">Pending Requests</div>
                        <div class="kpi-value">@Requests.Count(r => r.Status is "Draft" or "Submitted")</div>
                        <div class="kpi-detail">₱@Requests.Where(r => r.Status is "Draft" or "Submitted").Sum(r => r.TotalAmount).ToString("N2")</div>
                    </div>
                </div>
            </div>
        </section>

    <div class="two-col">
        <!-- Budgets -->
        <section class="panel finance-section">
            <header class="panel-head">
                <div class="panel-title-group">
                    <i class="bi bi-wallet2 panel-icon"></i>
                    <h2 class="panel-title">Barangay Budgets</h2>
                </div>
                <div class="panel-actions">
                    <input class="mini-input" placeholder="Search barangay or year…" @bind="budgetSearch" @bind:event="oninput" />
                    <select class="mini-input" @bind="budgetStatus">
                        <option value="">All Status</option>
                        <option>Draft</option>
                        <option>Approved</option>
                        <option>Closed</option>
                    </select>
                    <button class="mini-btn btn-primary" @onclick="NewBudget">
                        <i class="bi bi-plus-circle"></i> New Budget
                    </button>
                </div>
            </header>

            <div class="table-wrap">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th>Barangay</th>
                            <th class="t-center">Year</th>
                            <th class="t-right">Total Allocated</th>
                            <th class="t-right">Spent</th>
                            <th class="t-right">Available</th>
                            <th class="t-center">Status</th>
                            <th class="t-center" style="width:200px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var b in PagedBudgets)
                        {
                            var spent = budgetSpent.ContainsKey(b.BudgetId) ? budgetSpent[b.BudgetId] : 0m;
                            var available = b.TotalAmount - spent;
                            var percentUsed = b.TotalAmount > 0 ? (spent / b.TotalAmount * 100) : 0;
                            
                            <tr>
                                <td><strong>@b.BarangayName</strong></td>
                                <td class="t-center">@b.Year</td>
                                <td class="t-right">
                                    <span class="amount-text text-muted" style="font-size: 0.85rem;">₱@b.TotalAmount.ToString("N2")</span>
                                </td>
                                <td class="t-right">
                                    <span class="amount-text" style="color: #dc2626; font-size: 0.85rem;">₱@spent.ToString("N2")</span>
                                </td>
                                <td class="t-right">
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <span class="amount-text" style="font-weight: 700; color: @(available > 0 ? "#16a34a" : "#dc2626");">
                                            ₱@available.ToString("N2")
                                        </span>
                                        <span style="font-size: 0.65rem; color: #6b7280;">
                                            @percentUsed.ToString("F1")% used
                                        </span>
                                    </div>
                                </td>
                                <td class="t-center"><span class="status-chip status-@b.Status.ToLower()">@b.Status</span></td>
                                <td class="action-cell">
                                    <button class="action-btn edit" @onclick="() => EditBudget(b)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="action-btn view" @onclick="() => ManageBudgetItems(b)" title="Items">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                        @if (!PagedBudgets.Any())
                        {
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                                    <div class="empty-text">No budgets found</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <footer class="panel-foot">
                <div class="foot-left">
                    Showing @BudgetStartIndex–@BudgetEndIndex of @BudgetTotalFiltered budgets
                </div>
                <div class="foot-right">
                    <label class="foot-label">Rows</label>
                    <select class="mini-input" @bind="budgetPageSize">
                        <option>10</option>
                        <option>20</option>
                        <option>50</option>
                    </select>
                    <button class="mini-btn" @onclick="BudgetPrevPage" disabled="@(_budgetPageIndex == 0)">Prev</button>
                    <span class="page-indicator">Page @(_budgetPageIndex + 1) / @BudgetTotalPages</span>
                    <button class="mini-btn" @onclick="BudgetNextPage" disabled="@(_budgetPageIndex >= BudgetTotalPages - 1)">Next</button>
                </div>
            </footer>
        </section>

        <!-- Procurement -->
        <section class="panel finance-section">
            <header class="panel-head">
                <div class="panel-title-group">
                    <i class="bi bi-cart3 panel-icon"></i>
                    <h2 class="panel-title">Procurement Requests</h2>
                </div>
                <div class="panel-actions">
                    <input class="mini-input" placeholder="Search barangay…" @bind="requestSearch" @bind:event="oninput" />
                    <select class="mini-input" @bind="requestStatus">
                        <option value="">All Status</option>
                        <option>Draft</option>
                        <option>Submitted</option>
                        <option>Approved</option>
                        <option>Rejected</option>
                        <option>Ordered</option>
                    </select>
                    <button class="mini-btn btn-primary" @onclick="NewRequest">
                        <i class="bi bi-plus-circle"></i> New Request
                    </button>
                </div>
            </header>

            <div class="table-wrap">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th>Barangay</th>
                            <th>Supplier</th>
                            <th class="t-right">Total Amount</th>
                            <th class="t-center">Status</th>
                            <th class="t-center" style="width:250px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in PagedRequests)
                        {
                            <tr>
                                <td><strong>@r.BarangayName</strong></td>
                                <td>
                                    @if (r.Supplier != null)
                                    {
                                        <span class="supplier-badge"><i class="bi bi-building"></i> @r.Supplier.SupplierName</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted" style="font-style: italic;"><i class="bi bi-person-fill"></i> Anonymous</span>
                                    }
                                </td>
                                <td class="t-right"><span class="amount-text">₱@r.TotalAmount.ToString("N2")</span></td>
                                <td class="t-center"><span class="status-chip status-@r.Status.ToLower()">@r.Status</span></td>
                                <td class="action-cell">
                                    <button class="action-btn edit" 
                                            @onclick="() => EditRequest(r)" 
                                            title="Edit"
                                            disabled="@(r.Status == "Ordered")">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="action-btn view" 
                                            @onclick="() => ManageRequestItems(r)" 
                                            title="Items"
                                            disabled="@(r.Status == "Ordered")">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    @if (r.Status == "Draft")
                                    {
                                        <button class="action-btn submit" @onclick='() => QuickStatus(r.RequestId, "Submitted")' title="Submit">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    }

                                </td>
                            </tr>
                        }
                        @if (!PagedRequests.Any())
                        {
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                                    <div class="empty-text">No procurement requests found</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <footer class="panel-foot">
                <div class="foot-left">
                    Showing @RequestStartIndex–@RequestEndIndex of @RequestTotalFiltered requests
                </div>
                <div class="foot-right">
                    <label class="foot-label">Rows</label>
                    <select class="mini-input" @bind="requestPageSize">
                        <option>10</option>
                        <option>20</option>
                        <option>50</option>
                    </select>
                    <button class="mini-btn" @onclick="RequestPrevPage" disabled="@(_requestPageIndex == 0)">Prev</button>
                    <span class="page-indicator">Page @(_requestPageIndex + 1) / @RequestTotalPages</span>
                    <button class="mini-btn" @onclick="RequestNextPage" disabled="@(_requestPageIndex >= RequestTotalPages - 1)">Next</button>
                </div>
            </footer>
        </section>
    </div>

    @* Budget modal - UPDATED WITH DROPDOWN *@
    @if (showBudgetForm)
    {
        <div class="modal-overlay" @onclick="CloseBudgetForm" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(budgetModel.BudgetId == 0 ? "New Budget from Procurement" : "Edit Budget")</h3>
                    <button class="modal-close" @onclick="CloseBudgetForm">&times;</button>
                </div>
                <div class="modal-body">
                    @if (budgetModel.BudgetId == 0)
                    {
                        @* NEW BUDGET: Dropdown from Approved Procurement Requests *@
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label>Select Approved Procurement Request *</label>
                            <select class="form-control" @bind="selectedProcurementRequestId" @bind:after="OnProcurementRequestSelected">
                                <option value="0">-- Select Procurement Request --</option>
                                @foreach (var req in ApprovedProcurementRequests)
                                {
                                    <option value="@req.RequestId">
                                        Req #@req.RequestId - @req.BarangayName - ₱@req.TotalAmount.ToString("N2")
                                    </option>
                                }
                            </select>
                            @if (!ApprovedProcurementRequests.Any())
                            {
                                <small class="form-text" style="color: #f59e0b; display: block; margin-top: 6px;">
                                    <i class="bi bi-exclamation-triangle"></i> No approved procurement requests available
                                </small>
                            }
                        </div>

                        @if (selectedProcurementRequestId > 0)
                        {
                            <div style="padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="bi bi-check-circle-fill" style="color: #16a34a;"></i>
                                    <strong style="color: #166534;">Selected Procurement Request</strong>
                                </div>
                                <div style="font-size: 0.9rem; color: #166534;">
                                    <div><strong>Barangay:</strong> @budgetModel.BarangayName</div>
                                    <div><strong>Amount:</strong> ₱@budgetModel.TotalAmount.ToString("N2")</div>
                                    <div><strong>Year:</strong> @budgetModel.Year</div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        @* EDIT MODE: Show read-only fields *@
                        <div class="form-row">
                            <div class="form-group">
                                <label>Barangay *</label>
                                <input class="form-control" @bind="budgetModel.BarangayName" />
                            </div>
                            <div class="form-group">
                                <label>Year *</label>
                                <input type="number" class="form-control" @bind="budgetModel.Year" min="1900" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Total Amount *</label>
                                <input type="number" step="0.01" class="form-control" @bind="budgetModel.TotalAmount" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                            </div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select class="form-control" @bind="budgetModel.Status">
                                    <option>Draft</option>
                                    <option>Approved</option>
                                    <option>Closed</option>
                                </select>
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(budgetError))
                    {
                        <div class="form-error">@budgetError</div>
                    }
                    <div class="modal-actions">
                        <button class="btn-cancel" @onclick="CloseBudgetForm" disabled="@saving">Cancel</button>
                        <button class="btn-primary" 
                                @onclick="SaveBudget" 
                                disabled="@(saving || (budgetModel.BudgetId == 0 && selectedProcurementRequestId == 0))">
                            @(saving ? "Saving…" : "Save")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Budget items modal *@
    @if (showBudgetItems)
    {
        <div class="modal-overlay" @onclick="CloseBudgetItems" @onclick:stopPropagation="false">
            <div class="modal-dialog large" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Budget Items — @activeBudget?.BarangayName (@activeBudget?.Year)</h3>
                    <button class="modal-close" @onclick="CloseBudgetItems">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category *</label>
                            <input class="form-control" @bind="newItem.Category" />
                        </div>
                        <div class="form-group">
                            <label>Description *</label>
                            <input class="form-control" @bind="newItem.Description" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount *</label>
                            <input type="number" step="0.01" class="form-control" @bind="newItem.Amount" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <input class="form-control" @bind="newItem.Notes" />
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-primary" @onclick="AddBudgetItem" disabled="@saving">Add Item</button>
                    </div>

                    <div class="table-wrap" style="margin-top:10px;">
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th class="t-right">Amount</th>
                                    <th>Notes</th>
                                    <th style="width:120px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var it in budgetItems)
                                {
                                    <tr>
                                        <td>@it.Category</td>
                                        <td>@it.Description</td>
                                        <td class="t-right">@it.Amount.ToString("N2")</td>
                                        <td>@(it.Notes ?? "—")</td>
                                        <td>
                                            <button class="mini-btn" @onclick="() => EditBudgetItem(it)">Edit</button>
                                            <button class="mini-btn" @onclick="() => DeleteBudgetItem(it.BudgetItemId)">Delete</button>
                                        </td>
                                    </tr>
                                }
                                @if (!budgetItems.Any())
                                {
                                    <tr><td colspan="5" class="t-center text-muted">No items.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="panel-foot">
                        <div>Total of items: <strong>@budgetItems.Sum(i => i.Amount).ToString("N2")</strong></div>
                    </div>

                    @if (editItem != null)
                    {
                        <hr />
                        <h5>Edit Item</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Category *</label>
                                <input class="form-control" @bind="editItem.Category" />
                            </div>
                            <div class="form-group">
                                <label>Description *</label>
                                <input class="form-control" @bind="editItem.Description" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Amount *</label>
                                <input type="number" step="0.01" class="form-control" @bind="editItem.Amount" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <input class="form-control" @bind="editItem.Notes" />
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-cancel" @onclick="() => editItem = null">Cancel</button>
                            <button class="btn-primary" @onclick="SaveBudgetItem" disabled="@saving">Update</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @* Request modal *@
    @if (showRequestForm)
    {
        @* Update the Request modal to be read-only when status is "Ordered" *@
        <div class="modal-overlay" @onclick="CloseRequestForm" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(requestModel.RequestId == 0 ? "New Request" : requestModel.Status == "Ordered" ? "View Request (Ordered)" : "Edit Request")</h3>
                    <button class="modal-close" @onclick="CloseRequestForm">&times;</button>
                </div>
                <div class="modal-body">
                    @if (requestModel.Status == "Ordered")
                    {
                        <div style="padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-lock-fill" style="color: #d97706;"></i>
                                <strong style="color: #92400e;">This procurement request is ordered and cannot be edited.</strong>
                            </div>
                        </div>
                    }
                    <div class="form-row">
                        <div class="form-group">
                            <label>Barangay *</label>
                            <input class="form-control" @bind="requestModel.BarangayName" disabled="@(requestModel.Status == "Ordered")" />
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <select class="form-control" @bind="requestModel.SupplierId" disabled="@(requestModel.Status == "Ordered")">
                                <option value="">Anonymous</option>
                                @foreach (var s in Suppliers)
                                {
                                    <option value="@s.SupplierId">@s.SupplierName</option>
                                }
                            </select>
                            @if (!Suppliers.Any())
                            {
                                <small class="form-text" style="color: #f59e0b; display: block; margin-top: 6px;">
                                    <i class="bi bi-exclamation-triangle"></i> No suppliers available. Using Anonymous.
                                </small>
                            }
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status *</label>
                            <select class="form-control" @bind="requestModel.Status" disabled="@(requestModel.Status == "Ordered")">
                                <option>Draft</option>
                                <option>Submitted</option>
                                <option>Approved</option>
                                <option>Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Total</label>
                            <input type="number"
                                   step="0.01"
                                   class="form-control"
                                   @bind="requestModel.TotalAmount"
                                   min="0"
                                   disabled="@(requestModel.Status == "Ordered")"
                                   oninput="this.value = this.value.replace(/^-/, '')" />
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(requestError))
                    {
                        <div class="form-error">@requestError</div>
                    }
                    <div class="modal-actions">
                        <button class="btn-cancel" @onclick="CloseRequestForm" disabled="@saving">
                            @(requestModel.Status == "Ordered" ? "Close" : "Cancel")
                        </button>
                        @if (requestModel.Status != "Ordered")
                        {
                            <button class="btn-primary" @onclick="SaveRequest" disabled="@saving">
                                @(saving ? "Saving…" : "Save")
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* Request Items modal - WITH LIMIT INDICATOR *@
    @if (showRequestItems)
    {
        <div class="modal-overlay" @onclick="CloseRequestItems" @onclick:stopPropagation="false">
            <div class="modal-dialog large" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Request Items — @activeRequest?.BarangayName @(activeRequest?.Status == "Ordered" ? "(Ordered - Read Only)" : "")</h3>
                    <button class="modal-close" @onclick="CloseRequestItems">&times;</button>
                </div>
                <div class="modal-body">

                    @if (activeRequest?.Status == "Ordered")
                    {
                        <div style="padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="bi bi-lock-fill" style="color: #d97706;"></i>
                                <strong style="color: #92400e;">This procurement request is ordered. Items cannot be added, edited, or deleted.</strong>
                            </div>
                        </div>
                    }

                    @* Procurement Limit Indicator *@
                    @{
                        var currentRequestTotal = requestItems.Sum(i => i.UnitPrice * i.Quantity);
                        var percentUsed = PROCUREMENT_LIMIT > 0 ? (currentRequestTotal / PROCUREMENT_LIMIT * 100) : 0;
                        var remaining = PROCUREMENT_LIMIT - currentRequestTotal;
                        var limitColor = percentUsed >= 100 ? "#dc2626" : percentUsed >= 90 ? "#f59e0b" : "#16a34a";
                    }
                    
                    <div style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <strong style="color: #374151;">Procurement Limit Status</strong>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: @limitColor; font-weight: 600;">
                                    @percentUsed.ToString("F1")% Used
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; font-size: 0.85rem;">
                            <div>
                                <span style="color: #6b7280;">Current Total:</span>
                                <strong style="color: @limitColor; margin-left: 4px;">₱@currentRequestTotal.ToString("N2")</strong>
                            </div>
                            <div>
                                <span style="color: #6b7280;">Limit:</span>
                                <strong style="margin-left: 4px;">₱@PROCUREMENT_LIMIT.ToString("N2")</strong>
                            </div>
                            <div>
                                <span style="color: #6b7280;">Remaining:</span>
                                <strong style="color: @(remaining >= 0 ? "#16a34a" : "#dc2626"); margin-left: 4px;">
                                    ₱@remaining.ToString("N2")
                                </strong>
                            </div>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                            <div style="width: @Math.Min(percentUsed, 100)%; height: 100%; background: @limitColor; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                    @if (activeRequest?.Status != "Ordered")
                    {
                        <div class="form-row">
                            <div class="form-group">
                                <label>Item *</label>
                                <input class="form-control" @bind="newReqItem.ItemName" />
                            </div>
                            <div class="form-group">
                                <label>Unit *</label>
                                <input class="form-control" @bind="newReqItem.Unit" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Qty *</label>
                                <input type="number" class="form-control" @bind="newReqItem.Quantity" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                            </div>
                            <div class="form-group">
                                <label>Unit Price *</label>
                                <input type="number" step="0.01" class="form-control" @bind="newReqItem.UnitPrice" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button class="btn-primary" 
                                    @onclick="AddRequestItem" 
                                    disabled="@(saving || remaining <= 0)">
                                Add Item
                            </button>
                        </div>
                    }

                    <div class="table-wrap" style="margin-top:10px;">
                        <table class="dash-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Unit</th>
                                    <th class="t-center">Qty</th>
                                    <th class="t-right">Unit Price</th>
                                    <th class="t-right">Line Total</th>
                                    @if (activeRequest?.Status != "Ordered")
                                    {
                                        <th style="width:120px">Actions</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var it in requestItems)
                                {
                                    <tr>
                                        <td>@it.ItemName</td>
                                        <td>@it.Unit</td>
                                        <td class="t-center">@it.Quantity</td>
                                        <td class="t-right">@it.UnitPrice.ToString("N2")</td>
                                        <td class="t-right">@((it.UnitPrice * it.Quantity).ToString("N2"))</td>
                                        @if (activeRequest?.Status != "Ordered")
                                        {
                                            <td>
                                                <button class="mini-btn" @onclick="() => EditRequestItem(it)">Edit</button>
                                                <button class="mini-btn" @onclick="() => DeleteRequestItem(it.RequestItemId)">Delete</button>
                                            </td>
                                        }
                                    </tr>
                                }
                                @if (!requestItems.Any())
                                {
                                    <tr><td colspan="@(activeRequest?.Status == "Ordered" ? 5 : 6)" class="t-center text-muted">No items.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="panel-foot">
                        <div>Total of items: <strong style="color: @limitColor;">₱@currentRequestTotal.ToString("N2")</strong></div>
                    </div>

                    @if (editReqItem != null && activeRequest?.Status != "Ordered")
                    {
                        <hr />
                        <h5>Edit Item</h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Item *</label>
                                <input class="form-control" @bind="editReqItem.ItemName" />
                            </div>
                            <div class="form-group">
                                <label>Unit *</label>
                                <input class="form-control" @bind="editReqItem.Unit" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Qty *</label>
                                <input type="number" class="form-control" @bind="editReqItem.Quantity" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                            </div>
                            <div class="form-group">
                                <label>Unit Price *</label>
                                <input type="number" step="0.01" class="form-control" @bind="editReqItem.UnitPrice" min="0" oninput="this.value = this.value.replace(/^-/, '')" />
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-cancel" @onclick="() => editReqItem = null">Cancel</button>
                            <button class="btn-primary" @onclick="SaveRequestItem" disabled="@saving">Update</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @* Archive Confirmation Modal *@
   

    @* Budget Archive modal *@
   
</div>
}

@code {
    // Data lists
    private List<BarangayBudget> Budgets = new();
    private List<ProcurementRequest> Requests = new();
    private List<Supplier> Suppliers = new();

    // FIX: Add budgetSpent dictionary to track spent amounts
    private Dictionary<int, decimal> budgetSpent = new();

    // NEW: Selected procurement request ID for dropdown
    private int selectedProcurementRequestId = 0;
    private int? linkedProcurementRequestId = null;

    // NEW: Procurement request limit constant
    private const decimal PROCUREMENT_LIMIT = 50000m;

    // Missing AlertModal state variables
    private bool showAccessDenied = false;
    private bool showBudgetSaveSuccess = false;
    private bool showRequestSaveSuccess = false;
    private bool showBudgetSaveError = false;
    private bool showRequestSaveError = false;
    private bool showProcurementLimitWarning = false;
    private bool showBudgetValidationError = false;
    private bool showRequestValidationError = false;
    private bool showStatusChangeConfirm = false;
    private bool showProcurementLimitExceeded = false;
    private bool showBudgetCreatedWithStatusUpdate = false;

    // Missing message variables
    private string successTitle = string.Empty;
    private string successMessage = string.Empty;
    private string budgetSuccessMessage = string.Empty;
    private string procurementLimitMessage = string.Empty;
    private string procurementExceededDetails = string.Empty;
    private string statusChangeMessage = string.Empty;
    private bool isChangingStatus = false;

    // Filters
    private string budgetSearch = string.Empty;
    private string budgetStatus = string.Empty;
    private string requestSearch = string.Empty;
    private string requestStatus = string.Empty;

    // Pagination - Budget Table
    private int _budgetPageIndex = 0;
    private int budgetPageSize = 10;

    // Pagination - Request Table
    private int _requestPageIndex = 0;
    private int requestPageSize = 10;

    // UI state
    private bool saving;
    private bool _isLoading;

    // Budget form state
    private bool showBudgetForm;
    private string budgetError = string.Empty;
    private BarangayBudget budgetModel = new();

    // Budget items state
    private bool showBudgetItems;
    private BarangayBudget? activeBudget;
    private List<BarangayBudgetItem> budgetItems = new();
    private BarangayBudgetItem newItem = new();
    private BarangayBudgetItem? editItem;

    // Request form state
    private bool showRequestForm;
    private string requestError = string.Empty;
    private ProcurementRequest requestModel = new();

    // Request items state
    private bool showRequestItems;
    private ProcurementRequest? activeRequest;
    private List<ProcurementRequestItem> requestItems = new();
    private ProcurementRequestItem newReqItem = new();
    private ProcurementRequestItem? editReqItem;

    // Archive-related state
    private bool showArchiveModal = false;
    private bool isArchiving = false;
    private int requestToArchiveId = 0;
    private string requestToArchiveName = string.Empty;

    // Budget Archive state
    private bool showBudgetArchiveModal = false;
    private bool isBudgetArchiving = false;
    private int budgetToArchiveId = 0;
    private string budgetToArchiveName = string.Empty;

    // NEW: Get approved procurement requests
    private IEnumerable<ProcurementRequest> ApprovedProcurementRequests => 
        Requests.Where(r => r.Status == "Approved").OrderByDescending(r => r.RequestDate);

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to budget changes
        BudgetState.OnBudgetChanged += HandleBudgetChanged;
        await LoadAll();
    }

    private async Task LoadAll()
    {
        if (_isLoading) return;
        
        _isLoading = true;
        try
        {
            Suppliers = await SupplierSvc.GetAllAsync();
            Budgets = await BudgetSvc.GetAllAsync();
            Requests = await ProcSvc.GetAllAsync();
            
            // FIX: Load budget spent amounts
            await LoadBudgetSpentAsync();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    // FIX: Load spent amounts for all budgets
    private async Task LoadBudgetSpentAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        
        budgetSpent.Clear();
        foreach (var budget in Budgets)
        {
            var spent = await db.BarangayBudgetItems
                .Where(i => i.BudgetId == budget.BudgetId)
                .SumAsync(i => (decimal?)i.Amount) ?? 0m;  // Use nullable sum to handle empty results
            budgetSpent[budget.BudgetId] = spent;
        }
        
        System.Diagnostics.Debug.WriteLine($"✅ Finance: Loaded budget spent data for {budgetSpent.Count} budgets");
    }

    private void HandleBudgetChanged()
    {
        // Reload data when notified of budget changes
        InvokeAsync(async () =>
        {
            await LoadAll();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        BudgetState.OnBudgetChanged -= HandleBudgetChanged;
    }

    private async Task RefreshBudgetsAsync()
    {
        await BudgetState.RefreshBudgetsAsync(DbFactory);
    }

    // Filters - Budgets
    private IEnumerable<BarangayBudget> FilteredBudgets => Budgets
        .Where(b =>
            (string.IsNullOrWhiteSpace(budgetSearch)
                || b.BarangayName.Contains(budgetSearch, StringComparison.OrdinalIgnoreCase)
                || b.Year.ToString().Contains(budgetSearch))
            && (string.IsNullOrWhiteSpace(budgetStatus) || b.Status == budgetStatus))
        .OrderByDescending(b => b.Year)
        .ThenBy(b => b.BarangayName);

    // Pagination - Budgets
    private int BudgetTotalFiltered => FilteredBudgets.Count();
    private int BudgetTotalPages => Math.Max((int)Math.Ceiling(BudgetTotalFiltered / (double)budgetPageSize), 1);
    private int BudgetStartIndex => BudgetTotalFiltered == 0 ? 0 : (_budgetPageIndex * budgetPageSize) + 1;
    private int BudgetEndIndex => Math.Min((_budgetPageIndex + 1) * budgetPageSize, BudgetTotalFiltered);
    private IEnumerable<BarangayBudget> PagedBudgets => FilteredBudgets.Skip(_budgetPageIndex * budgetPageSize).Take(budgetPageSize);

    private void BudgetPrevPage() { if (_budgetPageIndex > 0) _budgetPageIndex--; }
    private void BudgetNextPage() { if (_budgetPageIndex < BudgetTotalPages - 1) _budgetPageIndex++; }

    // Filters - Requests
    private IEnumerable<ProcurementRequest> FilteredRequests => Requests
        .Where(r =>
            (string.IsNullOrWhiteSpace(requestSearch)
                || r.BarangayName.Contains(requestSearch, StringComparison.OrdinalIgnoreCase))
            && (string.IsNullOrWhiteSpace(requestStatus) || r.Status == requestStatus))
        .OrderByDescending(r => r.RequestDate);

    // Pagination - Requests
    private int RequestTotalFiltered => FilteredRequests.Count();
    private int RequestTotalPages => Math.Max((int)Math.Ceiling(RequestTotalFiltered / (double)requestPageSize), 1);
    private int RequestStartIndex => RequestTotalFiltered == 0 ? 0 : (_requestPageIndex * requestPageSize) + 1;
    private int RequestEndIndex => Math.Min((_requestPageIndex + 1) * requestPageSize, RequestTotalFiltered);
    private IEnumerable<ProcurementRequest> PagedRequests => FilteredRequests.Skip(_requestPageIndex * requestPageSize).Take(requestPageSize);

    private void RequestPrevPage() { if (_requestPageIndex > 0) _requestPageIndex--; }
    private void RequestNextPage() { if (_requestPageIndex < RequestTotalPages - 1) _requestPageIndex++; }

    // Filters - Requests
    private IEnumerable<ProcurementRequest> FilteredRequestsToArchive => Requests
        .Where(r => r.Status == "Archived")
        .OrderByDescending(r => r.RequestDate);

    // Pagination - Requests
    private int ArchiveTotalFiltered => FilteredRequestsToArchive.Count();
    private int ArchiveTotalPages => Math.Max((int)Math.Ceiling(ArchiveTotalFiltered / (double)requestPageSize), 1);
    private int ArchiveStartIndex => ArchiveTotalFiltered == 0 ? 0 : (_requestPageIndex * requestPageSize) + 1;
    private int ArchiveEndIndex => Math.Min((_requestPageIndex + 1) * requestPageSize, ArchiveTotalFiltered);
    private IEnumerable<ProcurementRequest> PagedRequestsToArchive => FilteredRequestsToArchive.Skip(_requestPageIndex * requestPageSize).Take(requestPageSize);

    private void ArchivePrevPage() { if (_requestPageIndex > 0) _requestPageIndex--; }
    private void ArchiveNextPage() { if (_requestPageIndex < ArchiveTotalPages - 1) _requestPageIndex++; }

    // Filters - Requests
    private IEnumerable<ProcurementRequest> FilteredOpenRequests => Requests
        .Where(r => r.Status != "Archived")
        .OrderByDescending(r => r.RequestDate);

    // Pagination - Requests
    private int OpenRequestTotalFiltered => FilteredOpenRequests.Count();
    private int OpenRequestTotalPages => Math.Max((int)Math.Ceiling(OpenRequestTotalFiltered / (double)requestPageSize), 1);
    private int OpenRequestStartIndex => OpenRequestTotalFiltered == 0 ? 0 : (_requestPageIndex * requestPageSize) + 1;
    private int OpenRequestEndIndex => Math.Min((_requestPageIndex + 1) * requestPageSize, OpenRequestTotalFiltered);
    private IEnumerable<ProcurementRequest> PagedOpenRequests => FilteredOpenRequests.Skip(_requestPageIndex * requestPageSize).Take(requestPageSize);

    private void OpenRequestPrevPage() { if (_requestPageIndex > 0) _requestPageIndex--; }
    private void OpenRequestNextPage() { if (_requestPageIndex < OpenRequestTotalPages - 1) _requestPageIndex++; }

    // Filters - Requests
    private IEnumerable<ProcurementRequest> FilteredDraftRequests => Requests
        .Where(r => r.Status == "Draft")
        .OrderByDescending(r => r.RequestDate);

    // Pagination - Requests
    private int DraftRequestTotalFiltered => FilteredDraftRequests.Count();
    private int DraftRequestTotalPages => Math.Max((int)Math.Ceiling(DraftRequestTotalFiltered / (double)requestPageSize), 1);
    private int DraftRequestStartIndex => DraftRequestTotalFiltered == 0 ? 0 : (_requestPageIndex * requestPageSize) + 1;
    private int DraftRequestEndIndex => Math.Min((_requestPageIndex + 1) * requestPageSize, DraftRequestTotalFiltered);
    private IEnumerable<ProcurementRequest> PagedDraftRequests => FilteredDraftRequests.Skip(_requestPageIndex * requestPageSize).Take(requestPageSize);

    private void DraftRequestPrevPage() { if (_requestPageIndex > 0) _requestPageIndex--; }
    private void DraftRequestNextPage() { if (_requestPageIndex < DraftRequestTotalPages - 1) _requestPageIndex++; }

    // Filters - Requests
    private IEnumerable<ProcurementRequest> FilteredSubmittedRequests => Requests
        .Where(r => r.Status == "Submitted")
        .OrderByDescending(r => r.RequestDate);

    // Pagination - Requests
    private int SubmittedRequestTotalFiltered => FilteredSubmittedRequests.Count();
    private int SubmittedRequestTotalPages => Math.Max((int)Math.Ceiling(SubmittedRequestTotalFiltered / (double)requestPageSize), 1);
    private int SubmittedRequestStartIndex => SubmittedRequestTotalFiltered == 0 ? 0 : (_requestPageIndex * requestPageSize) + 1;
    private int SubmittedRequestEndIndex => Math.Min((_requestPageIndex + 1) * requestPageSize, SubmittedRequestTotalFiltered);
    private IEnumerable<ProcurementRequest> PagedSubmittedRequests => FilteredSubmittedRequests.Skip(_requestPageIndex * requestPageSize).Take(requestPageSize);

    private void SubmittedRequestPrevPage() { if (_requestPageIndex > 0) _requestPageIndex--; }
    private void SubmittedRequestNextPage() { if (_requestPageIndex < SubmittedRequestTotalPages - 1) _requestPageIndex++; }

    // Budget actions
    private void NewBudget()
    {
        showBudgetForm = true;
        budgetError = string.Empty;
        selectedProcurementRequestId = 0;
        linkedProcurementRequestId = null;
        budgetModel = new BarangayBudget
        {
            Year = DateTime.UtcNow.Year,
            Status = "Draft",
            CreatedByUserId = Auth.CurrentUser?.UserId ?? 0
        };
    }

    // NEW: Handle procurement request selection
    private void OnProcurementRequestSelected()
    {
        if (selectedProcurementRequestId > 0)
        {
            var selectedRequest = Requests.FirstOrDefault(r => r.RequestId == selectedProcurementRequestId);
            if (selectedRequest != null)
            {
                budgetModel.BarangayName = selectedRequest.BarangayName;
                budgetModel.TotalAmount = selectedRequest.TotalAmount;
                budgetModel.Year = selectedRequest.RequestDate.Year;
                linkedProcurementRequestId = selectedRequest.RequestId;
            }
        }
        else
        {
            budgetModel.BarangayName = string.Empty;
            budgetModel.TotalAmount = 0;
            linkedProcurementRequestId = null;
        }
    }

    private void EditBudget(BarangayBudget b)
    {
        showBudgetForm = true;
        budgetError = string.Empty;
        selectedProcurementRequestId = 0;
        budgetModel = new BarangayBudget
        {
            BudgetId = b.BudgetId,
            BarangayName = b.BarangayName,
            Year = b.Year,
            TotalAmount = b.TotalAmount,
            Status = b.Status,
            CreatedByUserId = b.CreatedByUserId
        };
    }

    private async Task SaveBudget()
    {
        if (saving) return;
        saving = true;
        budgetError = string.Empty;
        try
        {
            if (string.IsNullOrWhiteSpace(budgetModel.BarangayName) || budgetModel.Year <= 0)
            {
                budgetError = "Barangay and Year are required.";
                showBudgetValidationError = true;
                return;
            }

            if (budgetModel.BudgetId == 0)
            {
                budgetModel.Status = "Approved";
                
                var (budget, error) = await BudgetSvc.CreateAsync(budgetModel);
                if (error != null)
                {
                    budgetError = error;
                    showBudgetSaveError = true;
                    return;
                }

                if (linkedProcurementRequestId.HasValue && linkedProcurementRequestId.Value > 0)
                {
                    await UpdateProcurementRequestStatusAsync(linkedProcurementRequestId.Value, "Ordered");
                    budgetSuccessMessage = $"Budget created successfully for {budgetModel.BarangayName}!";
                    showBudgetCreatedWithStatusUpdate = true;
                }
                else
                {
                    successTitle = "Budget Created";
                    successMessage = $"Budget for {budgetModel.BarangayName} created successfully!";
                    showBudgetSaveSuccess = true;
                }
            }
            else
            {
                var (budget, error) = await BudgetSvc.UpdateAsync(budgetModel);
                if (error != null)
                {
                    budgetError = error;
                    showBudgetSaveError = true;
                    return;
                }

                successTitle = "Budget Updated";
                successMessage = $"Budget for {budgetModel.BarangayName} updated successfully!";
                showBudgetSaveSuccess = true;
            }

            if (string.IsNullOrEmpty(budgetError))
            {
                showBudgetForm = false;
                await LoadAll();
            }
        }
        finally { saving = false; }
    }

    // NEW: Update procurement request status
    private async Task UpdateProcurementRequestStatusAsync(int requestId, string newStatus)
    {
        try
        {
            await ProcSvc.SetStatusAsync(requestId, newStatus);
            System.Diagnostics.Debug.WriteLine($"✅ Updated Procurement Request #{requestId} status to '{newStatus}'");
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"❌ Error updating procurement request status: {ex.Message}");
        }
    }

    private void CloseBudgetForm()
    {
        if (saving) return;
        showBudgetForm = false;
        budgetError = string.Empty;
        selectedProcurementRequestId = 0;
        linkedProcurementRequestId = null;
    }

    private async Task DeleteBudget(int id)
    {
        if (saving) return;
        saving = true;
        try
        {
            await BudgetSvc.DeleteAsync(id);
            await LoadAll();
            
            // Adjust current page if needed
            if (_budgetPageIndex >= BudgetTotalPages && BudgetTotalPages > 0)
                _budgetPageIndex = BudgetTotalPages - 1;
        }
        finally { saving = false; }
    }

    private async Task ManageBudgetItems(BarangayBudget b)
    {
        activeBudget = b;
        var full = await BudgetSvc.GetAsync(b.BudgetId);
        budgetItems = full?.Items.OrderBy(i => i.Category).ThenBy(i => i.Description).ToList() ?? new();
        newItem = new BarangayBudgetItem();
        editItem = null;
        showBudgetItems = true;
    }

    private void CloseBudgetItems()
    {
        if (saving) return;
        showBudgetItems = false;
        activeBudget = null;
        budgetItems.Clear();
        newItem = new();
        editItem = null;
    }

    private async Task AddBudgetItem()
    {
        if (saving || activeBudget is null) return;
        if (string.IsNullOrWhiteSpace(newItem.Category) || string.IsNullOrWhiteSpace(newItem.Description) || newItem.Amount <= 0)
            return;

        saving = true;
        try
        {
            var (it, err) = await BudgetSvc.AddItemAsync(activeBudget.BudgetId, newItem);
            if (it != null)
            {
                budgetItems.Add(it);
                // Reload spent amounts to update the Available column
                await LoadBudgetSpentAsync();
            }
            newItem = new();
        }
        finally { saving = false; }
    }

    private void EditBudgetItem(BarangayBudgetItem it) => editItem = new BarangayBudgetItem
    {
        BudgetItemId = it.BudgetItemId,
        BudgetId = it.BudgetId,
        Category = it.Category,
        Description = it.Description,
        Amount = it.Amount,
        Notes = it.Notes
    };

    private async Task SaveBudgetItem()
    {
        if (saving || editItem is null) return;
        saving = true;
        try
        {
            var (it, err) = await BudgetSvc.UpdateItemAsync(editItem);
            if (it != null)
            {
                var idx = budgetItems.FindIndex(x => x.BudgetItemId == it.BudgetItemId);
                if (idx >= 0) budgetItems[idx] = it;
                editItem = null;
                // Reload spent amounts to update the Available column
                await LoadBudgetSpentAsync();
            }
        }
        finally { saving = false; }
    }

    private async Task DeleteBudgetItem(int id)
    {
        if (saving) return;
        saving = true;
        try
        {
            var (ok, err) = await BudgetSvc.DeleteItemAsync(id);
            if (ok)
            {
                budgetItems.RemoveAll(i => i.BudgetItemId == id);
                // Reload spent amounts to update the Available column
                await LoadBudgetSpentAsync();
            }
        }
        finally { saving = false; }
    }

    // Request actions
    private void NewRequest()
    {
        showRequestForm = true;
        requestError = string.Empty;
        requestModel = new ProcurementRequest
        {
            RequestedByUserId = Auth.CurrentUser?.UserId ?? 0,
            Status = "Draft",
            BarangayName = ""
        };
    }

    private void EditRequest(ProcurementRequest r)
    {
        showRequestForm = true;
        requestError = string.Empty;
        requestModel = new ProcurementRequest
        {
            RequestId = r.RequestId,
            BarangayName = r.BarangayName,
            SupplierId = r.SupplierId,
            RequestedByUserId = r.RequestedByUserId,
            Status = r.Status,
            TotalAmount = r.TotalAmount,
            RequestDate = r.RequestDate
        };
    }

    private async Task SaveRequest()
    {
        if (saving) return;
        saving = true;
        requestError = string.Empty;
        try
        {
            // Validate Barangay
            if (string.IsNullOrWhiteSpace(requestModel.BarangayName))
            {
                requestError = "Barangay is required.";
                showRequestValidationError = true;
                return;
            }

            // REMOVED: Supplier validation - now optional (can be Anonymous)

            // Validate procurement limit
            if (requestModel.TotalAmount > PROCUREMENT_LIMIT)
            {
                requestError = $"Procurement request amount cannot exceed ₱{PROCUREMENT_LIMIT:N2}. Current amount: ₱{requestModel.TotalAmount:N2}";
                showRequestValidationError = true;
                return;
            }

            if (requestModel.RequestId == 0)
            {
                var (req, err) = await ProcSvc.CreateAsync(requestModel);
                if (err != null)
                {
                    requestError = err;
                    showRequestSaveError = true;
                    return;
                }

                successTitle = "Request Created";
                successMessage = $"Procurement request for {requestModel.BarangayName} created successfully!";
                showRequestSaveSuccess = true;
            }
            else
            {
                var (req, err) = await ProcSvc.UpdateAsync(requestModel);
                if (err != null)
                {
                    requestError = err;
                    showRequestSaveError = true;
                    return;
                }

                successTitle = "Request Updated";
                successMessage = $"Procurement request for {requestModel.BarangayName} updated successfully!";
                showRequestSaveSuccess = true;
            }

            if (string.IsNullOrEmpty(requestError))
            {
                showRequestForm = false;
                await LoadAll();
            }
        }
        finally { saving = false; }
    }

    private void CloseRequestForm()
    {
        if (saving) return;
        showRequestForm = false;
        requestError = string.Empty;
    }

    private async Task DeleteRequest(int id)
    {
        if (saving) return;
        saving = true;
        try
        {
            await ProcSvc.DeleteAsync(id);
            await LoadAll();
            
            // Adjust current page if needed
            if (_requestPageIndex >= RequestTotalPages && RequestTotalPages > 0)
                _requestPageIndex = RequestTotalPages - 1;
        }
        finally { saving = false; }
    }

    private async Task ManageRequestItems(ProcurementRequest r)
    {
        activeRequest = r;
        var full = await ProcSvc.GetAsync(r.RequestId);
        requestItems = full?.Items.OrderBy(i => i.ItemName).ToList() ?? new();
        newReqItem = new ProcurementRequestItem { Quantity = 1, Unit = "pcs", UnitPrice = 0m };
        editReqItem = null;
        showRequestItems = true;
    }

    private void CloseRequestItems()
    {
        if (saving) return;
        showRequestItems = false;
        activeRequest = null;
        requestItems.Clear();
        newReqItem = new();
        editReqItem = null;
    }

    private async Task AddRequestItem()
    {
        if (saving || activeRequest is null) return;
        if (string.IsNullOrWhiteSpace(newReqItem.ItemName) || string.IsNullOrWhiteSpace(newReqItem.Unit) || newReqItem.Quantity <= 0 || newReqItem.UnitPrice < 0)
            return;

        saving = true;
        try
        {
            // NEW: Calculate new total with the item to be added
            var newItemTotal = newReqItem.UnitPrice * newReqItem.Quantity;
            var currentTotal = requestItems.Sum(i => i.UnitPrice * i.Quantity);
            var projectedTotal = currentTotal + newItemTotal;

            // NEW: Validate against procurement limit
            if (projectedTotal > PROCUREMENT_LIMIT)
            {
                procurementLimitMessage = $"Cannot add item. Total would exceed limit of ₱{PROCUREMENT_LIMIT:N2}.";
                procurementExceededDetails = $"Current total: ₱{currentTotal:N2}\n" +
                    $"New item cost: ₱{newItemTotal:N2}\n" +
                    $"Projected total: ₱{projectedTotal:N2}\n" +
                    $"Over limit by: ₱{(projectedTotal - PROCUREMENT_LIMIT):N2}";
                showProcurementLimitExceeded = true;
                return;
            }

            var (it, err) = await ProcSvc.AddItemAsync(activeRequest.RequestId, newReqItem);
            if (it != null)
            {
                requestItems.Add(it);
                await ProcSvc.RecalculateTotalAsync(activeRequest.RequestId);
                await LoadAll();
                
                // Check if we're close to the limit
                var updatedTotal = requestItems.Sum(i => i.UnitPrice * i.Quantity) + newItemTotal;
                if (updatedTotal > PROCUREMENT_LIMIT * 0.9m // 90% threshold
                ) {
                    procurementLimitMessage = $"⚠️ Warning: Request total is at ₱{updatedTotal:N2} " +
                        $"({(updatedTotal / PROCUREMENT_LIMIT * 100):F1}% of ₱{PROCUREMENT_LIMIT:N2} limit)";
                    showProcurementLimitWarning = true;
                }
            }
            newReqItem = new ProcurementRequestItem { Quantity = 1, Unit = "pcs", UnitPrice = 0m };
        }
        finally { saving = false; }
    }

    private void EditRequestItem(ProcurementRequestItem it) => editReqItem = new ProcurementRequestItem
    {
        RequestItemId = it.RequestItemId,
        RequestId = it.RequestId,
        ItemName = it.ItemName,
        Unit = it.Unit,
        Quantity = it.Quantity,
        UnitPrice = it.UnitPrice
    };

    private async Task SaveRequestItem()
    {
        if (saving || editReqItem is null || activeRequest is null) return;
        saving = true;
        try
        {
            // NEW: Calculate new total with the edited item
            var editedItemTotal = editReqItem.UnitPrice * editReqItem.Quantity;
            var currentTotal = requestItems.Where(i => i.RequestItemId != editReqItem.RequestItemId)
                                          .Sum(i => i.UnitPrice * i.Quantity);
            var projectedTotal = currentTotal + editedItemTotal;

            // NEW: Validate against procurement limit
            if (projectedTotal > PROCUREMENT_LIMIT)
            {
                await JS.InvokeVoidAsync("alert", 
                    $"Cannot update item. Total would exceed limit of ₱{PROCUREMENT_LIMIT:N2}.\n\n" +
                    $"Other items total: ₱{currentTotal:N2}\n" +
                    $"Updated item cost: ₱{editedItemTotal:N2}\n" +
                    $"Projected total: ₱{projectedTotal:N2}\n" +
                    $"Over limit by: ₱{(projectedTotal - PROCUREMENT_LIMIT):N2}");
                return;
            }

            var (it, err) = await ProcSvc.UpdateItemAsync(editReqItem);
            if (it != null)
            {
                var idx = requestItems.FindIndex(x => x.RequestItemId == it.RequestItemId);
                if (idx >= 0) requestItems[idx] = it;
                editReqItem = null;
                await ProcSvc.RecalculateTotalAsync(activeRequest.RequestId);
                await LoadAll();
            }
        }
        finally { saving = false; }
    }

    private async Task DeleteRequestItem(int id)
    {
        if (saving || activeRequest is null) return;
        saving = true;
        try
        {
            var (ok, err) = await ProcSvc.DeleteItemAsync(id);
            if (ok)
            {
                requestItems.RemoveAll(i => i.RequestItemId == id);
                await ProcSvc.RecalculateTotalAsync(activeRequest.RequestId);
                await LoadAll();
            }
        }
        finally { saving = false; }
    }

    private async Task QuickStatus(int reqId, string status)
    {
        ShowStatusChangeConfirmation(reqId, status);
    }

    private Task RefreshAll() => LoadAll();

    // Archive functions
   

    private void PreventClose()
    {
        // Intentionally empty: stops click from bubbling to overlay
    }

    // Missing methods referenced in the UI
    private void ShowStatusChangeConfirmation(int reqId, string status)
    {
        // Implementation needed
        statusChangeMessage = $"Are you sure you want to change the status to '{status}'?";
        showStatusChangeConfirm = true;
    }

    private async Task ExecuteStatusChange()
    {
        // Implementation needed
        isChangingStatus = true;
        try
        {
            // Add your status change logic here
            showStatusChangeConfirm = false;
        }
        finally
        {
            isChangingStatus = false;
        }
    }

    private void CancelStatusChange()
    {
        showStatusChangeConfirm = false;
        statusChangeMessage = string.Empty;
    }
}