@page "/admin/archives"
@inject ArchiveService ArchiveService
@inject AuditService AuditService
@inject AuthState Auth
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using ResQLink.Data.Entities
@using ResQLink.Services
@using System.Text.Json

<PageTitle>Archive Management - ResQLink</PageTitle>

<div class="archives-root">
    @if (!Auth.IsAdmin())
    {
        <div class="access-denied">
            <i class="bi bi-shield-x"></i>
            <h2>Access Denied</h2>
            <p>You must be an administrator to view archived records.</p>
        </div>
        return;
    }

    <!-- Page Header -->
    <header class="page-header">
        <div>
            <p class="page-subtitle">
                <i class="bi bi-archive"></i>
                View and restore archived records from the centralized system
            </p>
        </div>

        <div class="page-actions">
            <button class="btn-secondary" @onclick="ClearFilters" title="Clear filters">
                <i class="bi bi-arrow-counterclockwise"></i>
                <span>Clear</span>
            </button>

            <button class="btn-primary" @onclick="LoadArchives" disabled="@isLoading">
                <i class="bi bi-arrow-clockwise"></i>
                <span>@(isLoading ? "Refreshing..." : "Refresh")</span>
            </button>
        </div>
    </header>

    <!-- Statistics Cards -->
    <section class="kpi-panel">
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon-circle total-icon">
                    <i class="bi bi-layers-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Archived</div>
                    <div class="kpi-value">@TotalArchived</div>
                </div>
            </div>

            @foreach (var stat in typeCounts.OrderByDescending(x => x.Value).Take(3))
            {
                <div class="kpi-card">
                    <div class="kpi-icon-circle">
                        <i class="@GetTypeIcon(stat.Key)"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-label">@GetFriendlyTypeName(stat.Key)</div>
                        <div class="kpi-value">@stat.Value</div>
                    </div>
                </div>
            }
        </div>
    </section>

    <!-- Filter Console -->
    <section class="console-panel">
        <div class="console-head">
            <div class="console-title">ARCHIVE CONSOLE</div>
            <div class="console-actions">
                <div class="controls-left">
                    <div class="control-item">
                        <select @bind="filterEntityType" @bind:after="ApplyFilters" class="mini-input">
                            <option value="">All Types</option>
                            <option value="ReliefGood">Relief Goods</option>
                            <option value="Disaster">Disasters</option>
                            <option value="Category">Categories</option>
                            <option value="Supplier">Suppliers</option>
                            <option value="Stock">Stocks</option>
                            <option value="ProcurementRequest">Procurement</option>
                            <option value="BarangayBudget">Budgets</option>
                        </select>
                    </div>

                    <div class="control-item">
                        <input type="date" @bind="filterDateFrom" @bind:after="ApplyFilters" class="mini-input" placeholder="From" />
                    </div>

                    <div class="control-item">
                        <input type="date" @bind="filterDateTo" @bind:after="ApplyFilters" class="mini-input" placeholder="To" />
                    </div>

                    <div class="control-item">
                        <input type="text" @bind="searchTerm" @bind:after="ApplyFilters" placeholder="Search entity name..." class="mini-input" style="min-width: 250px;" />
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Archive Table -->
    <div class="archive-table-container">
        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading archived records...</p>
            </div>
        }
        else if (!filteredArchives.Any())
        {
            <div class="empty-state">
                <i class="bi bi-inbox" style="font-size: 2.5rem;"></i>
                <p>No archived records found.</p>
            </div>
        }
        else
        {
            <table class="archive-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>ID</th>
                        <th>Name/Title</th>
                        <th>Archived Date</th>
                        <th>Archived By</th>
                        <th>Reason</th>
                        <th class="t-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var archive in PagedArchives)
                    {
                        <tr>
                            <td>
                                <span class="type-text">
                                    @GetFriendlyTypeName(archive.EntityType)
                                </span>
                            </td>
                            <td class="mono-text">@archive.EntityId</td>
                            <td><strong>@archive.EntityName</strong></td>
                            <td>
                                <div class="timestamp-cell">
                                    <span>@archive.ArchivedAt.ToString("MMM dd, yyyy")</span>
                                    <small>@archive.ArchivedAt.ToString("HH:mm")</small>
                                </div>
                            </td>
                            <td>@(archive.ArchivedByUser?.Username ?? "System")</td>
                            <td class="reason-text" title="@archive.ArchiveReason">@archive.ArchiveReason</td>
                            <td class="t-center actions-cell">
                                <button class="btn-icon" @onclick="() => ViewArchiveDetails(archive)" title="View Details">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                                <button class="btn-icon" @onclick="() => RestoreArchive(archive)" title="Restore">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <button class="btn-icon btn-danger-outline" @onclick="() => DeletePermanently(archive)" title="Delete Permanently">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info">
                    Showing @StartIndex to @EndIndex of @TotalFiltered entries
                </div>
                <div class="pagination-controls">
                    <select @bind="pageSize" @bind:after="ResetPagination" class="page-size-select">
                        <option value="10">10 / page</option>
                        <option value="25">25 / page</option>
                        <option value="50">50 / page</option>
                    </select>

                    <button class="btn-page" @onclick="PrevPage" disabled="@(_pageIndex == 0)">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>

                    <span class="page-number">
                        Page @(_pageIndex + 1) of @TotalPages
                    </span>

                    <button class="btn-page" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Archive Details Modal -->
    @if (selectedArchive != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3 class="modal-title">Archive Details</h3>
                    <button class="btn-close" @onclick="CloseModal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Entity Type</label>
                            <span class="type-text">@selectedArchive.EntityType</span>
                        </div>

                        <div class="detail-item">
                            <label>Entity ID</label>
                            <span class="mono-text">@selectedArchive.EntityId</span>
                        </div>

                        <div class="detail-item">
                            <label>Entity Name</label>
                            <span>@selectedArchive.EntityName</span>
                        </div>

                        <div class="detail-item">
                            <label>Archived Date</label>
                            <span>@selectedArchive.ArchivedAt.ToString("MMMM dd, yyyy HH:mm:ss")</span>
                        </div>

                        <div class="detail-item">
                            <label>Archived By</label>
                            <span>@(selectedArchive.ArchivedByUser?.Username ?? "System")</span>
                        </div>

                        <div class="detail-item">
                            <label>Reason</label>
                            <span>@selectedArchive.ArchiveReason</span>
                        </div>

                        <div class="detail-item full-width">
                            <label>Archived Data (JSON)</label>
                            <pre class="json-preview">@FormatJson(selectedArchive.ArchivedData)</pre>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-secondary" @onclick="CloseModal">Close</button>
                    <button class="btn-primary" @onclick="() => RestoreArchive(selectedArchive)">
                        <i class="bi bi-arrow-counterclockwise"></i> Restore Record
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = false;
    private string filterEntityType = "";
    private DateTime? filterDateFrom;
    private DateTime? filterDateTo;
    private string searchTerm = "";

    private List<Archive> allArchives = new();
    private List<Archive> filteredArchives = new();
    private Dictionary<string, int> typeCounts = new();
    private Archive? selectedArchive = null;

    private int TotalArchived => allArchives.Count;

    // Pagination
    private int _pageIndex = 0;
    private int pageSize = 10;
    private int TotalFiltered => filteredArchives.Count;
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<Archive> PagedArchives => filteredArchives.Skip(_pageIndex * pageSize).Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadArchives();
        await LoadTypeCounts();
    }

    private async Task LoadArchives()
    {
        isLoading = true;
        try
        {
            allArchives = await ArchiveService.GetAllArchivesAsync();
            ApplyFiltersInternal();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading archives: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTypeCounts()
    {
        try
        {
            typeCounts = await ArchiveService.GetArchiveCountsByTypeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading counts: {ex.Message}");
        }
    }

    private void ApplyFiltersInternal()
    {
        filteredArchives = allArchives.ToList();

        if (!string.IsNullOrEmpty(filterEntityType))
        {
            filteredArchives = filteredArchives.Where(x => x.EntityType == filterEntityType).ToList();
        }

        if (filterDateFrom.HasValue)
        {
            filteredArchives = filteredArchives.Where(x => x.ArchivedAt >= filterDateFrom.Value).ToList();
        }

        if (filterDateTo.HasValue)
        {
            var dateTo = filterDateTo.Value.AddDays(1);
            filteredArchives = filteredArchives.Where(x => x.ArchivedAt < dateTo).ToList();
        }

        if (!string.IsNullOrEmpty(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredArchives = filteredArchives.Where(x =>
                (x.EntityName?.ToLower().Contains(term) ?? false) ||
                (x.ArchiveReason?.ToLower().Contains(term) ?? false) ||
                x.EntityId.ToString().Contains(term)
            ).ToList();
        }

        filteredArchives = filteredArchives.OrderByDescending(x => x.ArchivedAt).ToList();
        _pageIndex = 0; // Reset to first page on filter
    }

    private void ApplyFilters()
    {
        ApplyFiltersInternal();
    }

    private void ClearFilters()
    {
        filterEntityType = "";
        filterDateFrom = null;
        filterDateTo = null;
        searchTerm = "";
        ApplyFiltersInternal();
    }

    // Pagination Methods
    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    private void ResetPagination()
    {
        _pageIndex = 0;
    }

    private async Task RestoreArchive(Archive archive)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to restore this {GetFriendlyTypeName(archive.EntityType)}?\n\n{archive.EntityName}");
        if (!confirmed) return;

        isLoading = true;
        try
        {
            var (success, error) = archive.EntityType switch
            {
                "ReliefGood" => await ArchiveService.RestoreAsync<ReliefGood>(archive.ArchiveId),
                "Disaster" => await ArchiveService.RestoreAsync<Disaster>(archive.ArchiveId),
                "Category" => await ArchiveService.RestoreAsync<Category>(archive.ArchiveId),
                "Supplier" => await ArchiveService.RestoreAsync<Supplier>(archive.ArchiveId),
                "Stock" => await ArchiveService.RestoreAsync<Stock>(archive.ArchiveId),
                "ProcurementRequest" => await ArchiveService.RestoreAsync<ProcurementRequest>(archive.ArchiveId),
                "BarangayBudget" => await ArchiveService.RestoreAsync<BarangayBudget>(archive.ArchiveId),
                _ => (false, "Unknown entity type")
            };

            if (success)
            {
                await JS.InvokeVoidAsync("alert", $"✓ {GetFriendlyTypeName(archive.EntityType)} restored successfully!");
                selectedArchive = null;
                await LoadArchives();
                await LoadTypeCounts();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to restore item. It may have been deleted.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DeletePermanently(Archive archive)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"⚠️ WARNING: This will PERMANENTLY delete this record.\n\nEntity: {GetFriendlyTypeName(archive.EntityType)}\nName: {archive.EntityName}\n\nThis cannot be undone. Continue?");
        if (!confirmed) return;

        isLoading = true;
        try
        {
            var (success, error) = await ArchiveService.DeletePermanentlyAsync(archive.ArchiveId);
            if (success)
            {
                selectedArchive = null;
                await LoadArchives();
                await LoadTypeCounts();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to delete archive.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ViewArchiveDetails(Archive archive) => selectedArchive = archive;
    private void CloseModal() => selectedArchive = null;

    private string GetFriendlyTypeName(string entityType) => entityType switch
    {
        "ReliefGood" => "Relief Goods",
        "Disaster" => "Disasters",
        "Category" => "Categories",
        "Supplier" => "Suppliers",
        "Stock" => "Stocks",
        "ProcurementRequest" => "Procurement",
        "BarangayBudget" => "Budgets",
        _ => entityType
    };

    private string GetTypeIcon(string entityType) => entityType switch
    {
        "ReliefGood" => "bi bi-box-seam-fill",
        "Disaster" => "bi bi-exclamation-triangle-fill",
        "Category" => "bi bi-tag-fill",
        "Supplier" => "bi bi-building-fill",
        "Stock" => "bi bi-inbox-fill",
        "ProcurementRequest" => "bi bi-cart-fill",
        "BarangayBudget" => "bi bi-cash-coin",
        _ => "bi bi-folder-fill"
    };

    private string FormatJson(string json)
    {
        try
        {
            var jsonDoc = JsonDocument.Parse(json);
            return JsonSerializer.Serialize(jsonDoc, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }
}