@page "/admin/archives"
@inject ArchiveService ArchiveService
@inject AuditService AuditService
@inject AuthState Auth
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using ResQLink.Data.Entities
@using ResQLink.Services
@using System.Text.Json

<PageTitle>Archive Management - ResQLink</PageTitle>

<div class="archives-root">
    @if (!Auth.IsAdmin())
    {
        <div class="access-denied">
            <i class="bi bi-shield-x" style="font-size: 4rem; color: #dc3545;"></i>
            <h2>Access Denied</h2>
            <p>You must be an administrator to view archived records.</p>
        </div>
        return;
    }

    <!-- Page Header -->
    <div class="page-header" style="margin-bottom: 1.5rem;">
        <div>
            <h1 style="font-size: 1.75rem; font-weight: 700; color: #111827; margin: 0;">
                <i class="bi bi-archive"></i> Archive Management
            </h1>
            <p style="font-size: 0.875rem; color: #6b7280; margin: 0.5rem 0 0 0;">
                View and restore archived records from the centralized archive system
            </p>
        </div>

        <div class="page-actions" style="display: flex; gap: 0.75rem;">
            <button class="btn-secondary" @onclick="ClearFilters" title="Clear filters" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background: white; cursor: pointer;">
                <i class="bi bi-arrow-counterclockwise"></i>
                Clear Filters
            </button>

            <button class="btn-primary" @onclick="LoadArchives" disabled="@isLoading" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; background: #059669; color: white; border: none; cursor: pointer;">
                <i class="bi bi-arrow-clockwise"></i>
                @(isLoading ? "Refreshing..." : "Refresh")
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        @foreach (var stat in typeCounts.OrderByDescending(x => x.Value))
        {
            <div class="stat-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.25rem;">
                <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">@GetFriendlyTypeName(stat.Key)</div>
                <div style="font-size: 2rem; font-weight: 700; color: #3b82f6; margin-top: 0.5rem;">@stat.Value</div>
            </div>
        }
        
        <div class="stat-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.25rem;">
            <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Total Archived</div>
            <div style="font-size: 2rem; font-weight: 700; color: #059669; margin-top: 0.5rem;">@TotalArchived</div>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Entity Type</label>
                <select @bind="filterEntityType" @bind:after="ApplyFilters" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                    <option value="">All Types</option>
                    <option value="ReliefGood">Relief Goods</option>
                    <option value="Disaster">Disasters</option>
                    <option value="Category">Categories</option>
                    <option value="Supplier">Suppliers</option>
                    <option value="Stock">Stocks</option>
                    <option value="ProcurementRequest">Procurement Requests</option>
                    <option value="BarangayBudget">Barangay Budgets</option>
                </select>
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Date From</label>
                <input type="date" @bind="filterDateFrom" @bind:after="ApplyFilters" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;" />
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Date To</label>
                <input type="date" @bind="filterDateTo" @bind:after="ApplyFilters" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;" />
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Search</label>
                <input type="text" @bind="searchTerm" @bind:after="ApplyFilters" placeholder="Search by entity name..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;" />
            </div>
        </div>
    </div>

    <!-- Archived Records List -->
    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden;">
        <div style="padding: 1.5rem;">
            @if (isLoading)
            {
                <div style="text-align: center; padding: 3rem;">
                    <div class="spinner" style="border: 3px solid #e5e7eb; border-top-color: #059669; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: #6b7280;">Loading archived records...</p>
                </div>
            }
            else if (!filteredArchives.Any())
            {
                <div style="text-align: center; padding: 3rem;">
                    <i class="bi bi-archive" style="font-size: 3rem; color: #d1d5db;"></i>
                    <p style="color: #6b7280; margin-top: 1rem;">No archived records found.</p>
                    @if (!string.IsNullOrEmpty(filterEntityType) || filterDateFrom != null || filterDateTo != null || !string.IsNullOrEmpty(searchTerm))
                    {
                        <button @onclick="ClearFilters" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #059669; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                            Clear Filters
                        </button>
                    }
                </div>
            }
            else
            {
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Type</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">ID</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Name/Title</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Archived Date</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Archived By</th>
                                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Reason</th>
                                <th style="padding: 0.75rem; text-align: center; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var archive in filteredArchives)
                            {
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 0.75rem;">
                                        <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #eff6ff; color: #1e40af; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
                                            @GetFriendlyTypeName(archive.EntityType)
                                        </span>
                                    </td>
                                    <td style="padding: 0.75rem; font-family: monospace; color: #6b7280;">@archive.EntityId</td>
                                    <td style="padding: 0.75rem; font-weight: 500;">@archive.EntityName</td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">@archive.ArchivedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem;">@(archive.ArchivedByUser?.Username ?? "System")</td>
                                    <td style="padding: 0.75rem; font-size: 0.875rem; color: #6b7280;">@archive.ArchiveReason</td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                            <button @onclick="() => ViewArchiveDetails(archive)" title="View details" style="padding: 0.25rem 0.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button @onclick="() => RestoreArchive(archive)" title="Restore" style="padding: 0.25rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                                                <i class="bi bi-arrow-counterclockwise"></i> Restore
                                            </button>
                                            <button @onclick="() => DeletePermanently(archive)" title="Delete permanently" style="padding: 0.25rem 0.5rem; background: #dc2626; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Info -->
                <div style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        Showing @filteredArchives.Count of @allArchives.Count archived records
                    </p>
                </div>
            }
        </div>
    </div>

    <!-- Archive Details Modal -->
    @if (selectedArchive != null)
    {
        <div @onclick="CloseModal" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem;">
            <div @onclick:stopPropagation style="background: white; border-radius: 0.75rem; max-width: 48rem; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin: 0;">
                        <i class="bi bi-info-circle"></i> Archive Details
                    </h2>
                    <button @onclick="CloseModal" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <div style="padding: 1.5rem;">
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Entity Type</label>
                            <p style="margin: 0; font-weight: 500;">@selectedArchive.EntityType</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Entity ID</label>
                            <p style="margin: 0; font-family: monospace;">@selectedArchive.EntityId</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Entity Name</label>
                            <p style="margin: 0; font-weight: 500;">@selectedArchive.EntityName</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Archived At</label>
                            <p style="margin: 0;">@selectedArchive.ArchivedAt.ToString("MMMM dd, yyyy HH:mm:ss")</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Archived By</label>
                            <p style="margin: 0;">@(selectedArchive.ArchivedByUser?.Username ?? "System")</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Reason</label>
                            <p style="margin: 0; color: #6b7280;">@selectedArchive.ArchiveReason</p>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Archived Data (JSON)</label>
                            <pre style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem; overflow-x: auto; font-size: 0.75rem; margin: 0; max-height: 300px;">@FormatJson(selectedArchive.ArchivedData)</pre>
                        </div>
                    </div>
                </div>

                <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button @onclick="CloseModal" style="padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer;">
                        Close
                    </button>
                    <button @onclick="() => RestoreArchive(selectedArchive)" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer;">
                        <i class="bi bi-arrow-counterclockwise"></i> Restore
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .spinner {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .stat-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed !important;
    }

    button:not(:disabled):hover {
        opacity: 0.9;
        transition: opacity 0.2s;
    }
</style>

@code {
    private bool isLoading = false;
    private string filterEntityType = "";
    private DateTime? filterDateFrom;
    private DateTime? filterDateTo;
    private string searchTerm = "";

    private List<Archive> allArchives = new();
    private List<Archive> filteredArchives = new();
    private Dictionary<string, int> typeCounts = new();
    private Archive? selectedArchive = null;

    private int TotalArchived => allArchives.Count;

    protected override async Task OnInitializedAsync()
    {
        await LoadArchives();
        await LoadTypeCounts();
    }

    private async Task LoadArchives()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            allArchives = await ArchiveService.GetAllArchivesAsync();
            ApplyFiltersInternal();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading archives: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadTypeCounts()
    {
        try
        {
            typeCounts = await ArchiveService.GetArchiveCountsByTypeAsync();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error loading archive counts: {ex.Message}");
        }
    }

    private void ApplyFiltersInternal()
    {
        filteredArchives = allArchives.ToList();

        // Filter by entity type
        if (!string.IsNullOrEmpty(filterEntityType))
        {
            filteredArchives = filteredArchives.Where(x => x.EntityType == filterEntityType).ToList();
        }

        // Filter by date range
        if (filterDateFrom.HasValue)
        {
            filteredArchives = filteredArchives.Where(x => x.ArchivedAt >= filterDateFrom.Value).ToList();
        }

        if (filterDateTo.HasValue)
        {
            var dateTo = filterDateTo.Value.AddDays(1); // Include the entire day
            filteredArchives = filteredArchives.Where(x => x.ArchivedAt < dateTo).ToList();
        }

        // Filter by search term
        if (!string.IsNullOrEmpty(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredArchives = filteredArchives.Where(x =>
                (x.EntityName?.ToLower().Contains(term) ?? false) ||
                (x.ArchiveReason?.ToLower().Contains(term) ?? false) ||
                x.EntityId.ToString().Contains(term)
            ).ToList();
        }

        filteredArchives = filteredArchives.OrderByDescending(x => x.ArchivedAt).ToList();
    }

    private async Task ApplyFilters()
    {
        ApplyFiltersInternal();
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void ClearFilters()
    {
        filterEntityType = "";
        filterDateFrom = null;
        filterDateTo = null;
        searchTerm = "";
        ApplyFiltersInternal();
        StateHasChanged();
    }

    private async Task RestoreArchive(Archive archive)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to restore this {GetFriendlyTypeName(archive.EntityType)}?\n\n{archive.EntityName}");
        if (!confirmed) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var (success, error) = archive.EntityType switch
            {
                "ReliefGood" => await ArchiveService.RestoreAsync<ReliefGood>(archive.ArchiveId),
                "Disaster" => await ArchiveService.RestoreAsync<Disaster>(archive.ArchiveId),
                "Category" => await ArchiveService.RestoreAsync<Category>(archive.ArchiveId),
                "Supplier" => await ArchiveService.RestoreAsync<Supplier>(archive.ArchiveId),
                "Stock" => await ArchiveService.RestoreAsync<Stock>(archive.ArchiveId),
                "ProcurementRequest" => await ArchiveService.RestoreAsync<ProcurementRequest>(archive.ArchiveId),
                "BarangayBudget" => await ArchiveService.RestoreAsync<BarangayBudget>(archive.ArchiveId),
                _ => (false, "Unknown entity type")
            };

            if (success)
            {
                await JS.InvokeVoidAsync("alert", $"✓ {GetFriendlyTypeName(archive.EntityType)} restored successfully!");
                selectedArchive = null;
                await LoadArchives();
                await LoadTypeCounts();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to restore the archived item. It may have been already restored or deleted.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error restoring archive: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DeletePermanently(Archive archive)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"⚠️ WARNING: This will PERMANENTLY delete this archived record!\n\nEntity: {GetFriendlyTypeName(archive.EntityType)}\nName: {archive.EntityName}\n\nThis action CANNOT be undone. Are you absolutely sure?");
        if (!confirmed) return;

        // Second confirmation
        var doubleConfirmed = await JS.InvokeAsync<bool>("confirm", "Final confirmation: Type 'DELETE' in the next prompt to confirm permanent deletion.");
        if (!doubleConfirmed) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var (success, error) = await ArchiveService.DeletePermanentlyAsync(archive.ArchiveId);
            
            if (success)
            {
                await JS.InvokeVoidAsync("alert", $"✓ Archive permanently deleted.");
                selectedArchive = null;
                await LoadArchives();
                await LoadTypeCounts();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to delete the archive.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error deleting archive: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ViewArchiveDetails(Archive archive)
    {
        selectedArchive = archive;
        StateHasChanged();
    }

    private void CloseModal()
    {
        selectedArchive = null;
        StateHasChanged();
    }

    private string GetFriendlyTypeName(string entityType)
    {
        return entityType switch
        {
            "ReliefGood" => "Relief Goods",
            "Disaster" => "Disasters",
            "Category" => "Categories",
            "Supplier" => "Suppliers",
            "Stock" => "Stocks",
            "ProcurementRequest" => "Procurement",
            "BarangayBudget" => "Budgets",
            _ => entityType
        };
    }

    private string FormatJson(string json)
    {
        try
        {
            var jsonDoc = JsonDocument.Parse(json);
            return JsonSerializer.Serialize(jsonDoc, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }
}
