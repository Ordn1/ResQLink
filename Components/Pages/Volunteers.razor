@page "/volunteers"
@inject ResQLink.Data.AppDbContext Db
@inject ResQLink.Services.ArchiveService ArchiveService
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities
@using System.Security.Cryptography
@using System.Text
@using ResQLink.Components.Shared

@* ========== ALERT MODALS - ADD AT TOP ========== *@

@* Success Alerts *@
<AlertModal @bind-IsVisible="showSaveSuccess"
            Title="@successTitle"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

<AlertModal @bind-IsVisible="showDeleteSuccess"
            Title="Volunteer Archived"
            Message="@deleteSuccessMessage"
            Type="AlertModal.AlertType.Success" />

@* Error Alerts *@
<AlertModal @bind-IsVisible="showLoadError"
            Title="Error Loading Data"
            Message="@globalError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showSaveError"
            Title="Error Saving Volunteer"
            Message="@formError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showDeleteError"
            Title="Error Archiving Volunteer"
            Message="@formError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showValidationError"
            Title="Validation Error"
            Message="@formError"
            Type="AlertModal.AlertType.Warning" />

@* Confirmation Dialogs *@
<AlertModal @bind-IsVisible="showDeleteConfirm"
            Title="Confirm Archive"
            Message="@deleteConfirmMessage"
            DetailMessage="This volunteer will be moved to archives. All data will be preserved. Administrators can restore it from the Archives page if needed."
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Archive"
            CancelText="Cancel"
            IsProcessing="isDeleting"
            OnConfirm="ExecuteArchive"
            OnCancel="CancelDelete" />

@* ========== END ALERT MODALS ========== *@

<div class="volunteers-root">
    @* KPI / Overview panel *@
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Volunteers Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary" @onclick="BeginCreate" disabled="@showForm">
                    <i class="bi bi-person-plus"></i> Register Volunteer
                </button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Volunteers</div>
                    <div class="kpi-value">@AllVolunteers.Count</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-person-check-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Active</div>
                    <div class="kpi-value">@ActiveCount</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Available</div>
                    <div class="kpi-value">@AvailableCount</div>
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Volunteer Management</h2>
            <div class="panel-actions">
                <input class="mini-input" placeholder="Search name, email or skills…" @bind="search" @bind:event="oninput" @onchange="ResetPagination" />
                <select class="mini-input" @bind="statusFilter" @bind:after="ResetPagination">
                    <option value="">All Status</option>
                    @foreach (var s in DistinctStatuses)
                    {
                        <option>@s</option>
                    }
                </select>
                <select class="mini-input" @bind="sortBy" @bind:after="ResetPagination">
                    <option value="registered_desc">Registered: Newest</option>
                    <option value="name_asc">Name: A → Z</option>
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Contact</th>
                        <th>Skills</th>
                        <th>Availability</th>
                        <th class="t-center">Status</th>
                        <th>Registered</th>
                        <th class="t-center" style="width:120px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var v in PagedVolunteers)
                    {
                        <tr>
                            <td><strong>@v.Name</strong></td>
                            <td>@v.Email</td>
                            <td>@v.ContactNumber</td>
                            <td>@(string.IsNullOrEmpty(v.Skills) ? "—" : v.Skills)</td>
                            <td>@(string.IsNullOrEmpty(v.Availability) ? "—" : v.Availability)</td>
                            <td class="t-center">
                                <span class="status-chip @StatusClass(v.Status)">@v.Status</span>
                            </td>
                            <td>@v.RegisteredAt.ToString("MMM dd, yyyy")</td>
                            <td class="action-cell">
                                <button class="action-btn edit"
                                        @onclick="() => BeginEdit(v.Id)"
                                        disabled="@(showForm || showDeleteConfirm)"
                                        title="Edit volunteer">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action-btn delete"
                                        @onclick="() => ShowArchiveConfirmation(v)"
                                        disabled="@(showForm || showDeleteConfirm || isDeleting)"
                                        title="Archive volunteer">
                                    <i class="bi bi-archive"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!PagedVolunteers.Any())
                    {
                        <tr>
                            <td colspan="8" class="empty-state">
                                <div class="empty-icon"><i class="bi bi-inbox"></i></div>
                                <div class="empty-text">
                                    @if (!string.IsNullOrWhiteSpace(search) || !string.IsNullOrWhiteSpace(statusFilter))
                                    {
                                        <text>No volunteers match your filters.</text>
                                    }
                                    else
                                    {
                                        <text>No volunteers found.</text>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">
                <i class="bi bi-info-circle"></i>
                Showing @StartIndex–@EndIndex of @TotalFiltered volunteers
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize" @bind:after="ResetPagination">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>
</div>

@* Create/Edit Modal with PASSWORD FIELDS *@
@if (showForm)
{
    <div class="modal-overlay">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(editModel.VolunteerId == 0 ? "Register Volunteer" : "Edit Volunteer")</h3>
                <button class="modal-close" @onclick="CancelForm" disabled="@saving">&times;</button>
            </div>
            <div class="modal-body" @onclick:stopPropagation="true">
                @if (loadingForm)
                {
                    <div class="loading-text" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="display: inline-block;"></div>
                        <p style="margin-top: 10px;">Loading volunteer details...</p>
                    </div>
                }
                else
                {
                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input id="firstName" class="form-control" @bind="editModel.FirstName" @bind:event="oninput" maxlength="100" @onclick:stopPropagation="true" placeholder="e.g., Juan" />
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input id="lastName" class="form-control" @bind="editModel.LastName" @bind:event="oninput" maxlength="100" @onclick:stopPropagation="true" placeholder="e.g., Dela Cruz" />
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input id="email" type="email" class="form-control" @bind="editModel.Email" @bind:event="oninput" maxlength="255" @onclick:stopPropagation="true" placeholder="email@example.com" />
                        </div>
                        <div class="form-group">
                            <label for="contact">Contact Number</label>
                            <input id="contact" class="form-control" @bind="editModel.ContactNumber" @bind:event="oninput" maxlength="30" @onclick:stopPropagation="true" placeholder="09XXXXXXXXX" />
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="password">Password @(editModel.VolunteerId == 0 ? "*" : "(Leave blank to keep current)")</label>
                            <div class="password-input-wrapper">
                                <input id="password" 
                                       type="@(showPasswordInForm ? "text" : "password")" 
                                       class="form-control" 
                                       @bind="editModel.Password" 
                                       @bind:event="oninput" 
                                       maxlength="255" 
                                       placeholder="Enter password"
                                       @onclick:stopPropagation="true" />
                                <button type="button" 
                                        class="toggle-password-btn" 
                                        @onclick="() => showPasswordInForm = !showPasswordInForm"
                                        @onclick:stopPropagation="true"
                                        title="@(showPasswordInForm ? "Hide password" : "Show password")">
                                    <i class="bi @(showPasswordInForm ? "bi-eye-slash" : "bi-eye")"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password @(editModel.VolunteerId == 0 ? "*" : "")</label>
                            <div class="password-input-wrapper">
                                <input id="confirmPassword" 
                                       type="@(showConfirmPasswordInForm ? "text" : "password")" 
                                       class="form-control" 
                                       @bind="editModel.ConfirmPassword" 
                                       @bind:event="oninput" 
                                       maxlength="255" 
                                       placeholder="Confirm password"
                                       @onclick:stopPropagation="true" />
                                <button type="button" 
                                        class="toggle-password-btn" 
                                        @onclick="() => showConfirmPasswordInForm = !showConfirmPasswordInForm"
                                        @onclick:stopPropagation="true"
                                        title="@(showConfirmPasswordInForm ? "Hide password" : "Show password")">
                                    <i class="bi @(showConfirmPasswordInForm ? "bi-eye-slash" : "bi-eye")"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input id="address" class="form-control" @bind="editModel.Address" @bind:event="oninput" maxlength="255" @onclick:stopPropagation="true" placeholder="Complete address" />
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="skills">Skills / Expertise</label>
                            <select id="skills" class="form-control" @bind="editModel.Skills" @onclick:stopPropagation="true">
                                <option value="">Select a skill</option>
                                <option value="Medical">Medical</option>
                                <option value="First Aid">First Aid</option>
                                <option value="Search and Rescue">Search and Rescue</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Communication">Communication</option>
                                <option value="Food Preparation">Food Preparation</option>
                                <option value="Shelter Management">Shelter Management</option>
                                <option value="Counseling">Counseling</option>
                                <option value="Transportation">Transportation</option>
                                <option value="IT Support">IT Support</option>
                                <option value="Translation">Translation</option>
                                <option value="Administration">Administration</option>
                                <option value="Construction">Construction</option>
                                <option value="Water and Sanitation">Water and Sanitation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="availability">Availability</label>
                            <select id="availability" class="form-control" @bind="editModel.Availability" @onclick:stopPropagation="true">
                                <option value="">Select availability</option>
                                <option value="Full-time">Full-time</option>
                                <option value="Part-time">Part-time</option>
                                <option value="Weekdays">Weekdays</option>
                                <option value="Weekends">Weekends</option>
                                <option value="Weekday Mornings">Weekday Mornings</option>
                                <option value="Weekday Evenings">Weekday Evenings</option>
                                <option value="Weekend Mornings">Weekend Mornings</option>
                                <option value="Weekend Evenings">Weekend Evenings</option>
                                <option value="On-call">On-call</option>
                                <option value="Emergency Only">Emergency Only</option>
                                <option value="Flexible">Flexible</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="shelter">Assigned Shelter</label>
                            <select id="shelter" class="form-control" @bind="editModel.AssignedShelterId" @onclick:stopPropagation="true">
                                <option value="">None</option>
                                @foreach (var s in shelters)
                                {
                                    <option value="@s.ShelterId">@s.Name</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="disaster">Assigned Disaster</label>
                            <select id="disaster" class="form-control" @bind="editModel.AssignedDisasterId" @onclick:stopPropagation="true">
                                <option value="">None</option>
                                @foreach (var d in disasters)
                                {
                                    <option value="@d.DisasterId">@d.Title</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="status">Status *</label>
                            <select id="status" class="form-control" @bind="editModel.Status" @onclick:stopPropagation="true">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="On Leave">On Leave</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row" @onclick:stopPropagation="true">
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" class="form-control" rows="3" @bind="editModel.Notes" @bind:event="oninput" maxlength="500" @onclick:stopPropagation="true" placeholder="Additional information"></textarea>
                        </div>
                    </div>

                    <div class="modal-actions" @onclick:stopPropagation="true">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CancelForm"
                                @onclick:stopPropagation="true"
                                disabled="@saving">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveAsync"
                                @onclick:stopPropagation="true"
                                disabled="@saving">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            @(editModel.VolunteerId == 0 ? "Register" : "Update")
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private record VolunteerRow(int Id, string Name, string Email, string ContactNumber, string Skills, string Availability, string Status, DateTime RegisteredAt);

    private class VolunteerEditModel
    {
        public int VolunteerId { get; set; }
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
        public string ContactNumber { get; set; } = "";
        public string Address { get; set; } = "";
        public string Status { get; set; } = "Active";
        public string Skills { get; set; } = "";
        public string Availability { get; set; } = "";
        public int? AssignedShelterId { get; set; }
        public int? AssignedDisasterId { get; set; }
        public string Notes { get; set; } = "";
    }

    private List<VolunteerRow> AllVolunteers = new();
    private List<Disaster> disasters = new();
    private List<Shelter> shelters = new();
    private VolunteerEditModel editModel = new();
    private VolunteerRow? volunteerToArchive = null;
    
    private bool showForm = false;
    private bool saving = false;
    private bool loadingForm = false;
    private bool showPasswordInForm = false;
    private bool showConfirmPasswordInForm = false;
    private string formError = string.Empty;
    private string globalError = string.Empty;

    private string search = string.Empty;
    private string statusFilter = string.Empty;
    private string sortBy = "registered_desc";
    private int _pageIndex = 0;
    private int pageSize = 10;

    // NEW: Alert modal state variables
    private bool showLoadError = false;
    private bool showSaveSuccess = false;
    private string successTitle = "";
    private string successMessage = "";
    private bool showSaveError = false;
    private bool showDeleteSuccess = false;
    private string deleteSuccessMessage = "";
    private bool showDeleteError = false;
    private bool showValidationError = false;
    private bool showDeleteConfirm = false;
    private string deleteConfirmMessage = "";
    private bool isDeleting = false;

    private int ActiveCount => AllVolunteers.Count(v => v.Status.Equals("Active", StringComparison.OrdinalIgnoreCase));
    private int AvailableCount => AllVolunteers.Count(v => !string.IsNullOrEmpty(v.Availability));

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadAsync();
        }
        catch (Exception ex)
        {
            globalError = $"Failed to load volunteers: {ex.Message}";
            showLoadError = true;
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            disasters = await Db.Disasters.AsNoTracking().OrderBy(d => d.Title).ToListAsync();
            shelters = await Db.Shelters.AsNoTracking().OrderBy(s => s.Name).ToListAsync();

            var volunteers = await Db.Volunteers
                .AsNoTracking()
                .OrderByDescending(v => v.RegisteredAt)
                .ToListAsync();

            AllVolunteers = volunteers.Select(v => new VolunteerRow(
                v.VolunteerId,
                v.FirstName + " " + v.LastName,
                v.Email,
                v.ContactNumber ?? "—",
                v.Skills ?? "",
                v.Availability ?? "",
                v.Status,
                v.RegisteredAt
            )).ToList();
        }
        catch (Exception ex)
        {
            globalError = $"Error loading data: {ex.Message}";
            showLoadError = true;
        }
    }

    private string HashPassword(string password)
    {
        using var sha256 = SHA256.Create();
        var hashedBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
        return Convert.ToBase64String(hashedBytes);
    }

    private IEnumerable<string> DistinctStatuses =>
        AllVolunteers.Select(v => v.Status).Distinct().OrderBy(s => s);

    private IEnumerable<VolunteerRow> Query
    {
        get
        {
            var q = AllVolunteers.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(search))
                q = q.Where(v =>
                    v.Name.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    v.Email.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    v.Skills.Contains(search, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(statusFilter))
                q = q.Where(v => v.Status.Equals(statusFilter, StringComparison.OrdinalIgnoreCase));
            return Sort(q);
        }
    }

    private IEnumerable<VolunteerRow> Sort(IEnumerable<VolunteerRow> source) =>
        sortBy switch
        {
            "name_asc" => source.OrderBy(v => v.Name),
            _ => source.OrderByDescending(v => v.RegisteredAt)
        };

    private int TotalFiltered => Query.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<VolunteerRow> PagedVolunteers => Query.Skip(_pageIndex * pageSize).Take(pageSize);

    private void ResetPagination()
    {
        _pageIndex = 0;
    }

    private void ClearFilters()
    {
        search = string.Empty;
        statusFilter = string.Empty;
        sortBy = "registered_desc";
        _pageIndex = 0;
    }

    private async Task Refresh()
    {
        await LoadAsync();
        _pageIndex = 0;
        StateHasChanged();
    }

    private void PrevPage() { if (_pageIndex > 0) _pageIndex--; }
    private void NextPage() { if (_pageIndex < TotalPages - 1) _pageIndex++; }

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "active" => "st-stable",
        "inactive" => "st-contained",
        "on leave" => "st-med",
        _ => "st-stable"
    };

    private void BeginCreate()
    {
        editModel = new VolunteerEditModel();
        formError = string.Empty;
        showPasswordInForm = false;
        showConfirmPasswordInForm = false;
        showForm = true;
    }

    private async Task BeginEdit(int id)
    {
        if (loadingForm || saving) return;

        loadingForm = true;
        formError = string.Empty;
        showPasswordInForm = false;
        showConfirmPasswordInForm = false;
        showForm = true;
        StateHasChanged();

        try
        {
            var entity = await Db.Volunteers.AsNoTracking().FirstOrDefaultAsync(v => v.VolunteerId == id);
            if (entity == null)
            {
                formError = "Volunteer not found.";
                showForm = false;
                showSaveError = true;
                return;
            }

            editModel = new VolunteerEditModel
            {
                VolunteerId = entity.VolunteerId,
                FirstName = entity.FirstName,
                LastName = entity.LastName,
                Email = entity.Email,
                ContactNumber = entity.ContactNumber ?? "",
                Address = entity.Address ?? "",
                Status = entity.Status,
                Skills = entity.Skills ?? "",
                Availability = entity.Availability ?? "",
                AssignedShelterId = entity.AssignedShelterId,
                AssignedDisasterId = entity.AssignedDisasterId,
                Notes = entity.Notes ?? "",
                Password = "",
                ConfirmPassword = ""
            };
        }
        catch (Exception ex)
        {
            formError = ex.Message;
            showSaveError = true;
        }
        finally
        {
            loadingForm = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SaveAsync()
    {
        if (saving) return;
        saving = true;
        formError = string.Empty;

        try
        {
            if (string.IsNullOrWhiteSpace(editModel.FirstName) || string.IsNullOrWhiteSpace(editModel.LastName))
            {
                formError = "First and last name are required.";
                showValidationError = true;
                return;
            }

            if (string.IsNullOrWhiteSpace(editModel.Email))
            {
                formError = "Email is required.";
                showValidationError = true;
                return;
            }

            // Password validation
            if (editModel.VolunteerId == 0)
            {
                if (string.IsNullOrWhiteSpace(editModel.Password))
                {
                    formError = "Password is required for new volunteers.";
                    showValidationError = true;
                    return;
                }

                if (editModel.Password.Length < 6)
                {
                    formError = "Password must be at least 6 characters long.";
                    showValidationError = true;
                    return;
                }

                if (editModel.Password != editModel.ConfirmPassword)
                {
                    formError = "Passwords do not match.";
                    showValidationError = true;
                    return;
                }
            }
            else
            {
                if (!string.IsNullOrWhiteSpace(editModel.Password))
                {
                    if (editModel.Password.Length < 6)
                    {
                        formError = "Password must be at least 6 characters long.";
                        showValidationError = true;
                        return;
                    }

                    if (editModel.Password != editModel.ConfirmPassword)
                    {
                        formError = "Passwords do not match.";
                        showValidationError = true;
                        return;
                    }
                }
            }

            if (editModel.VolunteerId == 0)
            {
                var entity = new Volunteer
                {
                    FirstName = editModel.FirstName.Trim(),
                    LastName = editModel.LastName.Trim(),
                    Email = editModel.Email.Trim(),
                    PasswordHash = HashPassword(editModel.Password),
                    ContactNumber = editModel.ContactNumber?.Trim(),
                    Address = editModel.Address?.Trim(),
                    Status = editModel.Status,
                    Skills = editModel.Skills?.Trim(),
                    Availability = editModel.Availability?.Trim(),
                    AssignedShelterId = editModel.AssignedShelterId,
                    AssignedDisasterId = editModel.AssignedDisasterId,
                    Notes = editModel.Notes?.Trim(),
                    RegisteredAt = DateTime.UtcNow
                };
                Db.Volunteers.Add(entity);
                
                successTitle = "Volunteer Registered";
                successMessage = $"Volunteer '{editModel.FirstName} {editModel.LastName}' registered successfully!";
            }
            else
            {
                var entity = await Db.Volunteers.FirstOrDefaultAsync(v => v.VolunteerId == editModel.VolunteerId);
                if (entity == null)
                {
                    formError = "Volunteer not found.";
                    showSaveError = true;
                    return;
                }
                entity.FirstName = editModel.FirstName.Trim();
                entity.LastName = editModel.LastName.Trim();
                entity.Email = editModel.Email.Trim();
                
                if (!string.IsNullOrWhiteSpace(editModel.Password))
                {
                    entity.PasswordHash = HashPassword(editModel.Password);
                }

                entity.ContactNumber = editModel.ContactNumber?.Trim();
                entity.Address = editModel.Address?.Trim();
                entity.Status = editModel.Status;
                entity.Skills = editModel.Skills?.Trim();
                entity.Availability = editModel.Availability?.Trim();
                entity.AssignedShelterId = editModel.AssignedShelterId;
                entity.AssignedDisasterId = editModel.AssignedDisasterId;
                entity.Notes = editModel.Notes?.Trim();
                Db.Volunteers.Update(entity);
                
                successTitle = "Volunteer Updated";
                successMessage = $"Volunteer '{editModel.FirstName} {editModel.LastName}' updated successfully!";
            }

            await Db.SaveChangesAsync();
            showForm = false;
            await LoadAsync();
            showSaveSuccess = true;
        }
        catch (DbUpdateException ex)
        {
            formError = "Database error: " + (ex.InnerException?.Message ?? ex.Message);
            showSaveError = true;
        }
        catch (Exception ex)
        {
            formError = ex.Message;
            showSaveError = true;
        }
        finally
        {
            saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ShowArchiveConfirmation(VolunteerRow volunteer)
    {
        volunteerToArchive = volunteer;
        
        var assignmentInfo = new List<string>();
        // We don't have full entity here, so we just show basic confirmation
        
        deleteConfirmMessage = $"Are you sure you want to archive volunteer '{volunteer.Name}'?";
        showDeleteConfirm = true;
    }

    private async Task ExecuteArchive()
    {
        if (volunteerToArchive == null || isDeleting) return;

        isDeleting = true;
        formError = string.Empty;

        try
        {
            var entity = await Db.Volunteers
                .Include(v => v.AssignedShelter)
                .Include(v => v.AssignedDisaster)
                .FirstOrDefaultAsync(v => v.VolunteerId == volunteerToArchive.Id);
            
            if (entity == null)
            {
                formError = "Volunteer not found";
                showDeleteError = true;
                showDeleteConfirm = false;
                return;
            }

            var assignmentInfo = new List<string>();
            if (entity.AssignedShelterId.HasValue)
                assignmentInfo.Add($"assigned to shelter '{entity.AssignedShelter?.Name}'");
            if (entity.AssignedDisasterId.HasValue)
                assignmentInfo.Add($"assigned to disaster '{entity.AssignedDisaster?.Title}'");
            
            var reason = assignmentInfo.Any()
                ? $"Archived with {string.Join(", ", assignmentInfo)}"
                : "Archived by user";

            var entityName = $"{entity.FirstName} {entity.LastName} ({entity.Email})";

            var result = await ArchiveService.ArchiveAsync<Volunteer>(
                volunteerToArchive.Id,
                reason,
                entityName);

            if (!result.success)
            {
                formError = result.error ?? "Failed to archive volunteer.";
                showDeleteError = true;
                showDeleteConfirm = false;
                return;
            }

            deleteSuccessMessage = $"Volunteer '{volunteerToArchive.Name}' has been archived successfully. Administrators can restore it from the Archives page.";
            showDeleteConfirm = false;
            await LoadAsync();
            
            // Adjust current page if needed
            if (_pageIndex >= TotalPages && TotalPages > 0)
                _pageIndex = TotalPages - 1;
            
            showDeleteSuccess = true;
        }
        catch (DbUpdateException ex)
        {
            formError = $"Archive failed: {ex.InnerException?.Message ?? ex.Message}";
            showDeleteError = true;
            showDeleteConfirm = false;
        }
        catch (Exception ex)
        {
            formError = $"Archive failed: {ex.Message}";
            showDeleteError = true;
            showDeleteConfirm = false;
        }
        finally
        {
            isDeleting = false;
            volunteerToArchive = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        volunteerToArchive = null;
        isDeleting = false;
    }

    private void CancelForm()
    {
        if (saving) return;
        showForm = false;
        formError = string.Empty;
        showPasswordInForm = false;
        showConfirmPasswordInForm = false;
    }

    private void HandleOverlayClick()
    {
        CancelForm();
    }
}
