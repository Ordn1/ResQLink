@page "/evacuees"
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities

<div class="evac-root">
    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Evacuees</h2>
            <div class="panel-actions">
                <input class="mini-input" placeholder="Search name, shelter or status…" @bind="search" @bind:event="oninput" />
                <select class="mini-input" @bind="statusFilter">
                    <option value="">All Status</option>
                    @foreach (var s in DistinctStatuses) { <option>@s</option> }
                </select>
                <select class="mini-input" @bind="shelterFilter">
                    <option value="">All Shelters</option>
                    @foreach (var s in DistinctShelters) { <option>@s</option> }
                </select>
                <select class="mini-input" @bind="sortBy">
                    <option value="registered_desc">Registered: Newest</option>
                    <option value="name_asc">Name: A → Z</option>
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
                <button class="mini-btn" @onclick="Refresh">↻</button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                <tr>
                    <th style="width:70px">ID</th>
                    <th>Name</th>
                    <th>Disaster</th>
                    <th>Shelter</th>
                    <th>Status</th>
                    <th>Registered</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var e in PagedEvacuees)
                {
                    <tr>
                        <td class="t-center">#@e.Id</td>
                        <td>@e.Name</td>
                        <td>@e.Disaster</td>
                        <td>@e.Shelter</td>
                        <td><span class="status-chip @StatusClass(e.Status)">@e.Status</span></td>
                        <td>@e.Registered.ToString("MMM dd, yyyy HH:mm")</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">Showing @StartIndex–@EndIndex of @TotalFiltered</div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize">
                    <option>10</option><option>20</option><option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Shelter Snapshot</h2>
        </header>
        <div class="shelter-cards">
            @foreach (var s in ShelterSummaries)
            {
                <div class="shelter-card">
                    <div class="s-name">@s.Shelter</div>
                    <div class="s-occupancy">
                        <strong>@s.Count</strong>
                        <span class="s-muted">/ @s.Capacity</span>
                    </div>
                    <div class="progress-shell thin" aria-label="Occupancy percent">
                        <div class="progress-bar" style="width:@s.Percent%"></div>
                    </div>
                    <div class="s-meta">
                        <span>@s.Count evacuees</span>
                    </div>
                </div>
            }
        </div>
    </section>
</div>

@code {
    private record EvacueeRow(int Id, string Name, string Disaster, string Shelter, string Status, DateTime Registered);
    private record ShelterSummary(string Shelter, int Count, int Capacity)
    {
        public int Percent => Math.Clamp((int)(Count / (double)Math.Max(Capacity, 1) * 100), 0, 100);
    }

    private List<EvacueeRow> AllEvacuees = new();
    private string search = string.Empty;
    private string statusFilter = string.Empty;
    private string shelterFilter = string.Empty;
    private string sortBy = "registered_desc";
    private int _pageIndex = 0;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        // Load evacuees with related data
        var evacuees = await Db.Evacuees
            .Include(e => e.Shelter)
            .Include(e => e.Disaster)
            .AsNoTracking()
            .ToListAsync();

        AllEvacuees = evacuees.Select(e => new EvacueeRow(
            e.EvacueeId,
            e.FirstName + " " + e.LastName,
            e.Disaster.Title,
            e.Shelter?.Name ?? "—",
            e.Status,
            e.RegisteredAt
        )).OrderByDescending(e => e.Registered).ToList();
    }

    private IEnumerable<string> DistinctShelters => AllEvacuees.Select(e => e.Shelter).Where(s => s != "—").Distinct().OrderBy(s => s);
    private IEnumerable<string> DistinctStatuses => AllEvacuees.Select(e => e.Status).Distinct().OrderBy(s => s);

    private IEnumerable<EvacueeRow> Query
    {
        get
        {
            var q = AllEvacuees.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(search))
                q = q.Where(e => e.Name.Contains(search, StringComparison.OrdinalIgnoreCase)
                              || e.Shelter.Contains(search, StringComparison.OrdinalIgnoreCase)
                              || e.Status.Contains(search, StringComparison.OrdinalIgnoreCase)
                              || e.Disaster.Contains(search, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(statusFilter))
                q = q.Where(e => e.Status.Equals(statusFilter, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(shelterFilter))
                q = q.Where(e => e.Shelter.Equals(shelterFilter, StringComparison.OrdinalIgnoreCase));
            return Sort(q);
        }
    }

    private IEnumerable<EvacueeRow> Sort(IEnumerable<EvacueeRow> source) =>
        sortBy switch
        {
            "name_asc" => source.OrderBy(e => e.Name),
            _ => source.OrderByDescending(e => e.Registered)
        };

    private int TotalFiltered => Query.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<EvacueeRow> PagedEvacuees => Query.Skip(_pageIndex * pageSize).Take(pageSize);

    private IEnumerable<ShelterSummary> ShelterSummaries =>
        AllEvacuees.Where(e => e.Shelter != "—")
                   .GroupBy(e => e.Shelter)
                   .Select(g => new ShelterSummary(g.Key, g.Count(), 100)) // Capacity placeholder until stored per shelter
                   .OrderBy(s => s.Shelter);

    private void ClearFilters()
    {
        search = string.Empty;
        statusFilter = string.Empty;
        shelterFilter = string.Empty;
        sortBy = "registered_desc";
        _pageIndex = 0;
    }

    private async void Refresh()
    {
        await LoadAsync();
        StateHasChanged();
    }
    private void PrevPage() { if (_pageIndex > 0) _pageIndex--; }
    private void NextPage() { if (_pageIndex < TotalPages - 1) _pageIndex++; }

    private string StatusClass(string status) => status.ToLowerInvariant() switch
    {
        "critical" => "st-critical",
        "needs med" => "st-med",
        "admitted" => "st-stable",
        "released" => "st-contained",
        _ => "st-stable"
    };
}