@* Evacuees.razor *@
@page "/evacuees"
@inject ResQLink.Data.AppDbContext Db
@using Microsoft.EntityFrameworkCore
@using ResQLink.Data.Entities
@using System.Text.RegularExpressions

<div class="evac-root">
    @* KPI / Overview panel *@
    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Evacuees Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn btn-primary" @onclick="BeginCreate" disabled="@showForm">
                    <i class="bi bi-person-plus"></i> Add Evacuee
                </button>
                <button class="mini-btn" @onclick="Refresh" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Evacuees</div>
                <div class="kpi-value">@AllEvacuees.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Admitted / Stable</div>
                <div class="kpi-value text-accent">@AdmittedOrStableCount</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Critical</div>
                <div class="kpi-value">@CriticalCount</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Evacuees</h2>
            <div class="panel-actions">
                <input class="mini-input" placeholder="Search name, shelter, disaster or status…" @bind="search" @bind:event="oninput" />
                <select class="mini-input" @bind="statusFilter">
                    <option value="">All Status</option>
                    @foreach (var s in DistinctStatuses)
                    {
                        <option>@s</option>
                    }
                </select>
                <select class="mini-input" @bind="shelterFilter">
                    <option value="">All Shelters</option>
                    @foreach (var s in DistinctShelters)
                    {
                        <option>@s</option>
                    }
                </select>
                <select class="mini-input" @bind="sortBy">
                    <option value="registered_desc">Registered: Newest</option>
                    <option value="name_asc">Name: A → Z</option>
                </select>
                <button class="mini-btn" @onclick="ClearFilters">Clear</button>
            </div>
        </header>

        <div class="table-wrap">
            <table class="dash-table">
                <thead>
                    <tr>
                        <th style="width:70px">ID</th>
                        <th>Name</th>
                        <th>Disaster</th>
                        <th>Shelter</th>
                        <th>Status</th>
                        <th>Registered</th>
                        <th style="width:120px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in PagedEvacuees)
                    {
                        <tr>
                            <td class="t-center">#@e.Id</td>
                            <td>@e.Name</td>
                            <td>@e.Disaster</td>
                            <td>@e.Shelter</td>
                            <td>
                                <span class="status-chip @StatusClass(e.Status)">@e.Status</span>
                            </td>
                            <td>@e.Registered.ToString("MMM dd, yyyy HH:mm")</td>
                            <td class="action-cell">
                                <button class="action-btn edit"
                                        @onclick="() => BeginEdit(e.Id)"
                                        disabled="@showForm"
                                        title="Edit evacuee">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="action-btn delete"
                                        @onclick="() => ShowDeleteConfirmation(e.Id, e.Name)"
                                        title="Delete evacuee">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!PagedEvacuees.Any())
                    {
                        <tr>
                            <td colspan="7" class="t-center text-muted">No results.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <footer class="panel-foot">
            <div class="foot-left">
                Showing @StartIndex–@EndIndex of @TotalFiltered evacuees
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="pageSize">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Shelter Snapshot</h2>
        </header>
        <div class="shelter-cards">
            @foreach (var s in ShelterSummaries)
            {
                <div class="shelter-card">
                    <div class="s-name">@s.Shelter</div>
                    <div class="s-occupancy">
                        <strong>@s.Count</strong>
                        <span class="s-muted">/ @s.Capacity</span>
                    </div>
                    <div class="progress-shell thin" aria-label="Occupancy percent">
                        <div class="progress-bar" style="width:@s.Percent%"></div>
                    </div>
                    <div class="s-meta">
                        <span>@s.Count evacuees</span>
                    </div>
                </div>
            }
        </div>
    </section>
</div>

@* Create/Edit Modal *@
@if (showForm)
{
    <div class="modal-overlay" @onclick="CancelForm" @onclick:stopPropagation="false">
        <div class="modal-dialog" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(editModel.EvacueeId == 0 ? "Add Evacuee" : $"Edit Evacuee #{editModel.EvacueeId}")</h3>
                <button class="modal-close" @onclick="CancelForm" @onclick:stopPropagation="true">&times;</button>
            </div>
            <div class="modal-body">
                @if (loadingForm)
                {
                    <div class="loading-text">Loading…</div>
                }

                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input id="firstName" class="form-control" @bind="editModel.FirstName" />
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input id="lastName" class="form-control" @bind="editModel.LastName" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" class="form-control" @bind="editModel.Status">
                            @foreach (var s in StatusChoices)
                            {
                                <option value="@s">@s</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="disaster">Disaster *</label>
                        <select id="disaster" class="form-control" @bind="editModel.DisasterId">
                            <option value="0">(Select disaster)</option>
                            @foreach (var d in disasters)
                            {
                                <option value="@d.DisasterId">@d.Title</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="shelter">Shelter</label>
                        <select id="shelter" class="form-control" @bind="editModel.ShelterId">
                            <option value="@((int?)null)">(None)</option>
                            @foreach (var s in shelters)
                            {
                                <option value="@s.ShelterId">@s.Name</option>
                            }
                        </select>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(formError))
                {
                    <div class="form-error">@formError</div>
                }

                <div class="modal-actions">
                    <button type="button"
                            class="btn-cancel"
                            @onclick="CancelForm"
                            disabled="@saving"
                            @onclick:stopPropagation="true">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn-primary"
                            @onclick="SaveAsync"
                            disabled="@saving"
                            @onclick:stopPropagation="true">
                        @if (saving)
                        {
                            <span class="spinner"></span>
                        }
                        @(editModel.EvacueeId == 0 ? "Save" : "Update")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Confirmation Modal *@
@if (showDeleteModal)
{
    <div class="modal-overlay" @onclick="CloseDeleteModal" @onclick:stopPropagation="false">
        <div class="modal-dialog small" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="modal-close" @onclick="CloseDeleteModal" @onclick:stopPropagation="true">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the evacuee <strong>"@evacueeToDeleteName"</strong>?</p>
                <p class="warning-text">This action cannot be undone and will also delete all related data.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseDeleteModal" @onclick:stopPropagation="true">Cancel</button>
                <button class="btn-danger" @onclick="ConfirmDeleteAsync" disabled="@isDeleting" @onclick:stopPropagation="true">
                    @if (isDeleting)
                    {
                        <span class="spinner"></span>
                    }
                    Delete
                </button>
            </div>
        </div>
    </div>
}

@code {
    private record EvacueeRow(int Id, string Name, string Disaster, string Shelter, string Status, DateTime Registered);
    private record ShelterSummary(string Shelter, int Count, int Capacity)
    {
        public int Percent => Math.Clamp((int)(Count / (double)Math.Max(Capacity, 1) * 100), 0, 100);
    }

    private class EvacueeEditModel
    {
        public int EvacueeId { get; set; }
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Status { get; set; } = "Admitted";
        public int DisasterId { get; set; }
        public int? ShelterId { get; set; }
    }

    private List<EvacueeRow> AllEvacuees = new();
    private List<Disaster> disasters = new();
    private List<Shelter> shelters = new();
    private EvacueeEditModel editModel = new();
    private bool showForm = false;
    private bool showDeleteModal = false;
    private bool saving = false;
    private bool loadingForm = false;
    private bool isDeleting = false;
    private string formError = string.Empty;
    private int evacueeToDeleteId = 0;
    private string evacueeToDeleteName = string.Empty;

    private string search = string.Empty;
    private string statusFilter = string.Empty;
    private string shelterFilter = string.Empty;
    private string sortBy = "registered_desc";
    private int _pageIndex = 0;
    private int pageSize = 10;

    private static readonly string[] DefaultStatusChoices = ["Admitted", "Released", "Transferred", "Critical", "Stable", "Needs Med", "Deceased"];
    private string[] StatusChoices = DefaultStatusChoices;
    private readonly Dictionary<string, string> StatusCanonicalMap = new(StringComparer.OrdinalIgnoreCase);

    private int AdmittedOrStableCount =>
        AllEvacuees.Count(e => string.Equals(e.Status, "Admitted", StringComparison.OrdinalIgnoreCase)
                            || string.Equals(e.Status, "Stable", StringComparison.OrdinalIgnoreCase));

    private int CriticalCount =>
        AllEvacuees.Count(e => string.Equals(e.Status, "Critical", StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadStatusChoicesAsync();
        await LoadAsync();
    }

    private async Task LoadStatusChoicesAsync()
    {
        try
        {
            var sql = "SELECT definition FROM sys.check_constraints WHERE name = 'CK_Evacuees_Status'";
            var definition = await Db.Database.SqlQueryRaw<string>(sql).FirstOrDefaultAsync();
            if (!string.IsNullOrWhiteSpace(definition))
            {
                var matches = Regex.Matches(definition, @"\[Status\]\s*=\s*'([^']+)'");
                var list = matches.Select(m => m.Groups[1].Value).Distinct().ToArray();
                if (list.Length > 0)
                    StatusChoices = list;
            }
        }
        catch
        {
            // fallback silently
        }

        StatusCanonicalMap.Clear();
        foreach (var s in StatusChoices)
            StatusCanonicalMap[s.ToLowerInvariant()] = s;

        if (!StatusCanonicalMap.ContainsKey(editModel.Status.ToLowerInvariant()))
            editModel.Status = StatusChoices.First();
    }

    private async Task LoadAsync()
    {
        disasters = await Db.Disasters.AsNoTracking().OrderBy(d => d.Title).ToListAsync();
        shelters = await Db.Shelters.AsNoTracking().OrderBy(s => s.Name).ToListAsync();

        var evacuees = await Db.Evacuees
            .Include(e => e.Shelter)
            .Include(e => e.Disaster)
            .AsNoTracking()
            .OrderByDescending(e => e.RegisteredAt)
            .ToListAsync();

        AllEvacuees = evacuees.Select(e => new EvacueeRow(
            e.EvacueeId,
            e.FirstName + " " + e.LastName,
            e.Disaster.Title,
            e.Shelter?.Name ?? "―",
            e.Status,
            e.RegisteredAt
        )).ToList();
    }

    private IEnumerable<string> DistinctShelters =>
        AllEvacuees.Select(e => e.Shelter)
                   .Where(s => s != "―")
                   .Distinct()
                   .OrderBy(s => s);

    private IEnumerable<string> DistinctStatuses =>
        AllEvacuees.Select(e => e.Status)
                   .Distinct()
                   .OrderBy(s => s);

    private IEnumerable<EvacueeRow> Query
    {
        get
        {
            var q = AllEvacuees.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(search))
                q = q.Where(e =>
                    e.Name.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    e.Shelter.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    e.Status.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    e.Disaster.Contains(search, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(statusFilter))
                q = q.Where(e => e.Status.Equals(statusFilter, StringComparison.OrdinalIgnoreCase));
            if (!string.IsNullOrEmpty(shelterFilter))
                q = q.Where(e => e.Shelter.Equals(shelterFilter, StringComparison.OrdinalIgnoreCase));
            return Sort(q);
        }
    }

    private IEnumerable<EvacueeRow> Sort(IEnumerable<EvacueeRow> source) =>
        sortBy switch
        {
            "name_asc" => source.OrderBy(e => e.Name),
            _ => source.OrderByDescending(e => e.Registered)
        };

    private int TotalFiltered => Query.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * pageSize, TotalFiltered);
    private IEnumerable<EvacueeRow> PagedEvacuees => Query.Skip(_pageIndex * pageSize).Take(pageSize);

    private IEnumerable<ShelterSummary> ShelterSummaries =>
        AllEvacuees.Where(e => e.Shelter != "―")
                   .GroupBy(e => e.Shelter)
                   .Select(g => new ShelterSummary(g.Key, g.Count(), 100))
                   .OrderBy(s => s.Shelter);

    private void ClearFilters()
    {
        search = string.Empty;
        statusFilter = string.Empty;
        shelterFilter = string.Empty;
        sortBy = "registered_desc";
        _pageIndex = 0;
    }

    private async Task Refresh()
    {
        await LoadAsync();
        _pageIndex = 0;
    }

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    private string StatusClass(string status) => status switch
    {
        "Critical" => "st-critical",
        "Needs Med" => "st-med",
        "Admitted" => "st-stable",
        "Stable" => "st-stable",
        "Released" => "st-contained",
        "Transferred" => "st-contained",
        "Deceased" => "st-critical",
        _ => "st-stable"
    };

    private void BeginCreate()
    {
        editModel = new EvacueeEditModel();
        formError = string.Empty;
        showForm = true;
    }

    private async Task BeginEdit(int id)
    {
        if (loadingForm || saving) return;

        loadingForm = true;
        formError = string.Empty;

        editModel = new EvacueeEditModel { EvacueeId = id };
        showForm = true;
        StateHasChanged();

        try
        {
            var entity = await Db.Evacuees.AsNoTracking().FirstOrDefaultAsync(e => e.EvacueeId == id);
            if (entity == null)
            {
                formError = "Evacuee not found.";
                showForm = false;
                return;
            }

            editModel = new EvacueeEditModel
            {
                EvacueeId = entity.EvacueeId,
                FirstName = entity.FirstName,
                LastName = entity.LastName,
                Status = entity.Status,
                DisasterId = entity.DisasterId,
                ShelterId = entity.ShelterId
            };

            var key = editModel.Status.ToLowerInvariant();
            if (StatusCanonicalMap.TryGetValue(key, out var canonical))
                editModel.Status = canonical;
        }
        catch (Exception ex)
        {
            formError = ex.Message;
        }
        finally
        {
            loadingForm = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool ValidateBasic()
    {
        if (string.IsNullOrWhiteSpace(editModel.FirstName) || string.IsNullOrWhiteSpace(editModel.LastName))
        {
            formError = "First and last name are required.";
            return false;
        }
        var key = editModel.Status?.Trim().ToLowerInvariant() ?? "";
        if (!StatusCanonicalMap.TryGetValue(key, out var canonical))
        {
            formError = "Invalid status. Allowed: " + string.Join(", ", StatusChoices);
            return false;
        }
        editModel.Status = canonical;
        return true;
    }

    private async Task<bool> ValidateForeignKeysAsync()
    {
        if (editModel.DisasterId <= 0 || !await Db.Disasters.AnyAsync(d => d.DisasterId == editModel.DisasterId))
        {
            formError = "Selected disaster is invalid.";
            return false;
        }
        if (editModel.ShelterId.HasValue && editModel.ShelterId.Value > 0 &&
            !await Db.Shelters.AnyAsync(s => s.ShelterId == editModel.ShelterId.Value))
        {
            formError = "Selected shelter is invalid.";
            return false;
        }
        if (editModel.ShelterId.HasValue && editModel.ShelterId.Value == 0)
            editModel.ShelterId = null;
        return true;
    }

    private async Task SaveAsync()
    {
        if (saving) return;
        saving = true;
        formError = string.Empty;

        try
        {
            if (!ValidateBasic()) return;
            if (!await ValidateForeignKeysAsync()) return;

            if (editModel.EvacueeId == 0)
            {
                var entity = new Evacuee
                {
                    DisasterId = editModel.DisasterId,
                    ShelterId = editModel.ShelterId,
                    FirstName = editModel.FirstName.Trim(),
                    LastName = editModel.LastName.Trim(),
                    Status = editModel.Status,
                    RegisteredAt = DateTime.UtcNow
                };
                Db.Evacuees.Add(entity);
            }
            else
            {
                var entity = await Db.Evacuees.FirstOrDefaultAsync(e => e.EvacueeId == editModel.EvacueeId);
                if (entity == null)
                {
                    formError = "Evacuee not found.";
                    return;
                }
                entity.FirstName = editModel.FirstName.Trim();
                entity.LastName = editModel.LastName.Trim();
                entity.Status = editModel.Status;
                entity.DisasterId = editModel.DisasterId;
                entity.ShelterId = editModel.ShelterId;
                Db.Evacuees.Update(entity);
            }

            await Db.SaveChangesAsync();
            showForm = false;
            await LoadAsync();
        }
        catch (DbUpdateException ex) when (ex.InnerException is Microsoft.Data.SqlClient.SqlException sql && sql.Number == 547 && sql.Message.Contains("CK_Evacuees_Status"))
        {
            formError = "Status violates constraint CK_Evacuees_Status. Allowed: " + string.Join(", ", StatusChoices);
        }
        catch (DbUpdateException ex)
        {
            formError = "Database update error: " + (ex.InnerException?.Message ?? ex.Message);
        }
        catch (Exception ex)
        {
            formError = ex.Message;
        }
        finally
        {
            saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ShowDeleteConfirmation(int id, string name)
    {
        evacueeToDeleteId = id;
        evacueeToDeleteName = name;
        showDeleteModal = true;
    }

    private async Task ConfirmDeleteAsync()
    {
        if (isDeleting) return;
        if (evacueeToDeleteId == 0) return;

        isDeleting = true;
        formError = string.Empty;

        try
        {
            var entity = await Db.Evacuees.FirstOrDefaultAsync(e => e.EvacueeId == evacueeToDeleteId);
            if (entity == null)
            {
                formError = "Evacuee not found.";
                return;
            }

            Db.Evacuees.Remove(entity);
            await Db.SaveChangesAsync();
            CloseDeleteModal();
            await LoadAsync();
        }
        catch (DbUpdateException ex)
        {
            formError = "Delete failed: " + (ex.InnerException?.Message ?? ex.Message);
        }
        catch (Exception ex)
        {
            formError = ex.Message;
        }
        finally
        {
            isDeleting = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        evacueeToDeleteId = 0;
        evacueeToDeleteName = string.Empty;
        isDeleting = false;
    }

    private void CancelForm()
    {
        if (saving) return;
        showForm = false;
        formError = string.Empty;
        StateHasChanged();
    }

    private void PreventClose()
    {
        // Intentionally empty: stops click from bubbling to overlay
    }
}