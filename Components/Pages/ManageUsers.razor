@page "/manage-users"
@using ResQLink.Data.Entities
@using ResQLink.Services.Users
@using ResQLink.Components.Shared
@inject IUserService UserService
@inject NavigationManager Navigation
@inject ResQLink.Services.ArchiveService ArchiveService
@inject ResQLink.Services.AuthState Auth

@* ========== ALERT MODALS - ADD AT TOP ========== *@

@* Success Alerts *@
<AlertModal @bind-IsVisible="showSaveSuccess"
            Title="@successTitle"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

<AlertModal @bind-IsVisible="showDeleteSuccess"
            Title="User Deleted"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

@* Error Alerts *@
<AlertModal @bind-IsVisible="showLoadError"
            Title="Error Loading Users"
            Message="@ErrorMessage"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showSaveError"
            Title="Error Saving User"
            Message="@ModalError"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showDeleteError"
            Title="Error Deleting User"
            Message="@ErrorMessage"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showValidationError"
            Title="Validation Error"
            Message="@ModalError"
            Type="AlertModal.AlertType.Warning" />

@* Confirmation Dialogs *@
<AlertModal @bind-IsVisible="showCloseConfirm"
            Title="Unsaved Changes"
            Message="Are you sure you want to close this form? Any unsaved changes will be lost."
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Close Anyway"
            CancelText="Keep Editing"
            OnConfirm="ConfirmCloseModal"
            OnCancel="CancelCloseModal" />

<AlertModal @bind-IsVisible="showDeleteConfirmation"
            Title="Confirm Delete"
            Message="@deleteConfirmMessage"
            DetailMessage="@GetDeleteWarning()"
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Delete"
            CancelText="Cancel"
            IsProcessing="isDeleting"
            OnConfirm="ExecuteDelete"
            OnCancel="CancelDelete" />

@* ========== END ALERT MODALS ========== *@

<div class="manage-users-container">
    <div class="page-header">
        <div>
            <h5> Administer user accounts, roles, and access</h5>
        </div>

        <button class="btn-primary" @onclick="OpenCreateModal">
            <span class="icon">+</span> Add New User
        </button>
    </div>

    @if (Loading)
    {
        <div class="loading">Loading users...</div>
    }
    else
    {
        <section class="users-table-container" aria-label="Users">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in PagedUsers)
                    {
                        <tr class="@(user.IsActive ? "" : "inactive-row")">
                            <td>@user.UserId</td>
                            <td>@user.Username</td>
                            <td>@user.Email</td>
                            <td>
                                <span class="role-badge role-@(user.Role?.RoleName?.Replace(" ", "-").ToLower())">
                                    @user.Role?.RoleName
                                </span>
                            </td>
                            <td>
                                <span class="status-text status-@(user.IsActive ? "active" : "inactive")">
                                    @(user.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>
                            <td class="actions-cell">
                                <button class="btn-icon" @onclick="() => OpenViewModal(user)" title="View Details">
                                    <i class="bi bi-eye-fill"></i>
                                </button>
                                <button class="btn-icon" @onclick="() => OpenEditModal(user)" title="Edit User">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn-icon" @onclick="() => OpenResetPasswordModal(user)" title="Reset Password">
                                    <i class="bi bi-key-fill"></i>
                                </button>
                                <button class="btn-icon btn-danger-outline" @onclick="() => ShowDeleteConfirmation(user)" title="Delete User">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                    @if (Users.Count == 0)
                    {
                        <tr>
                            <td colspan="7" style="text-align:center; padding: 20px;">No users found.</td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (Users.Count > 0)
            {
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing @((CurrentPage - 1) * PageSize + 1) to @Math.Min(CurrentPage * PageSize, Users.Count) of @Users.Count entries
                    </div>
                    <div class="pagination-controls">
                        <button class="btn-page" @onclick="PreviousPage" disabled="@(CurrentPage == 1)">
                            <i class="bi bi-chevron-left"></i> Previous
                        </button>

                        <span style="font-size: 0.875rem; margin: 0 8px;">Page @CurrentPage of @TotalPages</span>

                        <button class="btn-page" @onclick="NextPage" disabled="@(CurrentPage == TotalPages)">
                            Next <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            }
        </section>
    }
</div>

@* View User Modal *@
@if (ShowViewModal && SelectedUser is not null)
{
    <div class="modal-overlay" @onclick="CloseModals" @onclick:stopPropagation="false">
        <div class="modal-content" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>User Details</h3>
                <button class="btn-close" @onclick="CloseModals" @onclick:stopPropagation="true">×</button>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <span class="detail-label">User ID:</span>
                    <span class="detail-value">@SelectedUser.UserId</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Username:</span>
                    <span class="detail-value">@SelectedUser.Username</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">@SelectedUser.Email</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Role:</span>
                    <span class="detail-value">@SelectedUser.Role?.RoleName</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value status-text status-@(SelectedUser.IsActive ? "active" : "inactive")">
                        @(SelectedUser.IsActive ? "Active" : "Inactive")
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Password Hash:</span>
                    <span class="detail-value password-hash">@SelectedUser.PasswordHash</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Created:</span>
                    <span class="detail-value">@SelectedUser.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Updated:</span>
                    <span class="detail-value">@SelectedUser.UpdatedAt.ToString("yyyy-MM-dd HH:mm:ss")</span>
                </div>
                <div class="password-note">
                    <strong>Note:</strong> Passwords are securely hashed and cannot be decrypted. Only password reset is available.
                </div>
            </div>
        </div>
    </div>
}

@* Edit User Modal *@
@if (ShowEditModal && SelectedUser is not null)
{
    <div class="modal-overlay" @onclick="CloseEditModal" @onclick:stopPropagation="false">
        <div class="modal-content" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Edit User - @SelectedUser.Username</h3>
                <button class="btn-close" @onclick="CloseEditModal" disabled="@Saving" @onclick:stopPropagation="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-input" @bind="EditEmail" />
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select class="form-input" @bind="EditRoleId">
                        @foreach (var role in Roles)
                        {
                            <option value="@role.RoleId">@role.RoleName</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" @bind="EditIsActive" />
                        Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseEditModal" disabled="@Saving" @onclick:stopPropagation="true">Cancel</button>
                <button class="btn-primary" @onclick="SaveEdit" disabled="@Saving" @onclick:stopPropagation="true">
                    @(Saving ? "Saving..." : "Save Changes")
                </button>
            </div>
        </div>
    </div>
}

@* Create User Modal *@
@if (ShowCreateModal)
{
    <div class="modal-overlay" @onclick="CloseCreateModal" @onclick:stopPropagation="false">
        <div class="modal-content" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="btn-close" @onclick="CloseCreateModal" disabled="@Saving" @onclick:stopPropagation="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-input" @bind="CreateUsername" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-input" @bind="CreateEmail" />
                </div>
                <div class="form-group">
                    <label>Password (min 12 characters)</label>
                    <input type="password" class="form-input" @bind="CreatePassword" />
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" class="form-input" @bind="CreateConfirmPassword" />
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select class="form-input" @bind="CreateRoleId">
                        <option value="0">-- Select Role --</option>
                        @foreach (var role in Roles)
                        {
                            <option value="@role.RoleId">@role.RoleName</option>
                        }
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseCreateModal" disabled="@Saving" @onclick:stopPropagation="true">Cancel</button>
                <button class="btn-primary" @onclick="SaveCreate" disabled="@Saving" @onclick:stopPropagation="true">
                    @(Saving ? "Creating..." : "Create User")
                </button>
            </div>
        </div>
    </div>
}

@* Reset Password Modal *@
@if (ShowResetPasswordModal && SelectedUser is not null)
{
    <div class="modal-overlay" @onclick="CloseResetPasswordModal" @onclick:stopPropagation="false">
        <div class="modal-content" @onclick="PreventClose" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Reset Password - @SelectedUser.Username</h3>
                <button class="btn-close" @onclick="CloseResetPasswordModal" disabled="@Saving" @onclick:stopPropagation="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>New Password (min 12 characters)</label>
                    <input type="password" class="form-input" @bind="ResetPassword" />
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" class="form-input" @bind="ResetConfirmPassword" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseResetPasswordModal" disabled="@Saving" @onclick:stopPropagation="true">Cancel</button>
                <button class="btn-primary" @onclick="SaveResetPassword" disabled="@Saving" @onclick:stopPropagation="true">
                    @(Saving ? "Resetting..." : "Reset Password")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<User> Users = new();
    private List<UserRole> Roles = new();
    private bool Loading = true;
    private bool Saving = false;
    private bool isDeleting = false;
    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private string ModalError = "";

    private int CurrentPage = 1;
    private int PageSize = 10;

    private int TotalPages => (int)Math.Ceiling((double)Users.Count / PageSize);
    private IEnumerable<User> PagedUsers => Users.Skip((CurrentPage - 1) * PageSize).Take(PageSize);

    // Modal states
    private bool ShowViewModal = false;
    private bool ShowEditModal = false;
    private bool ShowCreateModal = false;
    private bool ShowResetPasswordModal = false;
    private User? SelectedUser = null;
    private User? userToDelete = null;

    // Edit form fields
    private string EditEmail = "";
    private int EditRoleId = 0;
    private bool EditIsActive = true;

    // Create form fields
    private string CreateUsername = "";
    private string CreateEmail = "";
    private string CreatePassword = "";
    private string CreateConfirmPassword = "";
    private int CreateRoleId = 0;

    // Reset password fields
    private string ResetPassword = "";
    private string ResetConfirmPassword = "";

    // NEW: Alert modal state variables
    private bool showLoadError = false;
    private bool showSaveSuccess = false;
    private string successTitle = "";
    private string successMessage = "";
    private bool showSaveError = false;
    private bool showDeleteSuccess = false;
    private bool showDeleteError = false;
    private bool showValidationError = false;
    private bool showCloseConfirm = false;
    private bool showDeleteConfirmation = false;
    private string deleteConfirmMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        Loading = true;
        ErrorMessage = "";
        try
        {
            Users = await UserService.GetAllUsersAsync();
            Roles = await UserService.GetAllRolesAsync();

            if (CurrentPage < 1) CurrentPage = 1;
            if (TotalPages > 0 && CurrentPage > TotalPages) CurrentPage = TotalPages;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load users: {ex.Message}";
            showLoadError = true;
        }
        finally
        {
            Loading = false;
        }
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
        }
    }

    private void PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
        }
    }

    private bool IsLastActiveAdmin()
    {
        if (userToDelete == null) return false;

        var isAdmin = userToDelete.Role?.RoleName?.Equals("Admin", StringComparison.OrdinalIgnoreCase) == true;
        if (!isAdmin || !userToDelete.IsActive) return false;

        var activeAdminCount = Users.Count(u =>
            u.Role?.RoleName?.Equals("Admin", StringComparison.OrdinalIgnoreCase) == true
            && u.IsActive);

        return activeAdminCount <= 1;
    }

    private string GetDeleteWarning()
    {
        if (IsLastActiveAdmin())
        {
            return "⚠️ WARNING: This is the last active admin user. Deletion is not allowed.";
        }
        return "⚠️ This action cannot be undone and will also delete all related data.";
    }

    private void PreventClose() { }

    private void OpenViewModal(User user)
    {
        SelectedUser = user;
        ShowViewModal = true;
    }

    private void OpenEditModal(User user)
    {
        SelectedUser = user;
        EditEmail = user.Email;
        EditRoleId = user.RoleId;
        EditIsActive = user.IsActive;
        ModalError = "";
        ShowEditModal = true;
    }

    private void OpenCreateModal()
    {
        CreateUsername = "";
        CreateEmail = "";
        CreatePassword = "";
        CreateConfirmPassword = "";
        CreateRoleId = 0;
        ModalError = "";
        ShowCreateModal = true;
    }

    private void OpenResetPasswordModal(User user)
    {
        SelectedUser = user;
        ResetPassword = "";
        ResetConfirmPassword = "";
        ModalError = "";
        ShowResetPasswordModal = true;
    }

    private void ShowDeleteConfirmation(User user)
    {
        userToDelete = user;
        deleteConfirmMessage = $"Are you sure you want to delete the user '{user.Username}'?";
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        userToDelete = null;
        isDeleting = false;
    }

    private void CloseModals()
    {
        if (Saving) return;
        ShowViewModal = false;
        SelectedUser = null;
        ModalError = "";
    }

    private void CloseEditModal()
    {
        if (Saving) return;
        
        // Check if there are changes
        if (SelectedUser != null && (EditEmail != SelectedUser.Email || EditRoleId != SelectedUser.RoleId || EditIsActive != SelectedUser.IsActive))
        {
            showCloseConfirm = true;
            return;
        }

        ShowEditModal = false;
        SelectedUser = null;
        ModalError = "";
    }

    private void CloseCreateModal()
    {
        if (Saving) return;
        
        // Check if there are changes
        if (!string.IsNullOrWhiteSpace(CreateUsername) || !string.IsNullOrWhiteSpace(CreateEmail) || CreateRoleId > 0)
        {
            showCloseConfirm = true;
            return;
        }

        ShowCreateModal = false;
        ModalError = "";
    }

    private void CloseResetPasswordModal()
    {
        if (Saving) return;
        
        // Check if there are changes
        if (!string.IsNullOrWhiteSpace(ResetPassword))
        {
            showCloseConfirm = true;
            return;
        }

        ShowResetPasswordModal = false;
        SelectedUser = null;
        ModalError = "";
    }

    private void ConfirmCloseModal()
    {
        showCloseConfirm = false;
        ShowEditModal = false;
        ShowCreateModal = false;
        ShowResetPasswordModal = false;
        SelectedUser = null;
        ModalError = "";
    }

    private void CancelCloseModal()
    {
        showCloseConfirm = false;
    }

    private async Task SaveEdit()
    {
        if (SelectedUser is null) return;

        Saving = true;
        ModalError = "";
        try
        {
            var (success, error) = await UserService.UpdateUserAsync(
                SelectedUser.UserId,
                EditEmail,
                EditRoleId,
                EditIsActive
            );

            if (success)
            {
                successTitle = "User Updated";
                successMessage = $"User '{SelectedUser.Username}' updated successfully!";
                ShowEditModal = false;
                await LoadData();
                showSaveSuccess = true;
            }
            else
            {
                ModalError = error ?? "Failed to update user";
                showSaveError = true;
            }
        }
        catch (Exception ex)
        {
            ModalError = $"Error: {ex.Message}";
            showSaveError = true;
        }
        finally
        {
            Saving = false;
        }
    }

    private async Task SaveCreate()
    {
        if (CreatePassword != CreateConfirmPassword)
        {
            ModalError = "Passwords do not match";
            showValidationError = true;
            return;
        }

        Saving = true;
        ModalError = "";
        try
        {
            var (user, error) = await UserService.RegisterUserAsync(
                CreateUsername,
                CreatePassword,
                CreateEmail,
                CreateRoleId,
                0
            );

            if (user is not null)
            {
                successTitle = "User Created";
                successMessage = $"User '{CreateUsername}' created successfully!";
                ShowCreateModal = false;
                await LoadData();
                showSaveSuccess = true;
            }
            else
            {
                ModalError = error ?? "Failed to create user";
                showSaveError = true;
            }
        }
        catch (Exception ex)
        {
            ModalError = $"Error: {ex.Message}";
            showSaveError = true;
        }
        finally
        {
            Saving = false;
        }
    }

    private async Task SaveResetPassword()
    {
        if (SelectedUser is null) return;

        if (ResetPassword != ResetConfirmPassword)
        {
            ModalError = "Passwords do not match";
            showValidationError = true;
            return;
        }

        Saving = true;
        ModalError = "";
        try
        {
            var (success, error) = await UserService.ResetPasswordAsync(
                SelectedUser.UserId,
                ResetPassword
            );

            if (success)
            {
                successTitle = "Password Reset";
                successMessage = $"Password for '{SelectedUser.Username}' reset successfully!";
                ShowResetPasswordModal = false;
                showSaveSuccess = true;
            }
            else
            {
                ModalError = error ?? "Failed to reset password";
                showSaveError = true;
            }
        }
        catch (Exception ex)
        {
            ModalError = $"Error: {ex.Message}";
            showSaveError = true;
        }
        finally
        {
            Saving = false;
        }
    }

    private async Task ExecuteDelete()
    {
        if (userToDelete is null || isDeleting || IsLastActiveAdmin()) return;

        isDeleting = true;
        ErrorMessage = "";

        try
        {
            var (success, error) = await UserService.DeleteUserAsync(userToDelete.UserId);

            if (success)
            {
                successMessage = $"User '{userToDelete.Username}' deleted successfully!";
                showDeleteConfirmation = false;
                await LoadData();
                showDeleteSuccess = true;
            }
            else
            {
                ErrorMessage = error ?? "Failed to delete user";
                showDeleteConfirmation = false;
                showDeleteError = true;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
            showDeleteConfirmation = false;
            showDeleteError = true;
        }
        finally
        {
            isDeleting = false;
            userToDelete = null;
        }
    }
}