@page "/categories"
@inject ResQLink.Services.CategoryService CategorySvc
@inject ResQLink.Data.AppDbContext Db
@inject IJSRuntime JS
@using ResQLink.Data.Entities
@using Microsoft.EntityFrameworkCore

<div class="categories-root">

    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Categories</h2>
            <div class="panel-badge">
                <span class="role-badge">INVENTORY MANAGER</span>
            </div>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh" title="Refresh" disabled="@isLoading">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Categories</div>
                <div class="kpi-value text-accent">@categories.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active</div>
                <div class="kpi-value">@categories.Count(c => c.IsActive)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Inactive</div>
                <div class="kpi-value">@categories.Count(c => !c.IsActive)</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Categories Management</h2>
            <div class="panel-actions">
                <select class="mini-input" @bind="typeFilter" style="width:150px;">
                    <option value="">All Types</option>
                    <option value="P">Perishable</option>
                    <option value="N">Non-Perishable</option>
                    <option value="M">Medical</option>
                    <option value="O">Others</option>
                </select>
                <button class="mini-btn btn-primary" @onclick="OpenAddModal" disabled="@(showModal || isLoading)">
                    <i class="bi bi-plus-circle"></i> Add Category
                </button>
            </div>
        </header>

        <div class="panel-body">
            @if (isLoading)
            {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading categories...</p>
                </div>
            }
            else if (!FilteredCategories.Any())
            {
                <div class="empty-state">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #9ca3af;"></i>
                    <p class="text-muted">No categories found.</p>
                </div>
            }
            else
            {
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th class="t-center col-id">ID</th>
                                <th class="col-name">Category Name</th>
                                <th class="col-type">Type</th>
                                <th class="col-desc">Description</th>
                                <th class="t-center col-items">Items</th>
                                <th class="t-center col-status">Status</th>
                                <th class="t-center col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cat in FilteredCategories)
                            {
                                var hasItems = cat.ReliefGoods.Count > 0;
                                <tr>
                                    <td class="t-center col-id">@cat.CategoryId</td>
                                    <td class="col-name"><strong>@cat.CategoryName</strong></td>
                                    <td class="col-type">
                                        <span class="status-chip @GetTypeClass(cat.CategoryType?.TypeCode ?? 'O')">
                                            @(cat.CategoryType?.TypeName ?? "Uncategorized")
                                        </span>
                                    </td>
                                    <td class="col-desc">@(!string.IsNullOrWhiteSpace(cat.Description) ? cat.Description : "—")</td>
                                    <td class="t-center col-items">
                                        @if (hasItems)
                                        {
                                            <span class="badge-count">@cat.ReliefGoods.Count</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0</span>
                                        }
                                    </td>
                                    <td class="t-center col-status">
                                        <span class="status-chip @(cat.IsActive ? "st-active" : "st-contained")">
                                            @(cat.IsActive ? "ACTIVE" : "INACTIVE")
                                        </span>
                                    </td>
                                    <td class="action-cell col-actions">
                                        <button class="action-btn edit"
                                                @onclick="() => OpenEditModal(cat)"
                                                disabled="@(showModal || isLoading)"
                                                title="Edit category">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="action-btn delete @(hasItems ? "disabled" : "")"
                                                @onclick="() => ShowDeleteConfirmation(cat)"
                                                disabled="@(hasItems || showModal || isLoading || isDeleting)"
                                                title="@(hasItems ? $"Cannot delete - {cat.ReliefGoods.Count} items assigned" : "Delete category")">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" style="margin: 16px;">
                <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
            </div>
        }

        <footer class="panel-foot">
            <div class="foot-left">
                <i class="bi bi-info-circle"></i>
                Showing @FilteredCategories.Count() of @categories.Count categories
            </div>
        </footer>
    </section>

    @* Add/Edit Category modal *@
    @if (showModal)
    {
        <div class="modal-overlay" @onclick="async () => await CloseModal()" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick="PreventClose" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(isEditMode ? $"Edit Category #{editModel.CategoryId}" : "Add Category")</h3>
                    <button class="modal-close" @onclick="async () => await CloseModal()" @onclick:stopPropagation="true">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="catName">Category Name *</label>
                            <input id="catName"
                                   key="@(editModel.CategoryId)"
                                   class="form-control @(fieldErrors.ContainsKey("Name") ? "is-invalid" : "")"
                                   placeholder="e.g., Canned Goods, First Aid"
                                   value="@editModel.CategoryName"
                                   @oninput="@((e) => editModel.CategoryName = e.Value?.ToString() ?? string.Empty)"
                                   @onblur="() => ValidateField(nameof(editModel.CategoryName))" />
                            @if (fieldErrors.ContainsKey("Name"))
                            {
                                <div class="invalid-feedback">@fieldErrors["Name"]</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="catType">Category Type *</label>
                            <select id="catType" 
                                    class="form-control @(fieldErrors.ContainsKey("Type") ? "is-invalid" : "")"
                                    @bind="editModel.CategoryTypeId"
                                    @bind:after="OnCategoryTypeChanged">
                                <option value="">-- Select Type --</option>
                                @foreach (var ct in categoryTypes)
                                {
                                    <option value="@ct.CategoryTypeId">
                                        @ct.TypeName (@ct.TypeCode)
                                    </option>
                                }
                            </select>
                            @if (fieldErrors.ContainsKey("Type"))
                            {
                                <div class="invalid-feedback">@fieldErrors["Type"]</div>
                            }
                            <small class="hint">
                                <strong>P</strong>=Perishable | 
                                <strong>N</strong>=Non-Perishable | 
                                <strong>M</strong>=Medical | 
                                <strong>O</strong>=Others
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="catDesc">Description</label>
                            <textarea id="catDesc"
                                      class="form-control"
                                      rows="2"
                                      placeholder="Brief description of this category"
                                      @bind="editModel.Description"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="chk-inline">
                                <input type="checkbox" @bind="editModel.IsActive" />
                                <span>Active</span>
                            </label>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(modalError))
                    {
                        <div class="form-error">
                            <i class="bi bi-exclamation-circle"></i> @modalError
                        </div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="async () => await CloseModal()"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveCategory"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            @(isEditMode ? "Update" : "Save")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Delete Confirmation Modal *@
    @if (showDeleteModal && categoryToDelete != null)
    {
        <div class="modal-overlay" @onclick="CloseDeleteModal" @onclick:stopPropagation="false">
            <div class="modal-dialog small" @onclick="PreventClose" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Confirm Delete</h3>
                    <button class="modal-close" @onclick="CloseDeleteModal" @onclick:stopPropagation="true">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 16px;">
                        Are you sure you want to delete the category 
                        <strong>"@categoryToDelete.CategoryName"</strong>?
                    </p>
                    @if (categoryToDelete.ReliefGoods.Count > 0)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            This category has <strong>@categoryToDelete.ReliefGoods.Count item(s)</strong> assigned.
                            You must reassign these items before deletion.
                        </div>
                    }
                    else
                    {
                        <p class="warning-text" style="color: #dc2626; font-size: 0.85rem;">
                            ⚠️ This action cannot be undone.
                        </p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" 
                            @onclick="CloseDeleteModal" 
                            disabled="@isDeleting"
                            @onclick:stopPropagation="true">
                        Cancel
                    </button>
                    <button class="btn-danger" 
                            @onclick="ConfirmDelete" 
                            disabled="@(isDeleting || categoryToDelete.ReliefGoods.Count > 0)" 
                            @onclick:stopPropagation="true">
                        @if (isDeleting)
                        {
                            <span class="spinner"></span>
                        }
                        Delete
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Category> categories = new();
    private List<CategoryType> categoryTypes = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool showDeleteModal = false;
    private bool isEditMode = false;
    private bool isDeleting = false;
    private bool saving = false;
    private string typeFilter = "";
    private string errorMessage = "";
    private string modalError = "";
    private Dictionary<string, string> fieldErrors = new();
    private Category editModel = new();
    private Category? categoryToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            categories = await CategorySvc.GetAllAsync();
            categoryTypes = await Db.CategoryTypes
                .Where(ct => ct.IsActive)
                .OrderBy(ct => ct.TypeName)
                .AsNoTracking()
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<Category> FilteredCategories
    {
        get
        {
            var query = categories.AsEnumerable();
            if (!string.IsNullOrEmpty(typeFilter))
            {
                query = query.Where(c => c.CategoryType?.TypeCode.ToString() == typeFilter);
            }
            return query.OrderBy(c => c.CategoryName);
        }
    }

    private string GetTypeClass(char typeCode) => typeCode switch
    {
        'P' => "st-critical",
        'N' => "st-active",
        'M' => "st-med",
        'O' => "st-contained",
        _ => "st-contained"
    };

    private void PreventClose()
    {
        // Prevents modal close when clicking inside
    }

    private void OpenAddModal()
    {
        // Force complete reset
        showModal = false;
        isEditMode = false;
        editModel = null!;
        modalError = string.Empty;
        fieldErrors.Clear();
        
        // Create fresh instance
        editModel = new Category 
        { 
            IsActive = true,
            CategoryName = string.Empty,
            Description = null,
            CategoryTypeId = null
        };
        
        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(Category category)
    {
        isEditMode = true;
        editModel = new Category
        {
            CategoryId = category.CategoryId,
            CategoryName = category.CategoryName,
            Description = category.Description,
            CategoryTypeId = category.CategoryTypeId,
            IsActive = category.IsActive
        };
        modalError = "";
        fieldErrors.Clear();
        showModal = true;
        StateHasChanged();
    }

    private async Task CloseModal()
    {
        if (saving) return;
        
        // Ask for confirmation before closing
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to close this form? Any unsaved changes will be lost.");
        if (!confirmed) return;
        
        showModal = false;
        editModel = new();
        modalError = "";
        fieldErrors.Clear();
        StateHasChanged();
    }

    // ✅ FIX: Use @bind:after instead of @onchange to avoid conflict
    private void OnCategoryTypeChanged()
    {
        ValidateField(nameof(editModel.CategoryTypeId));
    }

    private void ValidateField(string fieldName)
    {
        fieldErrors.Remove("Name");
        fieldErrors.Remove("Type");

        if (fieldName == nameof(editModel.CategoryName))
        {
            if (string.IsNullOrWhiteSpace(editModel.CategoryName))
                fieldErrors["Name"] = "Category name is required";
            else if (editModel.CategoryName.Trim().Length < 2)
                fieldErrors["Name"] = "Name must be at least 2 characters";
        }

        if (fieldName == nameof(editModel.CategoryTypeId))
        {
            if (!editModel.CategoryTypeId.HasValue)
                fieldErrors["Type"] = "Please select a category type";
        }
    }

    private bool Validate()
    {
        fieldErrors.Clear();

        if (string.IsNullOrWhiteSpace(editModel.CategoryName))
            fieldErrors["Name"] = "Category name is required";
        else if (editModel.CategoryName.Trim().Length < 2)
            fieldErrors["Name"] = "Name must be at least 2 characters";

        if (!editModel.CategoryTypeId.HasValue)
            fieldErrors["Type"] = "Please select a category type";

        return !fieldErrors.Any();
    }

    private async Task SaveCategory()
    {
        if (saving) return;

        if (!Validate())
        {
            modalError = "Please correct the errors above";
            return;
        }

        saving = true;
        modalError = "";
        StateHasChanged();

        try
        {
            if (isEditMode)
            {
                var (result, error) = await CategorySvc.UpdateAsync(editModel.CategoryId, editModel);
                if (error != null)
                {
                    modalError = error;
                    saving = false;
                    StateHasChanged();
                    return;
                }
                
                var categoryName = editModel.CategoryName;
                await CloseModal();
                await LoadDataAsync();
                await JS.InvokeVoidAsync("showToast", $"Category '{categoryName}' updated successfully!", "success");
            }
            else
            {
                var categoryName = editModel.CategoryName;
                var (result, error) = await CategorySvc.CreateAsync(editModel);
                
                if (error != null)
                {
                    modalError = error;
                    saving = false;
                    StateHasChanged();
                    return;
                }
                
                await CloseModal();
                await LoadDataAsync();
                await JS.InvokeVoidAsync("showToast", $"Category '{categoryName}' created successfully!", "success");
            }
        }
        catch (Exception ex)
        {
            var errorMsg = ex.InnerException != null 
                ? $"{ex.Message} - {ex.InnerException.Message}"
                : ex.Message;
            modalError = $"Error: {errorMsg}";
            System.Diagnostics.Debug.WriteLine($"❌ Category Save Error: {ex}");
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private void ShowDeleteConfirmation(Category category)
    {
        if (category.ReliefGoods.Count == 0)
        {
            categoryToDelete = category;
            showDeleteModal = true;
        }
        else
        {
            errorMessage = $"Cannot delete '{category.CategoryName}' - it has {category.ReliefGoods.Count} item(s) assigned.";
        }
    }

    private async Task ConfirmDelete()
    {
        if (categoryToDelete == null || isDeleting) return;

        isDeleting = true;
        modalError = "";

        try
        {
            var (success, error) = await CategorySvc.DeleteAsync(categoryToDelete.CategoryId);
            
            if (!success)
            {
                await JS.InvokeVoidAsync("showToast", error ?? "Failed to delete category", "error");
                CloseDeleteModal();
                isDeleting = false;
                return;
            }

            var categoryName = categoryToDelete.CategoryName;
            await LoadDataAsync();
            CloseDeleteModal();
            await JS.InvokeVoidAsync("showToast", $"Category '{categoryName}' archived successfully!", "success");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("showToast", $"Error: {ex.Message}", "error");
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CloseDeleteModal()
    {
        if (isDeleting) return;
        showDeleteModal = false;
        categoryToDelete = null;
    }

    private async Task Refresh()
    {
        errorMessage = "";
        await LoadDataAsync();
    }
}