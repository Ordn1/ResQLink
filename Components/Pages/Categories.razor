@page "/categories"
@inject ResQLink.Services.CategoryService CategorySvc
@inject ResQLink.Data.AppDbContext Db
@using ResQLink.Data.Entities
@using Microsoft.EntityFrameworkCore
@using ResQLink.Components.Shared

@* ========== ALERT MODALS - ADD AT TOP ========== *@

@* Success Alerts *@
<AlertModal @bind-IsVisible="showSaveSuccess"
            Title="@successTitle"
            Message="@successMessage"
            Type="AlertModal.AlertType.Success" />

<AlertModal @bind-IsVisible="showDeleteSuccess"
            Title="Category Archived"
            Message="@deleteSuccessMessage"
            Type="AlertModal.AlertType.Success" />

@* Error Alerts *@
<AlertModal @bind-IsVisible="showSaveError"
            Title="Error Saving Category"
            Message="@modalError"
            DetailMessage="@saveErrorDetail"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showDeleteError"
            Title="Error Deleting Category"
            Message="@deleteErrorMessage"
            Type="AlertModal.AlertType.Error" />

<AlertModal @bind-IsVisible="showValidationError"
            Title="Validation Error"
            Message="@modalError"
            Type="AlertModal.AlertType.Warning" />

<AlertModal @bind-IsVisible="showCannotDeleteError"
            Title="Cannot Delete Category"
            Message="@cannotDeleteMessage"
            DetailMessage="You must reassign or remove the items before deleting this category."
            Type="AlertModal.AlertType.Warning" />

@* Confirmation Dialogs *@
<AlertModal @bind-IsVisible="showCloseConfirm"
            Title="Unsaved Changes"
            Message="Are you sure you want to close this form? Any unsaved changes will be lost."
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Close Anyway"
            CancelText="Keep Editing"
            OnConfirm="ConfirmCloseModal"
            OnCancel="CancelCloseModal" />

<AlertModal @bind-IsVisible="showDeleteConfirm"
            Title="Confirm Delete"
            Message="@deleteConfirmMessage"
            DetailMessage="⚠️ This action cannot be undone."
            Type="AlertModal.AlertType.Warning"
            ShowCancel="true"
            ConfirmText="Delete"
            CancelText="Cancel"
            IsProcessing="isDeleting"
            OnConfirm="ConfirmDelete"
            OnCancel="CancelDeleteConfirm" />

@* ========== END ALERT MODALS ========== *@

<div class="categories-root">

    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Categories Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh" title="Refresh" disabled="@isLoading">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-tags-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Total Categories</div>
                    <div class="kpi-value">@categories.Count</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label">Active</div>
                    <div class="kpi-value">@categories.Count(c => c.IsActive)</div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon-circle" style="background: #fef2f2; color: #dc2626;">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-label" style="color: #991b1b;">Inactive</div>
                    <div class="kpi-value" style="color: #dc2626;">@categories.Count(c => !c.IsActive)</div>
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Categories Management</h2>
            <div class="panel-actions">
                <select class="mini-input" @bind="typeFilter" @bind:after="ResetPagination" style="width:150px;">
                    <option value="">All Types</option>
                    <option value="P">Perishable</option>
                    <option value="N">Non-Perishable</option>
                    <option value="M">Medical</option>
                    <option value="O">Others</option>
                </select>
                <button class="mini-btn btn-primary" @onclick="OpenAddModal" disabled="@(showModal || isLoading)">
                    <i class="bi bi-plus-circle"></i> Add Category
                </button>
            </div>
        </header>

        <div class="panel-body" style="padding: 0;">
            @if (isLoading)
            {
                <div class="loading-state" style="padding: 40px; text-align: center;">
                    <div class="spinner"></div>
                    <p class="text-muted" style="margin-top: 10px;">Loading categories...</p>
                </div>
            }
            else if (!FilteredCategories.Any())
            {
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p class="text-muted">No categories found.</p>
                </div>
            }
            else
            {
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th class="t-center col-id">ID</th>
                                <th class="col-name">Category Name</th>
                                <th class="col-type">Type</th>
                                <th class="col-desc">Description</th>
                                <th class="t-center col-items">Items</th>
                                <th class="t-center col-status">Status</th>
                                <th class="t-center col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cat in PagedCategories)
                            {
                                var hasItems = cat.ReliefGoods.Count > 0;
                                <tr>
                                    <td class="t-center col-id">@cat.CategoryId</td>
                                    <td class="col-name"><strong>@cat.CategoryName</strong></td>
                                    <td class="col-type">
                                        <span class="text-muted">
                                            @(cat.CategoryType?.TypeName ?? "Uncategorized")
                                        </span>
                                    </td>
                                    <td class="col-desc">@(!string.IsNullOrWhiteSpace(cat.Description) ? cat.Description : "—")</td>
                                    <td class="t-center col-items">
                                        @if (hasItems)
                                        {
                                            <span style="font-weight: 700; color: #111827;">@cat.ReliefGoods.Count</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0</span>
                                        }
                                    </td>
                                    <td class="t-center col-status">
                                        <span style="font-weight: 700; font-size: 0.7rem; text-transform: uppercase; color: @(cat.IsActive ? "#16a34a" : "#9ca3af");">
                                            @(cat.IsActive ? "ACTIVE" : "INACTIVE")
                                        </span>
                                    </td>
                                    <td class="action-cell col-actions">
                                        <button class="action-btn edit"
                                                @onclick="() => OpenEditModal(cat)"
                                                disabled="@(showModal || isLoading)"
                                                title="Edit category">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="action-btn delete @(hasItems ? "disabled" : "")"
                                                @onclick="() => ShowDeleteConfirmation(cat)"
                                                disabled="@(hasItems || showModal || isLoading || isDeleting)"
                                                title="@(hasItems ? $"Cannot delete - {cat.ReliefGoods.Count} items assigned" : "Delete category")">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" style="margin: 16px;">
                <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
            </div>
        }

        <footer class="panel-foot">
            <div class="foot-left">
                <i class="bi bi-info-circle"></i>
                Showing @StartIndex–@EndIndex of @TotalFiltered categories
            </div>
            <div class="foot-right">
                <label class="foot-label">Rows</label>
                <select class="mini-input" @bind="_pageSize" style="width: auto; min-width: 60px;" @bind:after="ResetPagination">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
                <button class="mini-btn" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
                <span class="page-indicator">Page @(_pageIndex + 1) / @TotalPages</span>
                <button class="mini-btn" @onclick="NextPage" disabled="@(_pageIndex >= TotalPages - 1)">Next</button>
            </div>
        </footer>
    </section>

    @* Add/Edit Category modal *@
    @if (showModal)
    {
        <div class="modal-overlay">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(isEditMode ? $"Edit Category #{editModel.CategoryId}" : "Add Category")</h3>
                    <button class="modal-close" @onclick="CloseModal" disabled="@saving">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="catName">Category Name *</label>
                            <input id="catName"
                                   key="@(editModel.CategoryId)"
                                   class="form-control @(fieldErrors.ContainsKey("Name") ? "is-invalid" : "")"
                                   placeholder="e.g., Canned Goods, First Aid"
                                   value="@editModel.CategoryName"
                                   @oninput="@((e) => { editModel.CategoryName = e.Value?.ToString() ?? string.Empty; OnFormChanged(); })"
                                   @onblur="() => ValidateField(nameof(editModel.CategoryName))" />
                            @if (fieldErrors.ContainsKey("Name"))
                            {
                                <div class="invalid-feedback">@fieldErrors["Name"]</div>
                            }
                        </div>
                        <div class="form-group">
                            <label for="catType">Category Type *</label>
                            <select id="catType"
                                    class="form-control @(fieldErrors.ContainsKey("Type") ? "is-invalid" : "")"
                                    @bind="editModel.CategoryTypeId"
                                    @bind:after="OnCategoryTypeChanged">
                                <option value="">-- Select Type --</option>
                                @foreach (var ct in categoryTypes)
                                {
                                    <option value="@ct.CategoryTypeId">
                                        @ct.TypeName (@ct.TypeCode)
                                    </option>
                                }
                            </select>
                            @if (fieldErrors.ContainsKey("Type"))
                            {
                                <div class="invalid-feedback">@fieldErrors["Type"]</div>
                            }
                            <small class="hint">
                                <strong>P</strong>=Perishable |
                                <strong>N</strong>=Non-Perishable |
                                <strong>M</strong>=Medical |
                                <strong>O</strong>=Others
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="catDesc">Description</label>
                            <textarea id="catDesc"
                                      class="form-control"
                                      rows="2"
                                      placeholder="Brief description of this category"
                                      @bind="editModel.Description"
                                      @oninput="OnFormChanged"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <ToggleSwitch @bind-Value="editModel.IsActive" 
                                          Label="Active" 
                                          @bind-Value:after="OnFormChanged" />
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseModal"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveCategory"
                                disabled="@saving"
                                @onclick:stopPropagation="true">
                            @if (saving)
                            {
                                <span class="spinner"></span>
                            }
                            @(isEditMode ? "Update" : "Save")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Category> categories = new();
    private List<CategoryType> categoryTypes = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditMode = false;
    private bool isDeleting = false;
    private bool saving = false;
    private string typeFilter = "";
    private string errorMessage = "";
    private string modalError = "";
    private string saveErrorDetail = "";
    private Dictionary<string, string> fieldErrors = new();
    private Category editModel = new();
    private Category? categoryToDelete = null;

    // NEW: Alert modal state variables
    private bool showSaveSuccess = false;
    private string successTitle = "";
    private string successMessage = "";
    private bool showDeleteSuccess = false;
    private string deleteSuccessMessage = "";
    private bool showSaveError = false;
    private bool showDeleteError = false;
    private string deleteErrorMessage = "";
    private bool showValidationError = false;
    private bool showCannotDeleteError = false;
    private string cannotDeleteMessage = "";
    private bool showCloseConfirm = false;
    private bool showDeleteConfirm = false;
    private string deleteConfirmMessage = "";
    private bool hasUnsavedChanges = false;

    // Pagination State
    private int _pageIndex = 0;
    private int _pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            categories = await CategorySvc.GetAllAsync();
            categoryTypes = await Db.CategoryTypes
                .Where(ct => ct.IsActive)
                .OrderBy(ct => ct.TypeName)
                .AsNoTracking()
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // Filters results
    private IEnumerable<Category> FilteredCategories
    {
        get
        {
            var query = categories.AsEnumerable();
            if (!string.IsNullOrEmpty(typeFilter))
            {
                query = query.Where(c => c.CategoryType?.TypeCode.ToString() == typeFilter);
            }
            return query.OrderBy(c => c.CategoryName);
        }
    }

    // Pagination Logic
    private int TotalFiltered => FilteredCategories.Count();
    private int TotalPages => Math.Max((int)Math.Ceiling(TotalFiltered / (double)_pageSize), 1);
    private int StartIndex => TotalFiltered == 0 ? 0 : (_pageIndex * _pageSize) + 1;
    private int EndIndex => Math.Min((_pageIndex + 1) * _pageSize, TotalFiltered);

    private IEnumerable<Category> PagedCategories =>
        FilteredCategories.Skip(_pageIndex * _pageSize).Take(_pageSize);

    private void NextPage()
    {
        if (_pageIndex < TotalPages - 1) _pageIndex++;
    }

    private void PrevPage()
    {
        if (_pageIndex > 0) _pageIndex--;
    }

    private void ResetPagination()
    {
        _pageIndex = 0;
    }

    private void OpenAddModal()
    {
        showModal = false;
        isEditMode = false;
        editModel = null!;
        modalError = string.Empty;
        fieldErrors.Clear();
        hasUnsavedChanges = false;

        editModel = new Category
        {
            IsActive = true,
            CategoryName = string.Empty,
            Description = null,
            CategoryTypeId = null
        };

        showModal = true;
        StateHasChanged();
    }

    private void OpenEditModal(Category category)
    {
        isEditMode = true;
        editModel = new Category
        {
            CategoryId = category.CategoryId,
            CategoryName = category.CategoryName,
            Description = category.Description,
            CategoryTypeId = category.CategoryTypeId,
            IsActive = category.IsActive
        };
        modalError = "";
        fieldErrors.Clear();
        hasUnsavedChanges = false;
        showModal = true;
        StateHasChanged();
    }

    // NEW: Track form changes
    private void OnFormChanged()
    {
        hasUnsavedChanges = true;
    }

    // CHANGED: Check for unsaved changes before closing
    private void CloseModal()
    {
        if (saving) return;

        // Check if there are unsaved changes
        if (!string.IsNullOrWhiteSpace(editModel.CategoryName) || editModel.CategoryTypeId.HasValue)
        {
            showCloseConfirm = true;
            return;
        }

        // No changes, close directly
        showModal = false;
        editModel = new();
        modalError = "";
        fieldErrors.Clear();
        hasUnsavedChanges = false;
    }

    private void ConfirmCloseModal()
    {
        showCloseConfirm = false;
        showModal = false;
        editModel = new();
        modalError = "";
        fieldErrors.Clear();
        hasUnsavedChanges = false;
    }

    private void CancelCloseModal()
    {
        showCloseConfirm = false;
    }

    private void OnCategoryTypeChanged()
    {
        ValidateField(nameof(editModel.CategoryTypeId));
        OnFormChanged();
    }

    private void ValidateField(string fieldName)
    {
        fieldErrors.Remove("Name");
        fieldErrors.Remove("Type");

        if (fieldName == nameof(editModel.CategoryName))
        {
            if (string.IsNullOrWhiteSpace(editModel.CategoryName))
                fieldErrors["Name"] = "Category name is required";
            else if (editModel.CategoryName.Trim().Length < 2)
                fieldErrors["Name"] = "Name must be at least 2 characters";
        }

        if (fieldName == nameof(editModel.CategoryTypeId))
        {
            if (!editModel.CategoryTypeId.HasValue)
                fieldErrors["Type"] = "Please select a category type";
        }
    }

    private bool Validate()
    {
        fieldErrors.Clear();

        if (string.IsNullOrWhiteSpace(editModel.CategoryName))
            fieldErrors["Name"] = "Category name is required";
        else if (editModel.CategoryName.Trim().Length < 2)
            fieldErrors["Name"] = "Name must be at least 2 characters";

        if (!editModel.CategoryTypeId.HasValue)
            fieldErrors["Type"] = "Please select a category type";

        return !fieldErrors.Any();
    }

    // CHANGED: Use AlertModal for validation and save errors
    private async Task SaveCategory()
    {
        if (saving) return;

        if (!Validate())
        {
            modalError = "Please correct the errors above";
            showValidationError = true;
            return;
        }

        saving = true;
        modalError = "";
        saveErrorDetail = "";
        StateHasChanged();

        try
        {
            if (isEditMode)
            {
                var (result, error) = await CategorySvc.UpdateAsync(editModel.CategoryId, editModel);
                if (error != null)
                {
                    modalError = error;
                    showSaveError = true;
                    saving = false;
                    StateHasChanged();
                    return;
                }

                // Success
                successTitle = "Category Updated";
                successMessage = $"Category '{editModel.CategoryName}' updated successfully!";
                showModal = false;
                hasUnsavedChanges = false;
                await LoadDataAsync();
                showSaveSuccess = true;
            }
            else
            {
                var categoryName = editModel.CategoryName;
                var (result, error) = await CategorySvc.CreateAsync(editModel);

                if (error != null)
                {
                    modalError = error;
                    showSaveError = true;
                    saving = false;
                    StateHasChanged();
                    return;
                }

                // Success
                successTitle = "Category Created";
                successMessage = $"Category '{categoryName}' created successfully!";
                showModal = false;
                hasUnsavedChanges = false;
                await LoadDataAsync();
                showSaveSuccess = true;
            }
        }
        catch (Exception ex)
        {
            modalError = ex.Message;
            saveErrorDetail = ex.InnerException?.Message ?? "";
            showSaveError = true;
            System.Diagnostics.Debug.WriteLine($"❌ Category Save Error: {ex}");
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    // CHANGED: Use AlertModal for delete success/error
    private void ShowDeleteConfirmation(Category category)
    {
        if (category.ReliefGoods.Count > 0)
        {
            cannotDeleteMessage = $"Cannot delete '{category.CategoryName}' - it has {category.ReliefGoods.Count} item(s) assigned.";
            showCannotDeleteError = true;
        }
        else
        {
            categoryToDelete = category;
            deleteConfirmMessage = $"Are you sure you want to delete the category '{category.CategoryName}'?";
            showDeleteConfirm = true;
        }
    }

    // CHANGED: Use AlertModal for delete success/error
    private async Task ConfirmDelete()
    {
        if (categoryToDelete == null || isDeleting) return;

        isDeleting = true;

        try
        {
            var categoryName = categoryToDelete.CategoryName;
            var (success, error) = await CategorySvc.DeleteAsync(categoryToDelete.CategoryId);

            if (!success)
            {
                deleteErrorMessage = error ?? "Failed to delete category";
                showDeleteConfirm = false;
                showDeleteError = true;
            }
            else
            {
                deleteSuccessMessage = $"Category '{categoryName}' archived successfully!";
                showDeleteConfirm = false;
                await LoadDataAsync();
                showDeleteSuccess = true;
            }
        }
        catch (Exception ex)
        {
            deleteErrorMessage = ex.Message;
            showDeleteConfirm = false;
            showDeleteError = true;
        }
        finally
        {
            isDeleting = false;
            categoryToDelete = null;
            StateHasChanged();
        }
    }

    private void CancelDeleteConfirm()
    {
        showDeleteConfirm = false;
        categoryToDelete = null;
    }

    private async Task Refresh()
    {
        errorMessage = "";
        await LoadDataAsync();
    }
}