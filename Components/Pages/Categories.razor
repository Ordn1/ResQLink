@page "/categories"
@inject ResQLink.Services.CategoryService CategorySvc
@inject ResQLink.Data.AppDbContext Db
@using ResQLink.Data.Entities
@using Microsoft.EntityFrameworkCore

<div class="categories-root">

    <section class="panel kpi-panel">
        <header class="panel-head">
            <h2 class="panel-title">Categories Overview</h2>
            <div class="panel-actions">
                <button class="mini-btn" @onclick="Refresh" title="Refresh list">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </header>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Categories</div>
                <div class="kpi-value text-accent">@categories.Count</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active</div>
                <div class="kpi-value">@categories.Count(c => c.IsActive)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Inactive</div>
                <div class="kpi-value">@categories.Count(c => !c.IsActive)</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <header class="panel-head">
            <h2 class="panel-title">Categories Management</h2>
            <div class="panel-actions">
                <select class="mini-input" @bind="typeFilter" style="width:150px;">
                    <option value="">All Types</option>
                    <option value="P">Perishable</option>
                    <option value="N">Non-Perishable</option>
                    <option value="M">Medical</option>
                    <option value="O">Others</option>
                </select>
                <button class="mini-btn btn-primary" @onclick="OpenAddModal" disabled="@showModal">
                    <i class="bi bi-plus-circle"></i> Add Category
                </button>
            </div>
        </header>

        <div class="panel-body">
            @if (isLoading)
            {
                <p class="t-center text-muted">Loading…</p>
            }
            else if (!FilteredCategories.Any())
            {
                <p class="t-center text-muted">No categories found.</p>
            }
            else
            {
                <div class="table-wrap">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th class="t-center col-id">ID</th>
                                <th class="col-name">Category Name</th>
                                <th class="col-type">Type</th>
                                <th class="col-desc">Description</th>
                                <th class="t-center col-items">Items</th>
                                <th class="t-center col-status">Status</th>
                                <th class="t-center col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cat in FilteredCategories)
                            {
                                <tr>
                                    <td class="t-center col-id">@cat.CategoryId</td>
                                    <td class="col-name"><strong>@cat.CategoryName</strong></td>
                                    <td class="col-type">
                                        <span class="status-chip @GetTypeClass(cat.CategoryType?.TypeCode ?? 'O')">
                                            @(cat.CategoryType?.TypeName ?? "Uncategorized")
                                        </span>
                                    </td>
                                    <td class="col-desc">@(!string.IsNullOrWhiteSpace(cat.Description) ? cat.Description : "—")</td>
                                    <td class="t-center col-items">@cat.ReliefGoods.Count</td>
                                    <td class="t-center col-status">
                                        <span class="status-chip @(cat.IsActive ? "st-active" : "st-contained")">
                                            @(cat.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                    <td class="action-cell col-actions">
                                        <button class="action-btn edit"
                                                @onclick="() => OpenEditModal(cat)"
                                                title="Edit category">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="action-btn delete"
                                                @onclick="() => DeleteCategory(cat.CategoryId)"
                                                title="Delete category"
                                                disabled="@(cat.ReliefGoods.Count > 0)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="form-error" style="margin-top:8px;">@errorMessage</div>
            }
        </div>
    </section>

    @* Add/Edit Category modal – same style as Shelter/Evacuees *@
    @if (showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal" @onclick:stopPropagation="false">
            <div class="modal-dialog" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>@(isEditMode ? "Edit Category" : "Add Category")</h3>
                    <button class="modal-close" @onclick="CloseModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="catName">Category Name *</label>
                            <input id="catName"
                                   class="form-control"
                                   placeholder="e.g., Canned Goods, First Aid"
                                   @bind="editModel.CategoryName" />
                        </div>
                        <div class="form-group">
                            <label for="catType">Category Type *</label>
                            <select id="catType" class="form-control" @bind="editModel.CategoryTypeId">
                                <option value="">-- Select Type --</option>
                                @foreach (var ct in categoryTypes)
                                {
                                    <option value="@ct.CategoryTypeId">
                                        @ct.TypeName - @GetTypeDescription(ct.TypeCode)
                                    </option>
                                }
                            </select>
                            <small class="hint">
                                <strong>P</strong>=Perishable ·
                                <strong>N</strong>=Non-Perishable ·
                                <strong>M</strong>=Medical ·
                                <strong>O</strong>=Others
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="catDesc">Description</label>
                            <textarea id="catDesc"
                                      class="form-control"
                                      rows="2"
                                      placeholder="Brief description of this category"
                                      @bind="editModel.Description"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="chk-inline">
                                <input type="checkbox" @bind="editModel.IsActive" />
                                <span>Active</span>
                            </label>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="form-error">@errorMessage</div>
                    }

                    <div class="modal-actions">
                        <button type="button"
                                class="btn-cancel"
                                @onclick="CloseModal"
                                @onclick:stopPropagation="true">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn-primary"
                                @onclick="SaveCategory"
                                @onclick:stopPropagation="true">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Category> categories = new();
    private List<CategoryType> categoryTypes = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditMode = false;
    private string typeFilter = "";
    private string errorMessage = "";
    private Category editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        categories = await CategorySvc.GetAllAsync();
        categoryTypes = await Db.CategoryTypes.OrderBy(ct => ct.TypeName).ToListAsync();
        isLoading = false;
    }

    private IEnumerable<Category> FilteredCategories
    {
        get
        {
            var query = categories.AsEnumerable();
            if (!string.IsNullOrEmpty(typeFilter))
            {
                query = query.Where(c => c.CategoryType?.TypeCode.ToString() == typeFilter);
            }
            return query.OrderBy(c => c.CategoryName);
        }
    }

    private string GetTypeClass(char typeCode) => typeCode switch
    {
        'P' => "st-critical",  // red/orange style (you can map this to existing chip classes)
        'N' => "st-active",    // green
        'M' => "st-med",       // yellow
        'O' => "st-contained", // gray/neutral
        _ => "st-contained"
    };

    private string GetTypeDescription(char typeCode) => typeCode switch
    {
        'P' => "Requires expiration tracking",
        'N' => "Long-term storage items",
        'M' => "Medical supplies with expiry",
        'O' => "Miscellaneous items",
        _ => "Unknown"
    };

    private void OpenAddModal()
    {
        isEditMode = false;
        editModel = new Category { IsActive = true };
        errorMessage = "";
        showModal = true;
    }

    private void OpenEditModal(Category category)
    {
        isEditMode = true;
        editModel = new Category
        {
            CategoryId = category.CategoryId,
            CategoryName = category.CategoryName,
            Description = category.Description,
            CategoryTypeId = category.CategoryTypeId,
            IsActive = category.IsActive
        };
        errorMessage = "";
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        editModel = new();
        errorMessage = "";
    }

    private async Task SaveCategory()
    {
        if (string.IsNullOrWhiteSpace(editModel.CategoryName))
        {
            errorMessage = "Category name is required.";
            return;
        }

        if (!editModel.CategoryTypeId.HasValue)
        {
            errorMessage = "Please select a category type.";
            return;
        }

        try
        {
            if (isEditMode)
            {
                await CategorySvc.UpdateAsync(editModel.CategoryId, editModel);
            }
            else
            {
                await CategorySvc.CreateAsync(editModel);
            }

            CloseModal();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task DeleteCategory(int id)
    {
        try
        {
            await CategorySvc.DeleteAsync(id);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting category: {ex.Message}";
        }
    }

    private async Task Refresh()
    {
        await LoadDataAsync();
    }
}